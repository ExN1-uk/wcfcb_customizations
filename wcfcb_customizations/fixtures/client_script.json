[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Vehicle",
  "enabled": 1,
  "modified": "2025-08-06 11:41:41.601219",
  "module": null,
  "name": "Vehicle List Custom Button",
  "script": "frappe.listview_settings['Vehicle'] = {\n    refresh: function(listview) {\n        if (!listview.page.wrapper.find('.trigger-webhook-btn').length) {\n            listview.page.add_button(__(\"Sync From CTrack\"), function() {\n                frappe.call({\n                    method: \"trigger_webhook\",  \n                    callback: function(response) {\n                        console.log(\"Response from server:\", response);\n                        if (response) {\n                            frappe.msgprint(\"Sync completed successfully! All Ctrack data is now up to date. Please refresh the page after one minute.\");\n                            listview.refresh();\n                        } else {\n                            frappe.msgprint(\"Sync failed. Unable to update data from Ctrack. Please try again later.\");\n                        }\n                    },\n                    error: function(error) {\n                        frappe.msgprint(\"Sync failed — data from Ctrack could not be updated. Please contact IT Support for assistance.\");\n                    }\n                });\n            })\n            .addClass('btn-primary trigger-webhook-btn')\n            .insertBefore(listview.page.menu_btn);\n        }\n    }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 0,
  "modified": "2025-11-26 14:39:05.391622",
  "module": null,
  "name": "beneficiary_pas_data",
  "script": "frappe.ui.form.on('Customer', {\r\n    refresh: function(frm) {\r\n        if (frm.doc.custom_pas_number) {\r\n            fetch_pensioner_data(frm);\r\n        }\r\n        \r\n        frm.add_custom_button(__('Refresh Pensioner Info'), function() {\r\n            fetch_pensioner_data(frm);\r\n        });\r\n    }\r\n});\r\n\r\nfunction fetch_pensioner_data(frm) {\r\n    if (!frm.doc.custom_pas_number) {\r\n        frappe.msgprint(__('Please set the PAS Number first'));\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: 'get_pensioners',\r\n        args: {\r\n            pas_number: frm.doc.custom_pas_number\r\n        },\r\n        callback: function(response) {\r\n            console.log('Full API response:', response.response); // Debug log\r\n            \r\n            try {\r\n                if (!response.response) {\r\n                    throw new Error('Empty response from server');\r\n                }\r\n\r\n                // Handle both direct response and nested response structure\r\n                const responseData = response.response;\r\n                \r\n                if (!responseData) {\r\n                    throw new Error('Invalid response structure');\r\n                }\r\n\r\n                if (responseData.success) {\r\n                    const data = responseData.data;\r\n                    \r\n                    // Update fields\r\n                    frm.set_value('custom_claim_number', data.claimNumber);\r\n                    frm.set_value('custom_claim_code', data.claimCode);\r\n                    frm.set_value('custom_marital_status1', data.maritalStatus === \"1\" ? 1 : 0);\r\n                    frm.set_value('custom_user_branch_code', data.userBranchCode);\r\n                    frm.set_value('custom_pension_commencment_date', data.pensionCommencementDate ? data.pensionCommencementDate.split('T')[0] : '');\r\n                    frm.set_value('custom_pension_enabled1', data.enabledFlag === \"1\" ? 1 : 0);\r\n                    frm.set_value('custom_last_payment_date', data.lastPaymentDate ? data.lastPaymentDate.split('T')[0] : '');\r\n                    frm.set_value('custom_monthly_pension', data.monthlyPension);\r\n                  \r\n                    // frappe.show_alert(__('Pensioner data retrieved successfully'));\r\n                } else {\r\n                    throw new Error(responseData.message || 'API call failed without error message');\r\n                }\r\n            } catch (error) {\r\n                console.error('Error processing pensioner data:', error); // Debug log\r\n                frappe.msgprint(__('Failed to fetch pensioner data: {0}', [error.message]));\r\n            }\r\n        },\r\n        error: function(error) {\r\n            console.error('API call error:', error); // Debug log\r\n            frappe.msgprint(__('Network error while fetching pensioner data'));\r\n        },\r\n        freeze: true,\r\n        freeze_message: __('Fetching pensioner data...')\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier",
  "enabled": 1,
  "modified": "2025-12-09 22:09:49.141679",
  "module": null,
  "name": "verify supplier on ZRA",
  "script": "frappe.ui.form.on('Supplier', {\n    refresh: function(frm) {\n        add_verify_button(frm);\n    }\n});\n\nfunction add_verify_button(frm) {\n    if (frm.custom_verify_button_added) return;\n    \n    setTimeout(() => {\n        const verifiedField = frm.get_field('custom_verified_with_zra');\n        \n        if (verifiedField && verifiedField.$wrapper) {\n            const existingBtn = verifiedField.$wrapper.next('.verify-zra-btn');\n            if (existingBtn.length > 0) return;\n            \n            const btn = $(`\n                <button class=\"btn btn-default btn-sm verify-zra-btn\" style=\"margin-left: 10px;\">\n                    <i class=\"fa fa-check-circle\"></i> ${__('Verify with ZRA')}\n                </button>\n            `);\n            \n            btn.on('click', () => fetch_supplier_data(frm));\n            verifiedField.$wrapper.after(btn);\n            verifiedField.$wrapper.css('margin-bottom', '10px');\n            frm.custom_verify_button_added = true;\n        } else {\n            if (!frm.custom_verify_button_added) {\n                frm.add_custom_button(__('Verify with ZRA'), () => {\n                    fetch_supplier_data(frm);\n                }, __('Verification'));\n                frm.custom_verify_button_added = true;\n            }\n        }\n    }, 300);\n}\n\nfunction fetch_supplier_data(frm) {\n    // ✅ Use the standard tax_id field instead of supplier_tpin\n    if (!frm.doc.tax_id) {\n        frappe.msgprint({\n            title: __('Missing Tax ID'),\n            message: __('Please enter the Tax ID first'),\n            indicator: 'red'\n        });\n        return;\n    }\n\n    frappe.call({\n        method: 'verify_supplier',\n        args: {\n            // If your server method still expects \"tpin\",\n            // pass tax_id as tpin:\n            tpin: frm.doc.tax_id\n            // If you changed the server side to use tax_id instead, use:\n            // tax_id: frm.doc.tax_id\n        },\n        callback: function(response) {\n            try {\n                const res = response.response;   // keep your existing format\n                console.log(res);\n\n                if (!res || !res.message) {\n                    throw new Error('Empty response from server');\n                }\n\n                if (res.success) {\n                    const supplier_found = res.supplier_found;\n                    const status = res.status; // e.g. \"000\" or \"001\"\n                    \n                    frm.set_value('custom_verified_with_zra', supplier_found ? 1 : 0);\n                    \n                    frappe.show_alert({\n                        message: supplier_found ? \n                            __('Supplier successfully verified with ZRA') : \n                            __('Supplier not found. Please verify the Tax ID and try again'),\n                        indicator: supplier_found ? 'green' : 'orange'\n                    }, 5);\n                    \n                    frm.refresh_field('custom_verified_with_zra');\n                } else {\n                    const errorMsg = res.message || 'API call failed';\n                    throw new Error(errorMsg);\n                }\n            } catch (error) {\n                console.error('Verification Error:', error);\n                frappe.msgprint({\n                    title: __('Verification Failed'),\n                    message: __('Error verifying supplier: {0}', [error.message]),\n                    indicator: 'red'\n                });\n            }\n        },\n        error: function(error) {\n            console.error('API Error:', error);\n            frappe.msgprint({\n                title: __('Connection Error'),\n                message: __('Could not connect to verification service. Please try again later.'),\n                indicator: 'red'\n            });\n        },\n        freeze: true,\n        freeze_message: __('Verifying with ZRA...')\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Expense Claim",
  "enabled": 1,
  "modified": "2025-06-01 08:59:58.302329",
  "module": null,
  "name": "Per Diem Expense calculation",
  "script": "frappe.ui.form.on('Expense Claim', {\r\n    custom_travel_request: function(frm) {\r\n        if (!frm.doc.custom_travel_request) return;\r\n        \r\n        frappe.call({\r\n            method: 'get_travel_request_details',\r\n            args: {\r\n                travel_request: frm.doc.custom_travel_request\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm.travel_details = r.message;\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// Child table events for Expense Claim Detail\r\nfrappe.ui.form.on('Expense Claim Detail', {\r\n    expense_type: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        \r\n        if (row.expense_type !== \"Per Diem\") return;\r\n        \r\n        if (!frm.doc.employee || !frm.travel_details?.travel_days) {\r\n            frappe.msgprint(__(\"Select Employee and valid Travel Request first\"));\r\n            frappe.model.set_value(cdt, cdn, 'expense_type', '');\r\n            return;\r\n        }\r\n        \r\n        frappe.call({\r\n            method: 'per_diem_calc',\r\n            args: {\r\n                employee: frm.doc.employee,\r\n                travel_days: frm.travel_details.travel_days\r\n            },\r\n            callback: function(r) {\r\n                if (r.message?.error) {\r\n                    frappe.msgprint(r.message.error);\r\n                    frappe.model.set_value(cdt, cdn, 'amount', 0);\r\n                    frappe.model.set_value(cdt, cdn, 'description', '');\r\n                } else if (r.message) {\r\n                    frappe.model.set_value(cdt, cdn, 'amount', r.message.amount);\r\n                    frappe.model.set_value(cdt, cdn, 'description', \r\n                        __(\"Per Diem: {0} days × {1}\", [\r\n                            r.message.days, \r\n                            format_currency(r.message.rate)\r\n                        ]));\r\n                    frm.refresh_field('expenses');\r\n                }\r\n            }\r\n        });\r\n    },\r\n    \r\n    expenses_add: function(frm, cdt, cdn) {\r\n        // This will handle auto-calculation if a row is added with Per Diem already selected\r\n        const row = locals[cdt][cdn];\r\n        if (row.expense_type === \"Per Diem\") {\r\n            // Trigger the expense_type function\r\n            frappe.ui.form.get_docfield('Expense Claim Detail', 'expense_type', cdn).trigger('change');\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2025-06-12 13:59:02.170198",
  "module": null,
  "name": "Verify Beneficiary on ZRA",
  "script": "frappe.ui.form.on('Customer', {\r\n    refresh: function(frm) {\r\n        add_verify_button(frm);\r\n    }\r\n});\r\n\r\nfunction add_verify_button(frm) {\r\n    if (frm.custom_verify_button_added) return;\r\n    \r\n    setTimeout(() => {\r\n        const verifiedField = frm.get_field('custom_verified_with_zra');\r\n        \r\n        if (verifiedField && verifiedField.$wrapper) {\r\n            const existingBtn = verifiedField.$wrapper.next('.verify-zra-btn');\r\n            if (existingBtn.length > 0) return;\r\n            \r\n            const btn = $(`\r\n                <button class=\"btn btn-default btn-sm verify-zra-btn\" style=\"margin-left: 10px;\">\r\n                    <i class=\"fa fa-check-circle\"></i> ${__('Verify Beneficiary with ZRA')}\r\n                </button>\r\n            `);\r\n            \r\n            btn.on('click', () => fetch_beneficiary_data(frm));\r\n            verifiedField.$wrapper.after(btn);\r\n            verifiedField.$wrapper.css('margin-bottom', '10px');\r\n            frm.custom_verify_button_added = true;\r\n        } else {\r\n            if (!frm.custom_verify_button_added) {\r\n                frm.add_custom_button(__('Verify Beneficiary with ZRA'), () => {\r\n                    fetch_beneficiary_data(frm);\r\n                }, __('Verification'));\r\n                frm.custom_verify_button_added = true;\r\n            }\r\n        }\r\n    }, 300);\r\n}\r\n\r\nfunction fetch_beneficiary_data(frm) {\r\n    if (!frm.doc.customer_tpin) {\r\n        frappe.msgprint({\r\n            title: __('Missing TPIN'),\r\n            message: __('Please enter the Beneficiary TPIN first'),\r\n            indicator: 'red'\r\n        });\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: 'verify_supplier',\r\n        args: { tpin: frm.doc.customer_tpin },\r\n        callback: function(response) {\r\n            try {\r\n                const res = response.response;\r\n                console.log(res)\r\n                if (!res || !res.message) {\r\n                    throw new Error('Empty response from server');\r\n                }\r\n\r\n                if (res.success) {\r\n                    // Handle the new response format correctly\r\n                    const beneficiary_found = res.beneficiary_found;\r\n                    const status = res.status; // \"000\" or \"001\"\r\n                    \r\n                    frm.set_value('custom_verified_with_zra', beneficiary_found ? 1 : 0);\r\n                    \r\n                    frappe.show_alert({\r\n                        message: beneficiary_found ? \r\n                            __('Beneficiary successfully verified with ZRA') : \r\n                            __('Beneficiary not found. Please verify the TPIN and try again'),\r\n                        indicator: beneficiary_found ? 'green' : 'orange'\r\n                    }, 5);\r\n                    \r\n                    frm.refresh_field('custom_verified_with_zra');\r\n                } else {\r\n                    // Handle API error cases\r\n                    const errorMsg = res.message || 'API call failed';\r\n                    throw new Error(errorMsg);\r\n                }\r\n            } catch (error) {\r\n                console.error('Verification Error:', error);\r\n                frappe.msgprint({\r\n                    title: __('Verification Failed'),\r\n                    message: __('Error verifying beneficiary: {0}', [error.message]),\r\n                    indicator: 'red'\r\n                });\r\n            }\r\n        },\r\n        error: function(error) {\r\n            console.error('API Error:', error);\r\n            frappe.msgprint({\r\n                title: __('Connection Error'),\r\n                message: __('Could not connect to verification service. Please try again later.'),\r\n                indicator: 'red'\r\n            });\r\n        },\r\n        freeze: true,\r\n        freeze_message: __('Verifying Beneficiary with ZRA...')\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-08-01 10:33:59.098860",
  "module": null,
  "name": "Sale Invoice  QRCode",
  "script": "\nfrappe.ui.form.on('Sales Invoice', {\n    refresh: function(frm) {\n        // Check if ZRA sync was successful and QR code exists\n        if (frm.doc.custom_is_zra_invoice === 1 && frm.doc.custom_qrcode_url) {\n            // Generate the QR Code image URL\n            let qr_image_url = \"https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=\" + encodeURIComponent(frm.doc.custom_qrcode_url);\n\n            // Show the QR Code image\n            frm.fields_dict.custom_qr_code_image.$wrapper.html(`\n                <div>\n                    <label>QR Code</label><br>\n                    <img src=\"${qr_image_url}\" alt=\"QR Code\"/>\n                </div>\n            `);\n        } else {\n            // Clear the QR code if not successful\n            frm.fields_dict.custom_qr_code_image.$wrapper.empty();\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-07-25 13:26:13.287805",
  "module": null,
  "name": "Get all Item from ZRA Button",
  "script": "frappe.listview_settings['Item'] = {\n    refresh: function(listview) {\n        // Prevent duplicate button creation\n        if (!listview.page.wrapper.find('.triggerrr-webhook-btn').length) {\n            // Add custom button\n            listview.page.add_button(__('Get All Items from ZRA'), function() {\n                frappe.call({\n                    method: 'get_all_item_from_zra',\n                    callback: function(response) {\n                        console.log(\"Response from server:\", response);\n\n                        if (response) {\n                            frappe.msgprint(__('Items successfully fetched from ZRA and refreshed within a minute.'));\n                            listview.refresh();\n                        } else {\n                            frappe.msgprint(__('Failed to fetch items: ') + (response.message?.message || 'Unknown error'));\n                        }\n                    },\n                    error: function(error) {\n                        frappe.msgprint(__('Error triggering request: ') + (error.message || 'Unknown error'));\n                    }\n                });\n            })\n            .addClass('btn-primary triggerrr-webhook-btn')\n            .insertBefore(listview.page.menu_btn);\n        }\n    }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Branch",
  "enabled": 1,
  "modified": "2025-07-24 16:17:44.941323",
  "module": null,
  "name": "Get All Branch From ZRA",
  "script": "frappe.listview_settings['Branch'] = {\n    refresh: function(listview) {\n        // Prevent duplicate button creation\n        if (!listview.page.wrapper.find('.triggerrr-webhook-btn').length) {\n            // Add custom button\n            listview.page.add_button(__('Get All Branch from ZRA'), function() {\n                frappe.call({\n                    method: 'get_all_branch_from_zra',\n                    callback: function(response) {\n                        console.log(\"Response from server:\", response);\n\n                        if (response) {\n                            frappe.msgprint(__('successfully fetched from ZRA.'));\n                            listview.refresh();\n                        } else {\n                            frappe.msgprint(__('Failed to fetch: ') + (response.message?.message || 'Unknown error'));\n                        }\n                    },\n                    error: function(error) {\n                        frappe.msgprint(__('Error triggering request: ') + (error.message || 'Unknown error'));\n                    }\n                });\n            })\n            .addClass('btn-primary triggerrr-webhook-btn')\n            .insertBefore(listview.page.menu_btn);\n        }\n    }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "ZRA Notices",
  "enabled": 1,
  "modified": "2025-07-01 15:09:04.308026",
  "module": null,
  "name": "Notices List Customization",
  "script": "frappe.listview_settings['ZRA Notices'] = {\n    onload(listview) {\n        listview.can_create = false;\n    }\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Import Declaration",
  "enabled": 1,
  "modified": "2025-07-28 10:14:53.738250",
  "module": null,
  "name": "Import Items",
  "script": "frappe.listview_settings['Import Declaration'] = {\n    refresh: function(listview) {\n        // Avoid duplicate button\n        if (!listview.page.wrapper.find('.triggerrr-webhook-btn').length) {\n            listview.page.add_button(__('Imported Items'), function() {\n                // Build dialog\n                const d = new frappe.ui.Dialog({\n                    title: __('Fetch Import Items from ZRA'),\n                    fields: [\n                        {\n                            fieldtype: 'Data',\n                            label: __('Declaration Reference Number'),\n                            fieldname: 'param',\n                            description: __('Enter any optional filter or param'),\n                            reqd: false // Make the field optional if param can be None\n                        }\n                    ],\n                    primary_action_label: __('Fetch'),\n                    primary_action(values) {\n                        d.hide();\n                        frappe.call({\n                            method: 'get_all_import_from_zra', // Update with correct module path\n                            args: { param: values.param || null }, // Pass null explicitly if empty\n                            callback: function(r) {\n                                if (r.message && r.message.success) {\n                                    frappe.msgprint({\n                                        message: __(r.message.message),\n                                        indicator: 'green'\n                                    });\n                                    listview.refresh();\n                                } else {\n                                    frappe.msgprint({\n                                        message: __('Failed to fetch items: {0}', [r.message?.message || __('Unknown error')]),\n                                        indicator: 'red'\n                                    });\n                                }\n                            },\n                            error: function(err) {\n                                frappe.msgprint({\n                                    message: __('Error triggering request: {0}', [err.message || __('Unknown error')]),\n                                        indicator: 'red'\n                                });\n                            }\n                        });\n                    }\n                });\n                d.show();\n            })\n            .addClass('btn-primary triggerrr-webhook-btn')\n            .insertAfter(listview.page.menu);\n        }\n    }\n};",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-07-30 00:20:09.619313",
  "module": "Setup",
  "name": "Age Validation",
  "script": "frappe.ui.form.on('Employee', {\n  validate: function(frm) {\n    if (frm.doc.date_of_birth && frm.doc.date_of_joining) {\n      let dob = frappe.datetime.str_to_obj(frm.doc.date_of_birth);\n      let doj = frappe.datetime.str_to_obj(frm.doc.date_of_joining);\n      let age = doj.getFullYear() - dob.getFullYear();\n      let m = doj.getMonth() - dob.getMonth();\n\n      if (m < 0 || (m === 0 && doj.getDate() < dob.getDate())) {\n        age--;\n      }\n\n      if (age < 18) {\n        frappe.throw(__('Employee must be at least 18 years old on Date of Joining'));\n      }\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Vehicle Log",
  "enabled": 1,
  "modified": "2025-08-06 15:46:23.207736",
  "module": null,
  "name": "Get Vehicle Logs For Today",
  "script": "frappe.listview_settings['Vehicle Log'] = {\n    refresh: function(listview) {\n        if (!listview.page.wrapper.find('.trigger-webhook-btn').length) {\n            listview.page.add_button(__(\"Load Current Logs\"), function() {\n                frappe.call({\n                    method: \"get_current_logs\",  \n                    callback: function(response) {\n                        console.log(\"Response from server:\", response);\n                        if (response) {\n                            frappe.msgprint(\"Sync Completed Successfully! All logs from Ctrack have been pulled and are now up to date.Please refresh the page after one minute to see the latest data.\");\n                            listview.refresh();\n                        } else {\n                            frappe.msgprint(\"Sync FailedWe were unable to retrieve logs from Ctrack.Please check your connection or try again later.\");\n                        }\n                    },\n                    error: function(error) {\n                        frappe.msgprint(\"Sync failed — data from Ctrack could not be updated. Please contact IT Support for assistance.\");\n                    }\n                });\n            })\n            .addClass('btn-primary trigger-webhook-btn')\n            .insertBefore(listview.page.menu_btn);\n        }\n    }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Requisition",
  "enabled": 1,
  "modified": "2025-08-11 11:11:06.812583",
  "module": null,
  "name": "Change Test",
  "script": "frappe.ui.form.on('Job Requisition', {\n    after_save: function(frm) {\n        frappe.show_alert({\n            message: __('Job Requisition Saved!'),\n            indicator: 'green'\n        }, 5);\n\n        // Move alert dynamically to top-center\n        $('.frappe-alert').css({\n            'top': '20px',\n            'bottom': 'auto',\n            'left': '50%',\n            'right': 'auto',\n            'transform': 'translateX(-50%)'\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Travel Request",
  "enabled": 0,
  "modified": "2025-09-04 07:48:05.492008",
  "module": null,
  "name": "Add rate",
  "script": "// ---- CONFIGURE to your actual fieldnames on Travel Request\nconst RATE_LINK_FIELD   = 'custom_expected_per_diem_rate';   // Link → Per Diem Rates\nconst RATE_VALUE_FIELD  = 'custom_expected_per_diem_value';  // Currency (numeric value)\nconst GRADE_FIELD       = 'custom_employee_grade';            // grade on Travel Request\nconst COUNTRY_FIELD     = 'custom_destination_country';       // optional\nconst COMPANY_FIELD     = 'company';                          // optional\nconst FROM_DATE_FIELD   = 'from_date';                        // optional (for effective_from logic)\n\n// Helper: set field only if it exists on the form\nfunction safe_set(frm, fieldname, value) {\n  if (frm.fields_dict[fieldname]) frm.set_value(fieldname, value);\n}\n\nasync function pick_and_fill_rate(frm) {\n  const grade = frm.doc[GRADE_FIELD];\n  if (!grade) {\n    safe_set(frm, RATE_LINK_FIELD, null);\n    safe_set(frm, RATE_VALUE_FIELD, null);\n    return;\n  }\n\n  // Build filters to find the most specific rate\n  const filters = { grade: grade };\n  if (frm.doc[COUNTRY_FIELD]) filters.country = frm.doc[COUNTRY_FIELD];\n  if (frm.doc[COMPANY_FIELD]) filters.company = frm.doc[COMPANY_FIELD];\n\n  // 1) Find the top candidate (newest effective_from first, if present)\n  const listResp = await frappe.call({\n    method: 'frappe.client.get_list',\n    args: {\n      doctype: 'Per Diem Rates',\n      filters,\n      fields: ['name', 'effective_from'],\n      order_by: \"IFNULL(effective_from,'1900-01-01') desc\",\n      limit_page_length: 5\n    }\n  });\n\n  let candidate = null;\n  const rows = listResp?.message || [];\n\n  if (rows.length) {\n    if (frm.doc[FROM_DATE_FIELD]) {\n      // pick the latest rate whose effective_from <= travel date\n      const trv = frappe.datetime.str_to_obj(frm.doc[FROM_DATE_FIELD]);\n      candidate = rows.find(r => !r.effective_from || frappe.datetime.str_to_obj(r.effective_from) <= trv) || rows[0];\n    } else {\n      candidate = rows[0];\n    }\n  }\n\n  if (!candidate) {\n    safe_set(frm, RATE_LINK_FIELD, null);\n    safe_set(frm, RATE_VALUE_FIELD, null);\n    return;\n  }\n\n  // 2) Set Link field to the selected record\n  safe_set(frm, RATE_LINK_FIELD, candidate.name);\n\n  // 3) Fetch full doc to read 'rate' (avoids \"Field not permitted in query\")\n  const docResp = await frappe.call({\n    method: 'frappe.client.get',\n    args: { doctype: 'Per Diem Rates', name: candidate.name }\n  });\n\n  const rateDoc = docResp?.message;\n  safe_set(frm, RATE_VALUE_FIELD, (rateDoc && rateDoc.rate) ? rateDoc.rate : 0);\n}\n\nfrappe.ui.form.on('Travel Request', {\n  refresh(frm) {\n    // Keep the Link filtered dynamically for manual picks\n    frm.set_query(RATE_LINK_FIELD, () => {\n      const q = { grade: frm.doc[GRADE_FIELD] || undefined };\n      if (frm.doc[COUNTRY_FIELD]) q.country = frm.doc[COUNTRY_FIELD];\n      if (frm.doc[COMPANY_FIELD]) q.company = frm.doc[COMPANY_FIELD];\n      return { filters: q };\n    });\n  },\n\n  // Auto-pick when these change\n  [GRADE_FIELD]: pick_and_fill_rate,\n  [COUNTRY_FIELD]: pick_and_fill_rate,\n  [COMPANY_FIELD]: pick_and_fill_rate,\n  [FROM_DATE_FIELD]: pick_and_fill_rate,\n\n  onload: pick_and_fill_rate\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Opening",
  "enabled": 1,
  "modified": "2025-11-03 11:10:00.028797",
  "module": null,
  "name": "Job Opening",
  "script": "frappe.ui.form.on('Job Opening', {\r\n    // ← change only if your doctype is different\r\n    async custom_pull_requirements_from_designation(frm) {\r\n\r\n        // ---- TARGET table on THIS form ----\r\n        const TARGET_TABLE_FIELDNAME = 'custom_skillscertifications';\r\n\r\n        // 0) Guard rails\r\n        const desigName = frm.doc.designation || frm.doc.position;\r\n        if (!desigName) {\r\n            frappe.msgprint(__('Please set a Designation (or Position) first.'));\r\n            return;\r\n        }\r\n\r\n        // 1) Ask replace/append (no freeze)\r\n        const mode = await new Promise(resolve => {\r\n            frappe.confirm(\r\n                __('Replace existing skills with Designation skills?<br/>Click \"No\" to append and skip duplicates.'),\r\n                () => resolve('replace'),\r\n                () => resolve('append')\r\n            );\r\n        });\r\n\r\n        try {\r\n            frm.__copying_skills = true;\r\n            frm.toggle_enable('custom_pull_requirements_from_designation', false);\r\n\r\n            // 2) Load Designation document (contains children)\r\n            const desig = await frappe.db.get_doc('Designation', desigName);\r\n\r\n            // 3) Read from Designation.skills[] and use the 'skill' column\r\n            const src = (desig && Array.isArray(desig.skills) ? desig.skills : []).filter(Boolean);\r\n            if (!src.length) {\r\n                frappe.msgprint(__('No skills found on the selected Designation.'));\r\n                return;\r\n            }\r\n\r\n            // 4) Detect the target child doctype & the column to write to\r\n            const grid = frm.fields_dict[TARGET_TABLE_FIELDNAME]?.grid;\r\n            if (!grid) {\r\n                frappe.msgprint(__('Target child table field \"{0}\" not found on this form.', [TARGET_TABLE_FIELDNAME]));\r\n                return;\r\n            }\r\n\r\n            const childDoctype = grid.doctype;\r\n            const childMeta = frappe.get_meta(childDoctype);\r\n\r\n            // Try common fieldnames in order; pick the first that exists on the child doctype\r\n            const candidateTargetFields = ['skill_name', 'skill', 'custom_skill', 'name1', 'title'];\r\n            const targetSkillField =\r\n                candidateTargetFields.find(f => childMeta.fields.some(ff => ff.fieldname === f)) ||\r\n                candidateTargetFields.find(f => childMeta.fields.some(ff => ff.fieldname?.toLowerCase() === f)) ||\r\n                null;\r\n\r\n            if (!targetSkillField) {\r\n                console.warn(\r\n                    'No obvious skill column found on',\r\n                    childDoctype,\r\n                    'fields:',\r\n                    childMeta.fields.map(f => f.fieldname)\r\n                );\r\n                frappe.msgprint(\r\n                    __('Could not find a skill column on child doctype {0}. Please add one (e.g. \"skill_name\").', [childDoctype])\r\n                );\r\n                return;\r\n            }\r\n\r\n            // Optional: detect a proficiency column if present\r\n            const candidateProfFields = ['custom_proficiency', 'proficiency', 'level'];\r\n            const targetProfField =\r\n                candidateProfFields.find(f => childMeta.fields.some(ff => ff.fieldname === f)) || null;\r\n\r\n            // 5) Replace or append (dedupe by lowercased skill text)\r\n            if (mode === 'replace') frm.clear_table(TARGET_TABLE_FIELDNAME);\r\n\r\n            const existing = new Set(\r\n                (frm.doc[TARGET_TABLE_FIELDNAME] || [])\r\n                    .map(r => (r[targetSkillField] || '').trim().toLowerCase())\r\n                    .filter(Boolean)\r\n            );\r\n\r\n            let added = 0;\r\n            for (const r of src) {\r\n                const skillText = (r.skill || r.skill_name || '').trim();\r\n                if (!skillText) continue;\r\n\r\n                const key = skillText.toLowerCase();\r\n                if (mode === 'append' && existing.has(key)) continue;\r\n\r\n                const row = frm.add_child(TARGET_TABLE_FIELDNAME);\r\n                row[targetSkillField] = skillText;\r\n\r\n                if (targetProfField) {\r\n                    row[targetProfField] =\r\n                        (r.custom_proficiency ?? r.proficiency ?? r.level ?? '') || '';\r\n                }\r\n\r\n                existing.add(key);\r\n                added++;\r\n            }\r\n\r\n            frm.refresh_field(TARGET_TABLE_FIELDNAME);\r\n            frappe.show_alert({\r\n                message: __(\"{0} skill(s) copied from Designation.\", [added]),\r\n                indicator: added ? 'green' : 'orange'\r\n            });\r\n\r\n            // Debug (optional): open devtools to verify once\r\n            console.log({\r\n                designation: desigName,\r\n                source_array_length: src.length,\r\n                child_doctype: childDoctype,\r\n                target_skill_field: targetSkillField,\r\n                target_proficiency_field: targetProfField,\r\n            });\r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n            frappe.msgprint({\r\n                title: __('Error'),\r\n                message: __('Could not copy skills from Designation. See console for details.'),\r\n                indicator: 'red'\r\n            });\r\n\r\n        } finally {\r\n            frm.toggle_enable('custom_pull_requirements_from_designation', true);\r\n            frm.__copying_skills = false;\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Travel Request",
  "enabled": 1,
  "modified": "2025-10-21 11:19:26.709073",
  "module": null,
  "name": "Per diem - Travel request calculation",
  "script": "frappe.ui.form.on('Travel Request', {\r\n    refresh: function(frm) {\r\n        // Calculate travel days from itinerary on refresh\r\n        calculate_travel_days_from_itinerary(frm);\r\n\r\n        // Auto-populate employee grade if empty\r\n        if (frm.doc.employee && !frm.doc.custom_employee_grade) {\r\n            populate_employee_grade(frm);\r\n        }\r\n\r\n        // Auto-create per diem costing if none exists (with delay to ensure travel days are calculated)\r\n        setTimeout(() => auto_create_per_diem_costing(frm), 200);\r\n\r\n        // Check and prevent self-approval\r\n        prevent_self_approval(frm);\r\n    },\r\n\r\n    employee: function(frm) {\r\n        if (frm.doc.employee) {\r\n            // Auto-populate employee grade if empty\r\n            if (!frm.doc.custom_employee_grade) {\r\n                populate_employee_grade(frm);\r\n            }\r\n\r\n            // Recalculate travel days first, then per diem items\r\n            calculate_travel_days_from_itinerary(frm);\r\n            schedule_per_diem_sync(frm);\r\n        }\r\n\r\n        // Re-check self-approval when employee changes\r\n        prevent_self_approval(frm);\r\n    },\r\n\r\n    workflow_state: function(frm) {\r\n        // Validate when workflow state changes (approval attempt)\r\n        validate_self_approval_attempt(frm);\r\n    },\r\n\r\n    validate: function(frm) {\r\n        // Final validation before save\r\n        return validate_self_approval_attempt(frm);\r\n    },\r\n\r\n    // Fire when a row is added to the costings child table\r\n    costings_add: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        if (row && row.expense_type === \"Per Diem\") {\r\n            calculate_per_diem_for_travel_request(frm, cdt, cdn);\r\n        }\r\n    }\r\n});\r\n\r\n// Child table events for Travel Itinerary\r\nfrappe.ui.form.on('Travel Itinerary', {\r\n    departure_date: function(frm) {\r\n        // Recalculate travel days when departure date changes\r\n        calculate_travel_days_from_itinerary(frm);\r\n        // Update expected per diem and costing after travel days change\r\n        schedule_per_diem_sync(frm);\r\n    },\r\n\r\n    itinerary_add: function(frm) {\r\n        // Recalculate when new itinerary row is added\r\n        setTimeout(() => {\r\n            calculate_travel_days_from_itinerary(frm);\r\n            schedule_per_diem_sync(frm);\r\n        }, 120);\r\n    },\r\n\r\n    itinerary_remove: function(frm) {\r\n        // Recalculate when itinerary row is removed\r\n        setTimeout(() => {\r\n            calculate_travel_days_from_itinerary(frm);\r\n            schedule_per_diem_sync(frm);\r\n        }, 120);\r\n    }\r\n});\r\n\r\n// Child table events for Travel Request Costing\r\nfrappe.ui.form.on('Travel Request Costing', {\r\n    expense_type: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n\r\n        if (row.expense_type !== \"Per Diem\") return;\r\n\r\n        if (!frm.doc.employee || !frm.doc.custom_number_of_days) {\r\n            frappe.msgprint(__(\"Select Employee and calculate Travel Days first\"));\r\n            frappe.model.set_value(cdt, cdn, 'expense_type', '');\r\n            return;\r\n        }\r\n\r\n        calculate_per_diem_for_travel_request(frm, cdt, cdn);\r\n    },\r\n});\r\n\r\n// ========== SELF-APPROVAL PREVENTION ==========\r\n\r\nfunction prevent_self_approval(frm) {\r\n    if (!frm.doc.employee) return;\r\n\r\n    // Get current user's employee ID\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Employee',\r\n            filters: {'user_id': frappe.session.user},\r\n            fieldname: 'name'\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.name) {\r\n                const current_user_employee = r.message.name;\r\n                const is_own_request = (current_user_employee === frm.doc.employee);\r\n\r\n                if (is_own_request) {\r\n                    // Hide or disable workflow action buttons for own request\r\n                    hide_approval_actions(frm);\r\n                    \r\n                    // Add visual indicator\r\n                    frm.set_df_property('employee', 'description', \r\n                        '<span style=\"color: orange;\">⚠ You cannot approve your own travel request</span>');\r\n                } else {\r\n                    // Clear the warning if not own request\r\n                    frm.set_df_property('employee', 'description', '');\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction validate_self_approval_attempt(frm) {\r\n    if (!frm.doc.employee) return true;\r\n\r\n    // Check if this is a status/workflow change that indicates approval\r\n    const approval_states = ['Approved', 'Approved by Manager', 'Approved by HR', 'Final Approval'];\r\n    const is_approval_change = approval_states.some(state => \r\n        frm.doc.workflow_state === state || frm.doc.status === state\r\n    );\r\n\r\n    if (!is_approval_change) return true;\r\n\r\n    // Synchronous check using cached data or block until we verify\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Employee',\r\n                filters: {'user_id': frappe.session.user},\r\n                fieldname: 'name'\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.name) {\r\n                    const current_user_employee = r.message.name;\r\n                    const is_own_request = (current_user_employee === frm.doc.employee);\r\n\r\n                    if (is_own_request) {\r\n                        frappe.msgprint({\r\n                            title: __('Self-Approval Not Allowed'),\r\n                            message: __('You cannot approve your own travel request. Please ask another authorized user to approve it.'),\r\n                            indicator: 'red'\r\n                        });\r\n                        \r\n                        frappe.validated = false;\r\n                        \r\n                        // Revert the workflow state if possible\r\n                        if (frm._original_workflow_state) {\r\n                            frm.set_value('workflow_state', frm._original_workflow_state);\r\n                        }\r\n                        \r\n                        resolve(false);\r\n                    } else {\r\n                        resolve(true);\r\n                    }\r\n                } else {\r\n                    // If we can't determine, allow (fail open for non-employee users)\r\n                    resolve(true);\r\n                }\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nfunction hide_approval_actions(frm) {\r\n    // Store original workflow state for potential reversion\r\n    if (!frm._original_workflow_state && frm.doc.workflow_state) {\r\n        frm._original_workflow_state = frm.doc.workflow_state;\r\n    }\r\n\r\n    // Hide workflow action buttons by removing them from the page\r\n    setTimeout(() => {\r\n        const workflow_buttons = document.querySelectorAll('.btn-workflow-action, button[data-action*=\"approve\"], button[data-action*=\"Approve\"]');\r\n        workflow_buttons.forEach(btn => {\r\n            const btn_text = (btn.innerText || '').toLowerCase();\r\n            if (btn_text.includes('approve') || btn_text.includes('accept')) {\r\n                btn.style.display = 'none';\r\n            }\r\n        });\r\n    }, 100);\r\n}\r\n\r\n// ========== EXISTING HELPER FUNCTIONS ==========\r\n\r\n// Helper function to calculate travel days from Travel Itinerary\r\nfunction calculate_travel_days_from_itinerary(frm) {\r\n    if (!frm.doc.itinerary || frm.doc.itinerary.length === 0) {\r\n        // Clear the number of days field if no itinerary\r\n        frm.set_value('custom_number_of_days', 0);\r\n        return;\r\n    }\r\n\r\n    // Get all departure dates from Travel Itinerary\r\n    const departure_dates = frm.doc.itinerary\r\n        .filter(row => row.departure_date)\r\n        .map(row => frappe.datetime.str_to_obj(row.departure_date))\r\n        .sort((a, b) => a - b);\r\n\r\n    if (departure_dates.length === 0) {\r\n        // Clear the number of days field if no valid departure dates\r\n        frm.set_value('custom_number_of_days', 0);\r\n        return;\r\n    }\r\n\r\n    // Calculate days between earliest and latest departure dates\r\n    const min_date = departure_dates[0];\r\n    const max_date = departure_dates[departure_dates.length - 1];\r\n    const diffTime = Math.abs(max_date - min_date);\r\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both dates\r\n\r\n    // Update the Number of Days field\r\n    frm.set_value('custom_number_of_days', diffDays);\r\n\r\n    // After days update, ensure expected per diem and costing are in sync\r\n    schedule_per_diem_sync(frm);\r\n}\r\n\r\n// Helper function to populate employee grade\r\nfunction populate_employee_grade(frm) {\r\n    if (!frm.doc.employee) return;\r\n\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Employee',\r\n            filters: {'name': frm.doc.employee},\r\n            fieldname: 'grade'\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.grade) {\r\n                frm.set_value('custom_employee_grade', r.message.grade);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Helper function to calculate expected per diem\r\nfunction calculate_expected_per_diem(frm) {\r\n    if (!frm.doc.employee || !frm.doc.custom_number_of_days) return;\r\n\r\n    frappe.call({\r\n        method: 'per_diem_calc',\r\n        args: {\r\n            employee: frm.doc.employee,\r\n            travel_days: frm.doc.custom_number_of_days\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && !r.message.error) {\r\n                // Set Expected Per Diem Value (total amount)\r\n                frm.set_value('custom_expected_per_diem_value', r.message.amount);\r\n\r\n                // Set Expected Per Diem (per diem rate link) - get the rate record by employee grade\r\n                if (frm.doc.custom_employee_grade) {\r\n                    get_per_diem_rate_record(frm, frm.doc.custom_employee_grade);\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Helper function to get and set the per diem rate record by employee grade\r\nfunction get_per_diem_rate_record(frm, employee_grade) {\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Per Diem Rates',\r\n            filters: {\r\n                'grade': employee_grade\r\n            },\r\n            fields: ['name', 'amount', 'grade'],\r\n            limit: 1\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                frm.set_value('custom_expected_per_diem_rate', r.message[0].name);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Helper function to calculate per diem for travel request\r\nfunction calculate_per_diem_for_travel_request(frm, cdt, cdn) {\r\n    if (!frm.doc.custom_number_of_days) {\r\n        frappe.msgprint(__(\"Please calculate travel days first\"));\r\n        return;\r\n    }\r\n\r\n    frappe.call({\r\n        method: 'per_diem_calc',\r\n        args: {\r\n            employee: frm.doc.employee,\r\n            travel_days: frm.doc.custom_number_of_days\r\n        },\r\n        callback: function(r) {\r\n            if (r.message?.error) {\r\n                frappe.msgprint(r.message.error);\r\n                frappe.model.set_value(cdt, cdn, 'total_amount', 0);\r\n                frappe.model.set_value(cdt, cdn, 'comments', '');\r\n            } else if (r.message) {\r\n                frappe.model.set_value(cdt, cdn, 'total_amount', r.message.amount);\r\n                const per_diem_comment = __(\"Per Diem: {0} days × {1}\", [\r\n                    r.message.days,\r\n                    format_currency(r.message.rate)\r\n                ]);\r\n                frappe.model.set_value(cdt, cdn, 'comments', per_diem_comment);\r\n                frm.refresh_field('costings');\r\n                const toast_text = __(\"{0} = {1}\", [per_diem_comment, format_currency(r.message.amount)]);\r\n                safe_show_per_diem_toast(frm, toast_text);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Recalculate all per diem items when travel days change\r\nfunction recalculate_per_diem_items(frm) {\r\n    if (frm.doc.costings) {\r\n        frm.doc.costings.forEach((item) => {\r\n            if (item.expense_type === \"Per Diem\") {\r\n                const cdn = item.name;\r\n                calculate_per_diem_for_travel_request(frm, 'Travel Request Costing', cdn);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n// Helper function to auto-create per diem costing\r\nfunction auto_create_per_diem_costing(frm) {\r\n    if (!frm.doc.employee || !frm.doc.custom_number_of_days) return;\r\n\r\n    // Check if per diem costing already exists\r\n    const has_per_diem = frm.doc.costings && frm.doc.costings.some(item => item.expense_type === \"Per Diem\");\r\n\r\n    if (!has_per_diem) {\r\n        // Add a new per diem costing row\r\n        const new_row = frappe.model.add_child(frm.doc, 'Travel Request Costing', 'costings');\r\n        new_row.expense_type = \"Per Diem\";\r\n\r\n        // Calculate the per diem amount for this row\r\n        frappe.call({\r\n            method: 'per_diem_calc',\r\n            args: {\r\n                employee: frm.doc.employee,\r\n                travel_days: frm.doc.custom_number_of_days\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && !r.message.error) {\r\n                    frappe.model.set_value('Travel Request Costing', new_row.name, 'total_amount', r.message.amount);\r\n                    const per_diem_comment = __(\"Per Diem: {0} days × {1}\", [\r\n                        r.message.days,\r\n                        format_currency(r.message.rate)\r\n                    ]);\r\n                    frappe.model.set_value('Travel Request Costing', new_row.name, 'comments', per_diem_comment);\r\n                    frm.refresh_field('costings');\r\n                    const toast_text = __(\"{0} = {1}\", [per_diem_comment, format_currency(r.message.amount)]);\r\n                    safe_show_per_diem_toast(frm, toast_text);\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n// Debounced sync to avoid duplicate recalculations/toasts\r\nfunction schedule_per_diem_sync(frm) {\r\n    if (!frm) return;\r\n    clearTimeout(frm.__pd_timer);\r\n    frm.__pd_timer = setTimeout(() => {\r\n        // Prevent re-entrancy\r\n        if (frm.__pd_sync_in_progress) return;\r\n        frm.__pd_sync_in_progress = true;\r\n        try {\r\n            calculate_expected_per_diem(frm);\r\n            auto_create_per_diem_costing(frm);\r\n            recalculate_per_diem_items(frm);\r\n        } finally {\r\n            frm.__pd_sync_in_progress = false;\r\n        }\r\n    }, 150);\r\n}\r\n\r\n// Deduplicate toasts within a short window\r\nfunction safe_show_per_diem_toast(frm, text) {\r\n    try {\r\n        const now = Date.now();\r\n        if (frm.__last_pd_toast && frm.__last_pd_toast.text === text && (now - frm.__last_pd_toast.ts) < 2000) {\r\n            return; // skip duplicate toast\r\n        }\r\n        frappe.show_alert({ message: text, indicator: 'green' }, 5);\r\n        frm.__last_pd_toast = { text, ts: now };\r\n    } catch (e) {\r\n        // noop\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-12-10 23:16:57.438758",
  "module": null,
  "name": "NRC",
  "script": "frappe.ui.form.on('Employee', {\r\n    setup(frm) {\r\n        // Add format hint to the field\r\n        frm.set_df_property('wcfcbzm_nrc_no', 'description', \r\n            'Format: XXXXXX/XX/X (e.g., 220237/65/1) - Last digit must be 1, 2, or 3');\r\n    },\r\n    \r\n    wcfcbzm_nrc_no(frm) {\r\n        // Real-time validation as user types\r\n        const nrc = (frm.doc.wcfcbzm_nrc_no || '').trim();\r\n        \r\n        if (!nrc) {\r\n            frm.set_df_property('wcfcbzm_nrc_no', 'description', \r\n                'Format: XXXXXX/XX/X (e.g., 220237/65/1) - Last digit must be 1, 2, or 3');\r\n            return;\r\n        }\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            // Check if it's the last digit that's wrong\r\n            const basicPattern = /^\\d{1,6}\\/\\d{2}\\/\\d{1}$/;\r\n            let errorMsg = '✗ Invalid format. Expected: XXXXXX/XX/X (e.g., 220237/65/1)';\r\n            \r\n            if (basicPattern.test(nrc)) {\r\n                errorMsg = '✗ Last digit must be 1, 2, or 3 only';\r\n            }\r\n            \r\n            frm.set_df_property('wcfcbzm_nrc_no', 'description', \r\n                `<span style=\"color: red;\">${errorMsg}</span>`);\r\n            \r\n            // Show immediate warning\r\n            frappe.show_alert({\r\n                message: __(errorMsg.replace('✗ ', '')),\r\n                indicator: 'red'\r\n            }, 3);\r\n        } else {\r\n            frm.set_df_property('wcfcbzm_nrc_no', 'description', \r\n                '<span style=\"color: green;\">✓ Valid NRC format</span>');\r\n        }\r\n    },\r\n    \r\n    validate(frm) {\r\n        // STRICT GUARD: Block saving if NRC format is invalid\r\n        const nrc = (frm.doc.wcfcbzm_nrc_no || '').trim();\r\n        \r\n        // Allow empty NRC (skip validation if field is empty)\r\n        if (!nrc) return;\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            // Set validation flag to false\r\n            frappe.validated = false;\r\n            \r\n            // Determine specific error message\r\n            const basicPattern = /^\\d{1,6}\\/\\d{2}\\/\\d{1}$/;\r\n            let errorDetail = 'NRC format is incorrect.';\r\n            \r\n            if (basicPattern.test(nrc)) {\r\n                errorDetail = 'The last digit of the NRC must be 1, 2, or 3 only.';\r\n            }\r\n            \r\n            // Show detailed error message\r\n            frappe.msgprint({\r\n                title: __('Invalid NRC Number'),\r\n                message: __(`${errorDetail}<br><br><b>Expected format:</b> XXXXXX/XX/X<br><b>Last digit:</b> Must be 1, 2, or 3<br><b>Example:</b> 220237/65/1<br><br><b>Your input:</b> {0}<br><br>Please correct the NRC number before saving.`, [nrc]),\r\n                indicator: 'red',\r\n                primary_action: {\r\n                    label: __('OK'),\r\n                    action: function() {\r\n                        // Focus back on the NRC field\r\n                        frm.scroll_to_field('wcfcbzm_nrc_no');\r\n                    }\r\n                }\r\n            });\r\n            \r\n            // Throw error to completely block the save\r\n            throw __('Invalid NRC format. Last digit must be 1, 2, or 3. Expected format: XXXXXX/XX/X (e.g., 220237/65/1)');\r\n        }\r\n    },\r\n    \r\n    before_save(frm) {\r\n        // Additional guard before save - double check validation\r\n        const nrc = (frm.doc.wcfcbzm_nrc_no || '').trim();\r\n        \r\n        if (!nrc) return;\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            frappe.validated = false;\r\n            frappe.throw(__('Cannot save: Invalid NRC format. Last digit must be 1, 2, or 3. Expected: XXXXXX/XX/X (e.g., 220237/65/1)'));\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-10-06 13:26:08.649992",
  "module": null,
  "name": "NHIMA",
  "script": "// Employee: NHIMA ID must be exactly 14 digits (e.g., 06272415110123)\n\nfrappe.ui.form.on('Employee', {\n  validate(frm) {\n    // normalize: remove non-digits, trim\n    const raw = (frm.doc.custom_nhima_member_id || '').trim();\n    const digits = raw.replace(/\\D/g, ''); // keep only 0-9\n    const nhima_pattern = /^\\d{14}$/;      // exactly 14 digits\n\n    if (digits && !nhima_pattern.test(digits)) {\n      frappe.throw(__('Invalid NHIMA ID format. Expected exactly 14 digits, e.g. 06272415110123.'));\n    }\n\n    // write back normalized value (digits only)\n    frm.doc.custom_nhima_member_id = digits;\n  }\n});\n\n// Optional: instant feedback while typing\nfrappe.ui.form.on('Employee', 'custom_nhima_member_id', function(frm) {\n  const raw = (frm.doc.custom_nhima_member_id || '').trim();\n  const digits = raw.replace(/\\D/g, '');\n  const nhima_pattern = /^\\d{14}$/;\n\n  if (digits && !nhima_pattern.test(digits)) {\n    frappe.msgprint(__('NHIMA ID should be 14 digits (e.g. 06272415110123). Non-digits are removed automatically.'));\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-10-05 18:15:40.448683",
  "module": null,
  "name": "TPIN",
  "script": "frappe.ui.form.on('Employee', {\n  validate(frm) {\n    // normalize: keep digits only (preserves leading zeros)\n    let val = (frm.doc.custom_tpin || '').replace(/\\D/g, '');\n    const tpin_pattern = /^\\d{10}$/;\n\n    if (val && !tpin_pattern.test(val)) {\n      frappe.throw(__('Invalid TPIN format. Must be exactly 10 digits.'));\n    }\n    // write normalized value back\n    frm.doc.custom_tpin = val;\n  },\n\n  // optional: instant feedback on change\n  custom_tpin(frm) {\n    const val = (frm.doc.custom_tpin || '').replace(/\\D/g, '');\n    if (val && val.length !== 10) {\n      frappe.msgprint(__('TPIN should be 10 digits (numbers only).'));\n    }\n    frm.doc.custom_tpin = val;\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 0,
  "modified": "2025-10-14 23:23:52.168369",
  "module": null,
  "name": "Passport date of isue",
  "script": "frappe.ui.form.on('Employee', {\n  // 1) Immediate feedback when the date is changed\n  date_of_issue(frm) {\n    enforce_date_of_issue_not_future(frm, { on_save: false });\n  },\n\n  // 2) Reliable guard right before save (fires consistently)\n  before_save(frm) {\n    enforce_date_of_issue_not_future(frm, { on_save: true });\n  }\n});\n\n// ---- helper ----\nfunction enforce_date_of_issue_not_future(frm, { on_save }) {\n  // If your field is a custom field, change to the exact fieldname (e.g. 'custom_date_of_issue')\n  const FIELD = 'date_of_issue';\n\n  const val = frm.doc[FIELD];\n  if (!val) return; // nothing to validate\n\n  const today = frappe.datetime.get_today();\n  const is_future = frappe.datetime.compare_date(val, today) > 0;\n\n  if (!is_future) return;\n\n  const msg = __('Date of Issue cannot be in the future.');\n\n  if (on_save) {\n    // Show a blocking dialog and cancel the save\n    frappe.msgprint({ title: __('Invalid Date'), message: msg, indicator: 'red' });\n    frappe.validated = false;\n  } else {\n    // Inline feedback while editing + reset the value (choose null or today)\n    frappe.show_alert({ message: msg, indicator: 'red' });\n    frm.set_value(FIELD, null); // or: today\n  }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-10-07 11:30:04.420384",
  "module": null,
  "name": "NAPSA",
  "script": "// Employee: Social Security Number must be exactly 9 digits (e.g., 123456789)\n\nfrappe.ui.form.on('Employee', {\n  validate(frm) {\n    // normalize: remove non-digits, trim spaces\n    const raw = (frm.doc.wcfcbzm_social_security_no || '').trim();\n    const digits = raw.replace(/\\D/g, ''); // keep only numeric\n    const ssn_pattern = /^\\d{9}$/;         // exactly 9 digits\n\n    if (digits && !ssn_pattern.test(digits)) {\n      frappe.throw(__('Invalid Social Security Number format. Expected exactly 9 digits, e.g. 123456789.'));\n    }\n\n    // write back normalized value (digits only)\n    frm.doc.wcfcbzm_social_security_no = digits;\n  }\n});\n\n// Optional: instant feedback while typing\nfrappe.ui.form.on('Employee', 'wcfcbzm_social_security_no', function(frm) {\n  const raw = (frm.doc.wcfcbzm_social_security_no || '').trim();\n  const digits = raw.replace(/\\D/g, '');\n  const ssn_pattern = /^\\d{9}$/;\n\n  if (digits && !ssn_pattern.test(digits)) {\n    frappe.msgprint(__('Social Security Number should be 9 digits (e.g. 123456789). Non-digits are removed automatically.'));\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-10-09 10:15:24.701014",
  "module": null,
  "name": "Autoset cost centre",
  "script": "frappe.ui.form.on('Payroll Entry', {\n    onload(frm) {\n        // Automatically set default cost center if empty\n        if (!frm.doc.cost_center) {\n            frm.set_value('cost_center', 'Main - WCFCB');\n        }\n    },\n    validate(frm) {\n        // Double-check before saving that cost_center is set\n        if (!frm.doc.cost_center) {\n            frm.set_value('cost_center', 'Main - WCFCB');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-10-10 20:31:41.352355",
  "module": null,
  "name": "Fetch asset book value",
  "script": "// Sales Invoice — Set rate from Asset Finance Book (client-only)\n// Uses frappe.client.get to fetch the parent Asset (incl. child rows)\n// and reads Finance Book = 'Fixed Asset' → value_after_depreciation.\n\nconst FINANCE_BOOK_NAME = 'Fixed Asset';  // adjust if named differently\nconst OVERRIDE_EXISTING_RATE = true;      // false → only set if rate is empty/zero\nconst AUTO_RUN_ON_REFRESH = true;         // run once when the form opens (Draft only)\n\nfrappe.ui.form.on('Sales Invoice', {\n  async refresh(frm) {\n    frm.add_custom_button(__('Fetch Asset Values'), async () => {\n      await apply_asset_values_from_child(frm, { show_dialog: true });\n    });\n\n    if (AUTO_RUN_ON_REFRESH && frm.doc.docstatus === 0 && !frm._asset_fb_once) {\n      frm._asset_fb_once = true;\n      await apply_asset_values_from_child(frm, { show_dialog: true });\n    }\n  },\n\n  // Optional: enforce before submit\n  async before_submit(frm) {\n    // Uncomment to force a final check:\n    // await apply_asset_values_from_child(frm, { show_dialog: false, enforce: true });\n  }\n});\n\nasync function apply_asset_values_from_child(frm, opts = {}) {\n  const show_dialog = opts.show_dialog ?? true;\n  const enforce = !!opts.enforce;\n\n  const rows = (frm.doc.items || []).filter(r => r.asset);\n  if (!rows.length) {\n    if (show_dialog) frappe.msgprint(__('No item rows with an Asset linked were found.'));\n    return;\n  }\n\n  const currency = frm.doc.currency || frappe.defaults.get_default('currency') || 'USD';\n  const summary = [];\n\n  for (const row of rows) {\n    let status = '';\n    let asset_label = '-';\n    let pp = null;\n    let bv = null;\n    let fb_used = null;\n\n    try {\n      // Read the parent Asset; this typically returns child rows as well.\n      const resp = await frappe.call({\n        method: 'frappe.client.get',\n        args: { doctype: 'Asset', name: row.asset },\n      });\n\n      const doc = resp.message;\n      if (!doc) {\n        status = 'Asset not found or no permission';\n      } else {\n        asset_label = doc.asset_name || row.asset;\n        pp = toNum(doc.gross_purchase_amount);\n\n        // Child table fieldname is usually \"finance_books\"\n        const children = (doc.finance_books || doc.asset_finance_books || []);\n        // Try exact (case-insensitive) match first, else fallback to first row\n        const wanted = children.find(\n          c => (c.finance_book || '').toLowerCase() === FINANCE_BOOK_NAME.toLowerCase()\n        ) || children[0];\n\n        if (!wanted) {\n          status = 'No Finance Book rows on Asset';\n        } else {\n          fb_used = wanted.finance_book || '-';\n          bv = toNum(wanted.value_after_depreciation);\n\n          if (bv == null) {\n            status = `No value_after_depreciation on '${fb_used}'`;\n          } else {\n            const current_rate = toNum(row.rate) || 0;\n            const should_set = OVERRIDE_EXISTING_RATE || current_rate === 0;\n\n            if (should_set) {\n              await frappe.model.set_value(row.doctype, row.name, 'rate', bv);\n              status = 'Rate Updated';\n            } else {\n              status = 'Rate left unchanged (override disabled)';\n            }\n          }\n        }\n      }\n\n    } catch (e) {\n      console.error('Asset read failed', row.asset, e);\n      status = 'Error fetching data';\n    }\n\n    // If enforcing at submit and we still have no rate, block\n    if (enforce && (bv == null)) {\n      frappe.throw(\n        __('Unable to fetch Book Value from Finance Book \"{0}\" for Asset {1}. Check permissions or data.',\n          [FINANCE_BOOK_NAME, row.asset]\n        )\n      );\n    }\n\n    summary.push({\n      idx: row.idx,\n      asset: row.asset,\n      asset_name: asset_label,\n      purchase_price: pp,\n      book_value: bv,\n      finance_book: fb_used,\n      status\n    });\n  }\n\n  frm.refresh_fields('items');\n  if (show_dialog) show_summary(frm, summary, currency);\n}\n\nfunction show_summary(frm, summary, currency) {\n  const rowsHtml = summary.map(s => `\n    <tr>\n      <td style=\"text-align:center\">${s.idx}</td>\n      <td>${frappe.utils.escape_html(s.asset_name || '-')}<br><small>${frappe.utils.escape_html(s.asset || '-')}</small></td>\n      <td style=\"text-align:right\">${s.purchase_price != null ? frappe.format(s.purchase_price, {fieldtype:'Currency'}, {currency}, frm.doc) : '-'}</td>\n      <td style=\"text-align:right\"><b>${s.book_value != null ? frappe.format(s.book_value, {fieldtype:'Currency'}, {currency}, frm.doc) : '-'}</b></td>\n      <td>${frappe.utils.escape_html(s.finance_book || '-')}</td>\n      <td style=\"text-align:center\">\n        ${s.status === 'Rate Updated'\n          ? '<span class=\"badge badge-success\">'+__('Rate Updated')+'</span>'\n          : '<span class=\"badge badge-warning\">'+__(s.status)+'</span>'}\n      </td>\n    </tr>\n  `).join('');\n\n  frappe.msgprint({\n    title: __('Asset Valuation Summary'),\n    message: `\n      <div style=\"overflow:auto; max-height:55vh;\">\n        <table class=\"table table-bordered\" style=\"margin:0\">\n          <thead>\n            <tr>\n              <th style=\"width:60px; text-align:center\">#</th>\n              <th>${__('Asset')}</th>\n              <th style=\"width:160px; text-align:right\">${__('Purchase Price')}</th>\n              <th style=\"width:190px; text-align:right\">${__('Book Value (used as Rate)')}</th>\n              <th style=\"width:180px;\">${__('Finance Book used')}</th>\n              <th style=\"width:160px; text-align:center\">${__('Status')}</th>\n            </tr>\n          </thead>\n          <tbody>${rowsHtml}</tbody>\n        </table>\n      </div>\n    `,\n    indicator: 'blue',\n    primary_action: { label: __('OK'), action: () => cur_dialog.hide() }\n  });\n}\n\nfunction toNum(v) {\n  if (v === null || v === undefined) return null;\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-10-16 22:56:03.632693",
  "module": null,
  "name": "Passport date of issue Validation",
  "script": "// Custom Script for Employee Doctype (Client-side)\r\n// Blocks save when Passport Issue Date is in the future\r\n\r\nfrappe.ui.form.on('Employee', {\r\n    onload: function(frm) {\r\n        setup_passport_validation(frm);\r\n    },\r\n    \r\n    refresh: function(frm) {\r\n        check_and_update_ui(frm);\r\n    },\r\n    \r\n    date_of_issue: function(frm) {\r\n        check_and_update_ui(frm);\r\n    },\r\n    \r\n    validate: function(frm) {\r\n        return validate_passport_date(frm);\r\n    }\r\n});\r\n\r\nfunction setup_passport_validation(frm) {\r\n    // Override the save function to add validation\r\n    if (!frm._passport_save_wrapped) {\r\n        const original_save = frm.save;\r\n        frm.save = function(save_action, callback, btn, on_error) {\r\n            if (!validate_passport_date(frm)) {\r\n                return Promise.reject();\r\n            }\r\n            return original_save.call(this, save_action, callback, btn, on_error);\r\n        };\r\n        frm._passport_save_wrapped = true;\r\n    }\r\n}\r\n\r\nfunction validate_passport_date(frm) {\r\n    const issue_date = frm.doc.date_of_issue;\r\n    \r\n    if (!issue_date) {\r\n        return true; // Allow save if no date is set\r\n    }\r\n    \r\n    if (is_future_date(issue_date)) {\r\n        frappe.msgprint({\r\n            title: __('Invalid Passport Issue Date'),\r\n            message: __('Passport Issue Date cannot be in the future. Please select today or a past date.'),\r\n            indicator: 'red'\r\n        });\r\n        \r\n        frappe.validated = false;\r\n        return false;\r\n    }\r\n    \r\n    return true;\r\n}\r\n\r\nfunction is_future_date(date_value) {\r\n    if (!date_value) return false;\r\n    \r\n    try {\r\n        // Convert to date object using Frappe's utility\r\n        const input_date = frappe.datetime.str_to_obj(date_value);\r\n        const today = frappe.datetime.str_to_obj(frappe.datetime.get_today());\r\n        \r\n        if (!input_date || !today) return false;\r\n        \r\n        // Compare dates (ignore time)\r\n        input_date.setHours(0, 0, 0, 0);\r\n        today.setHours(0, 0, 0, 0);\r\n        \r\n        return input_date > today;\r\n    } catch (e) {\r\n        console.error('Error checking passport date:', e);\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction check_and_update_ui(frm) {\r\n    const issue_date = frm.doc.date_of_issue;\r\n    \r\n    if (issue_date && is_future_date(issue_date)) {\r\n        // Disable save buttons\r\n        frm.disable_save();\r\n        \r\n        // Show indicator in the field\r\n        frm.set_df_property('date_of_issue', 'description', \r\n            '<span style=\"color: red;\">⚠ Date cannot be in the future</span>');\r\n    } else {\r\n        // Enable save buttons\r\n        frm.enable_save();\r\n        \r\n        // Clear the warning\r\n        frm.set_df_property('date_of_issue', 'description', '');\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-12-10 23:16:01.419104",
  "module": null,
  "name": "Applicant NRC",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n    setup(frm) {\r\n        // Add format hint to the field\r\n        frm.set_df_property('custom_nrc_no', 'description', \r\n            'Format: XXXXXX/XX/X (e.g., 220237/65/1) - Last digit must be 1, 2, or 3');\r\n    },\r\n    \r\n    custom_nrc_no(frm) {\r\n        // Real-time validation as user types\r\n        const nrc = (frm.doc.custom_nrc_no || '').trim();\r\n        \r\n        if (!nrc) {\r\n            frm.set_df_property('custom_nrc_no', 'description', \r\n                'Format: XXXXXX/XX/X (e.g., 220237/65/1) - Last digit must be 1, 2, or 3');\r\n            return;\r\n        }\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            // Check if it's the last digit that's wrong\r\n            const basicPattern = /^\\d{1,6}\\/\\d{2}\\/\\d{1}$/;\r\n            let errorMsg = '✗ Invalid format. Expected: XXXXXX/XX/X (e.g., 220237/65/1)';\r\n            \r\n            if (basicPattern.test(nrc)) {\r\n                errorMsg = '✗ Last digit must be 1, 2, or 3 only';\r\n            }\r\n            \r\n            frm.set_df_property('custom_nrc_no', 'description', \r\n                `<span style=\"color: red;\">${errorMsg}</span>`);\r\n            \r\n            // Show immediate warning\r\n            frappe.show_alert({\r\n                message: __(errorMsg.replace('✗ ', '')),\r\n                indicator: 'red'\r\n            }, 3);\r\n        } else {\r\n            frm.set_df_property('custom_nrc_no', 'description', \r\n                '<span style=\"color: green;\">✓ Valid NRC format</span>');\r\n        }\r\n    },\r\n    \r\n    validate(frm) {\r\n        // STRICT GUARD: Block saving if NRC format is invalid\r\n        const nrc = (frm.doc.custom_nrc_no || '').trim();\r\n        \r\n        // Allow empty NRC (skip validation if field is empty)\r\n        if (!nrc) return;\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            // Set validation flag to false\r\n            frappe.validated = false;\r\n            \r\n            // Determine specific error message\r\n            const basicPattern = /^\\d{1,6}\\/\\d{2}\\/\\d{1}$/;\r\n            let errorDetail = 'NRC format is incorrect.';\r\n            \r\n            if (basicPattern.test(nrc)) {\r\n                errorDetail = 'The last digit of the NRC must be 1, 2, or 3 only.';\r\n            }\r\n            \r\n            // Show detailed error message\r\n            frappe.msgprint({\r\n                title: __('Invalid NRC Number'),\r\n                message: __(`${errorDetail}<br><br><b>Expected format:</b> XXXXXX/XX/X<br><b>Last digit:</b> Must be 1, 2, or 3<br><b>Example:</b> 220237/65/1<br><br><b>Your input:</b> {0}<br><br>Please correct the NRC number before saving.`, [nrc]),\r\n                indicator: 'red',\r\n                primary_action: {\r\n                    label: __('OK'),\r\n                    action: function() {\r\n                        // Focus back on the NRC field\r\n                        frm.scroll_to_field('custom_nrc_no');\r\n                    }\r\n                }\r\n            });\r\n            \r\n            // Throw error to completely block the save\r\n            throw __('Invalid NRC format. Last digit must be 1, 2, or 3. Expected format: XXXXXX/XX/X (e.g., 220237/65/1)');\r\n        }\r\n    },\r\n    \r\n    before_save(frm) {\r\n        // Additional guard before save - double check validation\r\n        const nrc = (frm.doc.custom_nrc_no || '').trim();\r\n        \r\n        if (!nrc) return;\r\n        \r\n        // NRC pattern: 1–6 digits / 2 digits / 1 digit (must be 1, 2, or 3)\r\n        const pattern = /^\\d{1,6}\\/\\d{2}\\/[123]$/;\r\n        \r\n        if (!pattern.test(nrc)) {\r\n            frappe.validated = false;\r\n            frappe.throw(__('Cannot save: Invalid NRC format. Last digit must be 1, 2, or 3. Expected: XXXXXX/XX/X (e.g., 220237/65/1)'));\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset Movement",
  "enabled": 1,
  "modified": "2025-10-15 12:37:59.768174",
  "module": null,
  "name": "Duplicate",
  "script": "// Doctype: Asset Movement\n\nfrappe.ui.form.on('Asset Movement', {\n  validate: function (frm) {\n    // build a frequency map of assets on the child table\n    const freq = {};\n    const dups = [];\n\n    (frm.doc.assets || []).forEach(row => {\n      const a = (row.asset || '').trim();\n      if (!a) return;\n      freq[a] = (freq[a] || 0) + 1;\n    });\n\n    Object.keys(freq).forEach(a => {\n      if (freq[a] > 1) dups.push(a);\n    });\n\n    if (dups.length) {\n      frappe.throw(\n        __('Duplicate Asset(s) are not allowed in the Assets table. Found duplicates for: {0}', [dups.join(', ')])\n      );\n    }\n  },\n\n  on_submit: function (frm) {\n    // defensive: same check on submit\n    const assets = (frm.doc.assets || []).map(r => r.asset).filter(Boolean);\n    const hasDup = (new Set(assets)).size !== assets.length;\n    if (hasDup) {\n      frappe.throw(__('Cannot submit: duplicate Asset entries exist in the Assets table.'));\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset Movement",
  "enabled": 1,
  "modified": "2025-10-15 12:37:56.352469",
  "module": null,
  "name": "Instant feedback",
  "script": "// Child Table: Asset Movement Item\n\nfrappe.ui.form.on('Asset Movement Item', {\n  asset: function (frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    const val = (row.asset || '').trim();\n    if (!val) return;\n\n    const count = (frm.doc.assets || []).filter(r => (r.asset || '').trim() === val).length;\n    if (count > 1) {\n      frappe.msgprint(__('Asset {0} is already on another line. Removing the duplicate.', [val]));\n      row.asset = '';\n      frm.refresh_field('assets');\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-10-16 20:20:41.941379",
  "module": "ExN",
  "name": "ManualItemSync",
  "script": "// Item Webhook Client Script\r\n// To use: Create a new Client Script in ERPNext\r\n// DocType: Item\r\n// Script Type: Client Script\r\n\r\nfrappe.ui.form.on('Item', {\r\n    refresh: function(frm) {\r\n        // Add webhook button for saved items only\r\n        if (frm.doc.name && !frm.doc.__islocal) {\r\n            frm.add_custom_button(__('Sync to ZRA'), function() {\r\n                send_item_webhook(frm);\r\n            }, __('Actions'));\r\n        }\r\n    }\r\n});\r\n\r\nfunction send_item_webhook(frm) {\r\n    // Show confirmation dialog\r\n    frappe.confirm(\r\n        __('Sync item \"{0}\" to ZRA?', [frm.doc.name]),\r\n        function() {\r\n            // User confirmed - execute sync\r\n            execute_item_webhook(frm);\r\n        }\r\n    );\r\n}\r\n\r\nfunction execute_item_webhook(frm) {\r\n    // Show loading indicator\r\n    frappe.show_alert({\r\n        message: __('Syncing Item to ZRA'),\r\n        indicator: 'blue'\r\n    });\r\n\r\n    // Make server script call\r\n    frappe.call({\r\n        method: 'item_sync',\r\n        args: {\r\n            item_name: frm.doc.name\r\n        },\r\n        callback: function(response) {\r\n            handle_webhook_response(response);\r\n        },\r\n        error: function(error) {\r\n            handle_webhook_error(error);\r\n        }\r\n    });\r\n}\r\n\r\nfunction handle_webhook_response(response) {\r\n    if (response && response.message) {\r\n        const result = response.message;\r\n\r\n        // Check if server script succeeded AND webhook succeeded\r\n        const server_success = result.success;\r\n        const webhook_success = result.webhook_response && result.webhook_response.status === 'success';\r\n        const overall_success = server_success && webhook_success;\r\n\r\n        if (overall_success) {\r\n            // Complete success case\r\n            frappe.show_alert({\r\n                message: __('Item synced to ZRA'),\r\n                indicator: 'green'\r\n            });\r\n\r\n            // Show detailed success message\r\n            let details = __('Item synced to ZRA.');\r\n            if (result.data_size) {\r\n                details += '<br>' + __('Data size: {0} characters', [result.data_size]);\r\n            }\r\n            if (result.linked_fields) {\r\n                const field_count = Object.keys(result.linked_fields).length;\r\n                details += '<br>' + __('Linked fields processed: {0}', [field_count]);\r\n            }\r\n\r\n            frappe.msgprint({\r\n                title: __('ZRA Sync Success'),\r\n                message: details,\r\n                indicator: 'green'\r\n            });\r\n\r\n        } else {\r\n            // Error case - either server failed or webhook failed\r\n            frappe.show_alert({\r\n                message: __('ZRA sync failed'),\r\n                indicator: 'red'\r\n            });\r\n\r\n            let error_message = 'Unknown error occurred';\r\n            if (!server_success && result.message) {\r\n                error_message = result.message;\r\n            } else if (!webhook_success && result.webhook_response && result.webhook_response.error) {\r\n                error_message = 'Webhook error: ' + result.webhook_response.error;\r\n            }\r\n\r\n            frappe.msgprint({\r\n                title: __('ZRA Sync Error'),\r\n                message: __('Error: {0}', [error_message]),\r\n                indicator: 'red'\r\n            });\r\n        }\r\n    } else {\r\n        // Unexpected response\r\n        frappe.show_alert({\r\n            message: __('Unexpected server response'),\r\n            indicator: 'orange'\r\n        });\r\n    }\r\n}\r\n\r\nfunction handle_webhook_error(error) {\r\n    frappe.show_alert({\r\n        message: __('ZRA sync request failed'),\r\n        indicator: 'red'\r\n    });\r\n\r\n    frappe.msgprint({\r\n        title: __('Request Error'),\r\n        message: __('Failed to sync item to ZRA.<br>Please check your connection and try again.'),\r\n        indicator: 'red'\r\n    });\r\n\r\n    console.error('ZRA sync error:', error);\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-10-16 23:47:18.070533",
  "module": null,
  "name": "ZRAItemCodeGen",
  "script": "// Client Script for generating ZRA Item Code\r\n// DocType: Item\r\n// Type: Form\r\n\r\nfrappe.ui.form.on('Item', {\r\n    // Trigger when any of the source fields change\r\n    custom_product_type: function(frm) {\r\n        generate_zra_item_code(frm);\r\n    },\r\n    \r\n    custom_packaging_unit: function(frm) {\r\n        generate_zra_item_code(frm);\r\n    },\r\n    \r\n    custom_unit_of_measure: function(frm) {\r\n        generate_zra_item_code(frm);\r\n    },\r\n    \r\n    // Also trigger on form refresh for new items\r\n    refresh: function(frm) {\r\n        if (frm.is_new() && !frm.doc.custom_zra_item_code) {\r\n            generate_zra_item_code(frm);\r\n        }\r\n    }\r\n});\r\n\r\nfunction generate_zra_item_code(frm) {\r\n    // Get values from the fields\r\n    let product_type = frm.doc.custom_product_type || '';\r\n    let packaging_unit = frm.doc.custom_packaging_unit || '';\r\n    let unit_of_measure = frm.doc.custom_unit_of_measure || '';\r\n    \r\n    // Only proceed if all required fields have values\r\n    if (!product_type || !packaging_unit || !unit_of_measure) {\r\n        return;\r\n    }\r\n    \r\n    // Create the base code pattern\r\n    let base_code = \"ZM\" + product_type + packaging_unit + unit_of_measure;\r\n    \r\n    // Check for existing codes with this pattern and get next sequence\r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Item',\r\n            filters: {\r\n                'custom_zra_item_code': ['like', base_code + '%']\r\n            },\r\n            fields: ['custom_zra_item_code'],\r\n            limit_page_length: 0,\r\n            order_by: 'custom_zra_item_code desc'\r\n        },\r\n        callback: function(response) {\r\n            let next_sequence = 1;\r\n            \r\n            if (response.message && response.message.length > 0) {\r\n                // Find the highest sequence number\r\n                let highest_sequence = 0;\r\n                \r\n                response.message.forEach(function(item) {\r\n                    if (item.custom_zra_item_code) {\r\n                        // Extract sequence number from the end of the code\r\n                        let code = item.custom_zra_item_code;\r\n                        if (code.startsWith(base_code)) {\r\n                            let sequence_part = code.substring(base_code.length);\r\n                            let sequence_num = parseInt(sequence_part);\r\n                            if (!isNaN(sequence_num) && sequence_num > highest_sequence) {\r\n                                highest_sequence = sequence_num;\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n                \r\n                next_sequence = highest_sequence + 1;\r\n            }\r\n            \r\n            // Format sequence with leading zeros (e.g., 0000001, 0000002, etc.)\r\n            let formatted_sequence = String(next_sequence).padStart(7, '0');\r\n            \r\n            // Generate final ZRA item code\r\n            let zra_item_code = base_code + formatted_sequence;\r\n            \r\n            // Set the value in the custom field\r\n            frm.set_value('custom_zra_item_code', zra_item_code);\r\n            \r\n            // Show message to user\r\n            frappe.show_alert({\r\n                message: __('ZRA Item Code generated: {0}', [zra_item_code]),\r\n                indicator: 'green'\r\n            });\r\n        },\r\n        error: function(error) {\r\n            console.error('Error generating ZRA Item Code:', error);\r\n            frappe.msgprint({\r\n                title: __('Error'),\r\n                message: __('Failed to generate ZRA Item Code. Please try again.'),\r\n                indicator: 'red'\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// Optional: Add a button to manually regenerate the code\r\nfrappe.ui.form.on('Item', {\r\n    refresh: function(frm) {\r\n        // Add custom button to regenerate ZRA code\r\n        if (!frm.is_new()) {\r\n            frm.add_custom_button(__('Regenerate ZRA Code'), function() {\r\n                frappe.confirm(\r\n                    __('Are you sure you want to regenerate the ZRA Item Code? This will overwrite the existing code.'),\r\n                    function() {\r\n                        generate_zra_item_code(frm);\r\n                    }\r\n                );\r\n            }, __('ZRA'));\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Interview Feedback",
  "enabled": 1,
  "modified": "2025-11-10 02:51:22.840847",
  "module": null,
  "name": "Overall Interview Rating System",
  "script": "// Custom Script for Interview Feedback (Client-side)\r\n// Auto-calculates overall impression rating and syncs with average_rating\r\n\r\nfrappe.ui.form.on('Interview Feedback', {\r\n    refresh: function(frm) {\r\n        setup_rating_styles(frm);\r\n        add_rating_guide_button(frm);\r\n    },\r\n    \r\n    skill_assessment: function(frm) {\r\n        validate_rating_range(frm, 'skill_assessment');\r\n        show_rating_guidance(frm, 'skill_assessment');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_job_knowledge_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_job_knowledge_rating');\r\n        show_rating_guidance(frm, 'custom_job_knowledge_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_skills__competencies_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_skills__competencies_rating');\r\n        show_rating_guidance(frm, 'custom_skills__competencies_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_initiative__drive_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_initiative__drive_rating');\r\n        show_rating_guidance(frm, 'custom_initiative__drive_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_growth_potential_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_growth_potential_rating');\r\n        show_rating_guidance(frm, 'custom_growth_potential_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_personal_attributes_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_personal_attributes_rating');\r\n        show_rating_guidance(frm, 'custom_personal_attributes_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_computer_skills_rating: function(frm) {\r\n        validate_rating_range(frm, 'custom_computer_skills_rating');\r\n        show_rating_guidance(frm, 'custom_computer_skills_rating');\r\n        calculate_overall_rating(frm);\r\n    },\r\n    \r\n    custom_overall_impression_rating: function(frm) {\r\n        sync_average_rating(frm);\r\n    },\r\n    \r\n    validate: function(frm) {\r\n        return validate_all_ratings(frm);\r\n    }\r\n});\r\n\r\nfunction calculate_overall_rating(frm) {\r\n    // Get all rating values\r\n    const ratings = [\r\n        frm.doc.skill_assessment,\r\n        frm.doc.custom_job_knowledge_rating,\r\n        frm.doc.custom_skills__competencies_rating,\r\n        frm.doc.custom_initiative__drive_rating,\r\n        frm.doc.custom_growth_potential_rating,\r\n        frm.doc.custom_personal_attributes_rating,\r\n        frm.doc.custom_computer_skills_rating\r\n    ];\r\n    \r\n    // Filter out empty/null values\r\n    const valid_ratings = ratings.filter(r => r && !isNaN(r) && r >= 1 && r <= 5);\r\n    \r\n    if (valid_ratings.length === 0) {\r\n        frm.set_value('custom_overall_impression_rating', 0);\r\n        frm.set_value('average_rating', 0);\r\n        return;\r\n    }\r\n    \r\n    // Calculate precise average using proper mathematical principles\r\n    const sum = valid_ratings.reduce((acc, val) => acc + parseFloat(val), 0);\r\n    const average = sum / valid_ratings.length;\r\n    \r\n    // Round to 2 decimal places for precise ranking and comparison\r\n    // This follows mathematical standards and allows clear differentiation between candidates\r\n    const rounded_average = Math.round(average * 100) / 100;\r\n    \r\n    console.log('Calculated average:', average, 'Rounded:', rounded_average);\r\n    \r\n    // Set the overall impression rating with 2 decimal precision\r\n    // Use the rounded number directly (precision is controlled by field settings)\r\n    frm.set_value('custom_overall_impression_rating', rounded_average);\r\n    \r\n    // Sync to average_rating\r\n    sync_average_rating(frm);\r\n    \r\n    // Show overall performance summary\r\n    show_overall_summary(frm, rounded_average, valid_ratings.length);\r\n}\r\n\r\nfunction sync_average_rating(frm) {\r\n    // Sync overall impression rating to average_rating field\r\n    const overall = frm.doc.custom_overall_impression_rating;\r\n    \r\n    if (overall && !isNaN(overall)) {\r\n        frm.set_value('average_rating', overall);\r\n    }\r\n}\r\n\r\nfunction validate_rating_range(frm, fieldname) {\r\n    const value = frm.doc[fieldname];\r\n    \r\n    if (!value) return; // Allow empty values\r\n    \r\n    const num_value = parseFloat(value);\r\n    \r\n    // Check if value is outside 1-5 range\r\n    if (num_value < 1 || num_value > 5) {\r\n        frappe.msgprint({\r\n            title: __('Invalid Rating'),\r\n            message: __('Rating must be between 1 and 5. Please enter a valid rating.'),\r\n            indicator: 'red'\r\n        });\r\n        \r\n        // Reset to empty or previous valid value\r\n        frm.set_value(fieldname, '');\r\n        frm.refresh_field(fieldname);\r\n        return false;\r\n    }\r\n    \r\n    return true;\r\n}\r\n\r\nfunction validate_all_ratings(frm) {\r\n    const rating_fields = [\r\n        'skill_assessment',\r\n        'custom_job_knowledge_rating',\r\n        'custom_skills__competencies_rating',\r\n        'custom_initiative__drive_rating',\r\n        'custom_growth_potential_rating',\r\n        'custom_personal_attributes_rating',\r\n        'custom_computer_skills_rating'\r\n    ];\r\n    \r\n    let all_valid = true;\r\n    \r\n    rating_fields.forEach(field => {\r\n        const value = frm.doc[field];\r\n        \r\n        if (value) {\r\n            const num_value = parseFloat(value);\r\n            \r\n            if (num_value < 1 || num_value > 5) {\r\n                frappe.msgprint({\r\n                    title: __('Invalid Rating'),\r\n                    message: __(`${frappe.meta.get_label(frm.doctype, field)} must be between 1 and 5.`),\r\n                    indicator: 'red'\r\n                });\r\n                \r\n                all_valid = false;\r\n                frappe.validated = false;\r\n            }\r\n        }\r\n    });\r\n    \r\n    return all_valid;\r\n}\r\n\r\nfunction setup_rating_styles(frm) {\r\n    // Enhanced descriptions with rating scale guidance\r\n    const rating_guidance = `\r\n        <div style=\"background: #2c3e50; padding: 10px; border-radius: 5px; margin-top: 5px; color: #ecf0f1;\">\r\n            <strong style=\"color: #fff;\">Rating Scale Guide:</strong><br>\r\n            <span style=\"color: #e74c3c;\">★ 1 - Poor:</span> Below expectations, significant improvement needed<br>\r\n            <span style=\"color: #e67e22;\">★★ 2 - Fair:</span> Meets some expectations, needs development<br>\r\n            <span style=\"color: #f39c12;\">★★★ 3 - Good:</span> Meets expectations, satisfactory performance<br>\r\n            <span style=\"color: #2ecc71;\">★★★★ 4 - Very Good:</span> Exceeds expectations, strong performer<br>\r\n            <span style=\"color: #3498db;\">★★★★★ 5 - Excellent:</span> Far exceeds expectations, exceptional talent\r\n        </div>\r\n    `;\r\n    \r\n    const rating_fields = [\r\n        'skill_assessment',\r\n        'custom_job_knowledge_rating',\r\n        'custom_skills__competencies_rating',\r\n        'custom_initiative__drive_rating',\r\n        'custom_growth_potential_rating',\r\n        'custom_personal_attributes_rating',\r\n        'custom_computer_skills_rating'\r\n    ];\r\n    \r\n    rating_fields.forEach(field => {\r\n        frm.set_df_property(field, 'description', rating_guidance);\r\n    });\r\n    \r\n    // Make overall impression and average rating read-only\r\n    frm.set_df_property('custom_overall_impression_rating', 'read_only', 1);\r\n    frm.set_df_property('custom_overall_impression_rating', 'precision', 2);\r\n    frm.set_df_property('custom_overall_impression_rating', 'description', \r\n        '<strong style=\"color: #007bff;\">Auto-calculated average of all ratings above</strong>');\r\n    \r\n    frm.set_df_property('average_rating', 'read_only', 1);\r\n    frm.set_df_property('average_rating', 'precision', 2);\r\n    frm.set_df_property('average_rating', 'description', \r\n        '<strong style=\"color: #007bff;\">Overall impression rating (out of 5)</strong>');\r\n}\r\n\r\nfunction show_rating_guidance(frm, fieldname) {\r\n    const value = frm.doc[fieldname];\r\n    \r\n    if (!value || isNaN(value)) return;\r\n    \r\n    const num_value = parseFloat(value);\r\n    \r\n    if (num_value < 1 || num_value > 5) return;\r\n    \r\n    let performance_level = '';\r\n    let color = '';\r\n    let stars = '';\r\n    let description = '';\r\n    \r\n    if (num_value >= 4.5) {\r\n        performance_level = 'Excellent';\r\n        color = '#007bff';\r\n        stars = '★★★★★';\r\n        description = 'Far exceeds expectations - Exceptional talent';\r\n    } else if (num_value >= 3.5) {\r\n        performance_level = 'Very Good';\r\n        color = '#28a745';\r\n        stars = '★★★★';\r\n        description = 'Exceeds expectations - Strong performer';\r\n    } else if (num_value >= 2.5) {\r\n        performance_level = 'Good';\r\n        color = '#ffc107';\r\n        stars = '★★★';\r\n        description = 'Meets expectations - Satisfactory';\r\n    } else if (num_value >= 1.5) {\r\n        performance_level = 'Fair';\r\n        color = '#fd7e14';\r\n        stars = '★★';\r\n        description = 'Meets some expectations - Needs development';\r\n    } else {\r\n        performance_level = 'Poor';\r\n        color = '#dc3545';\r\n        stars = '★';\r\n        description = 'Below expectations - Significant improvement needed';\r\n    }\r\n    \r\n    // Show brief alert with the rating interpretation\r\n    frappe.show_alert({\r\n        message: `<strong style=\"color: ${color};\">${stars} ${performance_level}</strong>: ${description}`,\r\n        indicator: 'blue'\r\n    }, 4);\r\n}\r\n\r\nfunction show_overall_summary(frm, average, num_ratings) {\r\n    if (!average || average === 0) return;\r\n    \r\n    let performance_level = '';\r\n    let color = '';\r\n    let recommendation = '';\r\n    \r\n    if (average >= 4.5) {\r\n        performance_level = 'Outstanding Candidate';\r\n        color = '#007bff';\r\n        recommendation = 'Highly Recommended - Strong hire';\r\n    } else if (average >= 3.5) {\r\n        performance_level = 'Strong Candidate';\r\n        color = '#28a745';\r\n        recommendation = 'Recommended - Good fit for the role';\r\n    } else if (average >= 2.5) {\r\n        performance_level = 'Average Candidate';\r\n        color = '#ffc107';\r\n        recommendation = 'Moderate - Consider with reservations';\r\n    } else if (average >= 1.5) {\r\n        performance_level = 'Below Average Candidate';\r\n        color = '#fd7e14';\r\n        recommendation = 'Not Recommended - Significant concerns';\r\n    } else {\r\n        performance_level = 'Poor Candidate';\r\n        color = '#dc3545';\r\n        recommendation = 'Not Recommended - Does not meet requirements';\r\n    }\r\n    \r\n    // Update the overall impression description with summary\r\n    frm.set_df_property('custom_overall_impression_rating', 'description', \r\n        '<div style=\"background: ' + color + '15; padding: 10px; border-left: 4px solid ' + color + '; border-radius: 3px;\">' +\r\n            '<strong style=\"color: ' + color + ';\">' + performance_level + '</strong><br>' +\r\n            '<span style=\"color: #666;\">' + recommendation + '</span><br>' +\r\n            '<small style=\"color: #999;\">Precise Average: ' + average.toFixed(2) + ' / 5.00 (based on ' + num_ratings + ' ratings)</small>' +\r\n        '</div>');\r\n}\r\n\r\nfunction add_rating_guide_button(frm) {\r\n    // Add a button to show full rating guide\r\n    frm.add_custom_button(__('Rating Guide'), function() {\r\n        const guide_html = '<div style=\"font-family: Arial, sans-serif;\">' +\r\n            '<h4 style=\"color: #007bff; margin-top: 0;\">How to Rate Candidates</h4>' +\r\n            \r\n            '<div style=\"margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 5px;\">' +\r\n            '<strong style=\"color: #007bff;\">5 - Excellent</strong><br>' +\r\n            '<small>Far exceeds all expectations. Exceptional talent with outstanding skills and potential. Top 5% of candidates. Immediate hire recommendation.</small>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"margin: 15px 0; padding: 12px; background: #e8f5e9; border-radius: 5px;\">' +\r\n            '<strong style=\"color: #28a745;\">4 - Very Good</strong><br>' +\r\n            '<small>Clearly exceeds expectations. Strong performer with excellent skills. Top 20% of candidates. Highly recommended hire.</small>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"margin: 15px 0; padding: 12px; background: #fff8e1; border-radius: 5px;\">' +\r\n            '<strong style=\"color: #ffc107;\">3 - Good</strong><br>' +\r\n            '<small>Meets all expectations. Competent and capable. Average performer. Suitable for the role with standard expectations.</small>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"margin: 15px 0; padding: 12px; background: #fff3e0; border-radius: 5px;\">' +\r\n            '<strong style=\"color: #fd7e14;\">2 - Fair</strong><br>' +\r\n            '<small>Meets some expectations but has gaps. Needs additional training or development. Consider with caution or for junior roles only.</small>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"margin: 15px 0; padding: 12px; background: #ffebee; border-radius: 5px;\">' +\r\n            '<strong style=\"color: #dc3545;\">1 - Poor</strong><br>' +\r\n            '<small>Below expectations with significant concerns. Does not meet minimum requirements. Not recommended for this position.</small>' +\r\n            '</div>' +\r\n            \r\n            '<hr style=\"margin: 20px 0;\">' +\r\n            \r\n            '<h4 style=\"color: #495057;\">Overall Rating Interpretation:</h4>' +\r\n            '<ul style=\"color: #666; line-height: 1.8;\">' +\r\n            '<li><strong>4.5 - 5.0:</strong> Outstanding - Hire immediately</li>' +\r\n            '<li><strong>3.5 - 4.4:</strong> Strong - Highly recommended</li>' +\r\n            '<li><strong>2.5 - 3.4:</strong> Average - Consider carefully</li>' +\r\n            '<li><strong>1.5 - 2.4:</strong> Below Average - Not recommended</li>' +\r\n            '<li><strong>1.0 - 1.4:</strong> Poor - Reject</li>' +\r\n            '</ul>' +\r\n            \r\n            '<div style=\"margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;\">' +\r\n            '<small style=\"color: #666;\">' +\r\n            '<strong>Tip:</strong> Be objective and consistent. Compare candidates against job requirements, not against each other. Use the full scale - not all candidates should be rated 3 or above.' +\r\n            '</small>' +\r\n            '</div>' +\r\n            '</div>';\r\n        \r\n        frappe.msgprint({\r\n            title: __('Interview Rating Scale Guide'),\r\n            message: guide_html,\r\n            indicator: 'blue',\r\n            primary_action_label: __('Got it'),\r\n            primary_action: function() {\r\n                // Close the dialog\r\n            }\r\n        });\r\n    }, __('Help'));\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Loan",
  "enabled": 1,
  "modified": "2025-10-21 23:35:01.131787",
  "module": null,
  "name": "Check indebtedness",
  "script": "/**\n * Simple Client Script for Loan DocType - No Server Code Needed\n * Installation:\n * 1. Go to: Customization → Client Script → New\n * 2. Name: Loan Indebtedness Checker\n * 3. DocType: Loan\n * 4. Script Type: Form Script\n * 5. Paste this entire code and Save\n */\n\nfrappe.ui.form.on('Loan', {\n    refresh: function(frm) {\n        // Add \"Calculate Loan Impact\" button\n        if (frm.doc.applicant) {\n            frm.add_custom_button(__('Check Indebtedness'), function() {\n                check_indebtedness(frm);\n            }, __('Actions'));\n        }\n    },\n    \n    applicant: function(frm) {\n        frm.trigger('refresh');\n    }\n});\n\nfunction check_indebtedness(frm) {\n    if (!frm.doc.applicant) {\n        frappe.msgprint(__('Please select an employee first'));\n        return;\n    }\n    \n    if (!frm.doc.loan_amount || !frm.doc.repayment_periods || !frm.doc.rate_of_interest) {\n        frappe.msgprint(__('Please fill in Loan Amount, Repayment Period (in months), and Interest Rate'));\n        return;\n    }\n    \n    frappe.show_alert({\n        message: __('Calculating indebtedness...'),\n        indicator: 'blue'\n    });\n    \n    // Get employee details\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Employee',\n            name: frm.doc.applicant\n        },\n        callback: function(r) {\n            if (r.message) {\n                let employee = r.message;\n                // Get salary information\n                get_salary_info(frm, employee);\n            }\n        }\n    });\n}\n\nfunction get_salary_info(frm, employee) {\n    // Try to get latest salary slip\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Salary Slip',\n            filters: {\n                employee: employee.name,\n                docstatus: 1\n            },\n            fields: ['name', 'gross_pay', 'total_deduction', 'net_pay', 'end_date'],\n            order_by: 'end_date desc',\n            limit: 1\n        },\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                let salary_slip = r.message[0];\n                let salary_data = {\n                    gross_pay: salary_slip.gross_pay,\n                    total_deductions: salary_slip.total_deduction,\n                    net_pay: salary_slip.net_pay\n                };\n                get_existing_loans(frm, employee, salary_data);\n            } else {\n                // Fallback to Salary Structure Assignment\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Salary Structure Assignment',\n                        filters: {\n                            employee: employee.name,\n                            docstatus: 1\n                        },\n                        fields: ['base'],\n                        order_by: 'from_date desc',\n                        limit: 1\n                    },\n                    callback: function(r) {\n                        let salary_data;\n                        if (r.message && r.message.length > 0) {\n                            let base = r.message[0].base;\n                            let estimated_deductions = base * 0.2; // Estimate 20% deductions\n                            salary_data = {\n                                gross_pay: base,\n                                total_deductions: estimated_deductions,\n                                net_pay: base - estimated_deductions\n                            };\n                        } else {\n                            // No salary data found\n                            frappe.msgprint(__('No salary information found for this employee. Please create a salary slip or salary structure assignment.'));\n                            return;\n                        }\n                        get_existing_loans(frm, employee, salary_data);\n                    }\n                });\n            }\n        }\n    });\n}\n\nfunction get_existing_loans(frm, employee, salary_data) {\n    // Get all active loans for the employee - only get basic fields\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Loan',\n            filters: {\n                applicant: employee.name,\n                docstatus: 1,\n                status: ['in', ['Sanctioned', 'Partially Disbursed', 'Disbursed']]\n            },\n            fields: ['name', 'total_payment', 'monthly_repayment_amount', 'status'],\n            limit_page_length: 100\n        },\n        callback: function(r) {\n            if (r.message) {\n                // Now get full details for each loan\n                let loan_promises = [];\n                \n                r.message.forEach(loan => {\n                    // Skip the current loan if we're editing it\n                    if (loan.name !== frm.doc.name && loan.monthly_repayment_amount) {\n                        loan_promises.push(\n                            new Promise((resolve) => {\n                                frappe.call({\n                                    method: 'frappe.client.get',\n                                    args: {\n                                        doctype: 'Loan',\n                                        name: loan.name\n                                    },\n                                    callback: function(loan_r) {\n                                        if (loan_r.message) {\n                                            resolve({\n                                                loan_type: loan_r.message.loan_type || 'Loan',\n                                                outstanding_amount: loan_r.message.total_payment,\n                                                monthly_payment: loan_r.message.monthly_repayment_amount\n                                            });\n                                        } else {\n                                            resolve(null);\n                                        }\n                                    }\n                                });\n                            })\n                        );\n                    }\n                });\n                \n                // Wait for all loan details to be fetched\n                Promise.all(loan_promises).then(existing_loans => {\n                    existing_loans = existing_loans.filter(l => l !== null);\n                    let total_existing_monthly = 0;\n                    existing_loans.forEach(loan => {\n                        total_existing_monthly += loan.monthly_payment;\n                    });\n                    \n                    calculate_and_display_report(frm, employee, salary_data, existing_loans, total_existing_monthly);\n                });\n            } else {\n                // No existing loans\n                calculate_and_display_report(frm, employee, salary_data, [], 0);\n            }\n        },\n        error: function(r) {\n            console.log('Error fetching loans:', r);\n            // Continue without existing loans\n            calculate_and_display_report(frm, employee, salary_data, [], 0);\n        }\n    });\n}\n\nfunction calculate_and_display_report(frm, employee, salary_data, existing_loans, total_existing_monthly) {\n    // Get new loan details\n    let loan_amount = parseFloat(frm.doc.loan_amount);\n    let repayment_months = parseInt(frm.doc.repayment_periods);\n    let interest_rate = parseFloat(frm.doc.rate_of_interest) / 100; // Convert percentage to decimal\n    \n    // Calculate new loan details (Simple Interest)\n    let total_interest = (loan_amount * interest_rate * repayment_months) / 12;\n    let monthly_principal = loan_amount / repayment_months;\n    let monthly_interest = total_interest / repayment_months;\n    let monthly_payment = monthly_principal + monthly_interest;\n    \n    // Calculate existing indebtedness\n    let existing_indebtedness = (total_existing_monthly / salary_data.net_pay);\n    \n    // Calculate combined indebtedness\n    let total_monthly_payment = total_existing_monthly + monthly_payment;\n    let new_indebtedness_ratio = (total_monthly_payment / salary_data.net_pay);\n    let net_take_home_after_loans = salary_data.net_pay - total_monthly_payment;\n    let net_take_home_percentage = (net_take_home_after_loans / salary_data.net_pay) * 100;\n    \n    // Determine if advisable\n    let is_advisable = net_take_home_percentage >= 27;\n    let recommendation = is_advisable ? \n        'APPROVED - Within limits' : \n        'NOT RECOMMENDED - Exceeds 73% threshold';\n    let status_color = is_advisable ? '#28a745' : '#dc3545';\n    let status_bg = is_advisable ? '#d4edda' : '#f8d7da';\n    \n    // Build report HTML\n    let html = `\n        <div style=\"font-family: Arial, sans-serif; padding: 20px;\">\n            <h3 style=\"text-align: center; color: #333; border-bottom: 2px solid #333; padding-bottom: 10px;\">\n                WORKERS' COMPENSATION FUND CONTROL BOARD\n            </h3>\n            <h4 style=\"text-align: center; color: #333; margin-top: 20px;\">\n                PARTICULARS OF INDEBTEDNESS\n            </h4>\n            \n            <div style=\"margin-top: 20px;\">\n                <table style=\"width: 100%; border-collapse: collapse;\">\n                    <tr>\n                        <td style=\"padding: 8px 0; width: 25%;\"><strong>Name:</strong></td>\n                        <td style=\"padding: 8px 0; width: 25%;\">${employee.employee_name}</td>\n                        <td style=\"padding: 8px 0; width: 25%;\"><strong>Man No.:</strong></td>\n                        <td style=\"padding: 8px 0; width: 25%;\">${employee.name}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 8px 0;\"><strong>Gross Pay:</strong></td>\n                        <td style=\"padding: 8px 0;\">${format_currency(salary_data.gross_pay)}</td>\n                        <td style=\"padding: 8px 0;\"><strong>Net Pay:</strong></td>\n                        <td style=\"padding: 8px 0;\">${format_currency(salary_data.net_pay)}</td>\n                    </tr>\n                </table>\n            </div>\n            \n            <div style=\"margin-top: 30px;\">\n                <h4 style=\"color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;\">\n                    Indebtedness - Existing Loans\n                </h4>\n                ${generate_existing_loans_html(existing_loans, existing_indebtedness)}\n            </div>\n            \n            <div style=\"margin-top: 30px;\">\n                <h4 style=\"color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;\">\n                    Indebtedness - New Loan\n                </h4>\n                <table style=\"width: 100%; border-collapse: collapse; margin-top: 10px;\">\n                    <tr>\n                        <td style=\"padding: 5px 0; width: 50%;\"><strong>Loan Type:</strong></td>\n                        <td style=\"padding: 5px 0; width: 50%;\">${frm.doc.loan_type || 'N/A'}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Amount Applied for:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(loan_amount)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Recovery Period:</strong></td>\n                        <td style=\"padding: 5px 0;\">${repayment_months} Months</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Total interest rate:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_percentage(interest_rate)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Total interest:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(total_interest)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Monthly Instalment - Principal:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(monthly_principal)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Monthly Instalment - Interest:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(monthly_interest)}</td>\n                    </tr>\n                    <tr style=\"background-color: #f8f9fa;\">\n                        <td style=\"padding: 5px 0;\"><strong>Level of indebtedness:</strong></td>\n                        <td style=\"padding: 5px 0;\"><strong>${format_percentage(new_indebtedness_ratio)}</strong></td>\n                    </tr>\n                </table>\n            </div>\n            \n            <div style=\"margin-top: 30px; padding: 15px; background-color: ${status_bg}; border-left: 4px solid ${status_color}; border-radius: 5px;\">\n                <table style=\"width: 100%; border-collapse: collapse;\">\n                    <tr>\n                        <td style=\"padding: 5px 0; width: 50%;\"><strong>Total Monthly Payment (All Loans):</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(total_monthly_payment)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Net Take Home After Loans:</strong></td>\n                        <td style=\"padding: 5px 0;\">${format_currency(net_take_home_after_loans)}</td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding: 5px 0;\"><strong>Net Take Home Percentage:</strong></td>\n                        <td style=\"padding: 5px 0;\"><strong>${format_percentage(net_take_home_percentage / 100)}</strong></td>\n                    </tr>\n                </table>\n                <div style=\"margin-top: 15px; padding-top: 15px; border-top: 1px solid ${status_color};\">\n                    <strong style=\"color: ${status_color}; font-size: 16px;\">\n                        ${recommendation}\n                    </strong>\n                </div>\n            </div>\n            \n            <div style=\"margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 5px;\">\n                <strong>NOTE:</strong><br>\n                1. Total Net Take Home Pay should NOT fall below 27% of one's earnings.<br>\n                2. Calculations to include regular incomes/deductions ONLY.\n            </div>\n        </div>\n    `;\n    \n    // Show dialog\n    let dialog = new frappe.ui.Dialog({\n        title: __('Employee Indebtedness Report'),\n        size: 'large',\n        fields: [{\n            fieldtype: 'HTML',\n            fieldname: 'indebtedness_html',\n            options: html\n        }],\n        primary_action_label: __('Print'),\n        primary_action: function() {\n            print_report(html);\n        },\n        secondary_action_label: __('Close')\n    });\n    \n    dialog.show();\n}\n\nfunction generate_existing_loans_html(loans, indebtedness_ratio) {\n    if (!loans || loans.length === 0) {\n        return `\n            <p style=\"color: #666; font-style: italic; margin-top: 10px;\">No existing loans found.</p>\n            <div style=\"margin-top: 10px;\">\n                <strong>Current Indebtedness Ratio:</strong> ${format_percentage(0)}\n            </div>\n        `;\n    }\n    \n    let total_outstanding = 0;\n    let total_monthly = 0;\n    \n    let table = `\n        <table style=\"width: 100%; border-collapse: collapse; margin-top: 10px;\">\n            <thead>\n                <tr style=\"background-color: #f8f9fa;\">\n                    <th style=\"padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;\">Loan Type</th>\n                    <th style=\"padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;\">Outstanding</th>\n                    <th style=\"padding: 8px; text-align: right; border-bottom: 2px solid #dee2e6;\">Monthly Payment</th>\n                </tr>\n            </thead>\n            <tbody>\n    `;\n    \n    loans.forEach(loan => {\n        total_outstanding += loan.outstanding_amount;\n        total_monthly += loan.monthly_payment;\n        table += `\n            <tr>\n                <td style=\"padding: 8px; border-bottom: 1px solid #dee2e6;\">${loan.loan_type}</td>\n                <td style=\"padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;\">${format_currency(loan.outstanding_amount)}</td>\n                <td style=\"padding: 8px; text-align: right; border-bottom: 1px solid #dee2e6;\">${format_currency(loan.monthly_payment)}</td>\n            </tr>\n        `;\n    });\n    \n    table += `\n            </tbody>\n        </table>\n        <div style=\"margin-top: 10px;\">\n            <strong>Current Indebtedness Ratio:</strong> ${format_percentage(indebtedness_ratio)}\n        </div>\n    `;\n    \n    return table;\n}\n\nfunction format_currency(amount) {\n    return frappe.format(amount, {fieldtype: 'Currency'});\n}\n\nfunction format_percentage(value) {\n    return (value * 100).toFixed(2) + '%';\n}\n\nfunction print_report(html) {\n    let print_window = window.open('', '_blank');\n    print_window.document.write(`\n        <html>\n            <head>\n                <title>Indebtedness Report</title>\n                <style>\n                    body { font-family: Arial, sans-serif; margin: 20px; }\n                    @media print {\n                        body { margin: 0; }\n                    }\n                </style>\n            </head>\n            <body>\n                ${html}\n            </body>\n        </html>\n    `);\n    print_window.document.close();\n    print_window.print();\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Monthly Distribution",
  "enabled": 1,
  "modified": "2025-10-22 11:22:19.574529",
  "module": null,
  "name": "Calculate amounts and percentages",
  "script": "// ============================================\n// ERPNext Client Script - CORRECTED VERSION\n// DocType: Monthly Distribution\n// Script Type: Form\n// ============================================\n// Field names confirmed:\n// - Child table field: percentages\n// - Child DocType: Monthly Distribution Percentage\n// ============================================\n\nfrappe.ui.form.on('Monthly Distribution', {\n    refresh: function(frm) {\n        calculate_and_update(frm);\n    },\n    \n    custom_total_amount: function(frm) {\n        calculate_and_update(frm);\n    }\n});\n\nfrappe.ui.form.on('Monthly Distribution Percentage', {\n    activity_amount: function(frm, cdt, cdn) {\n        calculate_and_update(frm);\n    },\n    \n    percentages_remove: function(frm) {\n        calculate_and_update(frm);\n    },\n    \n    percentages_add: function(frm) {\n        calculate_and_update(frm);\n    }\n});\n\nfunction calculate_and_update(frm) {\n    let total_amount = 0.0;\n    \n    // Calculate total from child table (field name is 'percentages')\n    if (frm.doc.percentages) {\n        frm.doc.percentages.forEach(function(row) {\n            total_amount += flt(row.activity_amount);\n        });\n    }\n    \n    // Update total amount field\n    frm.set_value('custom_total_amount', total_amount);\n    \n    // Calculate and update percentages\n    if (total_amount > 0) {\n        frm.doc.percentages.forEach(function(row) {\n            let activity_amount = flt(row.activity_amount);\n            let percentage = (activity_amount / total_amount) * 100;\n            frappe.model.set_value(row.doctype, row.name, 'percentage_allocation', percentage);\n        });\n    } else {\n        // Set all percentages to 0 if total is 0\n        frm.doc.percentages.forEach(function(row) {\n            frappe.model.set_value(row.doctype, row.name, 'percentage_allocation', 0);\n        });\n    }\n    \n    frm.refresh_field('percentages');\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-10-22 11:42:49.796266",
  "module": null,
  "name": "Pull from monthly Distribution",
  "script": "// ============================================\n// ERPNext Client Script - Budget (WORKING VERSION)\n// DocType: Budget\n// Script Type: Form\n// ============================================\n// Confirmed field names:\n// - Child table: accounts\n// - Monthly Distribution field: custom_monthly_distribution\n// - Budget Amount field: budget_amount\n// - Total amount in Monthly Distribution: custom_total_amount\n// ============================================\n\nfrappe.ui.form.on('Budget Account', {\n    custom_monthly_distribution: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        \n        if (row.custom_monthly_distribution) {\n            // Fetch the Monthly Distribution document\n            frappe.db.get_doc('Monthly Distribution', row.custom_monthly_distribution)\n                .then(doc => {\n                    if (doc && doc.custom_total_amount) {\n                        // Set the budget amount to the total amount from Monthly Distribution\n                        frappe.model.set_value(cdt, cdn, 'budget_amount', doc.custom_total_amount);\n                        frappe.show_alert({\n                            message: __('Budget Amount updated to {0}', [format_currency(doc.custom_total_amount)]),\n                            indicator: 'green'\n                        }, 3);\n                    } else {\n                        frappe.show_alert({\n                            message: __('No total amount found in Monthly Distribution'),\n                            indicator: 'orange'\n                        }, 3);\n                    }\n                })\n                .catch(err => {\n                    console.error('Error fetching Monthly Distribution:', err);\n                    frappe.show_alert({\n                        message: __('Could not fetch Monthly Distribution'),\n                        indicator: 'red'\n                    }, 3);\n                });\n        }\n    }\n});\n\n// Add button to refresh all amounts from their Monthly Distributions\nfrappe.ui.form.on('Budget', {\n    refresh: function(frm) {\n        if (!frm.is_new()) {\n            frm.add_custom_button(__('Update All Amounts from Distributions'), function() {\n                update_all_amounts_from_distributions(frm);\n            });\n        }\n    }\n});\n\nfunction update_all_amounts_from_distributions(frm) {\n    // Child table is named 'accounts'\n    if (!frm.doc.accounts || frm.doc.accounts.length === 0) {\n        frappe.msgprint(__('No budget accounts to update'));\n        return;\n    }\n    \n    let updated_count = 0;\n    let rows_with_distribution = 0;\n    \n    // Count rows that have a monthly distribution\n    frm.doc.accounts.forEach(function(row) {\n        if (row.custom_monthly_distribution) {\n            rows_with_distribution++;\n        }\n    });\n    \n    if (rows_with_distribution === 0) {\n        frappe.msgprint(__('No rows have Monthly Distributions assigned'));\n        return;\n    }\n    \n    frappe.show_alert({\n        message: __('Updating {0} amounts from Monthly Distributions...', [rows_with_distribution]),\n        indicator: 'blue'\n    }, 3);\n    \n    frm.doc.accounts.forEach(function(row) {\n        if (row.custom_monthly_distribution) {\n            frappe.db.get_doc('Monthly Distribution', row.custom_monthly_distribution)\n                .then(doc => {\n                    if (doc && doc.custom_total_amount) {\n                        frappe.model.set_value(row.doctype, row.name, 'budget_amount', doc.custom_total_amount);\n                        updated_count++;\n                        \n                        // Show completion message when all done\n                        if (updated_count === rows_with_distribution) {\n                            frappe.show_alert({\n                                message: __('Updated {0} budget amounts successfully!', [updated_count]),\n                                indicator: 'green'\n                            }, 5);\n                            frm.refresh_field('accounts');\n                        }\n                    }\n                })\n                .catch(err => {\n                    console.error('Error fetching Monthly Distribution:', err);\n                    frappe.show_alert({\n                        message: __('Error updating row: {0}', [err.message]),\n                        indicator: 'red'\n                    }, 5);\n                });\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Training Event",
  "enabled": 0,
  "modified": "2025-11-12 16:44:50.229243",
  "module": null,
  "name": "Update number of hours",
  "script": "frappe.ui.form.on('Training Event', {\n    refresh: function(frm) {\n        calculate_training_hours(frm);\n    },\n    \n    start_time: function(frm) {\n        calculate_training_hours(frm);\n    },\n    \n    end_time: function(frm) {\n        calculate_training_hours(frm);\n    }\n});\n\nfrappe.ui.form.on('Training Event Employee', {\n    employees_add: function(frm) {\n        calculate_training_hours(frm);\n    },\n    \n    employees_remove: function(frm) {\n        calculate_training_hours(frm);\n    }\n});\n\nfunction calculate_training_hours(frm) {\n    // Check if we have all required fields\n    if (!frm.doc.start_time || !frm.doc.end_time) {\n        return;\n    }\n    \n    // Get the number of employees\n    let employee_count = frm.doc.employees ? frm.doc.employees.length : 0;\n    \n    // Calculate the difference in days between start_time and end_time\n    let start = frappe.datetime.str_to_obj(frm.doc.start_time);\n    let end = frappe.datetime.str_to_obj(frm.doc.end_time);\n    \n    // Calculate difference in milliseconds\n    let diff_ms = end - start;\n    \n    // Convert to days and round up\n    let days = Math.ceil(diff_ms / (1000 * 60 * 60 * 24));\n    \n    // Handle negative or zero duration\n    if (days < 0) {\n        frappe.msgprint(__('End time must be after start time'));\n        return;\n    }\n    \n    // If same day, count as 1 day\n    if (days === 0) {\n        days = 1;\n    }\n    \n    // Calculate total training hours\n    let training_hours = employee_count * days;\n    \n    // Set the value in the custom_training_hours field\n    frm.set_value('custom_training_hours', training_hours);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 0,
  "modified": "2025-11-03 21:06:37.098182",
  "module": null,
  "name": "Calculate Costs",
  "script": "// Client Script for Project DocType - With Preview & Multi-Year Support\n// FINAL VERSION - Hardened & Corrected\n// Script Type: Form\n// Enable: Yes\n\nfrappe.ui.form.on('Project', {\n  refresh(frm) {\n    // Show create button only when the doc exists and has an estimated cost\n    if (!frm.is_new() && frm.doc.estimated_costing) {\n      frm.add_custom_button('Create Budget from Milestones', async function () {\n\n        // ---------- Helpers ----------\n        const toNumber = (v) => {\n          if (typeof v === 'number') return v;\n          if (v === null || v === undefined || v === '') return 0;\n          const n = parseFloat(String(v).replace(/,/g, ''));\n          return isNaN(n) ? 0 : n;\n        };\n\n        const fmt = (v) => {\n          try {\n            return typeof format_currency === 'function'\n              ? format_currency(v)\n              : new Intl.NumberFormat().format(v);\n          } catch {\n            return String(v);\n          }\n        };\n\n        const getMonthName = (dateStr) => {\n          const date = frappe.datetime.str_to_obj(dateStr);\n          // JS Date.getMonth() -> 0..11; Frappe expects 1..12\n          return frappe.datetime.get_month_name(date.getMonth() + 1);\n        };\n\n        const getFiscalYear = async (dateStr) => {\n          const result = await frappe.call({\n            method: 'erpnext.accounts.utils.get_fiscal_year',\n            args: { date: dateStr, company: frm.doc.company }\n          });\n          // erpnext returns [fy_name, fy_start, fy_end]\n          return result.message ? result.message[0] : null;\n        };\n\n        // Normalize percentages so they always sum exactly to 100 (fix rounding drift)\n        const normalizePercentages = (rows) => {\n          const rounded = rows.map(r => ({\n            ...r,\n            percentage: Math.round(r.percentage * 100) / 100\n          }));\n          const sum = rounded.reduce((s, r) => s + r.percentage, 0);\n          const drift = Math.round((100 - sum) * 100) / 100;\n          if (Math.abs(drift) > 0 && rounded.length) {\n            // Add drift to the largest month so totals = 100\n            let idx = 0; let max = -Infinity;\n            rounded.forEach((r, i) => { if (r.percentage > max) { max = r.percentage; idx = i; } });\n            rounded[idx].percentage = Math.round((rounded[idx].percentage + drift) * 100) / 100;\n          }\n          return rounded;\n        };\n\n        // Promise-based preview dialog with proper closing\n        const showPreviewDialog = (html) => new Promise((resolve) => {\n          const d = frappe.msgprint({\n            title: __('Review Budget Distribution'),\n            message: html,\n            wide: true,\n            primary_action: {\n              label: __('Create Budget(s)'),\n              action: () => { try { d.hide(); } catch {} resolve(true); }\n            },\n            secondary_action: {\n              label: __('Cancel'),\n              action: () => { try { d.hide(); } catch {} resolve(false); }\n            }\n          });\n        });\n\n        try {\n          // ---------- 1) Validate Project Type ----------\n          if (!frm.doc.project_type) {\n            throw __('Please set the Project Type before creating a budget.');\n          }\n\n          const budget_type_mapping = {\n            'CAPEX Property': 'Property CAPEX',\n            'OPEX Lands and Building': 'Property Expenses'\n          };\n\n          // Specific account mapping (WCFCB - adjust as needed)\n          const account_mapping = {\n            'CAPEX Property': '230060 - Investments Property - AUC - WCFCB',\n            'OPEX Lands and Building': '230040 - Lands and Buildings - CAPEX AUC - WCFCB'\n          };\n\n          const budget_type = budget_type_mapping[frm.doc.project_type];\n          const account_name = account_mapping[frm.doc.project_type];\n\n          if (!budget_type || !account_name) {\n            throw __('Project Type must be either \"CAPEX Property\" or \"OPEX Lands and Building\" for budget creation.');\n          }\n\n          // ---------- 2) Resolve Company ----------\n          const company = frm.doc.company || frappe.defaults.get_user_default('company');\n          if (!company) {\n            throw __('Please set the Company on this Project.');\n          }\n\n          // ---------- 3) Fetch Tasks ----------\n          frappe.show_alert({ message: __('Analyzing project tasks...'), indicator: 'blue' }, 3);\n\n          const { message: taskList } = await frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n              doctype: 'Task',\n              filters: { project: frm.doc.name },\n              fields: ['name', 'subject', 'exp_end_date', 'is_milestone', 'custom_estimated_cost'],\n              limit_page_length: 0\n            }\n          });\n\n          if (!Array.isArray(taskList) || taskList.length === 0) {\n            throw __('No tasks found for this project. Please add tasks before creating a budget.');\n          }\n\n          // ---------- 4) Select Milestones (fallback to all) ----------\n          let milestone_tasks = taskList.filter(t => cint(t.is_milestone) === 1);\n          if (milestone_tasks.length === 0) {\n            frappe.msgprint({\n              title: __('No Milestone Tasks'),\n              indicator: 'orange',\n              message: __('No milestone tasks found. Using all tasks for distribution.')\n            });\n            milestone_tasks = taskList;\n          }\n\n          const tasks_with_dates = milestone_tasks.filter(t => t.exp_end_date);\n          if (tasks_with_dates.length === 0) {\n            throw __('No tasks have end dates set. Please set end dates on milestone tasks.');\n          }\n\n          // ---------- 5) Group by Fiscal Year and Month ----------\n          frappe.show_alert({ message: __('Grouping tasks by fiscal year...'), indicator: 'blue' }, 3);\n\n          const tasks_with_fy = [];\n          for (const task of tasks_with_dates) {\n            const fy = await getFiscalYear(task.exp_end_date);\n            if (fy) {\n              tasks_with_fy.push({\n                ...task,\n                fiscal_year: fy,\n                month_name: getMonthName(task.exp_end_date),\n                task_value: toNumber(task.custom_estimated_cost) || 0\n              });\n            }\n          }\n\n          if (tasks_with_fy.length === 0) {\n            throw __('Could not determine fiscal year for tasks. Please check your fiscal year setup.');\n          }\n\n          // Partition by FY\n          const by_fiscal_year = {};\n          tasks_with_fy.forEach(task => {\n            by_fiscal_year[task.fiscal_year] = by_fiscal_year[task.fiscal_year] || [];\n            by_fiscal_year[task.fiscal_year].push(task);\n          });\n\n          const fiscal_years = Object.keys(by_fiscal_year);\n\n          // ---------- 6) Per-FY Distributions ----------\n          const fy_summaries = [];\n          const month_order = [\n            'January', 'February', 'March', 'April', 'May', 'June',\n            'July', 'August', 'September', 'October', 'November', 'December'\n          ];\n\n          for (const fy of fiscal_years) {\n            const fy_tasks = by_fiscal_year[fy];\n\n            // If a task has no explicit value, spread the project estimated_costing evenly across tasks IN THIS FY (fix)\n            const explicit_sum = fy_tasks.reduce((s, t) => s + (t.task_value || 0), 0);\n            const missing_count = fy_tasks.filter(t => !t.task_value).length;\n            const fallback_each = missing_count > 0\n              ? (toNumber(frm.doc.estimated_costing) - explicit_sum) / Math.max(missing_count, 1)\n              : 0;\n\n            // Guard: if fallback_each goes negative (all tasks have values exceeding project estimate), clamp to 0\n            const safe_fallback = isFinite(fallback_each) && fallback_each > 0 ? fallback_each : 0;\n\n            // Compute total_in_fy using per-FY counts (fix)\n            const fy_values = fy_tasks.map(t => t.task_value || safe_fallback);\n            const total_in_fy = fy_values.reduce((s, v) => s + v, 0);\n\n            // Group by month\n            const by_month = {};\n            fy_tasks.forEach((t, idx) => {\n              const task_val = t.task_value || safe_fallback;\n              by_month[t.month_name] = by_month[t.month_name] || { amount: 0, tasks: [] };\n              by_month[t.month_name].amount += task_val;\n              by_month[t.month_name].tasks.push({\n                name: t.name,\n                subject: t.subject,\n                end_date: t.exp_end_date,\n                value: task_val\n              });\n            });\n\n            // Build distribution (percentages of FY total)\n            let distribution = [];\n            month_order.forEach(month => {\n              if (by_month[month]) {\n                const pct = total_in_fy > 0 ? (by_month[month].amount / total_in_fy) * 100 : 0;\n                distribution.push({\n                  month: month,\n                  amount: by_month[month].amount,\n                  percentage: pct,\n                  tasks: by_month[month].tasks\n                });\n              }\n            });\n\n            distribution = normalizePercentages(distribution);\n\n            fy_summaries.push({\n              fiscal_year: fy,\n              total_amount: total_in_fy,\n              task_count: fy_tasks.length,\n              distribution\n            });\n          }\n\n          // ---------- 6.5) UPDATE custom_costs_from_tasks ----------\n          // <<< ADDED: write the grand total from all FYs back to the Project\n          const grand_total_from_tasks = fy_summaries.reduce((s, fy) => s + (fy.total_amount || 0), 0);\n          try {\n            if (frm.doc.custom_costs_from_tasks !== grand_total_from_tasks) {\n              await frm.set_value('custom_costs_from_tasks', grand_total_from_tasks);\n              // optional save here to persist immediately; comment out if you prefer to save later\n              await frm.save();\n            }\n          } catch (e) {\n            // Do not block the flow if the custom field is missing; show a gentle hint\n            console.warn('custom_costs_from_tasks not updated:', e);\n            frappe.show_alert({\n              message: __('Note: Could not write to \"custom_costs_from_tasks\". Please ensure the field exists on Project (Currency).'),\n              indicator: 'orange'\n            }, 7);\n          }\n          // <<< ADDED END\n\n          // ---------- 7) Preview ----------\n          const preview_html = buildPreviewHTML(fy_summaries, frm.doc.name, budget_type, account_name, fmt);\n          const proceed = await showPreviewDialog(preview_html);\n          if (!proceed) {\n            frappe.show_alert(__('Budget creation cancelled'), 'info');\n            return;\n          }\n\n          // ---------- 8) Create Monthly Distributions & Budgets ----------\n          frappe.show_alert({ message: __('Creating budgets...'), indicator: 'blue' }, 5);\n\n          const created_budgets = [];\n\n          for (const fy_summary of fy_summaries) {\n            try {\n              const distribution_id = `${frm.doc.name} - ${fy_summary.fiscal_year} - ${frappe.datetime.now_date()}`;\n\n              const percentages = fy_summary.distribution.map(d => ({\n                month: d.month,\n                percentage_allocation: d.percentage\n              }));\n\n              const monthly_dist = await frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                  doc: {\n                    doctype: 'Monthly Distribution',\n                    distribution_id,\n                    fiscal_year: fy_summary.fiscal_year,\n                    percentages\n                  }\n                }\n              });\n\n              const distribution_name = monthly_dist.message.name;\n\n              const budget_doc = await frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                  doc: {\n                    doctype: 'Budget',\n                    budget_type,\n                    budget_against: 'Project',\n                    project: frm.doc.name,\n                    fiscal_year: fy_summary.fiscal_year,\n                    company,\n                    monthly_distribution: distribution_name,\n                    applicable_on_material_request: 0,\n                    applicable_on_purchase_order: 1,\n                    applicable_on_booking_actual_expenses: 1,\n                    action_if_annual_budget_exceeded: 'Stop',\n                    action_if_accumulated_monthly_budget_exceeded: 'Warn',\n                    accounts: [\n                      { account: account_name, budget_amount: fy_summary.total_amount }\n                    ]\n                  }\n                },\n                freeze: true,\n                freeze_message: __('Creating Budget for {0}...', [fy_summary.fiscal_year])\n              });\n\n              created_budgets.push({\n                name: budget_doc.message.name,\n                fiscal_year: fy_summary.fiscal_year,\n                amount: fy_summary.total_amount\n              });\n\n            } catch (fy_error) {\n              frappe.msgprint({\n                title: __('Error for {0}', [fy_summary.fiscal_year]),\n                indicator: 'red',\n                message: fy_error?.message || fy_error\n              });\n            }\n          }\n\n          // ---------- 9) Link first budget to Project ----------\n          if (created_budgets.length > 0) {\n            frm.set_value('custom_linked_budget', created_budgets[0].name);\n            await frm.save();\n\n            let success_msg = __('Successfully created {0} budget(s):', [created_budgets.length]) + '<br><br>';\n            created_budgets.forEach(b => {\n              success_msg += `<b>${frappe.utils.escape_html(b.name)}</b> - ${frappe.utils.escape_html(b.fiscal_year)} - ${fmt(b.amount)}<br>`;\n            });\n\n            frappe.msgprint({ title: __('Budgets Created'), indicator: 'green', message: success_msg });\n            frappe.set_route('Form', 'Budget', created_budgets[0].name);\n\n            // <<< ADDED: ensure the totals field remains in sync after creation as well\n            try {\n              if (frm.doc.custom_costs_from_tasks !== grand_total_from_tasks) {\n                await frm.set_value('custom_costs_from_tasks', grand_total_from_tasks);\n                await frm.save();\n              }\n            } catch (e2) {\n              console.warn('custom_costs_from_tasks post-create not updated:', e2);\n            }\n            // <<< ADDED END\n\n          } else {\n            throw __('No budgets were created successfully.');\n          }\n\n        } catch (err) {\n          frappe.msgprint({\n            title: __('Could not create Budget'),\n            indicator: 'red',\n            message: err?.message || err\n          });\n        }\n      }, __('Create'));\n    }\n\n    // Inline status\n    if (frm.doc.custom_linked_budget) {\n      frm.dashboard.add_indicator(__('Budget: {0}', [frm.doc.custom_linked_budget]), 'green');\n    }\n  },\n\n  estimated_costing: function (frm) {\n    if (frm.doc.estimated_costing && !frm.doc.custom_linked_budget) {\n      frappe.show_alert({\n        message: __('Estimated costing set. You can now create a budget from milestones.'),\n        indicator: 'blue'\n      }, 5);\n    }\n  },\n\n  project_type: function (frm) {\n    const valid_types = ['CAPEX Property', 'OPEX Lands and Building'];\n    if (frm.doc.project_type && frm.doc.estimated_costing && !valid_types.includes(frm.doc.project_type)) {\n      frappe.msgprint({\n        title: __('Project Type Note'),\n        indicator: 'blue',\n        message: __('For budget creation, Project Type should be \"CAPEX Property\" or \"OPEX Lands and Building\".')\n      });\n    }\n  }\n});\n\n// ---------- Preview Builder ----------\nfunction buildPreviewHTML(fy_summaries, project_name, budget_type, account_name, fmt) {\n  let html = `\n    <div style=\"padding: 10px;\">\n      <h4>Budget Distribution Preview</h4>\n      <table class=\"table table-bordered\" style=\"margin-bottom: 20px;\">\n        <tr><th>Project</th><td><b>${frappe.utils.escape_html(project_name)}</b></td></tr>\n        <tr><th>Budget Type</th><td><b>${frappe.utils.escape_html(budget_type)}</b></td></tr>\n        <tr><th>Account</th><td><b>${frappe.utils.escape_html(account_name)}</b></td></tr>\n        <tr><th>Fiscal Years</th><td><b>${fy_summaries.length}</b> ${fy_summaries.length > 1 ? '(Multiple budgets will be created)' : ''}</td></tr>\n      </table>\n  `;\n\n  fy_summaries.forEach((fy) => {\n    html += `\n      <div style=\"margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;\">\n        <h5 style=\"color: #2490ef;\">Fiscal Year: ${frappe.utils.escape_html(fy.fiscal_year)}</h5>\n        <p><b>Total Amount:</b> ${fmt(fy.total_amount)} | <b>Tasks:</b> ${fy.task_count}</p>\n        <h6>Monthly Distribution:</h6>\n        <table class=\"table table-bordered table-sm\">\n          <thead>\n            <tr>\n              <th>Month</th>\n              <th style=\"text-align: right;\">Amount</th>\n              <th style=\"text-align: right;\">Percentage</th>\n              <th>Tasks</th>\n            </tr>\n          </thead>\n          <tbody>\n    `;\n    fy.distribution.forEach(dist => {\n      html += `\n        <tr>\n          <td><b>${frappe.utils.escape_html(dist.month)}</b></td>\n          <td style=\"text-align: right;\">${fmt(dist.amount)}</td>\n          <td style=\"text-align: right;\">${Math.round(dist.percentage * 100) / 100}%</td>\n          <td style=\"font-size: 0.9em;\">\n      `;\n      dist.tasks.forEach(task => {\n        html += `\n          <div style=\"margin-bottom: 3px;\">\n            • ${frappe.utils.escape_html(task.subject)} (${frappe.datetime.str_to_user(task.end_date)}) - ${fmt(task.value)}\n          </div>\n        `;\n      });\n      html += `</td></tr>`;\n    });\n    html += `</tbody></table></div>`;\n  });\n\n  html += `\n      <div style=\"margin-top: 20px; padding: 10px; background: #f0f4f7; border-radius: 5px;\">\n        <p style=\"margin: 0;\"><b>Note:</b> This will create ${fy_summaries.length} budget(s) - one for each fiscal year.\n        Click <b>\"Create Budget(s)\"</b> to proceed or <b>\"Cancel\"</b> to abort.</p>\n      </div>\n    </div>\n  `;\n  return html;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-10-26 23:40:16.779384",
  "module": null,
  "name": "Multiplication units for CAPEX",
  "script": "// ============================================\n// ERPNext Client Script - Budget (MANUAL CALCULATION)\n// DocType: Budget\n// Script Type: Form\n// ============================================\n// This script calculates Budget Amount as:\n// custom_expected_price × custom_number_of_units\n// ============================================\n\nfrappe.ui.form.on('Budget Account', {\n    custom_expected_price: function(frm, cdt, cdn) {\n        calculate_budget_amount(cdt, cdn);\n    },\n    \n    custom_number_of_units: function(frm, cdt, cdn) {\n        calculate_budget_amount(cdt, cdn);\n    }\n});\n\nfunction calculate_budget_amount(cdt, cdn) {\n    let row = locals[cdt][cdn];\n    \n    let expected_price = flt(row.custom_expected_price) || 0;\n    let number_of_units = flt(row.custom_number_of_units) || 0;\n    \n    // Calculate: expected_price × number_of_units\n    let budget_amount = expected_price * number_of_units;\n    \n    // Update the budget_amount field\n    frappe.model.set_value(cdt, cdn, 'budget_amount', budget_amount);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-10-27 20:58:11.680113",
  "module": null,
  "name": "Dashboard for Budget List",
  "script": "// List View Customization for Budget DocType\n// Adds approval workflow, summary cards, and quick actions to standard ERPNext Budget\n\nfrappe.listview_settings['Budget'] = {\n    // Add status indicators with colors\n    get_indicator: function(doc) {\n        const status_colors = {\n            'Draft': 'orange',\n            'Submitted': 'blue',\n            'Cancelled': 'red',\n            'Approved': 'green',\n            'Rejected': 'red',\n            'Pending Approval': 'yellow'\n        };\n        \n        // Check if budget has approval status (custom field)\n        if (doc.approval_status) {\n            return [__(doc.approval_status), status_colors[doc.approval_status] || 'gray', \n                    'approval_status,=,' + doc.approval_status];\n        }\n        \n        // Use docstatus instead of status field\n        let status_text = 'Draft';\n        if (doc.docstatus === 1) {\n            status_text = 'Submitted';\n        } else if (doc.docstatus === 2) {\n            status_text = 'Cancelled';\n        }\n        \n        return [__(status_text), status_colors[status_text] || 'gray', 'docstatus,=,' + doc.docstatus];\n    },\n    \n    // Add custom buttons and actions\n    onload: function(listview) {\n        // Add \"Bulk Approve\" button\n        listview.page.add_action_item(__('Bulk Approve Selected'), function() {\n            bulk_approve_budgets(listview);\n        });\n        \n        // Add \"Bulk Submit\" button\n        listview.page.add_action_item(__('Bulk Submit Selected'), function() {\n            bulk_submit_budgets(listview);\n        });\n        \n        // Add \"Export to Excel\" button\n        listview.page.add_action_item(__('Export Selected to Excel'), function() {\n            export_budgets_to_excel(listview);\n        });\n        \n        // Add \"Add Metabase Links\" button\n        listview.page.add_action_item(__('Add Metabase Links'), function() {\n            add_metabase_links(listview);\n        });\n        \n        // Add quick filter buttons\n        listview.page.add_inner_button(__('Current Year Budgets'), function() {\n            filter_current_year(listview);\n        });\n        \n        listview.page.add_inner_button(__('Next Year Budgets'), function() {\n            filter_next_year(listview);\n        });\n        \n        listview.page.add_inner_button(__('Pending Approval'), function() {\n            filter_pending_approval(listview);\n        });\n        \n        // Add summary cards at the top\n        add_budget_summary_cards(listview);\n    },\n    \n    // Format specific fields\n    formatters: {\n        fiscal_year: function(value) {\n            return `<strong style=\"font-size: 13px; color: #2C3E50;\">${value}</strong>`;\n        },\n        \n        docstatus: function(value, df, doc) {\n            const status_map = {\n                0: 'Draft',\n                1: 'Submitted',\n                2: 'Cancelled'\n            };\n            \n            const colors = {\n                'Draft': '#F39C12',\n                'Submitted': '#3498DB',\n                'Cancelled': '#E74C3C'\n            };\n            \n            const status_text = status_map[value] || 'Draft';\n            const color = colors[status_text] || '#95A5A6';\n            return `<span style=\"color: ${color}; font-weight: 600;\">${status_text}</span>`;\n        }\n    },\n    \n    // Refresh callback\n    refresh: function(listview) {\n        // Refresh summary cards when list updates\n        add_budget_summary_cards(listview);\n    },\n    \n    // Hide name column if desired\n    hide_name_column: false,\n    \n    // Custom row button - shows workflow action\n    button: {\n        show: function(doc) {\n            // Show button if document is not cancelled and has a workflow\n            return doc.docstatus !== 2;\n        },\n        get_label: function(doc) {\n            // Get the next workflow action label\n            if (doc.workflow_state) {\n                return __('Approve'); // Will be dynamic based on workflow\n            }\n            return __('Quick Action');\n        },\n        get_description: function(doc) {\n            return __('Apply workflow action');\n        },\n        action: function(doc) {\n            show_workflow_actions(doc.name);\n        }\n    }\n};\n\n// Function: Add summary cards at the top of the list\nfunction add_budget_summary_cards(listview) {\n    // Get currently applied filters from the list view\n    const current_filters = listview.get_filters_for_args();\n    \n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'Budget',\n            fields: ['name', 'fiscal_year', 'docstatus', 'workflow_state', 'budget_against', 'cost_center', 'project'],\n            filters: current_filters,  // Apply current filters\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (r.message) {\n                const budgets = r.message;\n                \n                // Calculate statistics based on filtered data\n                const total = budgets.length;\n                const draft = budgets.filter(b => b.docstatus === 0).length;\n                const submitted = budgets.filter(b => b.docstatus === 1).length;\n                const cancelled = budgets.filter(b => b.docstatus === 2).length;\n                const cost_centers = budgets.filter(b => b.budget_against === 'Cost Center').length;\n                const projects = budgets.filter(b => b.budget_against === 'Project').length;\n                \n                // Get current year budgets from filtered data\n                const current_year = new Date().getFullYear().toString();\n                const current_year_budgets = budgets.filter(b => \n                    b.fiscal_year && b.fiscal_year.includes(current_year)\n                ).length;\n                \n                // Calculate percentages\n                const draft_pct = total > 0 ? Math.round((draft/total)*100) : 0;\n                const submitted_pct = total > 0 ? Math.round((submitted/total)*100) : 0;\n                const current_year_pct = total > 0 ? Math.round((current_year_budgets/total)*100) : 0;\n                \n                // Create summary HTML\n                const summary_html = `\n                    <div class=\"budget-summary-cards\" style=\"display: flex; gap: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n                        <div class=\"summary-card\" style=\"flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            <div style=\"font-size: 11px; color: #8D99AE; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;\">Total Budgets</div>\n                            <div style=\"font-size: 32px; font-weight: bold; color: #2C3E50;\">${total}</div>\n                            <div style=\"font-size: 11px; color: #95A5A6; margin-top: 4px;\">Filtered results</div>\n                        </div>\n                        <div class=\"summary-card\" style=\"flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            <div style=\"font-size: 11px; color: #8D99AE; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;\">Draft</div>\n                            <div style=\"font-size: 32px; font-weight: bold; color: #F39C12;\">${draft}</div>\n                            <div style=\"font-size: 11px; color: #95A5A6; margin-top: 4px;\">${draft_pct}% pending</div>\n                        </div>\n                        <div class=\"summary-card\" style=\"flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            <div style=\"font-size: 11px; color: #8D99AE; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;\">Submitted</div>\n                            <div style=\"font-size: 32px; font-weight: bold; color: #3498DB;\">${submitted}</div>\n                            <div style=\"font-size: 11px; color: #95A5A6; margin-top: 4px;\">${submitted_pct}% approved</div>\n                        </div>\n                        <div class=\"summary-card\" style=\"flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            <div style=\"font-size: 11px; color: #8D99AE; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;\">Current Year</div>\n                            <div style=\"font-size: 32px; font-weight: bold; color: #27AE60;\">${current_year_budgets}</div>\n                            <div style=\"font-size: 11px; color: #95A5A6; margin-top: 4px;\">${current_year_pct}% of filtered</div>\n                        </div>\n                        <div class=\"summary-card\" style=\"flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                            <div style=\"font-size: 11px; color: #8D99AE; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;\">Budget Types</div>\n                            <div style=\"display: flex; gap: 10px; margin-top: 8px;\">\n                                <div>\n                                    <div style=\"font-size: 20px; font-weight: bold; color: #9B59B6;\">${cost_centers}</div>\n                                    <div style=\"font-size: 10px; color: #95A5A6;\">Cost Centers</div>\n                                </div>\n                                <div>\n                                    <div style=\"font-size: 20px; font-weight: bold; color: #E67E22;\">${projects}</div>\n                                    <div style=\"font-size: 10px; color: #95A5A6;\">Projects</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n                \n                // Remove existing summary\n                $('.budget-summary-cards').remove();\n                \n                // Add summary at the top of the list\n                $(summary_html).insertBefore(listview.$page.find('.frappe-list'));\n            }\n        }\n    });\n}\n\n// Function: Bulk approve selected budgets (workflow-aware)\nfunction bulk_approve_budgets(listview) {\n    const selected = listview.get_checked_items();\n    \n    if (selected.length === 0) {\n        frappe.msgprint(__('Please select at least one budget'));\n        return;\n    }\n    \n    // First, check if budgets have workflows\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Budget',\n            name: selected[0].name\n        },\n        callback: function(r) {\n            if (r.message && r.message.workflow_state) {\n                // Has workflow - get available actions\n                frappe.call({\n                    method: 'frappe.model.workflow.get_transitions',\n                    args: {\n                        doc: r.message  // Pass the full document object\n                    },\n                    callback: function(transitions_response) {\n                        if (transitions_response.message && transitions_response.message.length > 0) {\n                            const transitions = transitions_response.message;\n                            \n                            // If multiple actions available, let user choose\n                            if (transitions.length > 1) {\n                                const action_options = transitions.map(t => t.action).join('\\n');\n                                \n                                frappe.prompt([\n                                    {\n                                        fieldname: 'action',\n                                        fieldtype: 'Select',\n                                        label: 'Workflow Action to Apply',\n                                        options: action_options,\n                                        reqd: 1,\n                                        default: transitions[0].action\n                                    }\n                                ], function(values) {\n                                    bulk_apply_workflow(selected, values.action);\n                                }, __('Select Action for All Budgets'), __('Apply'));\n                            } else {\n                                // Only one action, confirm and use it\n                                frappe.confirm(\n                                    __('Apply \"{0}\" to {1} budget(s)?', [transitions[0].action, selected.length]),\n                                    function() {\n                                        bulk_apply_workflow(selected, transitions[0].action);\n                                    }\n                                );\n                            }\n                        }\n                    }\n                });\n            } else {\n                // No workflow, use regular submit\n                bulk_submit_budgets_no_workflow(selected);\n            }\n        }\n    });\n}\n\n// Function: Bulk apply workflow action to multiple budgets\nfunction bulk_apply_workflow(selected, action) {\n    let completed = 0;\n    let failed = 0;\n    \n    frappe.show_alert({\n        message: __('Applying workflow action...'),\n        indicator: 'blue'\n    });\n    \n    selected.forEach(function(item) {\n        // First get the document\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'Budget',\n                name: item.name\n            },\n            callback: function(r) {\n                if (r.message) {\n                    // Now apply workflow with the doc object\n                    frappe.call({\n                        method: 'frappe.model.workflow.apply_workflow',\n                        args: {\n                            doc: r.message,  // Pass the full document object\n                            action: action\n                        },\n                        callback: function(workflow_response) {\n                            completed++;\n                            \n                            if (workflow_response.exc) {\n                                failed++;\n                            }\n                            \n                            if (completed === selected.length) {\n                                if (failed === 0) {\n                                    frappe.show_alert({\n                                        message: __('Workflow action applied to all {0} budget(s)', [selected.length]),\n                                        indicator: 'green'\n                                    });\n                                } else {\n                                    frappe.show_alert({\n                                        message: __('Applied: {0}, Failed: {1}', [selected.length - failed, failed]),\n                                        indicator: 'orange'\n                                    });\n                                }\n                                cur_list.refresh();\n                            }\n                        }\n                    });\n                } else {\n                    completed++;\n                    failed++;\n                    \n                    if (completed === selected.length) {\n                        frappe.show_alert({\n                            message: __('Applied: {0}, Failed: {1}', [selected.length - failed, failed]),\n                            indicator: 'orange'\n                        });\n                        cur_list.refresh();\n                    }\n                }\n            }\n        });\n    });\n}\n\n// Function: Bulk submit without workflow (fallback)\nfunction bulk_submit_budgets_no_workflow(selected) {\n    \n    // Check if they're all draft\n    const non_draft = selected.filter(item => item.docstatus !== 0);\n    if (non_draft.length > 0) {\n        frappe.msgprint(__('Some selected budgets are already submitted or cancelled'));\n        return;\n    }\n    \n    frappe.confirm(\n        __('Are you sure you want to submit {0} budget(s)?', [selected.length]),\n        function() {\n            let completed = 0;\n            let failed = 0;\n            \n            frappe.show_alert({\n                message: __('Submitting budgets...'),\n                indicator: 'blue'\n            });\n            \n            selected.forEach(function(item) {\n                frappe.call({\n                    method: 'frappe.client.submit',\n                    args: {\n                        doc: {\n                            doctype: 'Budget',\n                            name: item.name\n                        }\n                    },\n                    callback: function(r) {\n                        completed++;\n                        \n                        if (!r.exc) {\n                            // Success\n                        } else {\n                            failed++;\n                        }\n                        \n                        if (completed === selected.length) {\n                            if (failed === 0) {\n                                frappe.show_alert({\n                                    message: __('All {0} budget(s) submitted successfully', [selected.length]),\n                                    indicator: 'green'\n                                });\n                            } else {\n                                frappe.show_alert({\n                                    message: __('Submitted: {0}, Failed: {1}', [selected.length - failed, failed]),\n                                    indicator: 'orange'\n                                });\n                            }\n                            cur_list.refresh();\n                        }\n                    }\n                });\n            });\n        }\n    );\n}\n\n// Function: Bulk submit selected budgets\nfunction bulk_submit_budgets(listview) {\n    bulk_approve_budgets(listview); // Same as bulk approve for now\n}\n\n// Function: Show workflow actions for a budget\nfunction show_workflow_actions(budget_name) {\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Budget',\n            name: budget_name\n        },\n        callback: function(r) {\n            if (r.message) {\n                const doc = r.message;\n                \n                // Check if document has a workflow\n                if (!doc.workflow_state) {\n                    // No workflow, use regular submit\n                    quick_submit_budget(budget_name);\n                    return;\n                }\n                \n                // Get workflow transitions - pass the doc object\n                frappe.call({\n                    method: 'frappe.model.workflow.get_transitions',\n                    args: {\n                        doc: doc  // Pass the full document object\n                    },\n                    callback: function(transitions_response) {\n                        if (transitions_response.message && transitions_response.message.length > 0) {\n                            const transitions = transitions_response.message;\n                            \n                            // If only one action, apply it directly\n                            if (transitions.length === 1) {\n                                const action = transitions[0].action;\n                                frappe.confirm(\n                                    __('Apply workflow action \"{0}\"?', [action]),\n                                    function() {\n                                        apply_workflow_action(budget_name, action);\n                                    }\n                                );\n                            } else {\n                                // Show dialog to choose action\n                                show_workflow_dialog(budget_name, transitions);\n                            }\n                        } else {\n                            // No workflow or no available transitions\n                            frappe.msgprint(__('No workflow actions available for this budget'));\n                        }\n                    }\n                });\n            }\n        }\n    });\n}\n\n// Function: Show dialog with workflow action choices\nfunction show_workflow_dialog(budget_name, transitions) {\n    const action_options = transitions.map(t => t.action).join('\\n');\n    \n    frappe.prompt([\n        {\n            fieldname: 'action',\n            fieldtype: 'Select',\n            label: 'Workflow Action',\n            options: action_options,\n            reqd: 1,\n            default: transitions[0].action\n        }\n    ], function(values) {\n        apply_workflow_action(budget_name, values.action);\n    }, __('Select Workflow Action'), __('Apply'));\n}\n\n// Function: Apply workflow action to a budget\nfunction apply_workflow_action(budget_name, action) {\n    // First get the document\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Budget',\n            name: budget_name\n        },\n        callback: function(r) {\n            if (r.message) {\n                // Now apply workflow with the doc object\n                frappe.call({\n                    method: 'frappe.model.workflow.apply_workflow',\n                    args: {\n                        doc: r.message,  // Pass the full document object\n                        action: action\n                    },\n                    callback: function(workflow_response) {\n                        if (!workflow_response.exc) {\n                            frappe.show_alert({\n                                message: __('Workflow action \"{0}\" applied', [action]),\n                                indicator: 'green'\n                            });\n                            cur_list.refresh();\n                        } else {\n                            frappe.msgprint({\n                                title: __('Error'),\n                                message: workflow_response.exc || __('Could not apply workflow action'),\n                                indicator: 'red'\n                            });\n                        }\n                    }\n                });\n            }\n        }\n    });\n}\n\n// Function: Quick submit a single budget (fallback if no workflow)\nfunction quick_submit_budget(budget_name) {\n    // First check if there's a workflow\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Budget',\n            name: budget_name\n        },\n        callback: function(r) {\n            if (r.message) {\n                const doc = r.message;\n                \n                // Check if workflow exists\n                if (doc.workflow_state) {\n                    // Use workflow action instead\n                    show_workflow_actions(budget_name);\n                } else {\n                    // No workflow, just submit\n                    frappe.confirm(\n                        __('Submit this budget?'),\n                        function() {\n                            frappe.call({\n                                method: 'frappe.client.submit',\n                                args: {\n                                    doc: {\n                                        doctype: 'Budget',\n                                        name: budget_name\n                                    }\n                                },\n                                callback: function(r) {\n                                    if (!r.exc) {\n                                        frappe.show_alert({\n                                            message: __('Budget submitted'),\n                                            indicator: 'green'\n                                        });\n                                        cur_list.refresh();\n                                    }\n                                }\n                            });\n                        }\n                    );\n                }\n            }\n        }\n    });\n}\n\n// Function: Export selected budgets to Excel\nfunction export_budgets_to_excel(listview) {\n    const selected = listview.get_checked_items();\n    \n    if (selected.length === 0) {\n        frappe.msgprint(__('Please select at least one budget to export'));\n        return;\n    }\n    \n    const budget_names = selected.map(item => item.name);\n    \n    frappe.call({\n        method: 'frappe.desk.reportview.export_query',\n        args: {\n            doctype: 'Budget',\n            file_format_type: 'Excel',\n            filters: [['Budget', 'name', 'in', budget_names]]\n        },\n        callback: function(r) {\n            if (r.message) {\n                const a = document.createElement('a');\n                a.href = r.message;\n                a.download = 'budgets_export.xlsx';\n                a.click();\n                \n                frappe.show_alert({\n                    message: __('Exported {0} budget(s)', [selected.length]),\n                    indicator: 'green'\n                });\n            }\n        }\n    });\n}\n\n// Function: Add Metabase links to selected budgets\nfunction add_metabase_links(listview) {\n    const selected = listview.get_checked_items();\n    \n    if (selected.length === 0) {\n        frappe.msgprint(__('Please select at least one budget'));\n        return;\n    }\n    \n    frappe.prompt([\n        {\n            fieldname: 'budget_report_url',\n            fieldtype: 'Data',\n            label: 'Budget Report URL (Metabase)',\n            description: 'Link to budget report dashboard'\n        },\n        {\n            fieldname: 'comparison_report_url',\n            fieldtype: 'Data',\n            label: 'Comparison Report URL (Metabase)',\n            description: 'Link to budget vs actual comparison'\n        }\n    ], function(values) {\n        if (!values.budget_report_url && !values.comparison_report_url) {\n            frappe.msgprint(__('Please enter at least one URL'));\n            return;\n        }\n        \n        let completed = 0;\n        \n        frappe.show_alert({\n            message: __('Adding Metabase links...'),\n            indicator: 'blue'\n        });\n        \n        selected.forEach(function(item) {\n            frappe.call({\n                method: 'frappe.client.set_value',\n                args: {\n                    doctype: 'Budget',\n                    name: item.name,\n                    fieldname: {\n                        custom_budget_report_url: values.budget_report_url || '',\n                        custom_comparison_report_url: values.comparison_report_url || ''\n                    }\n                },\n                callback: function(r) {\n                    completed++;\n                    \n                    if (completed === selected.length) {\n                        frappe.show_alert({\n                            message: __('Metabase links added to {0} budget(s)', [selected.length]),\n                            indicator: 'green'\n                        });\n                        listview.refresh();\n                    }\n                }\n            });\n        });\n    }, __('Add Metabase Links'), __('Add Links'));\n}\n\n// Function: Filter current year budgets\nfunction filter_current_year(listview) {\n    const current_year = new Date().getFullYear().toString();\n    \n    listview.filter_area.clear();\n    listview.filter_area.add([[\n        'Budget',\n        'fiscal_year',\n        'like',\n        '%' + current_year + '%'\n    ]]);\n    \n    frappe.show_alert({\n        message: __('Showing budgets for {0}', [current_year]),\n        indicator: 'blue'\n    });\n}\n\n// Function: Filter next year budgets\nfunction filter_next_year(listview) {\n    const next_year = (new Date().getFullYear() + 1).toString();\n    \n    listview.filter_area.clear();\n    listview.filter_area.add([[\n        'Budget',\n        'fiscal_year',\n        'like',\n        '%' + next_year + '%'\n    ]]);\n    \n    frappe.show_alert({\n        message: __('Showing budgets for {0}', [next_year]),\n        indicator: 'blue'\n    });\n}\n\n// Function: Filter pending approval budgets\nfunction filter_pending_approval(listview) {\n    listview.filter_area.clear();\n    listview.filter_area.add([[\n        'Budget',\n        'docstatus',\n        '=',\n        0\n    ]]);\n    \n    frappe.show_alert({\n        message: __('Showing draft/pending budgets'),\n        indicator: 'orange'\n    });\n}\n\n// Add CSS for better styling\nfrappe.ready(function() {\n    $('<style>')\n        .prop('type', 'text/css')\n        .html(`\n            .budget-summary-cards .summary-card:hover {\n                transform: translateY(-2px);\n                transition: all 0.3s ease;\n                box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;\n            }\n            \n            .list-row:hover {\n                background-color: #f8f9fa;\n            }\n        `)\n        .appendTo('head');\n});",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 0,
  "modified": "2025-10-28 12:34:51.431099",
  "module": null,
  "name": "Clickable URL",
  "script": "frappe.ui.form.on('Your Doctype', {\n  onload_post_render(frm) { render_report_links(frm); },\n  refresh(frm) { render_report_links(frm); },\n\n  // Re-render if any URL changes\n  custom_budget_summary: frm => render_report_links(frm),\n  custom_consilidation_report: frm => render_report_links(frm),\n  custom_comparison_report: frm => render_report_links(frm),\n  custom_project_report: frm => render_report_links(frm),\n  custom_headcount_report: frm => render_report_links(frm),\n  custom_training_report: frm => render_report_links(frm),\n});\n\nfunction render_report_links(frm) {\n  const fields = [\n    { data: 'custom_budget_summary',             html: 'custom_budget_summary_html',             label: 'Budget Summary' },\n    { data: 'custom_consilidation_report',       html: 'custom_consilidation_report_html',       label: 'Consolidation Report' }, // note spelling\n    { data: 'custom_comparison_report',          html: 'custom_comparison_report_html',          label: 'Comparison Report' },\n    { data: 'custom_project_report',             html: 'custom_project_report_html',             label: 'Project Report' },\n    { data: 'custom_headcount_report',           html: 'custom_headcount_report_html',           label: 'Headcount Report' },\n    { data: 'custom_training_report',            html: 'custom_training_report_html',            label: 'Training Report' },\n  ];\n\n  fields.forEach(f => {\n    const url = (frm.doc[f.data] || '').trim();\n    const html_field = frm.fields_dict[f.html];\n    if (!html_field || !html_field.$wrapper) return;\n\n    // Clear previous content\n    html_field.$wrapper.empty();\n\n    if (url && /^https?:\\/\\/.+/i.test(url)) {\n      // Clickable link + small hint text\n      html_field.$wrapper.html(`\n        <div style=\"margin-top: 4px;\">\n          <a href=\"${frappe.utils.escape_html(url)}\" target=\"_blank\" rel=\"noopener\">\n            <i class=\"fa fa-external-link\"></i> Open ${frappe.utils.escape_html(f.label)}\n          </a>\n          <div style=\"font-size: 11px; color: #6c757d; margin-top: 2px;\">\n            ${frappe.utils.escape_html(url)}\n          </div>\n        </div>\n      `);\n    } else if (url) {\n      html_field.$wrapper.html(`\n        <div style=\"color:#b71c1c; font-size:12px; margin-top:4px;\">\n          Value is not a valid http(s) URL.\n        </div>\n      `);\n    } else {\n      html_field.$wrapper.html(`\n        <div style=\"color:#6c757d; font-size:12px; margin-top:4px;\">\n          No URL set.\n        </div>\n      `);\n    }\n  });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Person",
  "enabled": 1,
  "modified": "2025-10-30 14:19:57.403727",
  "module": null,
  "name": "Create draft budget",
  "script": "frappe.ui.form.on('Sales Person', {\n  refresh(frm) {\n    if (!frm.is_new()) {\n      frm.add_custom_button('Create Budget (Draft)', async function () {\n\n        // helpers\n        const toNumber = (v) => {\n          if (typeof v === 'number') return v;\n          if (!v) return 0;\n          const n = parseFloat(String(v).replace(/,/g, ''));\n          return isNaN(n) ? 0 : n;\n        };\n        const fmt = (v) => {\n          try { return typeof format_currency === 'function' ? format_currency(v) : new Intl.NumberFormat().format(v); }\n          catch { return String(v); }\n        };\n\n        // hard-coded defaults per your instance\n        const FIXED = {\n          budget_type: 'Forecast',           // must be one of: OPEX, CAPEX, Property Expenses, Property CAPEX, Forecast, HR, Headcount\n          monthly_distribution: '122025',\n          consolidation_group: 'OPEX - HQ',\n          fund_type: 'Accident Fund',\n          location: 'Head Office'\n        };\n\n        try {\n          // 1) Ask Fiscal Year (default from first target row)\n          const default_fy = (frm.doc.targets?.length && frm.doc.targets[0].fiscal_year) || '';\n          const { fiscal_year } = await new Promise((resolve) => {\n            frappe.prompt([{\n              fieldname: 'fiscal_year',\n              label: 'Fiscal Year',\n              fieldtype: 'Link',\n              options: 'Fiscal Year',\n              default: default_fy,\n              reqd: 1\n            }], resolve, 'Create Budget', 'Create');\n          });\n\n          // 2) Sum target amounts\n          const rows = frm.doc.targets || frm.doc.target_details || [];\n          const total_amount = rows.reduce((s, r) => s + toNumber(r.target_amount ?? r.amount ?? 0), 0);\n          if (total_amount <= 0) throw __('No target amounts found to create a budget.');\n\n          // 3) Employee → Department & Company\n          if (!frm.doc.employee) throw __('Please set the Employee on this Sales Person first.');\n          const emp = await frappe.db.get_value('Employee', frm.doc.employee, ['department', 'company']);\n          const department = emp?.message?.department;\n          const company = emp?.message?.company;\n          if (!department) throw __('Linked Employee has no Department; cannot map to Cost Center.');\n          if (!company) throw __('Linked Employee has no Company; cannot create Budget.');\n\n          // 4) Department doc (to read cost_center); fallback search by name\n          const deptDoc = await frappe.call({\n            method: 'frappe.client.get',\n            args: { doctype: 'Department', name: department },\n          });\n          const dept = deptDoc?.message || {};\n          const dept_name = dept.department_name || department;\n\n          let cost_center = dept.cost_center || null;\n\n          if (!cost_center) {\n            const like1 = `%${dept_name}%`;\n            let ccList = await frappe.call({\n              method: 'frappe.client.get_list',\n              args: {\n                doctype: 'Cost Center',\n                fields: ['name'],\n                filters: [\n                  ['Cost Center', 'company', '=', company],\n                  ['Cost Center', 'is_group', '=', 0],\n                  ['Cost Center', 'name', 'like', like1]\n                ],\n                limit_page_length: 1\n              }\n            });\n            if (!ccList?.message?.length) {\n              const compact = `%${String(dept_name).replace(/\\s+/g, '%')}%`;\n              ccList = await frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                  doctype: 'Cost Center',\n                  fields: ['name'],\n                  filters: [\n                    ['Cost Center', 'company', '=', company],\n                    ['Cost Center', 'is_group', '=', 0],\n                    ['Cost Center', 'name', 'like', compact]\n                  ],\n                  limit_page_length: 1\n                }\n              });\n            }\n            if (ccList?.message?.length) cost_center = ccList.message[0].name;\n          }\n\n          if (!cost_center) {\n            throw __(\n              `Could not resolve a Cost Center for Department \"${dept_name}\" in company \"${company}\". ` +\n              `Set the Department’s “Cost Center” field or ensure a matching Cost Center exists.`\n            );\n          }\n\n          // 5) Resolve “Assessment Raised” account for the company\n          let account_name = null;\n          let acc = await frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n              doctype: 'Account',\n              fields: ['name'],\n              filters: [\n                ['Account', 'company', '=', company],\n                ['Account', 'account_name', '=', 'Assessment Raised']\n              ],\n              limit_page_length: 1\n            }\n          });\n          if (acc?.message?.length) {\n            account_name = acc.message[0].name;\n          } else {\n            acc = await frappe.call({\n              method: 'frappe.client.get_list',\n              args: {\n                doctype: 'Account',\n                fields: ['name'],\n                filters: [\n                  ['Account', 'company', '=', company],\n                  ['Account', 'account_name', 'like', 'Assessment Raised%']\n                ],\n                limit_page_length: 1\n              }\n            });\n            if (acc?.message?.length) account_name = acc.message[0].name;\n          }\n          if (!account_name) throw __('Account \"Assessment Raised\" not found for this Company.');\n\n          // 6) Create Budget (Draft) with required fields\n          const ins = await frappe.call({\n            method: 'frappe.client.insert',\n            args: {\n              doc: {\n                doctype: 'Budget',\n                budget_type: FIXED.budget_type,             // \"Forecast\"\n                budget_against: 'Cost Center',\n                fiscal_year,\n                company,\n                cost_center,\n                monthly_distribution: FIXED.monthly_distribution,\n                consolidation_group: FIXED.consolidation_group,\n                fund_type: FIXED.fund_type,\n                location: FIXED.location,\n                accounts: [{ account: account_name, budget_amount: total_amount }]\n              }\n            },\n            freeze: true,\n            freeze_message: __('Creating Budget...')\n          });\n\n          const name = ins.message.name;\n          frappe.msgprint({\n            title: __('Budget Created'),\n            indicator: 'green',\n            message: __(\n              'Draft Budget <b>{0}</b> created for Cost Center <b>{1}</b> ({2}) with total amount <b>{3}</b>.',\n              [name, cost_center, company, fmt(total_amount)]\n            )\n          });\n          frappe.set_route('Form', 'Budget', name);\n\n        } catch (err) {\n          frappe.msgprint({\n            title: __('Could not create Budget'),\n            indicator: 'red',\n            message: err?.message || err\n          });\n        }\n      }, __('Actions'));\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-11-03 22:53:38.784768",
  "module": null,
  "name": "Create Budget",
  "script": "// Client Script for Project DocType - With Preview & Multi-Year Support\n// VERSION: v2.5 (Added Budget Series, fixed Monthly Distribution fields)\n// Script Type: Form\n// Enable: Yes\n\nfrappe.ui.form.on('Project', {\n  refresh(frm) {\n    if (!frm.is_new()) {\n      frm.add_custom_button(\n        'Create Budget from Milestones',\n        async function () {\n          const toNumber = (v) => {\n            if (typeof v === 'number') return v;\n            if (v === null || v === undefined || v === '') return 0;\n            const n = parseFloat(String(v).replace(/,/g, ''));\n            return isNaN(n) ? 0 : n;\n          };\n\n          const fmt = (v) => {\n            try {\n              if (typeof format_currency === 'function') return format_currency(v);\n              return new Intl.NumberFormat().format(v);\n            } catch {\n              return String(v);\n            }\n          };\n\n          const getMonthName = (dateStr) => {\n            const date = frappe.datetime.str_to_obj(dateStr);\n            const monthNames = [\n              'January', 'February', 'March', 'April', 'May', 'June',\n              'July', 'August', 'September', 'October', 'November', 'December'\n            ];\n            return monthNames[date.getMonth()];\n          };\n\n          const getFiscalYear = async (dateStr) => {\n            const result = await frappe.call({\n              method: 'erpnext.accounts.utils.get_fiscal_year',\n              args: { date: dateStr, company: frm.doc.company }\n            });\n            return result.message ? result.message[0] : null;\n          };\n\n          const normalizePercentages = (rows) => {\n            const rounded = rows.map(r => ({ ...r, percentage: Math.round(r.percentage * 100) / 100 }));\n            const sum = rounded.reduce((s, r) => s + r.percentage, 0);\n            const drift = Math.round((100 - sum) * 100) / 100;\n            if (Math.abs(drift) > 0 && rounded.length) {\n              let idx = 0; let max = -Infinity;\n              rounded.forEach((r, i) => { if (r.percentage > max) { max = r.percentage; idx = i; } });\n              rounded[idx].percentage = Math.round((rounded[idx].percentage + drift) * 100) / 100;\n            }\n            return rounded;\n          };\n\n          const showPreviewDialog = (html) => new Promise((resolve) => {\n            const d = frappe.msgprint({\n              title: __('Review Budget Distribution'),\n              message: html,\n              wide: true,\n              primary_action: {\n                label: __('Create Budget(s)'),\n                action: () => { try { d.hide(); } catch {} resolve(true); }\n              },\n              secondary_action: {\n                label: __('Cancel'),\n                action: () => { try { d.hide(); } catch {} resolve(false); }\n              }\n            });\n          });\n\n          try {\n            if (!frm.doc.project_type) throw __('Please set the Project Type before creating a budget.');\n\n            const budget_type_mapping = {\n              'CAPEX Property': 'Property CAPEX',\n              'OPEX Lands and Building': 'Property Expenses'\n            };\n\n            const account_mapping = {\n              'CAPEX Property': '230060 - Investments Property - AUC - WCFCB',\n              'OPEX Lands and Building': '230040 - Lands and Buildings - CAPEX AUC - WCFCB'\n            };\n\n            const budget_type = budget_type_mapping[frm.doc.project_type];\n            const account_name = account_mapping[frm.doc.project_type];\n            if (!budget_type || !account_name) throw __('Invalid Project Type for budget creation.');\n\n            const defaultCompany = frappe.defaults.get_user_default('Company') || frappe.defaults.get_user_default('company');\n            const company = frm.doc.company || defaultCompany;\n            if (!company) throw __('Please set the Company on this Project.');\n\n            frappe.show_alert({ message: __('Analyzing project tasks...'), indicator: 'blue' }, 3);\n\n            const { message: taskList } = await frappe.call({\n              method: 'frappe.client.get_list',\n              args: {\n                doctype: 'Task',\n                filters: { project: frm.doc.name },\n                fields: ['name', 'subject', 'exp_end_date', 'is_milestone', 'custom_estimated_cost'],\n                limit_page_length: 0\n              }\n            });\n\n            if (!Array.isArray(taskList) || taskList.length === 0) throw __('No tasks found for this project.');\n\n            let milestone_tasks = taskList.filter(t => Number(t.is_milestone) === 1);\n            if (milestone_tasks.length === 0) {\n              frappe.msgprint({ title: __('No Milestone Tasks'), indicator: 'orange', message: __('Using all tasks for distribution.') });\n              milestone_tasks = taskList;\n            }\n\n            const tasks_with_dates = milestone_tasks.filter(t => t.exp_end_date);\n            if (tasks_with_dates.length === 0) throw __('No tasks have end dates set.');\n\n            const enriched = [];\n            for (const task of tasks_with_dates) {\n              const fy = await getFiscalYear(task.exp_end_date);\n              if (fy) {\n                enriched.push({\n                  ...task,\n                  fiscal_year: fy,\n                  month_name: getMonthName(task.exp_end_date),\n                  explicit_value: toNumber(task.custom_estimated_cost) || 0\n                });\n              }\n            }\n\n            let project_estimate = toNumber(frm.doc.estimated_costing);\n            const total_explicit = enriched.reduce((s, t) => s + (t.explicit_value || 0), 0);\n\n            if (!project_estimate || project_estimate <= 0) {\n              if (total_explicit > 0) {\n                project_estimate = total_explicit;\n                try {\n                  await frm.set_value('estimated_costing', project_estimate);\n                  await frm.save();\n                  frappe.show_alert({ message: __('Estimated Costing auto-set from tasks: {0}', [fmt(project_estimate)]), indicator: 'green' }, 5);\n                } catch (eSet) { console.warn('Could not update estimated_costing:', eSet); }\n              }\n            }\n\n            let remaining_pool = Math.max((project_estimate || 0) - total_explicit, 0);\n            const missing = enriched.filter(t => !t.explicit_value);\n            const missing_count = missing.length;\n            const per_missing = missing_count > 0 ? (remaining_pool / missing_count) : 0;\n\n            const with_values = enriched.map(t => ({ ...t, task_value: (t.explicit_value && t.explicit_value > 0) ? t.explicit_value : per_missing }));\n\n            const grand_total_from_tasks_calc = with_values.reduce((s, t) => s + (t.task_value || 0), 0);\n            if (grand_total_from_tasks_calc <= 0) throw __('Total task value computed as 0.');\n\n            const by_fiscal_year = {};\n            with_values.forEach(task => {\n              by_fiscal_year[task.fiscal_year] = by_fiscal_year[task.fiscal_year] || [];\n              by_fiscal_year[task.fiscal_year].push(task);\n            });\n\n            const fiscal_years = Object.keys(by_fiscal_year);\n            const fy_summaries = [];\n            const month_order = ['January','February','March','April','May','June','July','August','September','October','November','December'];\n\n            for (const fy of fiscal_years) {\n              const fy_tasks = by_fiscal_year[fy];\n              const total_in_fy = fy_tasks.reduce((s, t) => s + (t.task_value || 0), 0);\n              const by_month = {};\n              fy_tasks.forEach(t => {\n                const task_val = t.task_value || 0;\n                by_month[t.month_name] = by_month[t.month_name] || { amount: 0, tasks: [] };\n                by_month[t.month_name].amount += task_val;\n                by_month[t.month_name].tasks.push({ name: t.name, subject: t.subject, end_date: t.exp_end_date, value: task_val });\n              });\n\n              let distribution = [];\n              const months_present = Object.keys(by_month);\n\n              if (total_in_fy > 0) {\n                months_present.forEach(month => {\n                  const pct = (by_month[month].amount / total_in_fy) * 100;\n                  distribution.push({ month, amount: by_month[month].amount, percentage: pct, tasks: by_month[month].tasks });\n                });\n              } else {\n                const equal_pct = 100 / (months_present.length || 12);\n                const months_to_use = months_present.length ? months_present : month_order;\n                months_to_use.forEach(month => {\n                  distribution.push({ month, amount: 0, percentage: equal_pct, tasks: by_month[month]?.tasks || [] });\n                });\n              }\n\n              distribution = normalizePercentages(distribution);\n              fy_summaries.push({ fiscal_year: fy, total_amount: total_in_fy, task_count: fy_tasks.length, distribution });\n            }\n\n            const grand_total_from_tasks = fy_summaries.reduce((s, fy) => s + (fy.total_amount || 0), 0);\n\n            const preview_html = buildPreviewHTML(fy_summaries, frm.doc.name, budget_type, account_name, fmt);\n            const proceed = await showPreviewDialog(preview_html);\n            if (!proceed) { frappe.show_alert(__('Budget creation cancelled'), 'info'); return; }\n\n            frappe.show_alert({ message: __('Creating budgets...'), indicator: 'blue' }, 5);\n            const created_budgets = [];\n\n            for (const fy_summary of fy_summaries) {\n              try {\n                const distribution_id = `PRJ-BUD-${frm.doc.name}-${fy_summary.fiscal_year}-${frappe.datetime.now_date()}`;\n\n                const percentages = fy_summary.distribution.map(d => ({\n                  doctype: 'Monthly Distribution Percentage', // child doctype\n                  parentfield: 'percentages',                 // child table fieldname\n                  month: d.month,\n                  percentage_allocation: Math.round(d.percentage * 100) / 100,\n                  activity_amount: Math.round((d.amount || 0) * 100) / 100,\n                  remarks: ((d.tasks && d.tasks.length)\n                    ? (d.tasks.slice(0, 3).map(t => t.subject).join(', ') + (d.tasks.length > 3 ? ` (+${d.tasks.length - 3} more)` : ''))\n                    : '').slice(0, 140) // keep remarks short\n                }));\n\n                const monthly_dist = await frappe.call({\n                  method: 'frappe.client.insert',\n                  args: {\n                    doc: {\n                      doctype: 'Monthly Distribution',\n                      distribution_id,\n                      company,\n                      fiscal_year: fy_summary.fiscal_year,\n                      total_amount: Math.round((fy_summary.total_amount || 0) * 100) / 100,\n                      // child rows under the correct child table fieldname\n                      percentages\n                    }\n                  }\n                });\n\n                const distribution_name = monthly_dist.message.name;\n\n                const budget_doc = await frappe.call({\n                  method: 'frappe.client.insert',\n                  args: {\n                    doc: {\n                      doctype: 'Budget',\n                      naming_series: 'PRJ-BUD-.{project}.-FY-.YYYY.-',\n                      budget_type,\n                      budget_against: 'Project',\n                      project: frm.doc.name,\n                      fiscal_year: fy_summary.fiscal_year,\n                      company,\n                      monthly_distribution: distribution_name,\n                      applicable_on_purchase_order: 1,\n                      applicable_on_booking_actual_expenses: 1,\n                      action_if_annual_budget_exceeded: 'Stop',\n                      action_if_accumulated_monthly_budget_exceeded: 'Warn',\n                      accounts: [ { account: account_name, budget_amount: fy_summary.total_amount } ]\n                    }\n                  }\n                });\n\n                created_budgets.push({ name: budget_doc.message.name, fiscal_year: fy_summary.fiscal_year, amount: fy_summary.total_amount });\n              } catch (fy_error) {\n                frappe.msgprint({ title: __('Error for {0}', [fy_summary.fiscal_year]), indicator: 'red', message: fy_error?.message || fy_error });\n              }\n            }\n\n            if (created_budgets.length > 0) {\n              await frm.set_value('custom_linked_budget', created_budgets[0].name);\n              await frm.save();\n              let msg = __('Successfully created {0} budget(s):', [created_budgets.length]) + '<br><br>';\n              created_budgets.forEach(b => { msg += `<b>${frappe.utils.escape_html(b.name)}</b> - ${b.fiscal_year} - ${fmt(b.amount)}<br>`; });\n              frappe.msgprint({ title: __('Budgets Created'), indicator: 'green', message: msg });\n              frappe.set_route('Form', 'Budget', created_budgets[0].name);\n            } else throw __('No budgets were created successfully.');\n\n          } catch (err) {\n            frappe.msgprint({ title: __('Could not create Budget'), indicator: 'red', message: err?.message || err });\n          }\n        },\n        __('Actions')\n      );\n    }\n\n    if (frm.doc.custom_linked_budget) frm.dashboard.add_indicator(__('Budget: {0}', [frm.doc.custom_linked_budget]), 'green');\n  }\n});\n\nfunction buildPreviewHTML(fy_summaries, project_name, budget_type, account_name, fmt) {\n  let html = `<div style=\"padding:10px;\"><h4>Budget Distribution Preview</h4><table class=\"table table-bordered\" style=\"margin-bottom:20px;\">\n  <tr><th>Project</th><td><b>${frappe.utils.escape_html(project_name)}</b></td></tr>\n  <tr><th>Budget Type</th><td><b>${frappe.utils.escape_html(budget_type)}</b></td></tr>\n  <tr><th>Account</th><td><b>${frappe.utils.escape_html(account_name)}</b></td></tr>\n  <tr><th>Fiscal Years</th><td><b>${fy_summaries.length}</b>${fy_summaries.length>1?' (Multiple budgets)': ''}</td></tr></table>`;\n\n  fy_summaries.forEach(fy=>{\n    html+=`<div style=\"margin-bottom:30px;border:1px solid #ddd;padding:15px;border-radius:5px;\">\n    <h5 style=\"color:#2490ef;\">Fiscal Year: ${frappe.utils.escape_html(fy.fiscal_year)}</h5>\n    <p><b>Total Amount:</b> ${fmt(fy.total_amount)} | <b>Tasks:</b> ${fy.task_count}</p>\n    <h6>Monthly Distribution:</h6><table class=\"table table-bordered table-sm\"><thead><tr><th>Month</th><th style=\"text-align:right;\">Amount</th><th style=\"text-align:right;\">%</th><th>Tasks</th></tr></thead><tbody>`;\n    fy.distribution.forEach(dist=>{\n      html+=`<tr><td><b>${frappe.utils.escape_html(dist.month)}</b></td><td style=\"text-align:right;\">${fmt(dist.amount)}</td><td style=\"text-align:right;\">${Math.round(dist.percentage*100)/100}%</td><td style=\"font-size:0.9em;\">`;\n      dist.tasks.forEach(task=>{html+=`<div>• ${frappe.utils.escape_html(task.subject)} (${frappe.datetime.str_to_user(task.end_date)}) - ${fmt(task.value)}</div>`});\n      html+='</td></tr>';\n    });\n    html+='</tbody></table></div>';\n  });\n  html+=`<div style=\"margin-top:20px;padding:10px;background:#f0f4f7;border-radius:5px;\"><p><b>Note:</b> ${fy_summaries.length} budget(s) will be created. Click <b>Create Budget(s)</b> to proceed.</p></div></div>`;\n  return html;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Travel Request",
  "enabled": 1,
  "modified": "2025-12-01 07:37:51.673561",
  "module": null,
  "name": "Workflow History Button Embed",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Travel Request', {\n        refresh: function(frm) {\n            if (!frm.is_new() && frm.doc.workflow_state) {\n                frm.add_custom_button(__('Workflow Tracker'), function() {\n                    open_workflow_tracker(frm);\n                }, __('Actions'));\n            }\n        }\n    });\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Requisition",
  "enabled": 1,
  "modified": "2025-11-07 23:31:05.700151",
  "module": null,
  "name": "Employee Replaced Filter",
  "script": "frappe.ui.form.on('Job Requisition', {\r\n    setup(frm) {\r\n        // Auto fill employee name from Employee.employee_name\r\n        frm.add_fetch('custom_employee_being_replaced', 'employee_name', 'custom_employee_being_replaced_name');\r\n    },\r\n\r\n    refresh(frm) {\r\n        set_employee_filter(frm);\r\n    },\r\n\r\n    department(frm) {\r\n        set_employee_filter(frm);\r\n        clear_if_invalid(frm);\r\n    },\r\n\r\n    position(frm) {\r\n        set_employee_filter(frm);\r\n        clear_if_invalid(frm);\r\n    }\r\n});\r\n\r\nfunction set_employee_filter(frm) {\r\n    frm.set_query('custom_employee_being_replaced', () => {\r\n        const filters = {};\r\n\r\n        // Filter employees by matching department\r\n        if (frm.doc.department) {\r\n            filters.department = frm.doc.department;\r\n        }\r\n\r\n        // Filter employees by matching position / designation\r\n        if (frm.doc.position) {\r\n            filters.designation = frm.doc.position;\r\n        }\r\n\r\n        // Only show active employees\r\n        filters.status = \"Active\";\r\n\r\n        return { filters };\r\n    });\r\n}\r\n\r\nfunction clear_if_invalid(frm) {\r\n    if (!frm.doc.custom_employee_being_replaced) return;\r\n\r\n    frappe.db.get_value('Employee', frm.doc.custom_employee_being_replaced, ['department', 'designation'])\r\n        .then(r => {\r\n            const emp = r.message;\r\n            if (!emp) return;\r\n\r\n            const mismatch =\r\n                (frm.doc.department && emp.department !== frm.doc.department) ||\r\n                (frm.doc.position && emp.designation !== frm.doc.position);\r\n\r\n            if (mismatch) {\r\n                frm.set_value('custom_employee_being_replaced', null);\r\n                frm.set_value('custom_employee_being_replaced_name', null);\r\n            }\r\n        });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Training Event",
  "enabled": 1,
  "modified": "2025-11-07 00:21:09.865082",
  "module": "ExN",
  "name": "Create Budget from trianing",
  "script": "// Training Event (List) — Create Training Budget\n// FINAL (rev B): writes to custom child field `custom_monthly_distribution`\n// and double-patches rows after insert to guarantee persistence.\n\nfrappe.listview_settings['Training Event'] = {\n  add_fields: ['custom_linked_department','custom_fiscal_year','custom_budget','custom_foreign_training'],\n  filters: [\n    ['custom_linked_department','!=',''],\n    ['custom_fiscal_year','!=','']\n  ],\n  onload: function(listview) {\n    // Tip banner\n    if (!listview.$result.find('.filter-help-message').length) {\n      listview.$result.prepend(\n        '<div class=\"filter-help-message\" style=\"background:#e8f4fd;border-left:4px solid #2490ef;padding:12px;margin:10px 0;border-radius:4px;\">' +\n        '<b>💡 Tip:</b> Filter by <b>Department</b> and <b>Fiscal Year</b> to create a training budget.' +\n        '</div>'\n      );\n    }\n\n    listview.page.add_inner_button(__('Create Training Budget'), async function () {\n\n      // ---------- CONFIG: adjust ONLY if your fieldname differs ----------\n      const DIST_FIELD = 'custom_monthly_distribution'; // <-- your custom Link field on child table \"Budget Account\"\n      // ------------------------------------------------------------------\n\n      // ---------- Helpers ----------\n      function toNumber(v){ if (typeof v==='number') return v; if (!v && v!==0) return 0; var n=parseFloat(String(v).replace(/,/g,'')); return isNaN(n)?0:n; }\n      function fmt(v){ try{ return typeof format_currency==='function'?format_currency(v):new Intl.NumberFormat().format(v);}catch(e){return String(v);} }\n      var MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];\n      function getMonthName(dateStr){ var dt=frappe.datetime.str_to_obj(dateStr); return MONTHS[dt.getMonth()]; }\n\n      function normalizeTo100(dist){\n        for (var i=0;i<dist.length;i++) dist[i].percentage = Number((+dist[i].percentage||0).toFixed(2));\n        var sum=0; for (var j=0;j<dist.length;j++) sum += dist[j].percentage; sum = Number(sum.toFixed(2));\n        var delta = Number((100 - sum).toFixed(2));\n        if (dist.length && Math.abs(delta)>=0.01){\n          var idx=0,max=-Infinity;\n          for (var k=0;k<dist.length;k++){ if (dist[k].percentage>max){max=dist[k].percentage; idx=k;} }\n          dist[idx].percentage = Number((dist[idx].percentage + delta).toFixed(2));\n        }\n      }\n\n      function buildPreview(data){\n        var html =\n          '<div style=\"padding:15px;\">' +\n          '<div style=\"background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:10px;margin-bottom:20px;\">' +\n          '<h3 style=\"margin:0 0 10px 0;color:white;\">Training Budget Overview</h3>' +\n          '<div style=\"display:grid;grid-template-columns:1fr 1fr;gap:10px;\"><div><b>Cost Centre:</b> '+data.cc+'</div><div><b>Fiscal Year:</b> '+data.fy+'</div></div></div>' +\n          '<div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;\">' +\n          '<div style=\"background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #2490ef;\"><div style=\"font-size:24px;font-weight:bold;color:#2490ef;\">'+data.total_events+'</div><div style=\"color:#666;font-size:12px;\">Total Events</div></div>' +\n          '<div style=\"background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #27ae60;\"><div style=\"font-size:20px;font-weight:bold;color:#27ae60;\">'+fmt(data.local_total)+'</div><div style=\"color:#666;font-size:12px;\">Local Training</div></div>' +\n          '<div style=\"background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #e74c3c;\"><div style=\"font-size:20px;font-weight:bold;color:#e74c3c;\">'+fmt(data.foreign_total)+'</div><div style=\"color:#666;font-size:12px;\">Foreign Training</div></div>' +\n          '</div>' +\n          '<div style=\"background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white;padding:15px;border-radius:8px;text-align:center;margin-bottom:20px;\">' +\n          '<div style=\"font-size:14px;opacity:.9;\">Total Budget Amount</div><div style=\"font-size:32px;font-weight:bold;margin-top:5px;\">'+fmt(data.grand_total)+'</div></div>';\n\n        function render(title,color,total,dist){\n          if(!dist||!dist.length) return '';\n          var s='<div style=\"margin-bottom:25px;border:1px solid '+color+';padding:15px;border-radius:8px;\">' +\n            '<h5 style=\"color:'+color+';margin-top:0;\"><span style=\"background:'+color+';color:white;padding:4px 12px;border-radius:4px;margin-right:8px;\">'+title+'</span>'+fmt(total)+'</h5>' +\n            '<table class=\"table table-bordered table-sm\"><thead><tr><th>Month</th><th style=\"text-align:right;\">Amount</th><th style=\"text-align:right;\">%</th><th>Events</th></tr></thead><tbody>';\n          for (var i=0;i<dist.length;i++){\n            var d=dist[i], rows=[];\n            for (var j=0;j<d.events.length;j++){ rows.push('• '+d.events[j].title+' ('+frappe.datetime.str_to_user(d.events[j].date)+')'); }\n            s+= '<tr><td><b>'+d.month+'</b></td><td style=\"text-align:right;\">'+fmt(d.amount)+'</td><td style=\"text-align:right;\">'+d.percentage+'%</td><td style=\"font-size:.9em;\">'+rows.join('<br>')+'</td></tr>';\n          }\n          return s + '</tbody></table></div>';\n        }\n        html += render('Local Training','#27ae60',data.local_total,data.local_dist);\n        html += render('Foreign Training','#e74c3c',data.foreign_total,data.foreign_dist);\n        html += '</div>';\n        return html;\n      }\n\n      // ---------- 1) Inputs ----------\n      var filters = listview.get_filters_for_args ? listview.get_filters_for_args() : [];\n      var cost_centre=null, fiscal_year=null;\n      for (var i=0;i<filters.length;i++){\n        var f=filters[i];\n        if (f[0]==='Training Event' && f[1]==='custom_linked_department') cost_centre=f[3];\n        if (f[0]==='Training Event' && f[1]==='custom_fiscal_year')       fiscal_year=f[3];\n      }\n      if (!cost_centre || !fiscal_year){\n        var values = await new Promise(function(resolve){\n          frappe.prompt([\n            {fieldname:'cc',label:'Cost Center',fieldtype:'Link',options:'Cost Center',reqd:1,default:cost_centre||''},\n            {fieldname:'fy',label:'Fiscal Year',fieldtype:'Link',options:'Fiscal Year',reqd:1,default:fiscal_year||''}\n          ], function(v){ resolve(v); }, __('Provide Inputs'), __('Continue'));\n        });\n        cost_centre = values.cc; fiscal_year = values.fy;\n      }\n\n      try {\n        // ---------- 2) Fetch events ----------\n        frappe.show_alert({message:__('Fetching training events...'),indicator:'blue'},3);\n        var r = await frappe.call({\n          method:'frappe.client.get_list',\n          args:{\n            doctype:'Training Event',\n            filters:{ custom_linked_department:cost_centre, custom_fiscal_year:fiscal_year },\n            fields:['name','event_name','start_time','custom_estimated_costs','custom_foreign_training','custom_budget'],\n            limit_page_length:0\n          }\n        });\n        var events = r.message || [];\n        if (!events.length){\n          frappe.msgprint({title:__('No Training Events Found'),indicator:'orange',\n            message:__('No training events found for:<br><br><b>Cost Centre:</b> {0}<br><b>Fiscal Year:</b> {1}', [cost_centre, fiscal_year])});\n          return;\n        }\n\n        // ---------- 3) Partition & totals ----------\n        var local=[], foreign=[];\n        for (i=0;i<events.length;i++){\n          var e=events[i];\n          if (!e.start_time) continue;\n          if (e.custom_foreign_training) foreign.push(e); else local.push(e);\n        }\n        if (!local.length && !foreign.length){\n          frappe.msgprint({title:__('No Valid Training Events'),indicator:'red',\n            message:__('All training events are missing start dates. Please set start dates before creating a budget.')});\n          return;\n        }\n        function sum(list){ var s=0; for (var a=0;a<list.length;a++) s+=toNumber(list[a].custom_estimated_costs); return s; }\n        var local_total=sum(local), foreign_total=sum(foreign), grand_total=local_total+foreign_total;\n\n        if (grand_total===0){\n          frappe.msgprint({title:__('No Estimated Costs'),indicator:'red',\n            message:__('All training events have zero estimated costs. Please set costs before creating a budget.')});\n          return;\n        }\n\n        // ---------- 4) Build distributions ----------\n        function aggregate(arr){\n          var map={};\n          for (var a=0;a<arr.length;a++){\n            var ev=arr[a], m=getMonthName(ev.start_time), amt=toNumber(ev.custom_estimated_costs);\n            if (!map[m]) map[m]={amount:0,events:[]};\n            map[m].amount += amt;\n            map[m].events.push({name:ev.name,title:ev.event_name,date:ev.start_time,cost:amt});\n          }\n          return map;\n        }\n        var localMap=aggregate(local), foreignMap=aggregate(foreign);\n        var local_dist=[], foreign_dist=[];\n        for (i=0;i<MONTHS.length;i++){\n          var m=MONTHS[i];\n          if (localMap[m])  local_dist.push({month:m,amount:localMap[m].amount,  percentage: Math.round(((localMap[m].amount /(local_total||1))*100)*100)/100,  events:localMap[m].events});\n          if (foreignMap[m])foreign_dist.push({month:m,amount:foreignMap[m].amount,percentage: Math.round(((foreignMap[m].amount/(foreign_total||1))*100)*100)/100,events:foreignMap[m].events});\n        }\n        if (local_dist.length)   normalizeTo100(local_dist);\n        if (foreign_dist.length) normalizeTo100(foreign_dist);\n\n        // ---------- 5) Preview ----------\n        var html = buildPreview({\n          cc:cost_centre, fy:fiscal_year, total_events:events.length,\n          local_total:local_total, foreign_total:foreign_total, grand_total:grand_total,\n          local_dist:local_dist, foreign_dist:foreign_dist\n        });\n        var proceed = await new Promise(function(resolve){\n          frappe.msgprint({\n            title: __('Review Training Budget'),\n            message: html, wide: true,\n            primary_action: { label: __('Create Budget'), action: function(){ resolve(true);} },\n            secondary_action:{ label: __('Cancel'),         action: function(){ resolve(false);} }\n          });\n        });\n        if (!proceed) { frappe.show_alert(__('Budget creation cancelled'),'info'); return; }\n\n        // ---------- 6) Create Monthly Distributions ----------\n        frappe.show_alert({message:__('Creating monthly distributions...'),indicator:'blue'},5);\n        var company = frappe.defaults.get_user_default('company');\n        if (!company) throw __('Please set a default company in your user defaults.');\n\n        async function createDistribution(title, rows, total_amount) {\n          if (!rows || !rows.length) return null;\n\n          // unique id to avoid collisions\n          var dist_id = title + ' - ' + cost_centre + ' - ' + fiscal_year + ' - ' + frappe.datetime.now_datetime().replace(/[:\\s-]/g,'');\n\n          var children = [];\n          for (var i=0;i<rows.length;i++){\n            var d = rows[i];\n            var names = []; for (var j=0;j<d.events.length;j++) names.push(d.events[j].title);\n            var remarks = names.join(', ');\n            if (remarks.length>140) remarks = remarks.slice(0,137)+'...';\n            children.push({\n              doctype: 'Monthly Distribution Percentage',\n              parentfield: 'percentages',\n              month: d.month,\n              percentage_allocation: Number((+d.percentage||0).toFixed(2)),\n              activity_amount: Number((+d.amount||0).toFixed(2)),\n              remarks: remarks\n            });\n          }\n\n          var ins = await frappe.call({\n            method: 'frappe.client.insert',\n            args: {\n              doc: {\n                doctype: 'Monthly Distribution',\n                distribution_id: dist_id,\n                company: company,\n                fiscal_year: fiscal_year,\n                total_amount: Number((+total_amount||0).toFixed(2)),\n                percentages: children\n              }\n            }\n          });\n          return ins.message.name;\n        }\n\n        var local_name  = await createDistribution('Training Local',  local_dist,  local_total);\n        var foreign_name= await createDistribution('Training Foreign',foreign_dist, foreign_total);\n        if (!local_name && !foreign_name) throw __('Failed to create any monthly distributions.');\n\n        // ---------- 7) Create Budget with child rows carrying the *custom* distribution field ----------\n        frappe.show_alert({message:__('Creating budget...'),indicator:'blue'},5);\n\n        var accounts = [];\n        if (local_total>0 && local_name){\n          let row = {\n            doctype: 'Budget Account',\n            parentfield: 'accounts',\n            account: '223010 - Training - Local - WCFCB',\n            budget_amount: Number(local_total.toFixed(2))\n          };\n          row[DIST_FIELD] = local_name;               // <-- write to custom field on insert\n          accounts.push(row);\n        }\n        if (foreign_total>0 && foreign_name){\n          let row = {\n            doctype: 'Budget Account',\n            parentfield: 'accounts',\n            account: '223005 - Training - Foreign - WCFCB',\n            budget_amount: Number(foreign_total.toFixed(2))\n          };\n          row[DIST_FIELD] = foreign_name;             // <-- write to custom field on insert\n          accounts.push(row);\n        }\n        if (!accounts.length) throw __('No budget accounts to create. Please check your training event costs.');\n\n        var budget_doc = await frappe.call({\n          method: 'frappe.client.insert',\n          args: {\n            doc: {\n              doctype: 'Budget',\n              budget_type: 'HR',\n              budget_against: 'Cost Center',\n              cost_center: cost_centre,\n              fiscal_year: fiscal_year,\n              company: company,\n              applicable_on_material_request: 0,\n              applicable_on_purchase_order: 0,\n              applicable_on_booking_actual_expenses: 1,\n              action_if_annual_budget_exceeded: 'Stop',\n              action_if_accumulated_monthly_budget_exceeded: 'Warn',\n              accounts: accounts\n            }\n          },\n          freeze: true,\n          freeze_message: __('Creating Training Budget...')\n        });\n        var budget_name = budget_doc.message.name;\n\n        // ---------- 8) Patch Budget Account rows with distribution (robust round-trip) ----------\n        try {\n          const b = await frappe.call({\n            method: 'frappe.client.get',\n            args: { doctype: 'Budget', name: budget_name }\n          });\n          const doc = b.message || {};\n          const rows = Array.isArray(doc.accounts) ? doc.accounts : [];\n\n          const distByAccount = {};\n          if (local_name)   distByAccount['223010 - Training - Local - WCFCB']  = local_name;\n          if (foreign_name) distByAccount['223005 - Training - Foreign - WCFCB'] = foreign_name;\n\n          let touched = 0;\n          for (let i = 0; i < rows.length; i++) {\n            const acc = rows[i];\n            const want = distByAccount[acc.account];\n            if (want && acc[DIST_FIELD] !== want) {\n              acc[DIST_FIELD] = want;                // <-- patch on the loaded doc\n              touched++;\n            }\n          }\n\n          if (touched > 0) {\n            await frappe.call({\n              method: 'frappe.client.save',\n              args: { doc }\n            });\n          }\n        } catch (patchErr) {\n          console.warn('Custom distribution patch (round-trip) failed:', patchErr);\n          // Fallback: per-row set_value on child doctype\n          try {\n            const b2 = await frappe.call({\n              method: 'frappe.client.get',\n              args: { doctype: 'Budget', name: budget_name }\n            });\n            const rows2 = (b2.message && b2.message.accounts) || [];\n            const distByAccount2 = {};\n            if (local_name)   distByAccount2['223010 - Training - Local - WCFCB']  = local_name;\n            if (foreign_name) distByAccount2['223005 - Training - Foreign - WCFCB'] = foreign_name;\n\n            const ops = [];\n            for (const r of rows2) {\n              const want = distByAccount2[r.account];\n              if (want && r[DIST_FIELD] !== want) {\n                ops.push(\n                  frappe.call({\n                    method: 'frappe.client.set_value',\n                    args: { doctype: 'Budget Account', name: r.name, fieldname: DIST_FIELD, value: want } // <-- custom field\n                  })\n                );\n              }\n            }\n            if (ops.length) await Promise.all(ops);\n          } catch (fallbackErr) {\n            console.warn('Per-row set_value fallback failed:', fallbackErr);\n          }\n        }\n\n        // ---------- 9) Link unbudgeted events ----------\n        frappe.show_alert({message:__('Updating training events...'),indicator:'blue'},5);\n        var updated=0;\n        for (i=0;i<events.length;i++){\n          var ev = events[i];\n          if (ev.custom_budget) continue;\n          try{\n            await frappe.call({\n              method:'frappe.client.set_value',\n              args:{ doctype:'Training Event', name: ev.name, fieldname:'custom_budget', value: budget_name }\n            });\n            updated++;\n          }catch(err){ console.warn('Failed to update', ev.name, err); }\n        }\n\n        // ---------- 10) Done ----------\n        frappe.msgprint({\n          title: __('Budget Created Successfully'),\n          indicator: 'green',\n          message:\n            '<div style=\"padding:10px;\">' +\n              '<p><b>Budget:</b> '+budget_name+'</p>' +\n              '<p><b>Cost Centre:</b> '+cost_centre+'</p>' +\n              '<p><b>Fiscal Year:</b> '+fiscal_year+'</p><hr>' +\n              (local_name?  '<p>✓ Local distribution: '+local_name+' ('+fmt(local_total)+')</p>':'') +\n              (foreign_name?'<p>✓ Foreign distribution: '+foreign_name+' ('+fmt(foreign_total)+')</p>':'') +\n              '<p><b>Total Budget:</b> '+fmt(grand_total)+'</p>' +\n              '<p><b>Training Events Updated:</b> '+updated+'</p>' +\n            '</div>'\n        });\n        listview.refresh();\n        frappe.set_route('Form','Budget',budget_name);\n\n      } catch (err){\n        frappe.msgprint({title:__('Could not create Budget'),indicator:'red',message: err && err.message ? err.message : err});\n        console.error('Budget creation error:', err);\n      }\n    }, __('Actions'));\n  }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Encashment",
  "enabled": 1,
  "modified": "2025-11-07 01:58:16.161776",
  "module": "ExN",
  "name": "Max leave days for management",
  "script": "frappe.ui.form.on('Leave Encashment', {\n  refresh(frm) {\n    // Check grade on refresh\n    check_management(frm);\n  },\n\n  custom_grade(frm) {\n    // Check grade on grade change\n    check_management(frm);\n  },\n\n  validate(frm) {\n    // Enforce max encashment days for management\n    if (frm.doc.custom_management && frm.doc.encashment_days > 14) {\n      frappe.throw(__('Management employees cannot encash more than 14 days of leave.'));\n    }\n  }\n});\n\n// Helper function\nfunction check_management(frm) {\n  const grade = frm.doc.custom_grade || '';\n  const isManagement = grade.trim().toUpperCase().startsWith('M');\n  \n  frm.set_value('custom_management', isManagement);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 0,
  "modified": "2025-11-12 09:31:23.565231",
  "module": null,
  "name": "Worflow Approval History - Budget Request",
  "script": "frappe.ui.form.on('Budget Request', {\r\n\r\n    onload(frm) {\r\n        hide_child_table(frm);\r\n        add_approval_history_button(frm);\r\n        frm._last_tracked_state = null;\r\n\r\n        // ✅ Fetch workflow metadata for Budget Request\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Workflow\",\r\n                name: \"Budget Request\"\r\n            },\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    frm._workflow_meta = r.message;\r\n                    console.log(\"✅ Workflow Metadata Loaded:\", frm._workflow_meta);\r\n                }\r\n            }\r\n        });\r\n    },\r\n\r\n    refresh(frm) {\r\n        hide_child_table(frm);\r\n        add_approval_history_button(frm);\r\n        track_workflow_history(frm);\r\n\r\n        // ✅ Allow edit after submit based on workflow state\r\n        enable_edit_after_submit(frm);\r\n    },\r\n\r\n    workflow_state(frm) {\r\n        track_workflow_history(frm);\r\n        enable_edit_after_submit(frm);\r\n    }\r\n});\r\n\r\n\r\n/* --------------------------------------------------------------- */\r\n/* ✅ ENABLE EDIT AFTER SUBMIT                                     */\r\n/* --------------------------------------------------------------- */\r\n\r\nfunction enable_edit_after_submit(frm) {\r\n    // Only allow after submit\r\n    if (frm.doc.docstatus !== 1) return;\r\n\r\n    const current_state = frm.doc.workflow_state;\r\n\r\n    // ✅ Customize which workflow states allow editing\r\n    const editable_states = [\r\n        'Pending Approval',\r\n        'Pending Review',\r\n        'Returned for Correction',\r\n        'Under Review',\r\n        'Query Raised'\r\n    ];\r\n\r\n    const can_edit = editable_states.some(state =>\r\n        current_state && current_state.toLowerCase().includes(state.toLowerCase())\r\n    );\r\n\r\n    if (can_edit) {\r\n        // Enable editing\r\n        frm.set_read_only(false);\r\n        frm.enable_save();\r\n\r\n        // OPTIONAL: Keep workflow_state itself locked so users can't change routing manually\r\n        frm.set_df_property('workflow_state', 'read_only', 1);\r\n\r\n        frappe.show_alert({\r\n            message: __('Document is editable in workflow state: {0}', [current_state]),\r\n            indicator: 'blue'\r\n        }, 3);\r\n\r\n        console.log(\"✅ Edit enabled for state:\", current_state);\r\n\r\n    } else {\r\n        // Lock the form when not allowed\r\n        frm.set_read_only(true);\r\n        console.log(\"🔒 Edit locked for state:\", current_state);\r\n    }\r\n}\r\n\r\n\r\n/* --------------------------------------------------------------- */\r\n/* WORKFLOW CONTEXT + LOGGING (No Changes Made)                    */\r\n/* --------------------------------------------------------------- */\r\n\r\nfunction get_workflow_context_for_state(frm, state_name) {\r\n    const roles = [];\r\n    const next_states = [];\r\n\r\n    const wf = frm._workflow_meta;\r\n    if (!wf || !wf.transitions) return { roles, next_states };\r\n\r\n    wf.transitions\r\n        .filter(t => String(t.state) === String(state_name))\r\n        .forEach(t => {\r\n            if (t.allowed) roles.push(t.allowed);\r\n            if (t.next_state) next_states.push(t.next_state);\r\n        });\r\n\r\n    return {\r\n        roles: [...new Set(roles)],\r\n        next_states: [...new Set(next_states)]\r\n    };\r\n}\r\n\r\nfunction track_workflow_history(frm) {\r\n    try {\r\n        if (!frm.doc.workflow_state) return;\r\n\r\n        const table_fieldname = 'custom_workflow_approval_history';\r\n        if (!frm.fields_dict[table_fieldname]) return;\r\n\r\n        const current_state = frm.doc.workflow_state;\r\n        const history = frm.doc[table_fieldname] || [];\r\n\r\n        if (frm._last_tracked_state === current_state) return;\r\n        const last = history.slice(-1)[0];\r\n        if (last && last.status === current_state) return;\r\n\r\n        frm._last_tracked_state = current_state;\r\n\r\n        const now = frappe.datetime.now_datetime();\r\n        const user = frappe.session.user;\r\n        const remarks = frm.doc.remarks || '';\r\n\r\n        const ctx = get_workflow_context_for_state(frm, current_state);\r\n\r\n        const entry = {\r\n            level: history.length + 1,\r\n            date: now,\r\n            role: ctx.roles.join(', ') || null,\r\n            next_state: ctx.next_states.join(', ') || null,\r\n            approved_by: user,\r\n            date_approved: now,\r\n            status: current_state,\r\n            remarks: remarks,\r\n            branch: frappe.boot?.user?.branch || ''\r\n        };\r\n\r\n        frm.add_child(table_fieldname, entry);\r\n        frm.refresh_field(table_fieldname);\r\n        frm.dirty();\r\n\r\n        frappe.show_alert({\r\n            message: __('Workflow updated → {0}', [current_state]),\r\n            indicator: getStateIndicator(current_state)\r\n        });\r\n\r\n        console.log(\"✅ Workflow Log Added:\", entry);\r\n\r\n    } catch (err) {\r\n        console.error(\"❌ Workflow History Tracking Error:\", err);\r\n    }\r\n}\r\n\r\nfunction hide_child_table(frm) {\r\n    ['workflow_approval_history', 'custom_workflow_approval_history'].forEach(field => {\r\n        if (frm.fields_dict[field]) {\r\n            frm.set_df_property(field, 'hidden', 1);\r\n        }\r\n    });\r\n}\r\n\r\nfunction add_approval_history_button(frm) {\r\n    frm.page.clear_inner_toolbar();\r\n    frm.add_custom_button(__('Workflow Approval History'), () => show_approval_history_dialog(frm), __('View'));\r\n}\r\n\r\nfunction show_approval_history_dialog(frm) {\r\n    const history = frm.doc.custom_workflow_approval_history || [];\r\n\r\n    if (!history.length) {\r\n        return frappe.msgprint(\"No approval history available yet.\");\r\n    }\r\n\r\n    const dialog = new frappe.ui.Dialog({\r\n        title: __('Workflow Approval History'),\r\n        size: 'extra-large',\r\n        fields: [\r\n            { fieldtype: 'HTML', fieldname: 'html' }\r\n        ]\r\n    });\r\n\r\n    let html = `\r\n        <table class=\"table table-bordered table-sm\">\r\n            <thead>\r\n                <tr>\r\n                    <th>#</th><th>Date</th><th>Date Approved</th>\r\n                    <th>Status</th><th>Approved By</th>\r\n                    <th>Role(s)</th><th>Next State</th>\r\n                    <th>Remarks</th>\r\n                </tr>\r\n            </thead>\r\n            <tbody>\r\n    `;\r\n\r\n    history.forEach((row, i) => {\r\n        html += `\r\n            <tr>\r\n                <td>${i + 1}</td>\r\n                <td>${row.date || '-'}</td>\r\n                <td>${row.date_approved || '-'}</td>\r\n                <td>${row.status || '-'}</td>\r\n                <td>${row.approved_by || '-'}</td>\r\n                <td>${row.role || '-'}</td>\r\n                <td>${row.next_state || '-'}</td>\r\n                <td>${row.remarks || '-'}</td>\r\n            </tr>`;\r\n    });\r\n\r\n    html += `</tbody></table>`;\r\n\r\n    dialog.fields_dict.html.$wrapper.html(html);\r\n    dialog.show();\r\n}\r\n\r\nfunction getStateIndicator(state) {\r\n    const s = state.toLowerCase();\r\n    if (s.includes('approved')) return 'green';\r\n    if (s.includes('reject') || s.includes('cancel')) return 'red';\r\n    if (s.includes('pending')) return 'orange';\r\n    if (s.includes('draft')) return 'grey';\r\n    return 'blue';\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-12-01 07:20:11.110248",
  "module": null,
  "name": "Workflow Approval History - Purchase Requisition",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Material Request', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Requisition",
  "enabled": 1,
  "modified": "2025-11-28 10:41:32.368677",
  "module": null,
  "name": "Department Auto fill",
  "script": "frappe.ui.form.on('Job Requisition', {\r\n    setup(frm) {\r\n        // Store the correct department based on designation\r\n        frm._correct_department = null;\r\n        frm._is_auto_setting = false; // Flag to prevent recursive calls\r\n        frm._designation_checked = false; // Track if designation has been validated\r\n    },\r\n    \r\n    refresh(frm) {\r\n        // Always make department read-only if designation is set (regardless of whether department exists)\r\n        if (frm.doc.designation) {\r\n            frm.set_df_property('department', 'read_only', 1);\r\n        } else {\r\n            frm.set_df_property('department', 'read_only', 0);\r\n        }\r\n    },\r\n    \r\n    designation(frm) {\r\n        // If designation cleared, clear department and reset flags\r\n        if (!frm.doc.designation) {\r\n            frm._correct_department = null;\r\n            frm._designation_checked = false;\r\n            frm._is_auto_setting = true;\r\n            frm.set_value('department', null);\r\n            frm._is_auto_setting = false;\r\n            frm.set_df_property('department', 'read_only', 0);\r\n            return;\r\n        }\r\n        \r\n        // Fetch the correct department from designation\r\n        frappe.db.get_value('Designation', frm.doc.designation, 'custom_department')\r\n            .then(r => {\r\n                const dep = r && r.message && r.message.custom_department;\r\n                \r\n                // Mark that we've checked the designation\r\n                frm._designation_checked = true;\r\n                \r\n                if (dep) {\r\n                    // Department exists - set it\r\n                    frm._correct_department = dep;\r\n                    frm._is_auto_setting = true;\r\n                    frm.set_value('department', dep);\r\n                    frm._is_auto_setting = false;\r\n                    frm.set_df_property('department', 'read_only', 1);\r\n                } else {\r\n                    // No department for this designation - clear and lock\r\n                    frm._correct_department = null;\r\n                    frm._is_auto_setting = true;\r\n                    frm.set_value('department', null);\r\n                    frm._is_auto_setting = false;\r\n                    frm.set_df_property('department', 'read_only', 1);\r\n                }\r\n            })\r\n            .catch(() => {\r\n                // Silent error handling - just lock the field\r\n                frm._designation_checked = true;\r\n                frm._correct_department = null;\r\n                frm.set_df_property('department', 'read_only', 1);\r\n            });\r\n    },\r\n    \r\n    department(frm) {\r\n        // Skip validation if we're auto-setting the value\r\n        if (frm._is_auto_setting) return;\r\n        \r\n        // If designation is set, prevent any manual changes\r\n        if (frm.doc.designation && frm._designation_checked) {\r\n            // Reset to correct department (or null if no department) silently\r\n            frm._is_auto_setting = true;\r\n            frm.set_value('department', frm._correct_department);\r\n            frm._is_auto_setting = false;\r\n        }\r\n    },\r\n    \r\n    validate(frm) {\r\n        // Final validation before save\r\n        if (frm.doc.designation && frm._designation_checked) {\r\n            // Check if department matches what it should be\r\n            if (frm.doc.department !== frm._correct_department) {\r\n                frappe.validated = false;\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Opening",
  "enabled": 1,
  "modified": "2025-11-09 19:48:27.434537",
  "module": null,
  "name": "Posting On and Closing On Dates - filters",
  "script": "frappe.ui.form.on('Job Opening', {\r\n    setup(frm) {\r\n        // Track the original values when form loads\r\n        frm._original_posted_on = null;\r\n        frm._original_closes_on = null;\r\n    },\r\n    \r\n    refresh(frm) {\r\n        // Store original values when form refreshes (after save or load)\r\n        if (!frm.is_new()) {\r\n            frm._original_posted_on = frm.doc.posted_on;\r\n            frm._original_closes_on = frm.doc.closes_on;\r\n        }\r\n    },\r\n    \r\n    posted_on(frm) {\r\n        // Only enforce if:\r\n        // 1. New document, OR\r\n        // 2. User actively changed the field (value different from original)\r\n        const isActiveEdit = !frm.is_new() && frm.doc.posted_on !== frm._original_posted_on;\r\n        \r\n        if (frm.is_new() || isActiveEdit) {\r\n            const today = frappe.datetime.get_today();\r\n            if (frm.doc.posted_on !== today) {\r\n                frappe.msgprint(__('Posted On must be today. It has been reset.'));\r\n                frm.set_value('posted_on', today);\r\n                // Update the original value after correction\r\n                if (!frm.is_new()) {\r\n                    frm._original_posted_on = today;\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \r\n    closes_on(frm) {\r\n        // Only enforce if:\r\n        // 1. New document, OR\r\n        // 2. User actively changed the field (value different from original)\r\n        const isActiveEdit = !frm.is_new() && frm.doc.closes_on !== frm._original_closes_on;\r\n        \r\n        if (frm.is_new() || isActiveEdit) {\r\n            const today = frappe.datetime.get_today();\r\n            if (frm.doc.closes_on && frm.doc.closes_on < today) {\r\n                frappe.msgprint(__('Closes On cannot be in the past. It has been reset to today.'));\r\n                frm.set_value('closes_on', today);\r\n                // Update the original value after correction\r\n                if (!frm.is_new()) {\r\n                    frm._original_closes_on = today;\r\n                }\r\n            }\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Opening",
  "enabled": 1,
  "modified": "2025-11-09 21:58:15.099923",
  "module": null,
  "name": "Job requisition Autofill - Job opening",
  "script": "// Client Script: Job Opening\r\nfrappe.ui.form.on('Job Opening', {\r\n    setup(frm) {\r\n        // Keep a guard so we don't loop when setting values\r\n        frm._auto_filling_from_jr = false;\r\n    },\r\n\r\n    // Trigger when position is chosen/changed\r\n    designation: async function(frm) {\r\n        if (!frm.doc.designation) return;\r\n        if (frm._auto_filling_from_jr) return;\r\n\r\n        // Only auto-fill on new docs or when targets are blank\r\n        const targetsBlank =\r\n            !frm.doc.department && !frm.doc.company && !frm.doc.custom_grade;\r\n\r\n        if (!frm.is_new() && !targetsBlank) {\r\n            // Respect existing saved data; do nothing\r\n            return;\r\n        }\r\n\r\n        await pull_from_job_requisition(frm);\r\n    },\r\n\r\n    refresh(frm) {\r\n        // Optional convenience button to re-pull\r\n        if (!frm.is_new()) {\r\n            frm.add_custom_button(__('Pull from Job Requisition'), async () => {\r\n                await pull_from_job_requisition(frm, { force: true });\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\nasync function pull_from_job_requisition(frm, opts = {}) {\r\n    try {\r\n        frm._auto_filling_from_jr = true;\r\n\r\n        // 1) Try latest SUBMITTED (docstatus=1) JR for this designation\r\n        let jr = await frappe.db.get_list('Job Requisition', {\r\n            filters: {\r\n                designation: frm.doc.designation,\r\n                docstatus: 1\r\n            },\r\n            fields: ['name', 'department', 'company', 'custom_expected_grade'],\r\n            order_by: 'creation desc',\r\n            limit: 1\r\n        });\r\n\r\n        // 2) Fallback: try latest Draft if no submitted requisition exists\r\n        if (!jr || jr.length === 0) {\r\n            jr = await frappe.db.get_list('Job Requisition', {\r\n                filters: {\r\n                    designation: frm.doc.designation,\r\n                    docstatus: 0\r\n                },\r\n                fields: ['name', 'department', 'company', 'custom_expected_grade'],\r\n                order_by: 'creation desc',\r\n                limit: 1\r\n            });\r\n        }\r\n\r\n        if (!jr || jr.length === 0) {\r\n            if (opts.force) {\r\n                frappe.msgprint({\r\n                    title: __('Not Found'),\r\n                    message: __('No Job Requisition found for designation: {0}', [frm.doc.designation]),\r\n                    indicator: 'orange'\r\n                });\r\n            }\r\n            return;\r\n        }\r\n\r\n        const row = jr[0];\r\n\r\n        // Map JR → Job Opening fields\r\n        const updates = {};\r\n        if (row.department && (!frm.doc.department || opts.force)) {\r\n            updates.department = row.department;\r\n        }\r\n        if (row.company && (!frm.doc.company || opts.force)) {\r\n            updates.company = row.company;\r\n        }\r\n        if (row.custom_expected_grade && (!frm.doc.custom_grade || opts.force)) {\r\n            updates.custom_grade = row.custom_expected_grade;\r\n        }\r\n\r\n        if (Object.keys(updates).length) {\r\n            await frm.set_value(updates);\r\n            // Optionally notify on manual pull\r\n            if (opts.force) {\r\n                frappe.show_alert({\r\n                    message: __('Pulled from Job Requisition: {0}', [row.name]),\r\n                    indicator: 'green'\r\n                }, 5);\r\n            }\r\n        } else if (opts.force) {\r\n            frappe.msgprint({\r\n                title: __('Up to Date'),\r\n                message: __('Fields are already filled; nothing to update.'),\r\n                indicator: 'blue'\r\n            });\r\n        }\r\n    } catch (e) {\r\n        // Permission or field-level restrictions can cause errors\r\n        console.error(e);\r\n        frappe.msgprint({\r\n            title: __('Error'),\r\n            message: __('Could not pull data from Job Requisition. Ensure you have Read access and fields are permitted.'),\r\n            indicator: 'red'\r\n        });\r\n    } finally {\r\n        frm._auto_filling_from_jr = false;\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-12-01 15:11:50.028141",
  "module": null,
  "name": "Standardised Phone Number -",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n    setup(frm) {\r\n        // Add format hint to the field\r\n        frm.set_df_property('phone_number', 'description', \r\n            'Format: 097 1234567 or 0971234567 (Zambian mobile: 10 digits starting with 095, 096, 097, or 076)');\r\n    },\r\n    \r\n    phone_number(frm) {\r\n        // Real-time validation and auto-formatting as user types\r\n        let phone = (frm.doc.phone_number || '').trim();\r\n        \r\n        if (!phone) {\r\n            frm.set_df_property('phone_number', 'description', \r\n                'Format: 097 1234567 or 0971234567 (Zambian mobile: 10 digits starting with 095, 096, 097, or 076)');\r\n            return;\r\n        }\r\n        \r\n        // Remove any extra spaces for validation\r\n        const cleanPhone = phone.replace(/\\s+/g, '');\r\n        \r\n        // Zambian mobile numbers: EXACTLY 10 digits starting with 095, 096, 097, or 076\r\n        const validPattern = /^(095|096|097|076)\\d{7}$/;\r\n        \r\n        console.log('Phone validation:', phone, 'Clean:', cleanPhone, 'Valid:', validPattern.test(cleanPhone));\r\n        \r\n        // Check if valid (without space)\r\n        if (validPattern.test(cleanPhone)) {\r\n            const formatted = cleanPhone.slice(0, 3) + \" \" + cleanPhone.slice(3);\r\n            frm.set_df_property('phone_number', 'description', \r\n                '<span style=\"color: green; font-weight: bold;\">✓ Valid Zambian mobile number</span>');\r\n            \r\n            // Auto-format without triggering recursion\r\n            if (frm.doc.phone_number !== formatted) {\r\n                frm.set_value('phone_number', formatted);\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Invalid format - show detailed error\r\n        let errorMsg = '';\r\n        let helpText = '';\r\n        \r\n        if (cleanPhone.length === 0) {\r\n            errorMsg = 'Phone number is required';\r\n            helpText = 'Enter a Zambian mobile number';\r\n        } else if (!/^\\d+$/.test(cleanPhone)) {\r\n            errorMsg = 'Only digits allowed (no letters or special characters)';\r\n            helpText = 'Remove any non-numeric characters';\r\n        } else if (cleanPhone.length < 10) {\r\n            errorMsg = `Too short: ${cleanPhone.length} digits entered, need 10 digits`;\r\n            helpText = `Add ${10 - cleanPhone.length} more digit(s)`;\r\n        } else if (cleanPhone.length > 10) {\r\n            errorMsg = `Too long: ${cleanPhone.length} digits entered, need exactly 10 digits`;\r\n            helpText = `Remove ${cleanPhone.length - 10} extra digit(s)`;\r\n        } else if (!/^(095|096|097|076)/.test(cleanPhone)) {\r\n            const enteredPrefix = cleanPhone.substring(0, 3);\r\n            errorMsg = `Invalid prefix: \"${enteredPrefix}\" is not a valid Zambian mobile prefix`;\r\n            helpText = 'Must start with 095, 096, 097, or 076';\r\n        } else {\r\n            errorMsg = 'Invalid phone number format';\r\n            helpText = 'Expected format: 097 1234567';\r\n        }\r\n        \r\n        frm.set_df_property('phone_number', 'description', \r\n            `<span style=\"color: red; font-weight: bold;\">✗ ${errorMsg}</span><br><span style=\"color: orange;\">${helpText}</span>`);\r\n        \r\n        // Show immediate warning (less frequent to avoid spam)\r\n        if (!frm._last_phone_alert || Date.now() - frm._last_phone_alert > 2000) {\r\n            frappe.show_alert({\r\n                message: __('Invalid phone: {0}', [errorMsg]),\r\n                indicator: 'red'\r\n            }, 3);\r\n            frm._last_phone_alert = Date.now();\r\n        }\r\n    },\r\n    \r\n    validate(frm) {\r\n        // STRICT GUARD: Block saving if phone format is invalid\r\n        let phone = (frm.doc.phone_number || '').trim();\r\n        \r\n        // Allow empty phone number (skip validation if field is empty)\r\n        if (!phone) return;\r\n        \r\n        // Remove any spaces for validation\r\n        const cleanPhone = phone.replace(/\\s+/g, '');\r\n        \r\n        console.log('Validate - Phone:', phone, 'Clean:', cleanPhone, 'Length:', cleanPhone.length);\r\n        \r\n        // Zambian mobile numbers: EXACTLY 10 digits starting with 095, 096, 097, or 076\r\n        const validPattern = /^(095|096|097|076)\\d{7}$/;\r\n        \r\n        // Check if valid\r\n        if (!validPattern.test(cleanPhone)) {\r\n            // Block save\r\n            frappe.validated = false;\r\n            \r\n            let errorDetail = '';\r\n            if (cleanPhone.length < 10) {\r\n                errorDetail = `<br><b>Issue:</b> Too short - you entered ${cleanPhone.length} digits, need exactly 10 digits.`;\r\n            } else if (cleanPhone.length > 10) {\r\n                errorDetail = `<br><b>Issue:</b> Too long - you entered ${cleanPhone.length} digits, need exactly 10 digits.`;\r\n            } else if (!/^(095|096|097|076)/.test(cleanPhone)) {\r\n                errorDetail = `<br><b>Issue:</b> Invalid prefix - must start with 095, 096, 097, or 076.`;\r\n            }\r\n            \r\n            // Show detailed error message\r\n            frappe.msgprint({\r\n                title: __('Invalid Phone Number'),\r\n                message: __('Phone number format is incorrect.<br><br><b>Expected format:</b> 097 1234567 or 0971234567<br><b>Requirements:</b><br>- Must be exactly 10 digits<br>- Must start with: 095, 096, 097, or 076{0}<br><br><b>Your input:</b> {1}<br><br>Please correct the phone number before saving.', [errorDetail, phone]),\r\n                indicator: 'red',\r\n                primary_action: {\r\n                    label: __('OK'),\r\n                    action: function() {\r\n                        // Focus back on the phone field\r\n                        frm.scroll_to_field('phone_number');\r\n                    }\r\n                }\r\n            });\r\n            \r\n            // Throw error to completely block the save\r\n            throw __('Invalid Zambian phone number. Must be exactly 10 digits starting with 095, 096, 097, or 076');\r\n        }\r\n        \r\n        // If valid, ensure it's properly formatted with space\r\n        const formatted = cleanPhone.slice(0, 3) + \" \" + cleanPhone.slice(3);\r\n        if (phone !== formatted) {\r\n            frm.set_value('phone_number', formatted);\r\n        }\r\n    },\r\n    \r\n    before_save(frm) {\r\n        // Additional guard before save - double check validation\r\n        let phone = (frm.doc.phone_number || '').trim();\r\n        \r\n        if (!phone) return;\r\n        \r\n        // Remove spaces for validation\r\n        const cleanPhone = phone.replace(/\\s+/g, '');\r\n        \r\n        // EXACTLY 10 digits starting with valid prefix\r\n        const validPattern = /^(095|096|097|076)\\d{7}$/;\r\n        \r\n        if (!validPattern.test(cleanPhone)) {\r\n            // Block invalid format\r\n            frappe.validated = false;\r\n            \r\n            let errorMsg = 'Invalid Zambian phone number.';\r\n            if (cleanPhone.length !== 10) {\r\n                errorMsg = `Phone must be exactly 10 digits (you have ${cleanPhone.length}).`;\r\n            } else {\r\n                errorMsg = 'Phone must start with 095, 096, 097, or 076.';\r\n            }\r\n            \r\n            frappe.throw(__('Cannot save: {0}', [errorMsg]));\r\n        }\r\n        \r\n        // Ensure proper formatting\r\n        const formatted = cleanPhone.slice(0, 3) + \" \" + cleanPhone.slice(3);\r\n        if (phone !== formatted) {\r\n            frm.set_value('phone_number', formatted);\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-12-01 15:11:50.054182",
  "module": null,
  "name": "Email Duplicate Validation - Job Applicant",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n    async validate(frm) {\r\n        const email = (frm.doc.email_id || '').trim().toLowerCase();\r\n        const title = (frm.doc.job_title || '').trim();\r\n\r\n        if (!email || !title) return;\r\n\r\n        // Check for another applicant with same email + job title\r\n        const existing = await frappe.db.get_list('Job Applicant', {\r\n            filters: {\r\n                email_id: email,\r\n                job_title: title,\r\n                name: [\"!=\", frm.doc.name]  // exclude current doc\r\n            },\r\n            limit: 1\r\n        });\r\n\r\n        if (existing && existing.length > 0) {\r\n            frappe.throw(\r\n                __(\r\n                    \"This applicant has already applied for this job.<br><br>\" +\r\n                    \"<b>Email:</b> {0}<br>\" +\r\n                    \"<b>Job Title:</b> {1}<br><br>\" +\r\n                    \"Duplicate applications for the same job are not allowed.\",\r\n                    [email, title]\r\n                )\r\n            );\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Interview Feedback",
  "enabled": 1,
  "modified": "2025-11-10 14:51:14.975632",
  "module": null,
  "name": "Interview Feedback Ranking",
  "script": "frappe.listview_settings['Interview Feedback'] = {\r\n    onload(listview) {\r\n        // Default sorting: Highest rating first\r\n        listview.page.sort_by_select.val('custom_overall_impression_rating');\r\n        listview.sort_by = 'custom_overall_impression_rating';\r\n        listview.sort_order = 'desc';\r\n        listview.refresh();\r\n    }\r\n};\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 0,
  "modified": "2025-12-02 09:23:29.611319",
  "module": null,
  "name": "Auto Sync Email",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n    email_id: function(frm) {\r\n        if (!frm.doc.name || !frm.doc.email_id) return;\r\n\r\n        // First, find all Interviews linked to this applicant\r\n        frappe.db.get_list('Interview', {\r\n            filters: { applicant: frm.doc.name },\r\n            fields: ['name']\r\n        }).then(interviews => {\r\n            // Update each Interview record individually\r\n            interviews.forEach(interview => {\r\n                frappe.call({\r\n                    method: \"frappe.client.set_value\",\r\n                    args: {\r\n                        doctype: \"Interview\",\r\n                        name: interview.name,   // Specific document name\r\n                        fieldname: \"candidate_email\",\r\n                        value: frm.doc.email_id\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Requisition",
  "enabled": 1,
  "modified": "2025-12-01 07:14:27.237750",
  "module": null,
  "name": "Workflow Approval History - Job Requisition",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\n// Job Requisition Workflow Tracker - Client Script\n\nfrappe.ui.form.on('Job Requisition', {\n    refresh: function(frm) {\n        // Only show for saved documents with a workflow state\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-11-15 02:54:12.639326",
  "module": "ExN",
  "name": "Create Requisition",
  "script": "// Client Script for Budget\n// - Adds \"Create Purchase Requisition\" button on Budget\n// - CAPEX: creates & inserts a Material Request with one item from selected budget line\n// - Non-CAPEX: opens a new Material Request form, only header prefilled (no items)\n\nfrappe.ui.form.on('Budget', {\n    refresh(frm) {\n        if (!frm.is_new()) {\n            frm.add_custom_button(\n                __('Create Purchase Requisition'),\n                () => open_pr_line_selector(frm),\n                __('Create')\n            );\n        }\n    }\n});\n\nfunction open_pr_line_selector(frm) {\n    const budget = frm.doc;\n\n    // For non-CAPEX, we don't need item lines: directly open MR with header only\n    if (budget.budget_type !== 'CAPEX') {\n        create_material_request_from_budget_line(frm, null);\n        return;\n    }\n\n    // For CAPEX, user must pick which budget line to convert\n    const lines = budget.accounts || [];\n\n    if (!lines.length) {\n        frappe.msgprint(__('No budget account lines found on this Budget.'));\n        return;\n    }\n\n    // Build labels for the select options\n    const options = lines.map(row => {\n        const labelParts = [\n            row.idx,\n            row.account || '',\n            row.custom_asset_category || '',\n            row.custom_remarks || ''\n        ].filter(Boolean);\n        return `${labelParts.join(' | ')}`;\n    });\n\n    const dialog = new frappe.ui.Dialog({\n        title: __('Select Budget Line for Purchase Requisition'),\n        fields: [\n            {\n                fieldname: 'line',\n                label: __('Budget Line'),\n                fieldtype: 'Select',\n                options: options,\n                reqd: 1\n            }\n        ],\n        primary_action_label: __('Create Purchase Requisition'),\n        primary_action(values) {\n            const selected_label = values.line;\n            const idx = options.indexOf(selected_label);\n\n            if (idx === -1) {\n                frappe.msgprint(__('Could not find selected line.'));\n                return;\n            }\n\n            const selected_line = lines[idx];\n            create_material_request_from_budget_line(frm, selected_line);\n            dialog.hide();\n        }\n    });\n\n    dialog.show();\n}\n\nfunction create_material_request_from_budget_line(frm, line) {\n    const budget = frm.doc;\n\n    // Map asset categories (3rd column) AND codes (1st column) to Item Codes (1st column)\n    // Keys: category names or codes\n    // Values: Item Codes to use on Material Request Item\n    const asset_item_map = {\n        // Motor Vehicles\n        'Motor Vehicles': 'FA/MV/01',\n        'MOTOR VEHICLE': 'FA/MV/01',\n        'FA/MV/01': 'FA/MV/01',\n\n        // Plant and Machinery\n        'Plant and Machinery': 'FA/PM/01',\n        'PLANT & MACHINE': 'FA/PM/01',\n        'FA/PM/01': 'FA/PM/01',\n\n        // Office Equipment\n        'Office Equipements': 'FA/OE/01',\n        'OFFICE EQUIPMENT': 'FA/OE/01',\n        'FA/OE/01': 'FA/OE/01',\n\n        // Office Furniture and Fittings\n        'Office Furniture and Fittings': 'FA/OF/01',\n        'OFFICE FURNITURE': 'FA/OF/01',\n        'FA/OF/01': 'FA/OF/01',\n\n        // Furniture\n        'Furniture': 'FA/FF/01',\n        'FURNITURE, FIXT': 'FA/FF/01',\n        'FA/FF/01': 'FA/FF/01',\n\n        // Land and Buildings\n        'Land and Buildings': 'FA/LB/01',\n        'LAND & BUILDING': 'FA/LB/01',\n        'FA/LB/01': 'FA/LB/01',\n\n        // Investment Property\n        'Investment Property': 'SC/00001',\n        'INVESTMENT PROPERTY': 'SC/00001',\n        'SC/00001': 'SC/00001',\n\n        // Computer Equipment\n        'Computer Equipment': 'FA/CE/01',\n        'COMPUTER EQUIPM': 'FA/CE/01',\n        'FA/CE/01': 'FA/CE/01'\n    };\n\n    // -------- CAPEX: create & insert Material Request with Items --------\n    if (budget.budget_type === 'CAPEX') {\n        if (!line) {\n            frappe.msgprint(__('No budget line provided for CAPEX Material Request.'));\n            return;\n        }\n\n        const asset_value = line.custom_asset_category;  // usually category name (3rd column)\n        const mapped_item_code = asset_item_map[asset_value] || asset_value; // fallback if code stored directly\n\n        const mr_doc = {\n            doctype: 'Material Request',\n            company: budget.company,\n            material_request_type: 'Purchase',\n            custom_linked_budget: budget.name,\n            items: [\n                {\n                    doctype: 'Material Request Item',\n                    item_code: mapped_item_code,\n                    qty: line.custom_number_of_units || 1,\n                    schedule_date: budget.to_date || frappe.datetime.nowdate(),\n                    description: line.custom_remarks || '',\n                    // These two assume you have matching fields on MR Item\n                    expense_account: line.account,\n                    rate: line.custom_expected_price || 0\n                }\n            ]\n        };\n\n        frappe.call({\n            method: 'frappe.client.insert',\n            args: { doc: mr_doc },\n            freeze: true,\n            freeze_message: __('Creating Purchase Requisition...'),\n            callback: function (r) {\n                if (r.exc) {\n                    frappe.msgprint(__('Error while creating Material Request.'));\n                    return;\n                }\n                const mr = r.message;\n                frappe.msgprint(__('Material Request {0} created.', [mr.name]));\n                frappe.set_route('Form', 'Material Request', mr.name);\n            }\n        });\n\n        return;\n    }\n\n    // -------- Non-CAPEX: open new MR form with only header prefilled --------\n    frappe.model.with_doctype('Material Request', () => {\n        const mr = frappe.model.get_new_doc('Material Request');\n        mr.company = budget.company;\n        mr.material_request_type = 'Purchase';\n        mr.custom_linked_budget = budget.name;\n\n        // No items added here – user captures them manually\n        frappe.set_route('Form', 'Material Request', mr.name);\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-11-22 23:55:24.484315",
  "module": "ExN",
  "name": "Validation button",
  "script": "frappe.ui.form.on('Budget', {\n    refresh(frm) {\n        // Add a \"Validate Budget\" button that does NOT save\n        frm.add_custom_button(__('Validate Budget'), () => {\n            validate_budget_client(frm);\n        });\n    }\n});\n\n// Main validation function\nfunction validate_budget_client(frm) {\n    const d = frm.doc || {};\n    const issues = [];\n    const warnings = [];\n    const infoBlocks = [];\n\n    const budget_type = d.budget_type;\n    const fiscal_year = d.fiscal_year;\n    const cost_center = d.cost_center;\n    const project = d.project;\n    const consolidation_group = d.custom_consolidation_group;\n    const accounts = d.accounts || [];\n\n    // ---------------------------------------------------------\n    // 1. Basic sanity check\n    // ---------------------------------------------------------\n    if (!accounts.length) {\n        issues.push('Budget Accounts table is empty. Please add at least one Budget Account line.');\n    }\n\n    // ---------------------------------------------------------\n    // 2. OPEX rules\n    // ---------------------------------------------------------\n    if (budget_type === 'OPEX') {\n        const missingRemarks = [];\n        const missingDistribution = [];\n\n        (accounts || []).forEach(row => {\n            const idx = row.idx || row.name || '?';\n\n            if (!row.custom_remarks) {\n                missingRemarks.push(String(idx));\n            }\n            if (!row.custom_monthly_distribution) {\n                missingDistribution.push(String(idx));\n            }\n        });\n\n        if (missingRemarks.length) {\n            issues.push(\n                'OPEX budget: Remarks (custom_remarks) are missing on Budget Account rows: ' +\n                missingRemarks.join(', ')\n            );\n        }\n\n        if (missingDistribution.length) {\n            issues.push(\n                'OPEX budget: Monthly Distribution (custom_monthly_distribution) is missing on Budget Account rows: ' +\n                missingDistribution.join(', ')\n            );\n        }\n    }\n\n    // ---------------------------------------------------------\n    // 3. CAPEX rules\n    // ---------------------------------------------------------\n    if (budget_type === 'CAPEX') {\n        const missingAssetCat = [];\n        const missingUnits = [];\n        const missingPrice = [];\n        const missingRemarksCapex = [];\n\n        (accounts || []).forEach(row => {\n            const idx = row.idx || row.name || '?';\n\n            if (!row.custom_asset_category) {\n                missingAssetCat.push(String(idx));\n            }\n            if (!row.custom_number_of_units) {\n                missingUnits.push(String(idx));\n            }\n            if (!row.custom_expected_price) {\n                missingPrice.push(String(idx));\n            }\n            if (!row.custom_remarks) {\n                missingRemarksCapex.push(String(idx));\n            }\n        });\n\n        if (missingAssetCat.length) {\n            issues.push(\n                'CAPEX budget: Asset Category (custom_asset_category) is missing on Budget Account rows: ' +\n                missingAssetCat.join(', ')\n            );\n        }\n        if (missingUnits.length) {\n            issues.push(\n                'CAPEX budget: Number of Units (custom_number_of_units) is missing on Budget Account rows: ' +\n                missingUnits.join(', ')\n            );\n        }\n        if (missingPrice.length) {\n            issues.push(\n                'CAPEX budget: Expected Price (custom_expected_price) is missing on Budget Account rows: ' +\n                missingPrice.join(', ')\n            );\n        }\n        if (missingRemarksCapex.length) {\n            issues.push(\n                'CAPEX budget: Remarks (custom_remarks) are missing on Budget Account rows: ' +\n                missingRemarksCapex.join(', ')\n            );\n        }\n    }\n\n    // ---------------------------------------------------------\n    // 4. Property CAPEX / Property Expenses rules\n    // ---------------------------------------------------------\n    if (['Property CAPEX', 'Property Expenses'].includes(budget_type)) {\n        if (!project) {\n            issues.push(\n                'Property budget: A linked Project is expected on the Budget header for Property CAPEX/Property Expenses.'\n            );\n        }\n    }\n\n    // ---------------------------------------------------------\n    // 5. Training budgets – HR - Training consolidation group\n    // ---------------------------------------------------------\n    if (consolidation_group === 'HR - Training') {\n        const nonTrainingAccounts = [];\n\n        (accounts || []).forEach(row => {\n            const accName = (row.account || '').toLowerCase();\n            if (accName && !accName.includes('train')) {\n                nonTrainingAccounts.push(row.account);\n            }\n        });\n\n        if (nonTrainingAccounts.length) {\n            warnings.push(\n                \"Training budget: Consolidation Group is 'HR - Training', but the following accounts may not be training accounts: \" +\n                nonTrainingAccounts.join(', ')\n            );\n        }\n    }\n\n    // ---------------------------------------------------------\n    // 6. Compute current budget total\n    // ---------------------------------------------------------\n    let total_current = 0.0;\n    (accounts || []).forEach(row => {\n        const amt = row.budget_amount || 0.0;\n        total_current += amt;\n    });\n\n    // ---------------------------------------------------------\n    // Helper: show the dialog \"page\"\n    // ---------------------------------------------------------\n    function show_validation_dialog() {\n        const name = d.name || 'New Budget';\n\n        const parts = [];\n        parts.push(\"<div style='max-height:70vh; overflow:auto;'>\");\n        parts.push(\"<h3>Budget Validation – \" + frappe.utils.escape_html(name) + \"</h3>\");\n\n        parts.push(\n            \"<p><b>Type:</b> \" + frappe.utils.escape_html(budget_type || '') +\n            \" &nbsp; <b>Fiscal Year:</b> \" + frappe.utils.escape_html(fiscal_year || '') +\n            \" &nbsp; <b>Cost Center:</b> \" + frappe.utils.escape_html(cost_center || '') +\n            \" &nbsp; <b>Project:</b> \" + frappe.utils.escape_html(project || '') + \"</p>\"\n        );\n\n        // Issues\n        if (issues.length) {\n            parts.push('<h4>Issues / Gaps (review recommended)</h4>');\n            parts.push('<ul>');\n            issues.forEach(e => {\n                parts.push('<li>' + frappe.utils.escape_html(e) + '</li>');\n            });\n            parts.push('</ul>');\n        } else {\n            parts.push('<h4>Issues / Gaps</h4><p>No issues detected based on current rules.</p>');\n        }\n\n        // Warnings\n        if (warnings.length) {\n            parts.push('<h4>Warnings</h4><ul>');\n            warnings.forEach(w => {\n                parts.push('<li>' + frappe.utils.escape_html(w) + '</li>');\n            });\n            parts.push('</ul>');\n        }\n\n        // Comparative info\n        if (infoBlocks.length) {\n            parts.push('<h4>Comparative Information</h4>');\n            infoBlocks.forEach(block => {\n                parts.push(\n                    \"<pre style='background:#f8f9fa; padding:8px; border-radius:4px; white-space:pre-wrap;'>\"\n                    + frappe.utils.escape_html(block) + \"</pre>\"\n                );\n            });\n        }\n\n        // Totals\n        parts.push('<h4>Totals</h4>');\n        parts.push(\n            '<p><b>Current budget total:</b> ' +\n            frappe.format(total_current, { fieldtype: 'Currency' }) +\n            ' (company currency)</p>'\n        );\n\n        parts.push(\n            \"<p style='margin-top:16px; font-size:90%; color:#666;'>\"\n            + \"Validation is advisory only and does not block saving or submission.\"\n            + \"</p>\"\n        );\n        parts.push('</div>');\n\n        const html = parts.join('');\n\n        const dlg = new frappe.ui.Dialog({\n            title: __('Budget Validation'),\n            size: 'large',\n            primary_action_label: __('Close'),\n            primary_action() {\n                dlg.hide();\n            }\n        });\n\n        // ✅ This is the key fix\n        if (dlg.body) {\n            dlg.body.innerHTML = html;\n        } else if (dlg.$body) {\n            dlg.$body.html(html);\n        }\n\n        dlg.show();\n    }\n\n    // ---------------------------------------------------------\n    // 7. Previous-year comparison (async), then show dialog\n    // ---------------------------------------------------------\n    if (project && cost_center && budget_type && fiscal_year) {\n        frappe.db.get_value('Fiscal Year', fiscal_year, 'year_start_date')\n            .then(r => {\n                const year_start =\n                    r && r.message ? r.message.year_start_date :\n                    r && r.year_start_date ? r.year_start_date :\n                    null;\n\n                if (!year_start) {\n                    infoBlocks.push(\n                        \"Fiscal Year '\" + fiscal_year +\n                        \"' has no year_start_date, comparison skipped.\"\n                    );\n                    show_validation_dialog();\n                    return;\n                }\n\n                return frappe.db.get_list('Fiscal Year', {\n                    fields: ['name', 'year_start_date'],\n                    filters: [['year_start_date', '<', year_start]],\n                    order_by: 'year_start_date desc',\n                    limit: 1\n                }).then(prevFYs => {\n                    const list = Array.isArray(prevFYs)\n                        ? prevFYs\n                        : (prevFYs && prevFYs.message) || [];\n\n                    if (!list.length) {\n                        infoBlocks.push(\n                            'No previous Fiscal Year found before ' +\n                            fiscal_year + ' for comparison.'\n                        );\n                        show_validation_dialog();\n                        return;\n                    }\n\n                    const prevFyName = list[0].name;\n\n                    const budgetFilters = {\n                        fiscal_year: prevFyName,\n                        budget_type: budget_type,\n                        cost_center: cost_center\n                    };\n                    if (d.budget_against === 'Project') {\n                        budgetFilters.budget_against = 'Project';\n                    }\n\n                    return frappe.db.get_list('Budget', {\n                        fields: ['name'],\n                        filters: budgetFilters\n                    }).then(prevBudgets => {\n                        const bList = Array.isArray(prevBudgets)\n                            ? prevBudgets\n                            : (prevBudgets && prevBudgets.message) || [];\n\n                        if (!bList.length) {\n                            infoBlocks.push(\n                                'No similar budgets found in previous Fiscal Year ' +\n                                prevFyName + ' (same Budget Type and Cost Center).'\n                            );\n                            show_validation_dialog();\n                            return;\n                        }\n\n                        const promises = bList.map(b =>\n                            frappe.db.get_list('Budget Account', {\n                                fields: ['budget_amount'],\n                                filters: { parent: b.name }\n                            }).then(rows => {\n                                const rList = Array.isArray(rows)\n                                    ? rows\n                                    : (rows && rows.message) || [];\n                                let totalPrev = 0.0;\n                                (rList || []).forEach(rrow => {\n                                    totalPrev += rrow.budget_amount || 0.0;\n                                });\n                                return totalPrev;\n                            })\n                        );\n\n                        return Promise.all(promises).then(totals => {\n                            if (!totals || !totals.length) {\n                                infoBlocks.push(\n                                    'Previous Fiscal Year ' + prevFyName +\n                                    ' has no comparable Budget Account information.'\n                                );\n                                show_validation_dialog();\n                                return;\n                            }\n\n                            let countPrev = totals.length;\n                            let sumPrev = 0.0;\n                            let minPrev = null;\n                            let maxPrev = null;\n\n                            totals.forEach(v => {\n                                sumPrev += v;\n                                if (minPrev === null || v < minPrev) minPrev = v;\n                                if (maxPrev === null || v > maxPrev) maxPrev = v;\n                            });\n\n                            const avgPrev = countPrev ? (sumPrev / countPrev) : 0.0;\n\n                            const lines = [];\n                            lines.push(\n                                'Comparison with similar budgets in previous Fiscal Year ' +\n                                prevFyName + ' (same Budget Type and Cost Center):'\n                            );\n                            lines.push('- Number of previous budgets: ' + countPrev);\n                            lines.push('- Average total (company currency): ' + avgPrev);\n                            lines.push('- Minimum total (company currency): ' + minPrev);\n                            lines.push('- Maximum total (company currency): ' + maxPrev);\n                            lines.push('- Current budget total (company currency): ' + total_current);\n\n                            infoBlocks.push(lines.join('\\n'));\n\n                            show_validation_dialog();\n                        });\n                    });\n                });\n            })\n            .catch(() => {\n                infoBlocks.push('Comparison with previous year failed due to an error.');\n                show_validation_dialog();\n            });\n    } else {\n        // No project/FY/CC/type – just show the local validation\n        show_validation_dialog();\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Procurement Plan",
  "enabled": 1,
  "modified": "2025-11-23 23:21:42.657350",
  "module": "ExN",
  "name": "Create from budget",
  "script": "// List View Custom Script for \"Procurement Plan\"\n// Button: Create Plan from Budgets (OPEX/HR)\n// User selects Fiscal Year + Account (Link to Account).\n// Script then creates a Procurement Plan with one item per Budget\n// that uses that account (OPEX + HR Headcount only).\n\nfrappe.listview_settings['Procurement Plan'] = {\n    onload(listview) {\n        listview.page.add_inner_button(\n            __('Create Plan from Budgets (OPEX/HR)'),\n            function () {\n                open_budget_to_plan_dialog();\n            }\n        );\n    }\n};\n\n// --------------------------------------------------\n// Step 1: Dialog – choose Fiscal Year + Account\n// --------------------------------------------------\nfunction open_budget_to_plan_dialog() {\n    var dlg = new frappe.ui.Dialog({\n        title: __('Create Procurement Plan from Budgets'),\n        size: 'small',\n        fields: [\n            {\n                fieldtype: 'Link',\n                fieldname: 'fiscal_year',\n                label: __('Fiscal Year'),\n                options: 'Fiscal Year',\n                reqd: 0,\n                description: __('Leave blank to include all fiscal years.')\n            },\n            {\n                fieldtype: 'Link',\n                fieldname: 'account',\n                label: __('Account'),\n                options: 'Account',\n                reqd: 1,\n                description: __('Pick the GL account you want to build a Procurement Plan for.')\n            }\n        ],\n        primary_action_label: __('Create Procurement Plan'),\n        primary_action: function (values) {\n            var fiscalYear = values.fiscal_year || '';\n            var account = values.account || '';\n\n            if (!account) {\n                frappe.msgprint(__('Please select an Account.'));\n                return;\n            }\n\n            dlg.disable_primary_action();\n            create_plan_from_budgets_for_account(fiscalYear, account)\n                .then(function () {\n                    dlg.hide();\n                })\n                .finally(function () {\n                    dlg.enable_primary_action();\n                });\n        }\n    });\n\n    dlg.show();\n}\n\n// --------------------------------------------------\n// Step 2: Fetch Budgets + Budget Account rows for that Account\n// --------------------------------------------------\nfunction create_plan_from_budgets_for_account(fiscalYearFilter, account) {\n    return new Promise(function (resolve) {\n        var budgetTypes = ['OPEX', 'HR Headcount'];\n\n        var msg = 'Fetching budgets for OPEX and HR Headcount';\n        if (fiscalYearFilter) {\n            msg += ' in Fiscal Year ' + fiscalYearFilter;\n        }\n        msg += ' and account ' + account + '...';\n\n        frappe.show_alert({ message: msg, indicator: 'blue' });\n\n        var filters = {\n            budget_type: ['in', budgetTypes]\n        };\n        if (fiscalYearFilter) {\n            filters.fiscal_year = fiscalYearFilter;\n        }\n\n        // 1) Get Budgets\n        frappe.db.get_list('Budget', {\n            fields: ['name', 'fiscal_year', 'company', 'cost_center', 'custom_consolidation_group'],\n            filters: filters,\n            limit: 5000\n        }).then(function (budgets) {\n            budgets = Array.isArray(budgets) ? budgets : (budgets && budgets.message) || [];\n\n            console.log('Budgets result:', budgets);\n\n            if (!budgets.length) {\n                var noMsg = 'No Budgets found for types: ' + budgetTypes.join(', ');\n                if (fiscalYearFilter) {\n                    noMsg += ' in Fiscal Year ' + fiscalYearFilter;\n                }\n                frappe.msgprint(noMsg);\n                resolve();\n                return;\n            }\n\n            frappe.msgprint(__('Found {0} Budgets matching filters.', [String(budgets.length)]));\n\n            var budgetNames = [];\n            var budgetInfoByName = {};\n\n            budgets.forEach(function (b) {\n                if (b && b.name) {\n                    budgetNames.push(b.name);\n                    budgetInfoByName[b.name] = b;\n                }\n            });\n\n            if (!budgetNames.length) {\n                frappe.msgprint(__('No valid Budget names found (empty list after filtering).'));\n                resolve();\n                return;\n            }\n\n            // 2) Get Budget Account rows for these budgets AND this account\n            frappe.show_alert({\n                message: __('Fetching Budget Account rows for {0} budgets and account {1}...', [\n                    String(budgetNames.length),\n                    account\n                ]),\n                indicator: 'blue'\n            });\n\n            frappe.db.get_list('Budget Account', {\n                fields: ['parent', 'budget_amount'],\n                filters: {\n                    parent: ['in', budgetNames],\n                    account: account\n                },\n                limit: 20000\n            }).then(function (baRows) {\n                baRows = Array.isArray(baRows) ? baRows : (baRows && baRows.message) || [];\n\n                console.log('Budget Account rows for account', account, ':', baRows);\n\n                if (!baRows.length) {\n                    frappe.msgprint(__('No Budget Account rows found for account: {0}', [account]));\n                    resolve();\n                    return;\n                }\n\n                frappe.msgprint(\n                    __('Found {0} Budget Account rows for account {1}.', [\n                        String(baRows.length),\n                        account\n                    ])\n                );\n\n                // 3) Aggregate amount per Budget\n                var amountByBudget = {};\n                baRows.forEach(function (row) {\n                    if (!row || !row.parent) return;\n                    var parent = row.parent;\n                    var amt = row.budget_amount || 0;\n                    if (!amountByBudget[parent]) {\n                        amountByBudget[parent] = 0;\n                    }\n                    amountByBudget[parent] += amt;\n                });\n\n                var budgetNamesForAccount = Object.keys(amountByBudget);\n\n                if (!budgetNamesForAccount.length) {\n                    frappe.msgprint(__('No Budget totals computed for account: {0}', [account]));\n                    resolve();\n                    return;\n                }\n\n                // 4) Build and insert the Procurement Plan\n                build_and_insert_procurement_plan_from_budget_totals(\n                    fiscalYearFilter,\n                    account,\n                    budgetInfoByName,\n                    amountByBudget,\n                    budgetNamesForAccount\n                ).then(function () {\n                    resolve();\n                });\n            }).catch(function (err) {\n                console.error('Error while fetching Budget Account rows', err);\n                frappe.msgprint(__('Error while fetching Budget Account rows. Check console for details.'));\n                resolve();\n            });\n\n        }).catch(function (err) {\n            console.error('Error while fetching Budgets', err);\n            frappe.msgprint(__('Error while fetching Budgets. Check console for details.'));\n            resolve();\n        });\n    });\n}\n\n// --------------------------------------------------\n// Step 3: Build and insert Procurement Plan\n// --------------------------------------------------\nfunction build_and_insert_procurement_plan_from_budget_totals(\n    fiscalYearFilter,\n    account,\n    budgetInfoByName,\n    amountByBudget,\n    budgetNamesForAccount\n) {\n    return new Promise(function (resolve) {\n        var firstBudgetName = budgetNamesForAccount[0];\n        var firstBudget = budgetInfoByName[firstBudgetName] || {};\n        var fiscalYear = firstBudget.fiscal_year || '';\n        var company = firstBudget.company || '';\n\n        var doc = {\n            doctype: 'Procurement Plan',\n            fiscal_year: fiscalYear,\n            company: company,\n            total_value: 0,\n            procurement_type: '',\n            source_of_funds: '',\n            procurement_method: '',\n            items: []\n        };\n\n        var totalValue = 0;\n        var count = 0;\n\n        budgetNamesForAccount.forEach(function (budgetName) {\n            var amount = amountByBudget[budgetName] || 0;\n            var info = budgetInfoByName[budgetName] || {};\n\n            var cc = info.cost_center || '';\n            var consol = info.custom_consolidation_group || '';\n            var fy = info.fiscal_year || '';\n\n            var parts = [];\n            parts.push('Budget: ' + budgetName);\n            if (fy) {\n                parts.push('Fiscal Year: ' + fy);\n            }\n            if (cc) {\n                parts.push('Cost Center: ' + cc);\n            }\n            if (consol) {\n                parts.push('Group: ' + consol);\n            }\n            parts.push('Account: ' + account);\n            parts.push('Amount: ' + String(amount));\n\n            var description = parts.join(' | ');\n\n            doc.items.push({\n                description: description,\n                unit: 'Lot',\n                quantity: 1\n            });\n\n            totalValue += amount;\n            count += 1;\n        });\n\n        doc.total_value = totalValue;\n\n        frappe.call({\n            method: 'frappe.client.insert',\n            args: { doc: doc },\n            callback: function (r) {\n                var inserted = (r && r.message) ? r.message : null;\n\n                if (!inserted || !inserted.name) {\n                    frappe.msgprint(__('Failed to create Procurement Plan. Please check the console for details.'));\n                    console.error('Insert result', r);\n                } else {\n                    var msg = 'Created Procurement Plan: ' + inserted.name +\n                              ' with ' + String(count) + ' items. Total value: ' + String(totalValue);\n                    if (fiscalYearFilter) {\n                        msg += ' (Fiscal Year filter: ' + fiscalYearFilter + ')';\n                    }\n                    frappe.msgprint(msg);\n                    frappe.set_route('Form', 'Procurement Plan', inserted.name);\n                }\n                resolve();\n            },\n            error: function (err) {\n                console.error('Error inserting Procurement Plan', err);\n                frappe.msgprint(__('Error inserting Procurement Plan. See console for details.'));\n                resolve();\n            }\n        });\n    });\n}\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Opening",
  "enabled": 1,
  "modified": "2025-11-24 10:46:07.296289",
  "module": null,
  "name": "Auto pull Job requisition fields",
  "script": "frappe.ui.form.on('Job Opening', {\r\n    job_title: function(frm) {\r\n        if (frm.doc.job_title) {\r\n            // First, let's check what doctype job_title is linked to\r\n            // It could be \"Designation\" or a custom \"Job Position\" doctype\r\n            \r\n            // Get the link doctype for job_title field\r\n            frappe.model.with_doctype('Job Opening', function() {\r\n                let meta = frappe.get_meta('Job Opening');\r\n                let job_title_field = meta.fields.find(f => f.fieldname === 'job_title');\r\n                \r\n                if (job_title_field && job_title_field.options) {\r\n                    let linked_doctype = job_title_field.options;\r\n                    \r\n                    // Fetch data from the linked doctype\r\n                    frappe.call({\r\n                        method: 'frappe.client.get_value',\r\n                        args: {\r\n                            doctype: linked_doctype,\r\n                            filters: {\r\n                                name: frm.doc.job_title\r\n                            },\r\n                            fieldname: ['custom_expected_grade', 'expected_compensation', 'custom_contract_type', 'department']\r\n                        },\r\n                        callback: function(r) {\r\n                            if (r.message) {\r\n                                // Set the fields with data from the source doctype\r\n                                if (r.message.custom_expected_grade) {\r\n                                    frm.set_value('custom_expected_grade', r.message.custom_expected_grade);\r\n                                }\r\n                                if (r.message.expected_compensation) {\r\n                                    frm.set_value('lower_range', r.message.expected_compensation);\r\n                                    frm.set_value('upper_range', r.message.expected_compensation);\r\n                                }\r\n                                if (r.message.custom_contract_type) {\r\n                                    frm.set_value('employment_type', r.message.custom_contract_type);\r\n                                }\r\n                                if (r.message.department) {\r\n                                    frm.set_value('department', r.message.department);\r\n                                }\r\n                                \r\n                                // Refresh the form to show updated values\r\n                                frm.refresh_fields();\r\n                            }\r\n                        },\r\n                        error: function(r) {\r\n                            console.log('Error fetching job position details:', r);\r\n                            frappe.msgprint(__('Could not fetch job position details. Please check if the fields exist in the {0} doctype.', [linked_doctype]));\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Requisition",
  "enabled": 1,
  "modified": "2025-12-01 12:09:19.955366",
  "module": null,
  "name": "Requested By - Autofill",
  "script": "frappe.ui.form.on('Job Requisition', {\r\n    onload(frm) {\r\n        // Set requested_by to current user on new document only\r\n        if (frm.is_new() && !frm.doc.requested_by) {\r\n            frm.set_value('requested_by', frappe.session.user);\r\n            \r\n            // Set the user's full name if available\r\n            frappe.db.get_value('User', frappe.session.user, 'full_name', (r) => {\r\n                if (r && r.full_name) {\r\n                    frm.set_value('requested_by_name', r.full_name);\r\n                }\r\n            });\r\n        }\r\n    },\r\n    \r\n    refresh(frm) {\r\n        // Make requested_by read-only at all times (visible but not editable)\r\n        frm.set_df_property('requested_by', 'read_only', 1);\r\n        frm.set_df_property('requested_by_name', 'read_only', 1);\r\n    },\r\n    \r\n    requested_by(frm) {\r\n        // Update name when requested_by changes (in case it's changed programmatically)\r\n        if (frm.doc.requested_by) {\r\n            frappe.db.get_value('User', frm.doc.requested_by, 'full_name', (r) => {\r\n                if (r && r.full_name) {\r\n                    frm.set_value('requested_by_name', r.full_name);\r\n                }\r\n            });\r\n        } else {\r\n            frm.set_value('requested_by_name', '');\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget",
  "enabled": 1,
  "modified": "2025-11-29 08:12:25.755745",
  "module": "ExN",
  "name": "Workflow History",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Budget', {\n    refresh: function(frm) {\n        // Only show for saved documents with a workflow state\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Staffing Plan",
  "enabled": 1,
  "modified": "2025-12-01 11:51:57.430235",
  "module": null,
  "name": "Workflow Approval History - Staffing Plan",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Staffing Plan', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-10-21 22:56:57.826965",
  "module": "HR Screening",
  "name": "Client Script for Job Applicant",
  "script": "// ===================================================================\n// MAIN JOB APPLICANT CLIENT SCRIPT\n// ===================================================================\n\nasync function resolve_opening(val) {\n  if (!val) return null;\n  try {\n    const a = await frappe.db.get_value('Job Opening', val, 'name');\n    if (a && a.message && a.message.name) return a.message.name;\n  } catch (e) {}\n  try {\n    const b = await frappe.db.get_value('Job Opening', { job_title: val }, 'name');\n    if (b && b.message && b.message.name) return b.message.name;\n  } catch (e) {}\n  return null;\n}\n\nfrappe.ui.form.on('Job Applicant', {\n  async refresh(frm) {\n    // Show/hide Screen button based on Job Opening.enable_advanced_screening\n    if (frm.doc.job_title) {\n      try {\n        const opening_name = await resolve_opening(frm.doc.job_title);\n        if (opening_name) {\n          const r = await frappe.db.get_value('Job Opening', opening_name, 'enable_advanced_screening');\n          const enabled = !!(r && r.message && r.message.enable_advanced_screening);\n          if (enabled) {\n            frm.add_custom_button(__('Screen Applicant'), () => {\n              frappe.call({\n                method: 'hr_screening.api.screening.screen_applicant',\n                args: { name: frm.doc.name },\n                freeze: true,\n                callback: () => frm.reload_doc(),\n              });\n            }, __('Screening'));\n          }\n        }\n      } catch (e) { /* ignore */ }\n    }\n\n    // Header indicator: use last_screened_on and show score\n    const pct = flt(frm.doc.final_score || 0);\n    const screened = !!frm.doc.last_screened_on;\n    let color = 'gray', label = __('Not Screened');\n    if (screened) {\n      if (pct < 50) { color = 'red'; }\n      else if (pct >= 80) { color = 'green'; }\n      else { color = 'blue'; }\n      const base = frm.doc.screening_label || __('Screened');\n      label = `${base} (${pct}%)`;\n    }\n    frm.dashboard.clear_headline();\n    frm.dashboard.set_headline(`<span class=\\\"indicator ${color}\\\">${label}</span>`);\n\n    // Update UI warnings for police clearance issue date\n    check_and_update_ui(frm);\n  },\n  \n  nationality(frm) { \n    toggle_work_auth(frm); \n  },\n  \n  country(frm) {\n    // Auto-populate nationality with country value\n    if (frm.doc.country && !frm.doc.nationality) {\n      frm.set_value('nationality', frm.doc.country);\n    }\n  },\n  \n  onload_post_render(frm) { \n    toggle_work_auth(frm); \n    check_and_update_ui(frm); \n  },\n  \n  police_clearance_issue_date(frm) { \n    check_and_update_ui(frm); \n  },\n  \n  validate(frm) {\n    if (!validate_police_issue_date(frm)) { return false; }\n    const issue = frm.doc.police_clearance_issue_date;\n    if (issue) {\n      const days = frappe.datetime.get_day_diff(frappe.datetime.get_today(), issue);\n      if (days > 90) {\n        frappe.msgprint({ \n          title: __('Police Clearance is older than 90 days'), \n          message: __('Police Clearance must not be older than 3 months (90 days).'), \n          indicator: 'orange' \n        });\n      }\n    }\n  },\n});\n\nfunction toggle_work_auth(frm) {\n  const is_zambian = (frm.doc.nationality_name || frm.doc.nationality || '').toLowerCase().includes('zambia');\n  frm.toggle_display('work_authorization', !is_zambian);\n  frm.toggle_display('work_authorization_proof', !is_zambian);\n}\n\nfunction validate_police_issue_date(frm) {\n  const issue_date = frm.doc.police_clearance_issue_date;\n  if (!issue_date) { return true; }\n  if (is_future_date(issue_date)) {\n    frappe.msgprint({ \n      title: __('Invalid Police Clearance Issue Date'), \n      message: __('Police Clearance Issue Date cannot be in the future. Please select today or a past date.'), \n      indicator: 'red' \n    });\n    frappe.validated = false;\n    return false;\n  }\n  return true;\n}\n\nfunction is_future_date(date_value) {\n  if (!date_value) return false;\n  try {\n    const input_date = frappe.datetime.str_to_obj(date_value);\n    const today = frappe.datetime.str_to_obj(frappe.datetime.get_today());\n    if (!input_date || !today) return false;\n    input_date.setHours(0, 0, 0, 0);\n    today.setHours(0, 0, 0, 0);\n    return input_date > today;\n  } catch (e) { return false; }\n}\n\nfunction check_and_update_ui(frm) {\n  const issue_date = frm.doc.police_clearance_issue_date;\n  if (issue_date && is_future_date(issue_date)) {\n    frm.disable_save();\n    frm.set_df_property('police_clearance_issue_date', 'description', '<span style=\\\"color: red;\\\">⚠ '+__('Date cannot be in the future')+'</span>');\n  } else {\n    frm.enable_save();\n    frm.set_df_property('police_clearance_issue_date', 'description', '');\n  }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-10-21 07:46:23.459151",
  "module": "HR Screening",
  "name": "Client Script for Job Applicant List",
  "script": "frappe.listview_settings['Job Applicant'] = frappe.listview_settings['Job Applicant'] || {};\nfrappe.listview_settings['Job Applicant'].onload = function(listview) {\n  listview.page.add_menu_item(__('Screening'), () => {\n    frappe.db.get_list('Job Opening', { filters: { status: 'Open' }, fields: ['name','job_title','enable_advanced_screening'], limit: 500 }).then(openings => {\n      const enabled = (openings||[]).filter(o => o.enable_advanced_screening);\n      const options = [{ label: __('Select...'), value: '' }].concat(enabled.map(o => ({ label: o.job_title || o.name, value: o.name })));\n      const d = new frappe.ui.Dialog({\n        title: __('Rank Applicants by Job Opening'),\n        fields: [\n          { fieldname: 'job_opening', label: __('Job Opening'), fieldtype: 'Select', options: options, reqd: 1 },\n          { fieldname: 'run_screening', label: __('Recalculate screening scores now'), fieldtype: 'Check', default: 1 },\n        ],\n        primary_action_label: __('Apply'),\n        primary_action: (values) => {\n          if (!values || !values.job_opening) return;\n          const proceed = () => {\n            frappe.route_options = { job_title: values.job_opening };\n            frappe.set_route('List', 'Job Applicant');\n            setTimeout(() => {\n              if (listview.sort_selector && listview.sort_selector.set_value) { listview.sort_selector.set_value('final_score', 'desc'); }\n              else { listview.sort_by = 'final_score'; listview.sort_order = 'desc'; listview.refresh(); }\n            }, 300);\n            d.hide();\n          };\n          if (values.run_screening) {\n            frappe.call({\n              method: 'hr_screening.api.screening.screen_applicants',\n              args: { job_opening: values.job_opening },\n              freeze: true,\n              callback: () => proceed(),\n            });\n          } else { proceed(); }\n        },\n      });\n      d.show();\n    });\n  });\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Opening",
  "enabled": 1,
  "modified": "2025-10-21 07:46:23.470999",
  "module": "HR Screening",
  "name": "Client Script for Job Opening",
  "script": "frappe.ui.form.on('Job Opening', {\n  refresh(frm) {\n    if (frm.doc.enable_advanced_screening) {\n      frm.add_custom_button(__('Screen Applicants'), () => {\n        if (!frm.doc.name) return;\n        frappe.call({\n          method: 'hr_screening.api.screening.screen_applicants',\n          args: { job_opening: frm.doc.name },\n          freeze: true,\n          callback: (r) => {\n            frappe.show_alert({ message: __('Screened {0} applicants', [r.message && r.message.screened || 0]), indicator: 'green' });\n          },\n        });\n      }, __('Screening'));\n    }\n  },\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-10-21 07:46:23.481813",
  "module": "HR Screening",
  "name": "Client Script for Job Applicant Screening Visibility",
  "script": "frappe.ui.form.on('Job Applicant', {\n  refresh(frm) { apply_screening_visibility(frm); },\n  onload_post_render(frm) { apply_screening_visibility(frm); },\n  job_title(frm) { apply_screening_visibility(frm); },\n});\n\nasync function resolve_opening(val) {\n  if (!val) return null;\n  try {\n    const a = await frappe.db.get_value('Job Opening', val, 'name');\n    if (a && a.message && a.message.name) return a.message.name;\n  } catch (e) {}\n  try {\n    const b = await frappe.db.get_value('Job Opening', { job_title: val }, 'name');\n    if (b && b.message && b.message.name) return b.message.name;\n  } catch (e) {}\n  return null;\n}\n\nasync function apply_screening_visibility(frm) {\n  const opening = await resolve_opening(frm.doc.job_title);\n  const enabled = await get_enable_screening(opening);\n  const screened = !!frm.doc.last_screened_on;\n  toggle_eligibility_fields(frm, !!enabled);\n  toggle_result_fields(frm, !!screened);\n}\n\nasync function get_enable_screening(name) {\n  if (!name) return false;\n  try {\n    const r = await frappe.db.get_value('Job Opening', name, 'enable_advanced_screening');\n    return !!(r && r.message && r.message.enable_advanced_screening);\n  } catch (e) {\n    console.warn('Enable Screening fetch failed', e);\n    return false;\n  }\n}\n\nfunction toggle_eligibility_fields(frm, show) {\n  const eligibility = [\n    'screening_eligibility_section','nationality','years_of_experience','highest_education_level','screening_eligibility_cb','id_type','id_number','id_scan','police_clearance_issue_date','police_clearance_file','relocation_willingness','notice_period_days','work_authorization','work_authorization_proof'\n  ];\n  eligibility.forEach(fn => frm.toggle_display(fn, show));\n  if (!show) { frm.enable_save(); frm.set_df_property('police_clearance_issue_date', 'description', ''); }\n}\n\nfunction toggle_result_fields(frm, show) {\n  const results = [\n    'screening_results_section','screening_label','eligible','qualification_score','completeness_score','final_score','last_screened_on','missing_requirements','screening_summary','screening_details','experience_over_target','screening_comparison_section','screening_comparison_html'\n  ];\n  results.forEach(fn => frm.toggle_display(fn, show));\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-10-21 22:56:02.912093",
  "module": "HR Screening",
  "name": "Job Applicant Screening Rate System",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n  before_save(frm) {\r\n    // Calculate screening scores before saving\r\n    calculate_screening_scores(frm);\r\n  },\r\n});\r\n\r\nasync function calculate_screening_scores(frm) {\r\n  if (!frm.doc.job_title) return;\r\n  \r\n  try {\r\n    // Fetch job opening requirements\r\n    const job_data = await frappe.db.get_value('Job Opening', frm.doc.job_title, [\r\n      'required_nationality',\r\n      'min_experience_years',\r\n      'required_education_level',\r\n      'require_id_document',\r\n      'require_police_clearance',\r\n      'document_validity_days'\r\n    ]);\r\n    \r\n    if (!job_data || !job_data.message) return;\r\n    const requirements = job_data.message;\r\n    \r\n    // Calculate qualification score (70%)\r\n    const qualification_score = calculate_qualification_score(frm, requirements);\r\n    frm.set_value('qualification_score', qualification_score);\r\n    \r\n    // Calculate completeness score (30%)\r\n    const completeness_score = calculate_completeness_score(frm, requirements);\r\n    frm.set_value('completeness_score', completeness_score);\r\n    \r\n    // Calculate final score\r\n    const final_score = (qualification_score * 0.7) + (completeness_score * 0.3);\r\n    frm.set_value('final_score', final_score);\r\n    \r\n    // Build screening summary table and missing requirements\r\n    await build_screening_summary(frm, requirements);\r\n    \r\n  } catch (e) {\r\n    console.error('Error calculating screening scores:', e);\r\n  }\r\n}\r\n\r\nfunction calculate_qualification_score(frm, requirements) {\r\n  let total_points = 0;\r\n  let earned_points = 0;\r\n  let points_per_requirement = 0;\r\n  let requirement_count = 0;\r\n  \r\n  // Count active requirements\r\n  if (requirements.required_nationality) requirement_count++;\r\n  if (requirements.min_experience_years) requirement_count++;\r\n  if (requirements.required_education_level) requirement_count++;\r\n  if (requirements.require_id_document) requirement_count++;\r\n  if (requirements.require_police_clearance) requirement_count++;\r\n  \r\n  if (requirement_count === 0) return 100;\r\n  \r\n  points_per_requirement = 100 / requirement_count;\r\n  total_points = 100;\r\n  \r\n  // 1. Nationality check\r\n  if (requirements.required_nationality) {\r\n    const applicant_nationality = (frm.doc.nationality_name || frm.doc.nationality || '').toLowerCase();\r\n    const required_nationality = (requirements.required_nationality || '').toLowerCase();\r\n    if (applicant_nationality.includes(required_nationality)) {\r\n      earned_points += points_per_requirement;\r\n    }\r\n  }\r\n  \r\n  // 2. Experience check\r\n  if (requirements.min_experience_years) {\r\n    const required_exp = parseInt(requirements.min_experience_years || 0, 10);\r\n    const applicant_exp = parseInt(frm.doc.years_of_experience || 0, 10);\r\n    \r\n    if (applicant_exp >= required_exp) {\r\n      earned_points += points_per_requirement;\r\n      \r\n      // Check if over target and tick checkbox\r\n      if (applicant_exp > required_exp) {\r\n        frm.set_value('experience_over_target', 1);\r\n      } else {\r\n        frm.set_value('experience_over_target', 0);\r\n      }\r\n    } else {\r\n      // Partial credit for experience (proportional)\r\n      const partial = (applicant_exp / required_exp) * points_per_requirement;\r\n      earned_points += Math.min(partial, points_per_requirement);\r\n      frm.set_value('experience_over_target', 0);\r\n    }\r\n  }\r\n  \r\n  // 3. Education check with hierarchical rating\r\n  if (requirements.required_education_level) {\r\n    const education_points = calculate_education_score(\r\n      requirements.required_education_level,\r\n      frm.doc.highest_education_level,\r\n      points_per_requirement\r\n    );\r\n    earned_points += education_points;\r\n  }\r\n  \r\n  // 4. ID Document check\r\n  if (requirements.require_id_document) {\r\n    if (frm.doc.id_scan) {\r\n      earned_points += points_per_requirement;\r\n    }\r\n  }\r\n  \r\n  // 5. Police Clearance check\r\n  if (requirements.require_police_clearance) {\r\n    const valid_days = parseInt(requirements.document_validity_days || 90, 10);\r\n    const file_ok = !!frm.doc.police_clearance_file;\r\n    \r\n    if (file_ok) {\r\n      let is_valid = true;\r\n      if (frm.doc.police_clearance_issue_date) {\r\n        try {\r\n          const days = frappe.datetime.get_day_diff(\r\n            frappe.datetime.get_today(), \r\n            frm.doc.police_clearance_issue_date\r\n          );\r\n          if (days > valid_days) {\r\n            is_valid = false;\r\n          }\r\n        } catch(e) {}\r\n      }\r\n      \r\n      if (is_valid) {\r\n        earned_points += points_per_requirement;\r\n      } else {\r\n        // Partial credit for expired document\r\n        earned_points += points_per_requirement * 0.5;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return Math.round(earned_points * 100) / 100;\r\n}\r\n\r\nfunction calculate_education_score(required_level, applicant_level, max_points) {\r\n  const education_hierarchy = {\r\n    'Secondary': 1,\r\n    'Diploma': 2,\r\n    'Bachelor': 3,\r\n    'Master': 4,\r\n    'PhD': 5\r\n  };\r\n  \r\n  const required_rank = education_hierarchy[required_level] || 0;\r\n  const applicant_rank = education_hierarchy[applicant_level] || 0;\r\n  \r\n  if (required_rank === 0 || applicant_rank === 0) {\r\n    return 0;\r\n  }\r\n  \r\n  if (applicant_rank === required_rank) {\r\n    // Exact match - full points\r\n    return max_points;\r\n  } else if (applicant_rank > required_rank) {\r\n    // Over-qualified - full points (meets requirement)\r\n    return max_points;\r\n  } else {\r\n    // Under-qualified - proportional points based on hierarchy\r\n    // The closer to required, the more points\r\n    const points_per_level = max_points / required_rank;\r\n    return applicant_rank * points_per_level;\r\n  }\r\n}\r\n\r\nfunction calculate_completeness_score(frm, requirements) {\r\n  let total_fields = 0;\r\n  let completed_fields = 0;\r\n  \r\n  // Required fields for all applicants\r\n  const base_fields = [\r\n    'applicant_name',\r\n    'email_id',\r\n    'country',\r\n    'nationality',\r\n    'years_of_experience',\r\n    'highest_education_level',\r\n    'id_type',\r\n    'id_number',\r\n    'id_scan',\r\n    'police_clearance_issue_date',\r\n    'police_clearance_file'\r\n  ];\r\n  \r\n  // Check base fields\r\n  for (const field of base_fields) {\r\n    total_fields++;\r\n    if (field === 'id_scan' || field === 'police_clearance_file') {\r\n      if (frm.doc[field]) completed_fields++;\r\n    } else {\r\n      if (frm.doc[field] && String(frm.doc[field]).trim()) completed_fields++;\r\n    }\r\n  }\r\n  \r\n  // Resume: attachment OR link (at least one)\r\n  total_fields++;\r\n  if (frm.doc.resume_attachment || (frm.doc.resume_link && String(frm.doc.resume_link).trim())) {\r\n    completed_fields++;\r\n  }\r\n  \r\n  // Work authorization fields (only for non-Zambians)\r\n  const is_zambian = (frm.doc.nationality_name || frm.doc.nationality || '').toLowerCase().includes('zambia');\r\n  if (!is_zambian) {\r\n    total_fields += 2;\r\n    if (frm.doc.work_authorization && String(frm.doc.work_authorization).trim()) completed_fields++;\r\n    if (frm.doc.work_authorization_proof) completed_fields++;\r\n  }\r\n  \r\n  if (total_fields === 0) return 100;\r\n  \r\n  const score = (completed_fields / total_fields) * 100;\r\n  return Math.round(score * 100) / 100;\r\n}\r\n\r\nasync function build_screening_summary(frm, requirements) {\r\n  // Clear existing child table\r\n  frm.clear_table('screening_details');\r\n  \r\n  const missing_items = [];\r\n  \r\n  // 1. Nationality\r\n  if (requirements.required_nationality) {\r\n    const applicant_nationality = frm.doc.nationality_name || frm.doc.nationality || '-';\r\n    const required_nationality = requirements.required_nationality;\r\n    const matches = (applicant_nationality.toLowerCase()).includes(required_nationality.toLowerCase());\r\n    \r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('Nationality: ') + required_nationality;\r\n    row.value = applicant_nationality;\r\n    if (!matches) {\r\n      row.value += ' (' + __('Required: ') + required_nationality + ')';\r\n      missing_items.push(__('Required nationality: ') + required_nationality);\r\n    }\r\n  }\r\n  \r\n  // 2. Experience\r\n  if (requirements.min_experience_years) {\r\n    const required_exp = parseInt(requirements.min_experience_years || 0, 10);\r\n    const applicant_exp = parseInt(frm.doc.years_of_experience || 0, 10);\r\n    \r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('Minimum Experience: ') + required_exp + ' ' + __('years');\r\n    row.value = applicant_exp + ' ' + __('years');\r\n    \r\n    if (applicant_exp < required_exp) {\r\n      const shortfall = required_exp - applicant_exp;\r\n      row.value += ' (' + __('Short by ') + shortfall + ' ' + __('years') + ')';\r\n      missing_items.push(__('Additional ') + shortfall + ' ' + __('years of experience'));\r\n    } else if (applicant_exp > required_exp) {\r\n      row.value += ' (' + __('Exceeds requirement') + ')';\r\n    }\r\n  }\r\n  \r\n  // 3. Education\r\n  if (requirements.required_education_level) {\r\n    const required_edu = requirements.required_education_level;\r\n    const applicant_edu = frm.doc.highest_education_level || '-';\r\n    \r\n    const education_hierarchy = {\r\n      'Secondary': 1,\r\n      'Diploma': 2,\r\n      'Bachelor': 3,\r\n      'Master': 4,\r\n      'PhD': 5\r\n    };\r\n    \r\n    const required_rank = education_hierarchy[required_edu] || 0;\r\n    const applicant_rank = education_hierarchy[applicant_edu] || 0;\r\n    \r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('Education Level: ') + required_edu;\r\n    row.value = applicant_edu;\r\n    \r\n    if (applicant_rank < required_rank) {\r\n      row.value += ' (' + __('Required: ') + required_edu + ')';\r\n      missing_items.push(__('Education level: ') + required_edu);\r\n    } else if (applicant_rank > required_rank) {\r\n      row.value += ' (' + __('Exceeds requirement') + ')';\r\n    }\r\n  }\r\n  \r\n  // 4. ID Document\r\n  if (requirements.require_id_document) {\r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('ID Document Required');\r\n    row.value = frm.doc.id_scan ? __('Attached') : __('Not Attached');\r\n    \r\n    if (!frm.doc.id_scan) {\r\n      row.value += ' (' + __('Missing') + ')';\r\n      missing_items.push(__('ID Document'));\r\n    }\r\n  }\r\n  \r\n  // 5. Police Clearance\r\n  if (requirements.require_police_clearance) {\r\n    const valid_days = parseInt(requirements.document_validity_days || 90, 10);\r\n    const file_ok = !!frm.doc.police_clearance_file;\r\n    \r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('Police Clearance (Valid for ') + valid_days + ' ' + __('days') + ')';\r\n    \r\n    if (!file_ok) {\r\n      row.value = __('Not Attached') + ' (' + __('Missing') + ')';\r\n      missing_items.push(__('Police Clearance Certificate'));\r\n    } else {\r\n      row.value = __('Attached');\r\n      \r\n      if (frm.doc.police_clearance_issue_date) {\r\n        try {\r\n          const days = frappe.datetime.get_day_diff(\r\n            frappe.datetime.get_today(), \r\n            frm.doc.police_clearance_issue_date\r\n          );\r\n          if (days > valid_days) {\r\n            row.value += ' (' + __('Expired - Issued ') + days + ' ' + __('days ago') + ')';\r\n            missing_items.push(__('Valid Police Clearance (current one expired)'));\r\n          } else {\r\n            row.value += ' (' + __('Valid - Issued ') + days + ' ' + __('days ago') + ')';\r\n          }\r\n        } catch(e) {}\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 6. Work Authorization (for non-Zambians)\r\n  const is_zambian = (frm.doc.nationality_name || frm.doc.nationality || '').toLowerCase().includes('zambia');\r\n  if (!is_zambian) {\r\n    const row = frm.add_child('screening_details');\r\n    row.label = __('Work Authorization (Non-Zambian)');\r\n    \r\n    const has_auth = frm.doc.work_authorization && String(frm.doc.work_authorization).trim();\r\n    const has_proof = !!frm.doc.work_authorization_proof;\r\n    \r\n    if (has_auth && has_proof) {\r\n      row.value = __('Authorization: ') + frm.doc.work_authorization + ', ' + __('Proof attached');\r\n    } else if (has_auth && !has_proof) {\r\n      row.value = __('Authorization: ') + frm.doc.work_authorization + ' (' + __('Proof missing') + ')';\r\n      missing_items.push(__('Work Authorization Proof'));\r\n    } else if (!has_auth && has_proof) {\r\n      row.value = __('Proof attached') + ' (' + __('Authorization details missing') + ')';\r\n      missing_items.push(__('Work Authorization Details'));\r\n    } else {\r\n      row.value = __('Not provided') + ' (' + __('Missing') + ')';\r\n      missing_items.push(__('Work Authorization and Proof'));\r\n    }\r\n  }\r\n  \r\n  // Refresh the child table\r\n  frm.refresh_field('screening_details');\r\n  \r\n  // Update missing requirements field\r\n  if (missing_items.length > 0) {\r\n    frm.set_value('missing_requirements', missing_items.join('; '));\r\n  } else {\r\n    frm.set_value('missing_requirements', __('All requirements met'));\r\n  }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Applicant",
  "enabled": 1,
  "modified": "2025-10-21 23:10:26.082397",
  "module": "HR Screening",
  "name": "Job Applicant Nationality",
  "script": "frappe.ui.form.on('Job Applicant', {\r\n  country(frm) {\r\n    // Auto-populate nationality with country value immediately when country is selected\r\n    if (frm.doc.country) {\r\n      frm.set_value('nationality', frm.doc.country);\r\n    }\r\n  }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Application",
  "enabled": 1,
  "modified": "2025-12-04 21:36:36.575095",
  "module": null,
  "name": "Workflow history - Leave Application",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Leave Application', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Training Event",
  "enabled": 1,
  "modified": "2025-12-04 21:38:59.609306",
  "module": null,
  "name": "Workflow History - HR Training",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Training Event', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Appraisal",
  "enabled": 1,
  "modified": "2025-12-04 21:41:47.609108",
  "module": null,
  "name": "Workflow History - Appraisal",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Appraisal', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Internal Audit",
  "enabled": 1,
  "modified": "2025-12-04 21:43:38.589996",
  "module": null,
  "name": "Workflow History - Internal Audit",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Internal Audit', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-12-04 21:46:25.259146",
  "module": null,
  "name": "Workflow History - GRN",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Purchase Receipt', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-04 21:48:37.378353",
  "module": null,
  "name": "Workflow History - Purchase Order",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Purchase Order', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2025-12-04 21:50:17.769244",
  "module": null,
  "name": "Workflow History - Job Offer",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Job Offer', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Interview",
  "enabled": 1,
  "modified": "2025-12-04 21:52:04.527358",
  "module": null,
  "name": "Workflow History - Interview Schedule",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Interview', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Request",
  "enabled": 1,
  "modified": "2025-12-04 21:53:36.420267",
  "module": null,
  "name": "Workflow History - Budget Request",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Budget Request', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Advance",
  "enabled": 1,
  "modified": "2025-12-04 21:56:48.492861",
  "module": null,
  "name": "Workflow History - Salary Advance",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Employee Advance', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Transfer",
  "enabled": 1,
  "modified": "2025-12-04 21:58:18.706776",
  "module": null,
  "name": "Workflow History - Employee Transfer",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Employee Transfer', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Promotion",
  "enabled": 1,
  "modified": "2025-12-04 21:59:44.557163",
  "module": null,
  "name": "Workflow History - Employee Promotion",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Employee Promotion', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Incentive",
  "enabled": 1,
  "modified": "2025-12-04 22:01:13.728860",
  "module": null,
  "name": "Workflow History - Employee Incentive",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Employee Incentive', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Route History",
  "enabled": 1,
  "modified": "2025-12-04 22:03:26.879137",
  "module": null,
  "name": "Workflow History - History",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Route History', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Loan",
  "enabled": 1,
  "modified": "2025-12-04 22:05:31.854679",
  "module": null,
  "name": "Workflow History - Loan",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Loan', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Loan Application",
  "enabled": 1,
  "modified": "2025-12-04 22:06:48.638326",
  "module": null,
  "name": "Workflow History - Loan Application",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Loan Application', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Salary Structure",
  "enabled": 1,
  "modified": "2025-12-04 22:08:16.607191",
  "module": null,
  "name": "Worklfow History - Salary Structure",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Salary Structure', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-12-04 22:09:41.762837",
  "module": null,
  "name": "Workflow History - Payroll",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Payroll Entry', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Claims",
  "enabled": 1,
  "modified": "2025-12-04 22:12:34.356881",
  "module": null,
  "name": "Workflow History - Hr Fin Expense Claim Approval",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Claims', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Expense Claim",
  "enabled": 1,
  "modified": "2025-12-04 22:14:29.082612",
  "module": null,
  "name": "Workflow History - Expense Claim",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Expense Claim', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Training Program",
  "enabled": 1,
  "modified": "2025-12-04 22:16:18.977949",
  "module": null,
  "name": "Workflow History - Training Event",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Training Program', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Expense Claim Type",
  "enabled": 1,
  "modified": "2025-12-04 22:17:53.208252",
  "module": null,
  "name": "Workflow History - Expense Claim Type",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Expense Claim Type', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-12-04 22:19:38.342737",
  "module": null,
  "name": "Workflow History - Purchase Invoice",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Purchase Invoice', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-12-04 22:22:39.924320",
  "module": null,
  "name": "Workflow History - Project",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Project', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Entry",
  "enabled": 1,
  "modified": "2025-12-04 22:25:16.945282",
  "module": null,
  "name": "Workflow History - Payment Entry",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Payment Entry', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Order",
  "enabled": 1,
  "modified": "2025-12-04 22:30:49.680770",
  "module": null,
  "name": "Woflow Approval - Payment Order",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Payment Order', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Request",
  "enabled": 1,
  "modified": "2025-12-04 22:32:36.624374",
  "module": null,
  "name": "Workflow History - Payment Request",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Payment Request', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Signatures PO",
  "enabled": 1,
  "modified": "2025-12-04 22:34:20.005613",
  "module": null,
  "name": "Workflow History - PO Signatures",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Signatures PO', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journal Entry",
  "enabled": 1,
  "modified": "2025-12-04 22:38:29.261899",
  "module": null,
  "name": "Workflow History - Journal Entry",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Journal Entry', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Contract",
  "enabled": 1,
  "modified": "2025-12-04 22:39:50.947192",
  "module": null,
  "name": "Workflow History - Contract",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Contract', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset Movement",
  "enabled": 1,
  "modified": "2025-12-04 22:41:02.518448",
  "module": null,
  "name": "Workflow History - Asset Movement",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Asset Movement', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset Depreciation Schedule",
  "enabled": 1,
  "modified": "2025-12-04 22:42:50.398012",
  "module": null,
  "name": "Workflow History - Asset Disposal",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Asset Depreciation Schedule', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset Value Adjustment",
  "enabled": 1,
  "modified": "2025-12-04 22:52:30.249533",
  "module": null,
  "name": "Workflow Approval history - Asset value Adjustment",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Asset Value Adjustment', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-12-04 22:55:34.880976",
  "module": null,
  "name": "Workflow History - Sales Invoice",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Sales Invoice', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Procurement Plan",
  "enabled": 1,
  "modified": "2025-12-04 22:56:50.840580",
  "module": null,
  "name": "Workflow History - Procurement Plan",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Procurement Plan', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Additional Salary",
  "enabled": 1,
  "modified": "2025-12-04 22:58:16.524607",
  "module": null,
  "name": "Workflow History - Additional Salary",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Additional Salary', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Designation",
  "enabled": 1,
  "modified": "2025-12-04 22:59:26.131733",
  "module": null,
  "name": "Workflow History - Position",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Designation', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Consolidation",
  "enabled": 1,
  "modified": "2025-12-05 11:55:57.784297",
  "module": null,
  "name": "Budget Consolidation Form",
  "script": "\nfrappe.ui.form.on('Budget Consolidation', {\n    \n    refresh: function(frm) {\n        // Add custom buttons\n        if (frm.doc.docstatus === 0) {\n            frm.add_custom_button(__('Refresh Values'), function() {\n                frappe.confirm(\n                    'This will refresh all budget data from the database. Continue?',\n                    function() {\n                        frm.save();\n                    }\n                );\n            }, __('Actions'));\n            \n            frm.add_custom_button(__('Preview Draft Budgets'), function() {\n                var drafts = (frm.doc.budget_items || []).filter(function(b) { \n                    return b.budget_status === 'Draft'; \n                });\n                if (drafts.length === 0) {\n                    frappe.msgprint('No draft budgets found');\n                    return;\n                }\n                var html = '<h4>' + drafts.length + ' Draft Budgets</h4><ul>';\n                drafts.forEach(function(b) {\n                    html += '<li><a href=\"/app/budget/' + b.budget + '\">' + b.budget + '</a> - ' + b.budget_type + ' (' + format_currency(b.budget_amount) + ')</li>';\n                });\n                html += '</ul>';\n                frappe.msgprint({title: 'Draft Budgets', message: html, indicator: 'orange'});\n            }, __('Actions'));\n        }\n        \n        // Render HTML sections\n        render_summary_html(frm);\n        render_budget_actions_html(frm);\n        \n        // Highlight changed rows\n        highlight_changed_rows(frm);\n    },\n    \n    fiscal_year: function(frm) {\n        if (frm.doc.fiscal_year && !frm.doc.title) {\n            frm.set_value('title', 'Budget Consolidation - ' + frm.doc.fiscal_year);\n        }\n    },\n    \n    onload: function(frm) {\n        // Set title if new\n        if (frm.is_new() && frm.doc.fiscal_year && !frm.doc.title) {\n            frm.set_value('title', 'Budget Consolidation - ' + frm.doc.fiscal_year);\n        }\n    }\n});\n\nfunction highlight_changed_rows(frm) {\n    // Highlight summary rows that changed\n    setTimeout(function() {\n        ['summary_items', 'detail_items', 'budget_items'].forEach(function(table_name) {\n            var grid = frm.fields_dict[table_name];\n            if (grid && grid.grid) {\n                (frm.doc[table_name] || []).forEach(function(row, idx) {\n                    if (row.has_changed) {\n                        var row_element = grid.grid.grid_rows[idx];\n                        if (row_element && row_element.row) {\n                            $(row_element.row).css('background-color', '#fff3cd');\n                        }\n                    }\n                });\n            }\n        });\n    }, 500);\n}\n\nfunction render_summary_html(frm) {\n    if (!frm.fields_dict.summary_html) return;\n    \n    var total_budgets = (frm.doc.budget_items || []).length;\n    var draft_count = (frm.doc.budget_items || []).filter(function(b) { return b.budget_status === 'Draft'; }).length;\n    var total_amount = 0;\n    (frm.doc.summary_items || []).forEach(function(s) { total_amount += (s.current_year_amount || 0); });\n    \n    var html = '<div class=\"row\" style=\"margin-bottom:15px;\">';\n    \n    // Card 1: Total Budgets\n    html += '<div class=\"col-md-3\"><div style=\"padding:15px;background:#e3f2fd;border-radius:8px;text-align:center;\">';\n    html += '<div style=\"font-size:24px;font-weight:bold;\">' + total_budgets + '</div>';\n    html += '<div style=\"color:#666;\">Total Budgets</div></div></div>';\n    \n    // Card 2: Draft Budgets\n    html += '<div class=\"col-md-3\"><div style=\"padding:15px;background:' + (draft_count > 0 ? '#fff3e0' : '#e8f5e9') + ';border-radius:8px;text-align:center;\">';\n    html += '<div style=\"font-size:24px;font-weight:bold;\">' + draft_count + '</div>';\n    html += '<div style=\"color:#666;\">Draft</div></div></div>';\n    \n    // Card 3: Total Amount\n    html += '<div class=\"col-md-3\"><div style=\"padding:15px;background:#f3e5f5;border-radius:8px;text-align:center;\">';\n    html += '<div style=\"font-size:24px;font-weight:bold;\">' + format_currency(total_amount) + '</div>';\n    html += '<div style=\"color:#666;\">Total Budget</div></div></div>';\n    \n    // Card 4: Surplus/Deficit\n    var surplus = frm.doc.surplus_deficit || 0;\n    var surplus_color = surplus >= 0 ? '#e8f5e9' : '#ffebee';\n    html += '<div class=\"col-md-3\"><div style=\"padding:15px;background:' + surplus_color + ';border-radius:8px;text-align:center;\">';\n    html += '<div style=\"font-size:24px;font-weight:bold;\">' + format_currency(surplus) + '</div>';\n    html += '<div style=\"color:#666;\">Surplus/(Deficit)</div></div></div>';\n    \n    html += '</div>';\n    \n    // Change notification\n    var changed_count = (frm.doc.summary_items || []).filter(function(r) { return r.has_changed; }).length +\n                        (frm.doc.detail_items || []).filter(function(r) { return r.has_changed; }).length +\n                        (frm.doc.budget_items || []).filter(function(r) { return r.has_changed; }).length;\n    \n    if (changed_count > 0) {\n        html += '<div class=\"alert alert-warning\"><i class=\"fa fa-exclamation-triangle\"></i> <strong>' + changed_count + ' items changed</strong> since last refresh (highlighted in yellow)</div>';\n    }\n    \n    if (draft_count > 0 && frm.doc.docstatus === 0) {\n        html += '<div class=\"alert alert-info\"><i class=\"fa fa-info-circle\"></i> When you submit this consolidation, all ' + draft_count + ' draft budgets will be automatically submitted.</div>';\n    }\n    \n    frm.fields_dict.summary_html.$wrapper.html(html);\n}\n\nfunction render_budget_actions_html(frm) {\n    if (!frm.fields_dict.budgets_action_html) return;\n    \n    var total = (frm.doc.budget_items || []).length;\n    var draft = (frm.doc.budget_items || []).filter(function(b) { return b.budget_status === 'Draft'; }).length;\n    var submitted = (frm.doc.budget_items || []).filter(function(b) { return b.budget_status === 'Submitted'; }).length;\n    \n    var html = '<div class=\"row\" style=\"margin-bottom:15px;\">';\n    html += '<div class=\"col-md-4\"><div style=\"padding:10px;background:#e3f2fd;border-radius:5px;text-align:center;\"><strong>Total:</strong> ' + total + '</div></div>';\n    html += '<div class=\"col-md-4\"><div style=\"padding:10px;background:#fff3e0;border-radius:5px;text-align:center;\"><strong>Draft:</strong> ' + draft + '</div></div>';\n    html += '<div class=\"col-md-4\"><div style=\"padding:10px;background:#e8f5e9;border-radius:5px;text-align:center;\"><strong>Submitted:</strong> ' + submitted + '</div></div>';\n    html += '</div>';\n    \n    if (draft > 0 && frm.doc.docstatus === 0) {\n        html += '<p class=\"text-muted\"><i class=\"fa fa-info-circle\"></i> ' + draft + ' draft budgets will be submitted when you submit this consolidation.</p>';\n    }\n    \n    frm.fields_dict.budgets_action_html.$wrapper.html(html);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Budget Consolidation",
  "enabled": 1,
  "modified": "2025-12-05 12:11:46.196811",
  "module": null,
  "name": "Workflow History - Budget Consolidation",
  "script": "// Budget Workflow Tracker - Client Script\n// Place this in Budget DocType > Client Script\n\nfrappe.ui.form.on('Budget Consolidation', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.workflow_state) {\n            frm.add_custom_button(__('Workflow Tracker'), function() {\n                open_workflow_tracker(frm);\n            }, __('Actions'));\n        }\n    }\n});\n\nfunction open_workflow_tracker(frm) {\n    // Show loading dialog\n    frappe.dom.freeze(__('Loading Workflow Information...'));\n    \n    // Fetch all workflow data\n    frappe.call({\n        method: 'frappe.client.get',\n        args: {\n            doctype: 'Workflow',\n            filters: {\n                document_type: frm.doc.doctype,\n                is_active: 1\n            }\n        },\n        callback: function(r) {\n            if (!r.message) {\n                frappe.dom.unfreeze();\n                frappe.msgprint(__('No active workflow found for this document type.'));\n                return;\n            }\n            \n            let workflow = r.message;\n            \n            // Get workflow history (Version log)\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Version',\n                    filters: {\n                        ref_doctype: frm.doc.doctype,\n                        docname: frm.doc.name\n                    },\n                    fields: ['creation', 'owner', 'data'],\n                    order_by: 'creation asc',\n                    limit_page_length: 0\n                },\n                callback: function(version_response) {\n                    // Get Workflow Action records (pending and completed)\n                    // Use exact document name for reference_name filter\n                    frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: 'Workflow Action',\n                            filters: {\n                                reference_doctype: frm.doc.doctype,\n                                reference_name: frm.doc.name\n                            },\n                            fields: ['name', 'creation', 'modified', 'owner', 'workflow_state', 'status', 'user', 'completed_by', 'completed_by_role'],\n                            order_by: 'creation asc',\n                            limit_page_length: 0\n                        },\n                        callback: function(action_response) {\n                            frappe.dom.unfreeze();\n                            \n                            let workflow_history = parse_workflow_history(\n                                version_response.message || [],\n                                action_response.message || [],\n                                frm\n                            );\n                            \n                            show_workflow_tracker_dialog(frm, workflow, workflow_history, action_response.message || []);\n                        },\n                        error: function(err) {\n                            frappe.dom.unfreeze();\n                            frappe.msgprint(__('Error loading Workflow Actions: ' + (err.message || 'Unknown error')));\n                        }\n                    });\n                }\n            });\n        }\n    });\n}\n\nfunction parse_workflow_history(versions, workflow_actions, frm) {\n    let history = [];\n    \n    // Parse version logs for workflow state changes\n    versions.forEach(function(version) {\n        try {\n            let data = JSON.parse(version.data);\n            if (data.changed && data.changed.length) {\n                data.changed.forEach(function(change) {\n                    if (change[0] === 'workflow_state') {\n                        history.push({\n                            timestamp: version.creation,\n                            user: version.owner,\n                            from_state: change[1] || 'Draft',\n                            to_state: change[2],\n                            type: 'transition'\n                        });\n                    }\n                });\n            }\n        } catch (e) {\n            // Skip if data parsing fails\n        }\n    });\n    \n    // Add Workflow Action records - these show who was assigned and if they completed\n    workflow_actions.forEach(function(action) {\n        history.push({\n            timestamp: action.creation,\n            modified: action.modified,\n            user: action.user || action.owner,\n            completed_by: action.completed_by,\n            completed_by_role: action.completed_by_role,\n            state: action.workflow_state,\n            status: action.status, // 'Open' or 'Completed'\n            type: 'workflow_action'\n        });\n    });\n    \n    // Sort by timestamp\n    history.sort(function(a, b) {\n        return new Date(a.timestamp) - new Date(b.timestamp);\n    });\n    \n    // If no history, add creation entry\n    if (history.length === 0) {\n        history.push({\n            timestamp: frm.doc.creation,\n            user: frm.doc.owner,\n            from_state: null,\n            to_state: frm.doc.workflow_state || 'Draft',\n            type: 'creation'\n        });\n    }\n    \n    return history;\n}\n\n// Helper function to check if document is submitted/approved (docstatus = 1)\nfunction is_document_submitted(frm) {\n    return frm.doc.docstatus === 1;\n}\n\n// Helper function to check if document is cancelled (docstatus = 2)\nfunction is_document_cancelled(frm) {\n    return frm.doc.docstatus === 2;\n}\n\n// Helper function to check if a state represents rejection/cancellation\nfunction is_rejection_state(state_name) {\n    if (!state_name) return false;\n    let lower = state_name.toLowerCase();\n    \n    let rejection_patterns = [\n        'reject',\n        'cancel',\n        'declined',\n        'denied',\n        'refused',\n        'terminated'\n    ];\n    \n    return rejection_patterns.some(pattern => lower.includes(pattern));\n}\n\nfunction show_workflow_tracker_dialog(frm, workflow, history, workflow_actions) {\n    // Build workflow states map\n    let states_map = {};\n    let states_order = [];\n    \n    workflow.states.forEach(function(state) {\n        states_map[state.state] = state;\n        states_order.push(state.state);\n    });\n    \n    // Build transitions map\n    let transitions_map = {};\n    workflow.transitions.forEach(function(trans) {\n        if (!transitions_map[trans.state]) {\n            transitions_map[trans.state] = [];\n        }\n        transitions_map[trans.state].push(trans);\n    });\n    \n    // Determine current state\n    let current_state = frm.doc.workflow_state;\n    let current_state_index = states_order.indexOf(current_state);\n    \n    // For amended documents, we need to track the actual path taken\n    // Build a sequential list of states visited in ORDER from version history\n    let state_sequence = [];\n    history.forEach(function(h) {\n        if (h.type === 'transition' && h.to_state) {\n            // Only add if not already the last state in sequence (avoid duplicates)\n            if (state_sequence.length === 0 || state_sequence[state_sequence.length - 1] !== h.to_state) {\n                state_sequence.push(h.to_state);\n            }\n        }\n    });\n    \n    // The current state should be the last in sequence\n    // Completed states are all states BEFORE current in the sequence (not in workflow order)\n    let completed_states = new Set();\n    let found_current = false;\n    \n    // Walk through the sequence - everything before current state is completed\n    for (let i = 0; i < state_sequence.length; i++) {\n        if (state_sequence[i] === current_state) {\n            found_current = true;\n            break; // Stop - don't mark current or anything after as completed\n        }\n        completed_states.add(state_sequence[i]);\n    }\n    \n    // If current state wasn't in sequence, use simpler logic - \n    // only mark states that come BEFORE current in workflow definition AND were visited\n    if (!found_current) {\n        completed_states.clear();\n        state_sequence.forEach(function(state) {\n            let state_index = states_order.indexOf(state);\n            if (state !== current_state && state_index !== -1 && state_index < current_state_index) {\n                completed_states.add(state);\n            }\n        });\n    }\n    \n    console.log('Workflow Tracker - Current State:', current_state, 'Index:', current_state_index);\n    console.log('Workflow Tracker - State Sequence (in order):', state_sequence);\n    console.log('Workflow Tracker - Completed States:', [...completed_states]);\n    \n    // Get pending workflow actions (status = Open)\n    let pending_actions = workflow_actions.filter(a => a.status === 'Open');\n    console.log('Workflow Tracker - Pending Actions:', pending_actions);\n    \n    // Check document status\n    let is_submitted = is_document_submitted(frm);\n    let is_cancelled = is_document_cancelled(frm);\n    \n    // Create dialog content\n    let dialog_content = build_workflow_tracker_html(\n        frm, workflow, states_map, states_order, transitions_map,\n        current_state, completed_states, history, pending_actions,\n        is_submitted, is_cancelled\n    );\n    \n    let d = new frappe.ui.Dialog({\n        title: __('Workflow Tracker: {0}', [frm.doc.name]),\n        size: 'extra-large',\n        fields: [\n            {\n                fieldtype: 'HTML',\n                fieldname: 'workflow_content',\n                options: dialog_content\n            }\n        ],\n        primary_action_label: __('Close'),\n        primary_action: function() {\n            d.hide();\n        }\n    });\n    \n    d.show();\n    \n    // Bind reminder button events after dialog is shown\n    bind_reminder_events(d, frm);\n}\n\nfunction build_workflow_tracker_html(frm, workflow, states_map, states_order, transitions_map, current_state, completed_states, history, pending_actions, is_submitted, is_cancelled) {\n    let html = `\n        <style>\n            .workflow-tracker-container {\n                font-family: var(--font-stack);\n            }\n            .workflow-section {\n                margin-bottom: 25px;\n                padding: 15px;\n                border: 1px solid var(--border-color);\n                border-radius: 8px;\n                background: var(--card-bg);\n            }\n            .workflow-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                margin-bottom: 15px;\n                color: var(--heading-color);\n                border-bottom: 1px solid var(--border-color);\n                padding-bottom: 8px;\n            }\n            .workflow-timeline {\n                display: flex;\n                align-items: flex-start;\n                flex-wrap: wrap;\n                padding: 20px 10px;\n                gap: 10px 0;\n                justify-content: flex-start;\n            }\n            .workflow-row {\n                display: flex;\n                align-items: center;\n                width: 100%;\n                flex-wrap: wrap;\n            }\n            .workflow-step {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                width: 120px;\n                min-width: 120px;\n                max-width: 120px;\n                position: relative;\n            }\n            .workflow-step-circle {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: bold;\n                font-size: 16px;\n                border: 3px solid;\n                z-index: 1;\n                background: var(--card-bg);\n            }\n            .step-completed {\n                background-color: var(--green-100) !important;\n                border-color: var(--green-500) !important;\n                color: var(--green-700);\n            }\n            .step-current {\n                background-color: var(--blue-100) !important;\n                border-color: var(--blue-500) !important;\n                color: var(--blue-700);\n                animation: pulse 2s infinite;\n            }\n            .step-pending {\n                background-color: var(--gray-100) !important;\n                border-color: var(--gray-400) !important;\n                color: var(--gray-600);\n            }\n            .step-rejected {\n                background-color: var(--red-100) !important;\n                border-color: var(--red-500) !important;\n                color: var(--red-700);\n            }\n            .step-final-approved {\n                background-color: var(--green-200) !important;\n                border-color: var(--green-600) !important;\n                color: var(--green-800);\n                box-shadow: 0 0 10px rgba(34, 197, 94, 0.4);\n            }\n            @keyframes pulse {\n                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }\n                50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }\n            }\n            .workflow-step-label {\n                margin-top: 10px;\n                font-size: 12px;\n                font-weight: 500;\n                text-align: center;\n                max-width: 120px;\n                word-wrap: break-word;\n            }\n            .workflow-step-role {\n                font-size: 10px;\n                color: var(--text-muted);\n                margin-top: 3px;\n            }\n            .workflow-connector {\n                height: 3px;\n                width: 30px;\n                min-width: 30px;\n                max-width: 30px;\n                margin-top: -40px;\n                align-self: flex-start;\n                margin-top: 25px;\n            }\n            .connector-completed { background-color: var(--green-500); }\n            .connector-pending { background-color: var(--gray-300); }\n            \n            .history-table {\n                width: 100%;\n                border-collapse: collapse;\n            }\n            .history-table th, .history-table td {\n                padding: 10px;\n                text-align: left;\n                border-bottom: 1px solid var(--border-color);\n                font-size: 13px;\n            }\n            .history-table th {\n                background: var(--subtle-bg);\n                font-weight: 600;\n            }\n            .wait-time {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .wait-time-warning { color: var(--orange-500); }\n            .wait-time-danger { color: var(--red-500); }\n            \n            .approver-card {\n                display: inline-flex;\n                align-items: center;\n                padding: 8px 12px;\n                margin: 5px;\n                border: 1px solid var(--border-color);\n                border-radius: 6px;\n                background: var(--subtle-bg);\n            }\n            .approver-avatar {\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                background: var(--blue-100);\n                color: var(--blue-600);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-weight: 600;\n                margin-right: 10px;\n            }\n            .approver-info {\n                display: flex;\n                flex-direction: column;\n            }\n            .approver-name {\n                font-weight: 500;\n                font-size: 13px;\n            }\n            .approver-email {\n                font-size: 11px;\n                color: var(--text-muted);\n            }\n            .btn-reminder {\n                margin-left: 10px;\n                padding: 4px 10px;\n                font-size: 11px;\n            }\n            .current-wait-banner {\n                background: linear-gradient(135deg, var(--yellow-50), var(--orange-50));\n                border: 1px solid var(--orange-200);\n                border-radius: 8px;\n                padding: 15px;\n                margin-bottom: 20px;\n            }\n            .stats-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                gap: 15px;\n            }\n            .stat-card {\n                text-align: center;\n                padding: 15px;\n                background: var(--subtle-bg);\n                border-radius: 6px;\n            }\n            .stat-value {\n                font-size: 24px;\n                font-weight: 700;\n                color: var(--primary);\n            }\n            .stat-label {\n                font-size: 11px;\n                color: var(--text-muted);\n                margin-top: 5px;\n            }\n        </style>\n        \n        <div class=\"workflow-tracker-container\">\n    `;\n    \n    // Check if workflow is complete or rejected\n    let is_workflow_complete = is_submitted;\n    let is_workflow_rejected = is_cancelled || is_rejection_state(current_state);\n    \n    // Status banner - show completion, rejection, or waiting\n    if (is_workflow_complete) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--green-50), var(--green-100)); border: 1px solid var(--green-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--green-700);\">✅ Workflow Complete</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--green-600);\">\n                            Document has reached <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else if (is_workflow_rejected) {\n        html += `\n            <div style=\"background: linear-gradient(135deg, var(--red-50), var(--red-100)); border: 1px solid var(--red-300); border-radius: 8px; padding: 15px; margin-bottom: 20px;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div>\n                        <strong style=\"color: var(--red-700);\">❌ Workflow Ended</strong>\n                        <div style=\"font-size: 14px; margin-top: 5px; color: var(--red-600);\">\n                            Document status: <strong>${current_state}</strong>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    } else {\n        // Current wait time banner for pending workflows\n        let current_wait = calculate_current_wait_time(history, frm);\n        if (current_wait) {\n            let wait_class = '';\n            if (current_wait.hours > 48) wait_class = 'wait-time-danger';\n            else if (current_wait.hours > 24) wait_class = 'wait-time-warning';\n            \n            html += `\n                <div class=\"current-wait-banner\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <div>\n                            <strong>⏱️ Currently waiting for approval</strong>\n                            <div class=\"wait-time ${wait_class}\" style=\"font-size: 14px; margin-top: 5px;\">\n                                ${current_wait.formatted} at <strong>${current_state}</strong>\n                            </div>\n                        </div>\n                        <div>\n                            <span style=\"font-size: 12px; color: var(--text-muted);\">Since: ${frappe.datetime.str_to_user(current_wait.since)}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow Progress Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📊 Workflow Progress</div>\n            <div class=\"workflow-timeline\">\n    `;\n    \n    states_order.forEach(function(state, index) {\n        let state_info = states_map[state];\n        let is_completed = completed_states.has(state) && state !== current_state;\n        let is_current = state === current_state;\n        let is_rejected = is_rejection_state(state);\n        \n        let step_class = 'step-pending';\n        let step_icon = (index + 1);\n        \n        if (is_current) {\n            if (is_submitted) {\n                // Document is submitted - show final approved state\n                step_class = 'step-final-approved';\n                step_icon = '✓✓';\n            } else if (is_cancelled || is_rejected) {\n                step_class = 'step-rejected';\n                step_icon = '✗';\n            } else {\n                step_class = 'step-current';\n                step_icon = '●';\n            }\n        } else if (is_completed) {\n            step_class = 'step-completed';\n            step_icon = '✓';\n        } else if (is_rejected && completed_states.has(state)) {\n            step_class = 'step-rejected';\n            step_icon = '✗';\n        }\n        \n        // Add connector before step (except first)\n        if (index > 0) {\n            let connector_class = is_completed || is_current ? 'connector-completed' : 'connector-pending';\n            html += `<div class=\"workflow-connector ${connector_class}\"></div>`;\n        }\n        \n        html += `\n            <div class=\"workflow-step\">\n                <div class=\"workflow-step-circle ${step_class}\">\n                    ${step_icon}\n                </div>\n                <div class=\"workflow-step-label\">${state}</div>\n                <div class=\"workflow-step-role\">${state_info.allow_edit || 'System'}</div>\n            </div>\n        `;\n    });\n    \n    html += `\n            </div>\n        </div>\n    `;\n    \n    // Next Approvers Section - Show pending workflow actions first (only if not complete)\n    let next_transitions = transitions_map[current_state] || [];\n    \n    // Only show pending actions if workflow is not complete/rejected\n    if (!is_workflow_complete && !is_workflow_rejected) {\n        // Show pending Workflow Actions (users who have Open actions)\n        if (pending_actions && pending_actions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">⏳ Pending Approvals (Workflow Actions)</div>\n                    <div class=\"pending-approvers-info\" style=\"margin-bottom: 15px; padding: 10px; background: var(--yellow-50); border-radius: 6px; border-left: 4px solid var(--yellow-500);\">\n                        <strong>${pending_actions.length}</strong> pending workflow action(s) awaiting approval\n                    </div>\n                    <div id=\"pending-approvers-container\">\n                        <div style=\"text-align: center; padding: 10px;\">\n                            <span class=\"text-muted\">Loading pending approver details...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        \n        if (next_transitions.length > 0) {\n            html += `\n                <div class=\"workflow-section\">\n                    <div class=\"workflow-section-title\">👥 Available Approvers for Next Step</div>\n                    <div id=\"approvers-container\">\n                        <div style=\"text-align: center; padding: 20px;\">\n                            <span class=\"text-muted\">Loading approvers...</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Workflow History Section\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📜 Approval History & Wait Times</div>\n            <table class=\"history-table\">\n                <thead>\n                    <tr>\n                        <th>Date/Time</th>\n                        <th>Action/Transition</th>\n                        <th>Assigned To / Completed By</th>\n                        <th>Status</th>\n                        <th>Wait Time</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    let prev_timestamp = null;\n    \n    // Group and display history - filter for unique meaningful entries\n    let displayed_transitions = new Set();\n    \n    history.forEach(function(h, index) {\n        let wait_time = '';\n        let wait_class = '';\n        \n        if (prev_timestamp) {\n            let diff = calculate_time_diff(prev_timestamp, h.timestamp);\n            wait_time = diff.formatted;\n            if (diff.hours > 48) wait_class = 'wait-time-danger';\n            else if (diff.hours > 24) wait_class = 'wait-time-warning';\n        }\n        \n        let action_text = '';\n        let user_text = '';\n        let status_badge = '';\n        \n        if (h.type === 'creation') {\n            action_text = `Created → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Created</span>';\n        } else if (h.type === 'transition') {\n            let transition_key = `${h.from_state}-${h.to_state}-${h.timestamp}`;\n            if (displayed_transitions.has(transition_key)) return; // Skip duplicates\n            displayed_transitions.add(transition_key);\n            \n            action_text = `${h.from_state || 'Draft'} → ${h.to_state}`;\n            user_text = h.user;\n            status_badge = '<span class=\"badge\" style=\"background: var(--blue-100); color: var(--blue-700);\">Transitioned</span>';\n        } else if (h.type === 'workflow_action') {\n            action_text = `Action at: ${h.state}`;\n            user_text = h.completed_by \n                ? `<strong>${h.completed_by}</strong>` + (h.completed_by_role ? ` (${h.completed_by_role})` : '')\n                : `Assigned: ${h.user}`;\n            \n            if (h.status === 'Completed') {\n                status_badge = '<span class=\"badge\" style=\"background: var(--green-100); color: var(--green-700);\">Completed</span>';\n            } else {\n                status_badge = '<span class=\"badge\" style=\"background: var(--yellow-100); color: var(--yellow-700);\">Open</span>';\n            }\n        }\n        \n        html += `\n            <tr>\n                <td>${frappe.datetime.str_to_user(h.timestamp)}</td>\n                <td>${action_text}</td>\n                <td>${user_text}</td>\n                <td>${status_badge}</td>\n                <td class=\"wait-time ${wait_class}\">${wait_time || '-'}</td>\n            </tr>\n        `;\n        \n        prev_timestamp = h.timestamp;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    // Statistics Section\n    let stats = calculate_workflow_stats(history);\n    html += `\n        <div class=\"workflow-section\">\n            <div class=\"workflow-section-title\">📈 Workflow Statistics</div>\n            <div class=\"stats-grid\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_transitions}</div>\n                    <div class=\"stat-label\">Total Transitions</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.avg_wait_time}</div>\n                    <div class=\"stat-label\">Avg Wait Time</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.longest_wait}</div>\n                    <div class=\"stat-label\">Longest Wait</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-value\">${stats.total_time}</div>\n                    <div class=\"stat-label\">Total Process Time</div>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    html += `</div>`;\n    \n    // Store data as a data attribute instead of script tag\n    // The script tag inside dialog HTML doesn't execute\n    window._workflow_tracker_data = {\n        transitions: next_transitions,\n        pending_actions: pending_actions || [],\n        doctype: frm.doc.doctype,\n        docname: frm.doc.name,\n        current_state: current_state\n    };\n    \n    return html;\n}\n\nfunction calculate_time_diff(from_time, to_time) {\n    let from_date = new Date(from_time);\n    let to_date = new Date(to_time);\n    let diff_ms = to_date - from_date;\n    \n    let hours = Math.floor(diff_ms / (1000 * 60 * 60));\n    let minutes = Math.floor((diff_ms % (1000 * 60 * 60)) / (1000 * 60));\n    let days = Math.floor(hours / 24);\n    \n    let formatted = '';\n    if (days > 0) {\n        formatted = `${days}d ${hours % 24}h`;\n    } else if (hours > 0) {\n        formatted = `${hours}h ${minutes}m`;\n    } else {\n        formatted = `${minutes}m`;\n    }\n    \n    return { hours: hours, minutes: minutes, days: days, formatted: formatted };\n}\n\nfunction calculate_current_wait_time(history, frm) {\n    if (history.length === 0) return null;\n    \n    let last_entry = history[history.length - 1];\n    let diff = calculate_time_diff(last_entry.timestamp, frappe.datetime.now_datetime());\n    \n    return {\n        ...diff,\n        since: last_entry.timestamp\n    };\n}\n\nfunction calculate_workflow_stats(history) {\n    if (history.length < 2) {\n        return {\n            total_transitions: history.length,\n            avg_wait_time: '-',\n            longest_wait: '-',\n            total_time: '-'\n        };\n    }\n    \n    let wait_times = [];\n    for (let i = 1; i < history.length; i++) {\n        let diff = calculate_time_diff(history[i-1].timestamp, history[i].timestamp);\n        wait_times.push(diff);\n    }\n    \n    let total_hours = wait_times.reduce((sum, w) => sum + w.hours + (w.minutes / 60), 0);\n    let avg_hours = total_hours / wait_times.length;\n    let longest = wait_times.reduce((max, w) => (w.hours > max.hours ? w : max), wait_times[0]);\n    \n    let total_diff = calculate_time_diff(history[0].timestamp, history[history.length - 1].timestamp);\n    \n    return {\n        total_transitions: history.length,\n        avg_wait_time: format_hours(avg_hours),\n        longest_wait: longest.formatted,\n        total_time: total_diff.formatted\n    };\n}\n\nfunction format_hours(hours) {\n    if (hours >= 24) {\n        let days = Math.floor(hours / 24);\n        let remaining_hours = Math.round(hours % 24);\n        return `${days}d ${remaining_hours}h`;\n    }\n    return `${Math.round(hours)}h`;\n}\n\nfunction bind_reminder_events(dialog, frm) {\n    // Load approvers after dialog is shown\n    setTimeout(function() {\n        load_approvers(frm, dialog);\n        load_pending_approvers(frm, dialog);\n    }, 100);\n    \n    // Bind click events for reminder buttons\n    $(dialog.$wrapper).on('click', '.btn-send-reminder', function() {\n        let user = $(this).data('user');\n        let email = $(this).data('email');\n        let full_name = $(this).data('fullname');\n        send_approval_reminder(frm, user, email, full_name);\n    });\n    \n    $(dialog.$wrapper).on('click', '.btn-send-all-reminders', function() {\n        let approvers = [];\n        $(dialog.$wrapper).find('.btn-send-reminder').each(function() {\n            approvers.push({\n                user: $(this).data('user'),\n                email: $(this).data('email'),\n                full_name: $(this).data('fullname')\n            });\n        });\n        send_bulk_reminders(frm, approvers);\n    });\n}\n\nfunction load_pending_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Pending Actions Data:', data.pending_actions);\n    \n    if (!data || !data.pending_actions || data.pending_actions.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No pending workflow actions found.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique users from pending actions - owner is the assigned user in Workflow Action\n    let pending_users = [...new Set(data.pending_actions.map(a => a.owner).filter(u => u))];\n    console.log('Workflow Tracker - Pending Users:', pending_users);\n    \n    if (pending_users.length === 0) {\n        $(dialog.$wrapper).find('#pending-approvers-container').html(`\n            <div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">\n                No users assigned to pending actions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Fetch user details\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                name: ['in', pending_users],\n                enabled: 1\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            let users = r.message || [];\n            console.log('Workflow Tracker - Loaded Users:', users);\n            let html = '';\n            \n            if (users.length === 0) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">Could not load user details for: ${pending_users.join(', ')}</div>`;\n                $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n                return;\n            }\n            \n            users.forEach(function(user) {\n                let initials = (user.full_name || user.name || '??').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                let action_for_user = data.pending_actions.find(a => a.owner === user.name);\n                \n                html += `\n                    <div class=\"approver-card\" style=\"border-color: var(--yellow-300); background: var(--yellow-50);\">\n                        <div class=\"approver-avatar\" style=\"background: var(--yellow-200); color: var(--yellow-800);\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email || ''}</span>\n                            ${action_for_user ? `<span style=\"font-size: 10px; color: var(--yellow-700);\">State: ${action_for_user.workflow_state || 'N/A'}</span>` : ''}\n                        </div>\n                        <button class=\"btn btn-xs btn-warning btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email || ''}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Send Reminder\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (!html) {\n                html = `<div style=\"text-align: center; padding: 10px; color: var(--text-muted);\">No user details found.</div>`;\n            }\n            \n            $(dialog.$wrapper).find('#pending-approvers-container').html(html);\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            $(dialog.$wrapper).find('#pending-approvers-container').html(`\n                <div style=\"text-align: center; padding: 10px; color: var(--red-500);\">\n                    Error loading pending approvers.\n                </div>\n            `);\n        }\n    });\n}\n\nfunction load_approvers(frm, dialog) {\n    let data = window._workflow_tracker_data;\n    console.log('Workflow Tracker - Transitions Data:', data.transitions);\n    \n    if (!data || !data.transitions || data.transitions.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No next transitions available from current state.\n            </div>\n        `);\n        return;\n    }\n    \n    // Get unique roles from transitions\n    let roles = [...new Set(data.transitions.map(t => t.allowed).filter(r => r))];\n    console.log('Workflow Tracker - Required Roles:', roles);\n    \n    if (roles.length === 0) {\n        $(dialog.$wrapper).find('#approvers-container').html(`\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No roles defined for next transitions.\n            </div>\n        `);\n        return;\n    }\n    \n    // Use frappe.call with a server-side method to get users by role\n    // We'll use reportview which is whitelisted\n    frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n            doctype: 'User',\n            filters: {\n                enabled: 1,\n                user_type: 'System User'\n            },\n            fields: ['name', 'full_name', 'email', 'user_image'],\n            limit_page_length: 0\n        },\n        callback: function(r) {\n            if (!r.message || r.message.length === 0) {\n                $(dialog.$wrapper).find('#approvers-container').html(`\n                    <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                        No users found.\n                    </div>\n                `);\n                return;\n            }\n            \n            let all_users = r.message;\n            console.log('Workflow Tracker - All System Users:', all_users.length);\n            \n            // Now check which users have the required roles using frappe.user.has_role\n            // We need to get role info for each user - use a different approach\n            // Query User doctype with roles\n            let user_roles = {};\n            let checked_count = 0;\n            let users_to_check = all_users.slice(0, 50); // Limit to first 50 users for performance\n            \n            if (users_to_check.length === 0) {\n                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                return;\n            }\n            \n            // For each user, get their roles\n            users_to_check.forEach(function(user) {\n                frappe.call({\n                    method: 'frappe.client.get',\n                    args: {\n                        doctype: 'User',\n                        name: user.name\n                    },\n                    async: true,\n                    callback: function(user_r) {\n                        checked_count++;\n                        \n                        if (user_r.message && user_r.message.roles) {\n                            let user_role_names = user_r.message.roles.map(r => r.role);\n                            let matching_roles = roles.filter(role => user_role_names.includes(role));\n                            \n                            if (matching_roles.length > 0) {\n                                user_roles[user.name] = {\n                                    user: user,\n                                    roles: matching_roles\n                                };\n                            }\n                        }\n                        \n                        // When all users checked, render\n                        if (checked_count >= users_to_check.length) {\n                            console.log('Workflow Tracker - Users with matching roles:', Object.keys(user_roles));\n                            \n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    },\n                    error: function() {\n                        checked_count++;\n                        if (checked_count >= users_to_check.length) {\n                            if (Object.keys(user_roles).length === 0) {\n                                render_approvers_with_roles_only(dialog, data.transitions, roles);\n                            } else {\n                                let users_list = Object.values(user_roles).map(u => u.user);\n                                let roles_map = {};\n                                Object.keys(user_roles).forEach(function(uname) {\n                                    roles_map[uname] = user_roles[uname].roles;\n                                });\n                                render_approvers(dialog, users_list, roles_map, data.transitions);\n                            }\n                        }\n                    }\n                });\n            });\n        },\n        error: function(err) {\n            console.error('Workflow Tracker - Error loading users:', err);\n            // Fallback: just show the roles needed\n            render_approvers_with_roles_only(dialog, data.transitions, roles);\n        }\n    });\n}\n\n// Fallback function to show just the roles when we can't get users\nfunction render_approvers_with_roles_only(dialog, transitions, roles) {\n    let html = '';\n    \n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        html += `\n            <div style=\"margin-bottom: 15px;\">\n                <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                    <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                    → ${next_state} \n                </div>\n                <div class=\"approver-card\">\n                    <div class=\"approver-avatar\" style=\"background: var(--blue-100); color: var(--blue-600);\">\n                        <i class=\"fa fa-users\"></i>\n                    </div>\n                    <div class=\"approver-info\">\n                        <span class=\"approver-name\">Role: ${role}</span>\n                        <span class=\"approver-email\" style=\"font-size: 11px; color: var(--text-muted);\">\n                            Users with this role can approve\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `;\n    });\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html || `\n        <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n            No transitions available.\n        </div>\n    `);\n}\n\nfunction render_approvers(dialog, users, user_roles, transitions) {\n    let html = '';\n    \n    // Group by transition/next state\n    transitions.forEach(function(trans) {\n        let role = trans.allowed;\n        let next_state = trans.next_state;\n        let action = trans.action;\n        \n        let eligible_users = users.filter(u => user_roles[u.name] && user_roles[u.name].includes(role));\n        \n        if (eligible_users.length > 0) {\n            html += `\n                <div style=\"margin-bottom: 15px;\">\n                    <div style=\"font-weight: 500; margin-bottom: 10px; color: var(--heading-color);\">\n                        <span class=\"badge badge-primary\" style=\"margin-right: 5px;\">${action}</span>\n                        → ${next_state} \n                        <span style=\"color: var(--text-muted); font-weight: normal;\">(Role: ${role})</span>\n                    </div>\n                    <div>\n            `;\n            \n            eligible_users.slice(0, 5).forEach(function(user) {\n                let initials = (user.full_name || user.name).split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n                html += `\n                    <div class=\"approver-card\">\n                        <div class=\"approver-avatar\">${initials}</div>\n                        <div class=\"approver-info\">\n                            <span class=\"approver-name\">${user.full_name || user.name}</span>\n                            <span class=\"approver-email\">${user.email}</span>\n                        </div>\n                        <button class=\"btn btn-xs btn-primary btn-reminder btn-send-reminder\" \n                                data-user=\"${user.name}\"\n                                data-email=\"${user.email}\"\n                                data-fullname=\"${user.full_name || user.name}\">\n                            📧 Remind\n                        </button>\n                    </div>\n                `;\n            });\n            \n            if (eligible_users.length > 5) {\n                html += `<div class=\"text-muted\" style=\"margin-left: 10px; font-size: 12px;\">\n                    ... and ${eligible_users.length - 5} more users\n                </div>`;\n            }\n            \n            html += `\n                    </div>\n                </div>\n            `;\n        }\n    });\n    \n    if (html) {\n        html += `\n            <div style=\"margin-top: 15px; text-align: right;\">\n                <button class=\"btn btn-sm btn-secondary btn-send-all-reminders\">\n                    📧 Send Reminder to All Approvers\n                </button>\n            </div>\n        `;\n    } else {\n        html = `\n            <div style=\"text-align: center; padding: 20px; color: var(--text-muted);\">\n                No eligible approvers found for the next workflow step.\n            </div>\n        `;\n    }\n    \n    $(dialog.$wrapper).find('#approvers-container').html(html);\n}\n\nfunction send_approval_reminder(frm, user, email, full_name) {\n    frappe.confirm(\n        __('Send approval reminder to {0}?', [full_name]),\n        function() {\n            frappe.call({\n                method: 'frappe.core.doctype.communication.email.make',\n                args: {\n                    recipients: email,\n                    subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                    content: get_reminder_email_content(frm, full_name),\n                    doctype: frm.doc.doctype,\n                    name: frm.doc.name,\n                    send_email: 1\n                },\n                callback: function(r) {\n                    frappe.show_alert({\n                        message: __('Reminder sent to {0}', [full_name]),\n                        indicator: 'green'\n                    });\n                },\n                error: function() {\n                    frappe.msgprint(__('Failed to send reminder. Please try again.'));\n                }\n            });\n        }\n    );\n}\n\nfunction send_bulk_reminders(frm, approvers) {\n    if (approvers.length === 0) return;\n    \n    frappe.confirm(\n        __('Send approval reminders to {0} users?', [approvers.length]),\n        function() {\n            let sent = 0;\n            approvers.forEach(function(approver) {\n                frappe.call({\n                    method: 'frappe.core.doctype.communication.email.make',\n                    args: {\n                        recipients: approver.email,\n                        subject: __('Approval Required: {0} - {1}', [frm.doc.doctype, frm.doc.name]),\n                        content: get_reminder_email_content(frm, approver.full_name),\n                        doctype: frm.doc.doctype,\n                        name: frm.doc.name,\n                        send_email: 1\n                    },\n                    async: false,\n                    callback: function() {\n                        sent++;\n                    }\n                });\n            });\n            \n            frappe.show_alert({\n                message: __('Reminders sent to {0} users', [sent]),\n                indicator: 'green'\n            });\n        }\n    );\n}\n\nfunction get_reminder_email_content(frm, recipient_name) {\n    let doc_link = frappe.utils.get_form_link(frm.doc.doctype, frm.doc.name, true);\n    \n    return `\n        <p>Dear ${recipient_name},</p>\n        \n        <p>This is a reminder that the following document requires your approval:</p>\n        \n        <table style=\"border-collapse: collapse; margin: 20px 0;\">\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document Type</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.doctype}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Document ID</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.name}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Current Status</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.workflow_state}</td>\n            </tr>\n            <tr>\n                <td style=\"padding: 8px; border: 1px solid #ddd; font-weight: bold;\">Submitted By</td>\n                <td style=\"padding: 8px; border: 1px solid #ddd;\">${frm.doc.owner}</td>\n            </tr>\n        </table>\n        \n        <p>Please click the link below to review and take action:</p>\n        <p><a href=\"${doc_link}\" style=\"background-color: #5e64ff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;\">Review Document</a></p>\n        \n        <p>Thank you for your prompt attention to this matter.</p>\n        \n        <p style=\"color: #666; font-size: 12px; margin-top: 30px;\">\n            This is an automated reminder from the Workflow Tracker system.\n        </p>\n    `;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Investment Income Forecast",
  "enabled": 1,
  "modified": "2025-12-07 13:19:58.263705",
  "module": null,
  "name": "Investment Income Forecast - Actions",
  "script": "\nfrappe.ui.form.on('Investment Income Forecast', {\n    \n    setup: function(frm) {\n        frm.set_query('investment_asset', function() {\n            return {\n                filters: {\n                    'docstatus': 0,\n                    'status': ['not in', ['Scrapped', 'Sold']]\n                }\n            };\n        });\n    },\n    \n    refresh: function(frm) {\n        frm.trigger('set_title');\n        \n        // Draft document - show all action buttons\n        if (!frm.is_new() && frm.doc.docstatus === 0) {\n            if (frm.doc.investment_asset) {\n                frm.add_custom_button(__('Pull Actuals'), function() {\n                    frm.trigger('pull_actuals');\n                }, __('Actions'));\n            }\n            \n            if (!frm.doc.project) {\n                frm.add_custom_button(__('Create Project'), function() {\n                    frm.trigger('create_project');\n                }, __('Actions'));\n            }\n            \n            if (frm.doc.project && !frm.doc.budget) {\n                frm.add_custom_button(__('Create Budget'), function() {\n                    frm.trigger('create_budget');\n                }, __('Actions'));\n            }\n            \n            if (frm.doc.budget) {\n                let has_actuals = (frm.doc.monthly_forecast || []).some(row => flt(row.actual_amount) > 0 && !row.journal_entry);\n                if (has_actuals) {\n                    frm.add_custom_button(__('Create Journal Entry'), function() {\n                        frm.trigger('create_journal_entry');\n                    }, __('Actions'));\n                }\n            }\n            \n            frm.change_custom_button_type(__('Actions'), null, 'primary');\n        }\n        \n        // Submitted document - show Update Actuals button\n        if (frm.doc.docstatus === 1 && frm.doc.investment_asset) {\n            frm.add_custom_button(__('Update Actuals'), function() {\n                frm.trigger('cancel_amend_and_pull');\n            });\n            frm.change_custom_button_type(__('Update Actuals'), null, 'primary');\n        }\n        \n        frm.trigger('calculate_totals');\n    },\n    \n    cancel_amend_and_pull: function(frm) {\n        let fy = frm.doc.fiscal_year;\n        let start_date = fy + '-01-01';\n        let end_date = fy + '-12-31';\n        \n        frappe.confirm(\n            __('This will cancel the current document, create an amendment, and pull latest actuals for {0}. Continue?', \n                [frm.doc.asset_name]),\n            function() {\n                // Step 1: Fetch GL Entries first\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['property', '=', frm.doc.investment_asset],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date]\n                        ],\n                        fields: ['posting_date', 'credit', 'account', 'voucher_no'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        let entries = r.message || [];\n                        \n                        // Calculate monthly totals\n                        let monthly_totals = {\n                            'January': 0, 'February': 0, 'March': 0,\n                            'April': 0, 'May': 0, 'June': 0,\n                            'July': 0, 'August': 0, 'September': 0,\n                            'October': 0, 'November': 0, 'December': 0\n                        };\n                        \n                        let months = ['January', 'February', 'March', 'April', 'May', 'June',\n                                     'July', 'August', 'September', 'October', 'November', 'December'];\n                        \n                        entries.forEach(function(entry) {\n                            let date = new Date(entry.posting_date);\n                            let month_idx = date.getMonth();\n                            let month_name = months[month_idx];\n                            monthly_totals[month_name] = monthly_totals[month_name] + flt(entry.credit);\n                        });\n                        \n                        // Step 2: Cancel the current document\n                        frappe.call({\n                            method: 'frappe.client.cancel',\n                            args: {\n                                doctype: 'Investment Income Forecast',\n                                name: frm.doc.name\n                            },\n                            freeze: true,\n                            freeze_message: __('Cancelling current document...'),\n                            callback: function(cancel_response) {\n                                // Step 3: Create amended document with updated actuals\n                                let new_doc = {\n                                    doctype: 'Investment Income Forecast',\n                                    amended_from: frm.doc.name,\n                                    investment_asset: frm.doc.investment_asset,\n                                    asset_name: frm.doc.asset_name,\n                                    institution: frm.doc.institution,\n                                    fiscal_year: frm.doc.fiscal_year,\n                                    fund: frm.doc.fund,\n                                    income_type: frm.doc.income_type,\n                                    income_subtype: frm.doc.income_subtype,\n                                    tenor: frm.doc.tenor,\n                                    status: entries.length > 0 ? 'Actuals Entered' : frm.doc.status,\n                                    project: frm.doc.project,\n                                    budget: frm.doc.budget,\n                                    notes: frm.doc.notes,\n                                    monthly_forecast: []\n                                };\n                                \n                                // Copy monthly rows with updated actuals\n                                let total_budget = 0;\n                                let total_actual = 0;\n                                \n                                (frm.doc.monthly_forecast || []).forEach(function(row) {\n                                    let new_actual = monthly_totals[row.month] || 0;\n                                    let budget = flt(row.budget_amount);\n                                    let actual = new_actual > 0 ? new_actual : flt(row.actual_amount);\n                                    let variance = actual - budget;\n                                    let variance_pct = budget ? (variance / budget) * 100 : 0;\n                                    \n                                    total_budget = total_budget + budget;\n                                    total_actual = total_actual + actual;\n                                    \n                                    new_doc.monthly_forecast.push({\n                                        month: row.month,\n                                        budget_amount: budget,\n                                        actual_amount: actual,\n                                        variance: variance,\n                                        variance_percent: variance_pct,\n                                        justification: row.justification,\n                                        actual_entry_date: actual > 0 ? frappe.datetime.get_today() : null,\n                                        journal_entry: row.journal_entry\n                                    });\n                                });\n                                \n                                new_doc.total_budget = total_budget;\n                                new_doc.total_actual = total_actual;\n                                new_doc.total_variance = total_actual - total_budget;\n                                new_doc.variance_percentage = total_budget ? ((total_actual - total_budget) / total_budget) * 100 : 0;\n                                \n                                // Insert the amended document\n                                frappe.call({\n                                    method: 'frappe.client.insert',\n                                    args: {\n                                        doc: new_doc\n                                    },\n                                    freeze: true,\n                                    freeze_message: __('Creating Amendment...'),\n                                    callback: function(insert_response) {\n                                        if (insert_response.message) {\n                                            frappe.show_alert({\n                                                message: __('Amendment created with {0} GL Entries. Total Actual: {1}', \n                                                    [entries.length, format_currency(total_actual)]),\n                                                indicator: 'green'\n                                            });\n                                            frappe.set_route('Form', 'Investment Income Forecast', insert_response.message.name);\n                                        }\n                                    }\n                                });\n                            },\n                            error: function(err) {\n                                frappe.msgprint(__('Error cancelling document. Please cancel manually first.'));\n                            }\n                        });\n                    }\n                });\n            }\n        );\n    },\n    \n    pull_actuals: function(frm) {\n        let fy = frm.doc.fiscal_year;\n        let start_date = fy + '-01-01';\n        let end_date = fy + '-12-31';\n        \n        frappe.confirm(\n            __('Fetch GL Entries for asset {0} from {1} to {2}?', [frm.doc.asset_name, start_date, end_date]),\n            function() {\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['property', '=', frm.doc.investment_asset],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date]\n                        ],\n                        fields: ['posting_date', 'credit', 'account', 'voucher_no'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        if (r.message && r.message.length > 0) {\n                            let entries = r.message;\n                            let monthly_totals = {\n                                'January': 0, 'February': 0, 'March': 0,\n                                'April': 0, 'May': 0, 'June': 0,\n                                'July': 0, 'August': 0, 'September': 0,\n                                'October': 0, 'November': 0, 'December': 0\n                            };\n                            \n                            let months = ['January', 'February', 'March', 'April', 'May', 'June',\n                                         'July', 'August', 'September', 'October', 'November', 'December'];\n                            \n                            entries.forEach(function(entry) {\n                                let date = new Date(entry.posting_date);\n                                let month_idx = date.getMonth();\n                                let month_name = months[month_idx];\n                                monthly_totals[month_name] = monthly_totals[month_name] + flt(entry.credit);\n                            });\n                            \n                            let updated = 0;\n                            (frm.doc.monthly_forecast || []).forEach(function(row) {\n                                let new_actual = monthly_totals[row.month] || 0;\n                                if (new_actual > 0) {\n                                    frappe.model.set_value(row.doctype, row.name, 'actual_amount', new_actual);\n                                    frappe.model.set_value(row.doctype, row.name, 'actual_entry_date', frappe.datetime.get_today());\n                                    updated = updated + 1;\n                                }\n                            });\n                            \n                            frm.trigger('calculate_totals');\n                            \n                            if (frm.doc.status === 'Budget Created' && updated > 0) {\n                                frm.set_value('status', 'Actuals Entered');\n                            }\n                            \n                            frm.save().then(function() {\n                                frappe.show_alert({\n                                    message: __('Updated {0} months from {1} GL Entries. Total: {2}', \n                                        [updated, entries.length, format_currency(frm.doc.total_actual)]),\n                                    indicator: 'green'\n                                });\n                            });\n                        } else {\n                            frappe.msgprint(__('No GL Entries found for asset {0} in fiscal year {1}', \n                                [frm.doc.asset_name, frm.doc.fiscal_year]));\n                        }\n                    }\n                });\n            }\n        );\n    },\n    \n    onload_post_render: function(frm) {\n        if (frm.is_new() && frm.doc.monthly_forecast.length === 0) {\n            frm.trigger('populate_months');\n        }\n    },\n    \n    investment_asset: function(frm) {\n        frm.trigger('set_title');\n    },\n    \n    income_type: function(frm) {\n        frm.trigger('set_title');\n        if (frm.doc.income_type !== 'Interest Income') {\n            frm.set_value('income_subtype', '');\n            frm.set_value('tenor', '');\n        }\n    },\n    \n    fiscal_year: function(frm) {\n        frm.trigger('set_title');\n    },\n    \n    set_title: function(frm) {\n        if (frm.doc.asset_name && frm.doc.income_type && frm.doc.fiscal_year) {\n            let title = frm.doc.asset_name + ' - ' + frm.doc.income_type + ' - ' + frm.doc.fiscal_year;\n            frm.set_value('title', title);\n        }\n    },\n    \n    populate_months: function(frm) {\n        const months = ['January', 'February', 'March', 'April', 'May', 'June',\n                       'July', 'August', 'September', 'October', 'November', 'December'];\n        \n        frm.clear_table('monthly_forecast');\n        months.forEach(month => {\n            let row = frm.add_child('monthly_forecast');\n            row.month = month;\n            row.budget_amount = 0;\n            row.actual_amount = 0;\n            row.variance = 0;\n        });\n        frm.refresh_field('monthly_forecast');\n        frappe.show_alert({message: __('12 months populated'), indicator: 'blue'});\n    },\n    \n    calculate_totals: function(frm) {\n        let total_budget = 0;\n        let total_actual = 0;\n        \n        (frm.doc.monthly_forecast || []).forEach(row => {\n            total_budget = total_budget + flt(row.budget_amount);\n            total_actual = total_actual + flt(row.actual_amount);\n        });\n        \n        let total_variance = total_actual - total_budget;\n        let variance_pct = total_budget ? (total_variance / total_budget) * 100 : 0;\n        \n        frm.set_value('total_budget', total_budget);\n        frm.set_value('total_actual', total_actual);\n        frm.set_value('total_variance', total_variance);\n        frm.set_value('variance_percentage', variance_pct);\n    },\n    \n    get_income_account: function(frm) {\n        let income_type = frm.doc.income_type;\n        let income_subtype = frm.doc.income_subtype;\n        \n        let account_map = {\n            'Dividend Income': '113005 - Dividends - WCFCB',\n            'FV Gain - Financial': '114005 - FV Gains - Financial Investments - WCFCB',\n            'FV Gain - Property': '114010 - FV Gains - Property - WCFCB'\n        };\n        \n        let interest_account_map = {\n            'Government Bonds': '113010 - GRZ bonds - WCFCB',\n            'Treasury Bills': '112005 - Treasury Bills - WCFCB',\n            'Corporate Debt': '113015 - Corporate Debt - WCFCB',\n            'Corporate Bonds': '113020 - Corporate Bonds - WCFCB',\n            'Short Term Deposit': '112010 - Short Term Deposits - WCFCB',\n            'Term Deposit': '113025 - Term Deposits - WCFCB',\n            'Current Account Interest': '113030 - Current Account Interest - WCFCB',\n            'Other': '113000 - Income from Long term investments - WCFCB'\n        };\n        \n        if (income_type === 'Interest Income') {\n            return interest_account_map[income_subtype] || '113000 - Income from Long term investments - WCFCB';\n        }\n        \n        return account_map[income_type] || '110000 - Income from investments - WCFCB';\n    },\n    \n    create_project: function(frm) {\n        frappe.confirm(__('Create a new Project for this forecast?'), function() {\n            let project_name = frm.doc.title || (frm.doc.asset_name + ' - ' + frm.doc.income_type);\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Project',\n                        project_name: project_name,\n                        project_type: 'Internal',\n                        status: 'Open',\n                        expected_start_date: frappe.datetime.get_today(),\n                        company: frappe.defaults.get_default('company'),\n                        notes: 'Investment Income Forecast: ' + frm.doc.name\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Project...'),\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('project', r.message.name);\n                        frm.set_value('status', 'Project Created');\n                        frm.save().then(() => {\n                            frappe.show_alert({message: __('Project created: ') + r.message.name, indicator: 'green'});\n                            frm.reload_doc();\n                        });\n                    }\n                }\n            });\n        });\n    },\n    \n    create_budget: function(frm) {\n        if (!frm.doc.project) {\n            frappe.msgprint(__('Please create a Project first.'));\n            return;\n        }\n        \n        frappe.confirm(__('Create Budget linked to Project? Budget amount will be negative (income).'), function() {\n            let income_account = frm.events.get_income_account(frm);\n            let total_amount = -1 * Math.abs(frm.doc.total_budget || 0);\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Budget',\n                        naming_series: 'PRJ-BUD-.{project}.-FY-.YYYY.-',\n                        budget_against: 'Project',\n                        project: frm.doc.project,\n                        fiscal_year: frm.doc.fiscal_year,\n                        company: frappe.defaults.get_default('company'),\n                        docstatus: 0,\n                        accounts: [{\n                            account: income_account,\n                            budget_amount: total_amount\n                        }]\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Budget...'),\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('budget', r.message.name);\n                        frm.set_value('status', 'Budget Created');\n                        frm.save().then(() => {\n                            frappe.show_alert({message: __('Budget created in Draft: ') + r.message.name, indicator: 'green'});\n                            frm.reload_doc();\n                        });\n                    }\n                }\n            });\n        });\n    },\n    \n    create_journal_entry: function(frm) {\n        let rows_with_actuals = (frm.doc.monthly_forecast || []).filter(row => \n            flt(row.actual_amount) > 0 && !row.journal_entry\n        );\n        \n        if (rows_with_actuals.length === 0) {\n            frappe.msgprint(__('No unposted actuals found.'));\n            return;\n        }\n        \n        let total_actual = 0;\n        let months_list = [];\n        rows_with_actuals.forEach(row => {\n            total_actual = total_actual + flt(row.actual_amount);\n            months_list.push(row.month);\n        });\n        \n        let income_account = frm.events.get_income_account(frm);\n        \n        let d = new frappe.ui.Dialog({\n            title: __('Create Journal Entry'),\n            fields: [\n                {label: __('Months'), fieldname: 'months_info', fieldtype: 'HTML',\n                 options: '<p><strong>Months:</strong> ' + months_list.join(', ') + '</p><p><strong>Total:</strong> ' + format_currency(total_actual) + '</p><p><strong>Income Account:</strong> ' + income_account + '</p>'},\n                {label: __('Posting Date'), fieldname: 'posting_date', fieldtype: 'Date',\n                 default: frappe.datetime.get_today(), reqd: 1},\n                {label: __('Remarks'), fieldname: 'remarks', fieldtype: 'Small Text',\n                 default: 'Investment Income - ' + frm.doc.asset_name}\n            ],\n            primary_action_label: __('Create'),\n            primary_action: function(values) {\n                d.hide();\n                frm.trigger('post_journal', [values, rows_with_actuals, total_actual, income_account]);\n            }\n        });\n        d.show();\n    },\n    \n    post_journal: function(frm, args) {\n        let values = args[0];\n        let rows = args[1];\n        let total = args[2];\n        let income_account = args[3];\n        \n        let receivable_account = '443010 - Dividends Receivable - WCFCB';\n        \n        let accounts = [\n            {\n                account: receivable_account, \n                debit_in_account_currency: total, \n                credit_in_account_currency: 0, \n                project: frm.doc.project\n            },\n            {\n                account: income_account, \n                debit_in_account_currency: 0, \n                credit_in_account_currency: total, \n                project: frm.doc.project\n            }\n        ];\n        \n        frappe.call({\n            method: 'frappe.client.insert',\n            args: {\n                doc: {\n                    doctype: 'Journal Entry',\n                    posting_date: values.posting_date,\n                    company: frappe.defaults.get_default('company'),\n                    voucher_type: 'Journal Entry',\n                    user_remark: values.remarks,\n                    cheque_no: frm.doc.name,\n                    cheque_date: values.posting_date,\n                    accounts: accounts\n                }\n            },\n            freeze: true,\n            freeze_message: __('Creating Journal Entry...'),\n            callback: function(r) {\n                if (r.message) {\n                    rows.forEach(row => {\n                        frappe.model.set_value(row.doctype, row.name, 'journal_entry', r.message.name);\n                    });\n                    \n                    frm.set_value('status', 'Journal Posted');\n                    frm.save().then(() => {\n                        frappe.show_alert({message: __('Journal Entry created: ') + r.message.name, indicator: 'green'});\n                        frm.reload_doc();\n                    });\n                }\n            }\n        });\n    }\n});\n\nfrappe.ui.form.on('Investment Income Forecast Item', {\n    budget_amount: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        frappe.model.set_value(cdt, cdn, 'variance', flt(row.actual_amount) - flt(row.budget_amount));\n        let pct = row.budget_amount ? ((row.actual_amount - row.budget_amount) / row.budget_amount) * 100 : 0;\n        frappe.model.set_value(cdt, cdn, 'variance_percent', pct);\n        frm.trigger('calculate_totals');\n    },\n    \n    actual_amount: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        frappe.model.set_value(cdt, cdn, 'variance', flt(row.actual_amount) - flt(row.budget_amount));\n        let pct = row.budget_amount ? ((row.actual_amount - row.budget_amount) / row.budget_amount) * 100 : 0;\n        frappe.model.set_value(cdt, cdn, 'variance_percent', pct);\n        \n        if (flt(row.actual_amount) > 0 && !row.actual_entry_date) {\n            frappe.model.set_value(cdt, cdn, 'actual_entry_date', frappe.datetime.get_today());\n        }\n        \n        frm.trigger('calculate_totals');\n        \n        if (frm.doc.status === 'Budget Created') {\n            frm.set_value('status', 'Actuals Entered');\n        }\n    },\n    \n    monthly_forecast_remove: function(frm) {\n        frm.trigger('calculate_totals');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Rental Income Budget",
  "enabled": 1,
  "modified": "2025-12-07 13:44:51.067877",
  "module": null,
  "name": "Rental Income Budget - Actions",
  "script": "\nfrappe.ui.form.on('Rental Income Budget', {\n    \n    setup: function(frm) {\n        frm.set_query('property', function() {\n            return {\n                filters: {\n                    'docstatus': 0,\n                    'status': ['not in', ['Scrapped', 'Sold']]\n                }\n            };\n        });\n    },\n    \n    refresh: function(frm) {\n        // Draft document - show action buttons\n        if (!frm.is_new() && frm.doc.docstatus === 0) {\n            if (frm.doc.property) {\n                frm.add_custom_button(__('Pull Actuals'), function() {\n                    frm.trigger('pull_actuals');\n                }, __('Actions'));\n            }\n            \n            if (!frm.doc.project) {\n                frm.add_custom_button(__('Create Project'), function() {\n                    frm.trigger('create_project');\n                }, __('Actions'));\n            }\n            \n            if (frm.doc.project && !frm.doc.budget) {\n                frm.add_custom_button(__('Create Budget'), function() {\n                    frm.trigger('create_budget');\n                }, __('Actions'));\n            }\n            \n            frm.change_custom_button_type(__('Actions'), null, 'primary');\n        }\n        \n        // Submitted document - show Update Actuals button\n        if (frm.doc.docstatus === 1 && frm.doc.property) {\n            frm.add_custom_button(__('Update Actuals'), function() {\n                frm.trigger('cancel_amend_and_pull');\n            });\n            frm.change_custom_button_type(__('Update Actuals'), null, 'primary');\n        }\n        \n        frm.trigger('calculate_totals');\n    },\n    \n    property: function(frm) {\n        if (frm.doc.property) {\n            frappe.db.get_value('Asset', frm.doc.property, ['asset_name', 'location'], function(r) {\n                if (r) {\n                    frm.set_value('property_name', r.asset_name);\n                    frm.set_value('location', r.location || '');\n                }\n            });\n        }\n    },\n    \n    actual_rent: function(frm) {\n        frm.trigger('calculate_actuals');\n    },\n    \n    actual_service_charge: function(frm) {\n        frm.trigger('calculate_actuals');\n    },\n    \n    calculate_actuals: function(frm) {\n        let actual_rent = flt(frm.doc.actual_rent);\n        let actual_sc = flt(frm.doc.actual_service_charge);\n        let total_actual = actual_rent + actual_sc;\n        \n        let rent_variance = actual_rent - flt(frm.doc.annual_rent_budget);\n        let sc_variance = actual_sc - flt(frm.doc.annual_service_charge_budget);\n        let total_variance = total_actual - flt(frm.doc.total_budget);\n        let variance_pct = frm.doc.total_budget ? (total_variance / frm.doc.total_budget) * 100 : 0;\n        \n        frm.set_value('total_actual', total_actual);\n        frm.set_value('rent_variance', rent_variance);\n        frm.set_value('service_charge_variance', sc_variance);\n        frm.set_value('total_variance', total_variance);\n        frm.set_value('variance_percentage', variance_pct);\n        \n        if (total_actual > 0 && frm.doc.status === 'Budget Created') {\n            frm.set_value('status', 'Actuals Entered');\n        }\n    },\n    \n    calculate_totals: function(frm) {\n        let monthly_rent = 0;\n        let monthly_sc = 0;\n        let annual_rent = 0;\n        let annual_sc = 0;\n        let unit_count = 0;\n        \n        (frm.doc.sublets || []).forEach(function(row) {\n            monthly_rent = monthly_rent + flt(row.rent_per_month);\n            monthly_sc = monthly_sc + flt(row.service_charge_per_month);\n            annual_rent = annual_rent + flt(row.annual_rent);\n            annual_sc = annual_sc + flt(row.annual_service_charge);\n            unit_count = unit_count + 1;\n        });\n        \n        let monthly_total = monthly_rent + monthly_sc;\n        let total_budget = annual_rent + annual_sc;\n        \n        frm.set_value('monthly_rent', monthly_rent);\n        frm.set_value('monthly_service_charge', monthly_sc);\n        frm.set_value('monthly_total', monthly_total);\n        frm.set_value('annual_rent_budget', annual_rent);\n        frm.set_value('annual_service_charge_budget', annual_sc);\n        frm.set_value('total_budget', total_budget);\n        frm.set_value('number_of_units', unit_count);\n        \n        frm.trigger('calculate_actuals');\n    },\n    \n    cancel_amend_and_pull: function(frm) {\n        let fy = frm.doc.fiscal_year;\n        let start_date = fy + '-01-01';\n        let end_date = fy + '-12-31';\n        \n        frappe.confirm(\n            __('This will cancel the current document, create an amendment, and pull latest actuals for {0}. Continue?', \n                [frm.doc.property_name]),\n            function() {\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['property', '=', frm.doc.property],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date],\n                            ['account', 'like', '111%']\n                        ],\n                        fields: ['posting_date', 'credit', 'account', 'voucher_no'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        let entries = r.message || [];\n                        let total_actual = 0;\n                        entries.forEach(function(e) {\n                            total_actual = total_actual + flt(e.credit);\n                        });\n                        \n                        frappe.call({\n                            method: 'frappe.client.cancel',\n                            args: {\n                                doctype: 'Rental Income Budget',\n                                name: frm.doc.name\n                            },\n                            freeze: true,\n                            freeze_message: __('Cancelling current document...'),\n                            callback: function(cancel_response) {\n                                let new_doc = {\n                                    doctype: 'Rental Income Budget',\n                                    amended_from: frm.doc.name,\n                                    fiscal_year: frm.doc.fiscal_year,\n                                    fund: frm.doc.fund,\n                                    property: frm.doc.property,\n                                    property_name: frm.doc.property_name,\n                                    location: frm.doc.location,\n                                    property_type: frm.doc.property_type,\n                                    occupancy_rate: frm.doc.occupancy_rate,\n                                    status: 'Actuals Entered',\n                                    project: frm.doc.project,\n                                    budget: frm.doc.budget,\n                                    monthly_rent: frm.doc.monthly_rent,\n                                    monthly_service_charge: frm.doc.monthly_service_charge,\n                                    monthly_total: frm.doc.monthly_total,\n                                    annual_rent_budget: frm.doc.annual_rent_budget,\n                                    annual_service_charge_budget: frm.doc.annual_service_charge_budget,\n                                    total_budget: frm.doc.total_budget,\n                                    number_of_units: frm.doc.number_of_units,\n                                    actual_rent: total_actual,\n                                    actual_service_charge: 0,\n                                    total_actual: total_actual,\n                                    rent_variance: total_actual - flt(frm.doc.annual_rent_budget),\n                                    total_variance: total_actual - flt(frm.doc.total_budget),\n                                    notes: frm.doc.notes,\n                                    sublets: []\n                                };\n                                \n                                (frm.doc.sublets || []).forEach(function(row) {\n                                    new_doc.sublets.push({\n                                        tenant_name: row.tenant_name,\n                                        unit_code: row.unit_code,\n                                        rent_per_month: row.rent_per_month,\n                                        service_charge_per_month: row.service_charge_per_month,\n                                        annual_rent: row.annual_rent,\n                                        annual_service_charge: row.annual_service_charge,\n                                        total_annual: row.total_annual,\n                                        notes: row.notes\n                                    });\n                                });\n                                \n                                frappe.call({\n                                    method: 'frappe.client.insert',\n                                    args: { doc: new_doc },\n                                    freeze: true,\n                                    freeze_message: __('Creating Amendment...'),\n                                    callback: function(insert_response) {\n                                        if (insert_response.message) {\n                                            frappe.show_alert({\n                                                message: __('Amendment created. Actual: {0}', [format_currency(total_actual)]),\n                                                indicator: 'green'\n                                            });\n                                            frappe.set_route('Form', 'Rental Income Budget', insert_response.message.name);\n                                        }\n                                    }\n                                });\n                            }\n                        });\n                    }\n                });\n            }\n        );\n    },\n    \n    pull_actuals: function(frm) {\n        let fy = frm.doc.fiscal_year;\n        let start_date = fy + '-01-01';\n        let end_date = fy + '-12-31';\n        \n        frappe.confirm(\n            __('Fetch GL Entries for property {0} from {1} to {2}?', [frm.doc.property_name, start_date, end_date]),\n            function() {\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['property', '=', frm.doc.property],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date],\n                            ['account', 'like', '111%']\n                        ],\n                        fields: ['posting_date', 'credit', 'account', 'voucher_no'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        if (r.message && r.message.length > 0) {\n                            let entries = r.message;\n                            let total_actual = 0;\n                            entries.forEach(function(e) {\n                                total_actual = total_actual + flt(e.credit);\n                            });\n                            \n                            frm.set_value('actual_rent', total_actual);\n                            frm.trigger('calculate_actuals');\n                            \n                            if (frm.doc.status === 'Budget Created') {\n                                frm.set_value('status', 'Actuals Entered');\n                            }\n                            \n                            frm.save().then(function() {\n                                frappe.show_alert({\n                                    message: __('Updated from {0} GL Entries. Total: {1}', \n                                        [entries.length, format_currency(total_actual)]),\n                                    indicator: 'green'\n                                });\n                            });\n                        } else {\n                            frappe.msgprint(__('No GL Entries found for property {0} in fiscal year {1}', \n                                [frm.doc.property_name, frm.doc.fiscal_year]));\n                        }\n                    }\n                });\n            }\n        );\n    },\n    \n    create_project: function(frm) {\n        frappe.confirm(__('Create a new Project for this rental income budget?'), function() {\n            let project_name = frm.doc.property_name + ' - Rental Income - ' + frm.doc.fiscal_year;\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Project',\n                        project_name: project_name,\n                        project_type: 'Internal',\n                        status: 'Open',\n                        expected_start_date: frappe.datetime.get_today(),\n                        company: frappe.defaults.get_default('company'),\n                        notes: 'Rental Income Budget: ' + frm.doc.name\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Project...'),\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('project', r.message.name);\n                        frm.set_value('status', 'Project Created');\n                        frm.save().then(() => {\n                            frappe.show_alert({message: __('Project created: ') + r.message.name, indicator: 'green'});\n                            frm.reload_doc();\n                        });\n                    }\n                }\n            });\n        });\n    },\n    \n    create_budget: function(frm) {\n        if (!frm.doc.project) {\n            frappe.msgprint(__('Please create a Project first.'));\n            return;\n        }\n        \n        frappe.confirm(__('Create Budget linked to Project? Budget amount will be negative (income).'), function() {\n            let income_account = '111005 - Rental income - WCFCB';\n            let total_amount = -1 * Math.abs(frm.doc.total_budget || 0);\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Budget',\n                        naming_series: 'PRJ-BUD-.{project}.-FY-.YYYY.-',\n                        budget_against: 'Project',\n                        project: frm.doc.project,\n                        fiscal_year: frm.doc.fiscal_year,\n                        company: frappe.defaults.get_default('company'),\n                        docstatus: 0,\n                        accounts: [{\n                            account: income_account,\n                            budget_amount: total_amount\n                        }]\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Budget...'),\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('budget', r.message.name);\n                        frm.set_value('status', 'Budget Created');\n                        frm.save().then(() => {\n                            frappe.show_alert({message: __('Budget created: ') + r.message.name, indicator: 'green'});\n                            frm.reload_doc();\n                        });\n                    }\n                }\n            });\n        });\n    }\n});\n\nfrappe.ui.form.on('Rental Income Budget Item', {\n    rent_per_month: function(frm, cdt, cdn) {\n        frm.events.calculate_row(frm, cdt, cdn);\n    },\n    \n    service_charge_per_month: function(frm, cdt, cdn) {\n        frm.events.calculate_row(frm, cdt, cdn);\n    },\n    \n    sublets_add: function(frm, cdt, cdn) {\n        frm.trigger('calculate_totals');\n    },\n    \n    sublets_remove: function(frm, cdt, cdn) {\n        frm.trigger('calculate_totals');\n    }\n});\n\nfrappe.ui.form.on('Rental Income Budget', {\n    calculate_row: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let annual_rent = flt(row.rent_per_month) * 12;\n        let annual_sc = flt(row.service_charge_per_month) * 12;\n        let total = annual_rent + annual_sc;\n        \n        frappe.model.set_value(cdt, cdn, 'annual_rent', annual_rent);\n        frappe.model.set_value(cdt, cdn, 'annual_service_charge', annual_sc);\n        frappe.model.set_value(cdt, cdn, 'total_annual', total);\n        \n        frm.trigger('calculate_totals');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Assessment Budget",
  "enabled": 1,
  "modified": "2025-12-08 00:06:39.495020",
  "module": null,
  "name": "Assessment Budget - Actions",
  "script": "\nfrappe.ui.form.on('Assessment Budget', {\n    \n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.docstatus === 0) {\n            frm.add_custom_button(__('Populate Months'), function() {\n                frm.trigger('populate_distribution');\n            }, __('Actions'));\n            \n            frm.add_custom_button(__('Pull Actuals'), function() {\n                frm.trigger('pull_actuals');\n            }, __('Actions'));\n            \n            if (!frm.doc.project) {\n                frm.add_custom_button(__('Create Project'), function() {\n                    frm.trigger('create_project');\n                }, __('Actions'));\n            }\n            \n            if (frm.doc.project && !frm.doc.budget_link) {\n                frm.add_custom_button(__('Create Budget'), function() {\n                    frm.trigger('create_budget');\n                }, __('Actions'));\n            }\n            \n            frm.change_custom_button_type(__('Actions'), null, 'primary');\n        }\n        \n        if (frm.doc.docstatus === 1) {\n            frm.add_custom_button(__('Update Actuals'), function() {\n                frm.trigger('cancel_amend_and_pull');\n            });\n            frm.change_custom_button_type(__('Update Actuals'), null, 'primary');\n        }\n        \n        frm.trigger('calculate_totals');\n    },\n    \n    populate_distribution: function(frm) {\n        if (!frm.doc.total_budgeted_assessments) {\n            frappe.msgprint(__('Please add assessment items first.'));\n            return;\n        }\n        \n        let distribution = [\n            {month: 'January', percent: 25},\n            {month: 'February', percent: 22},\n            {month: 'March', percent: 14},\n            {month: 'April', percent: 9},\n            {month: 'May', percent: 7},\n            {month: 'June', percent: 6},\n            {month: 'July', percent: 4},\n            {month: 'August', percent: 3},\n            {month: 'September', percent: 3},\n            {month: 'October', percent: 3},\n            {month: 'November', percent: 2},\n            {month: 'December', percent: 2}\n        ];\n        \n        frm.clear_table('distribution');\n        let total = flt(frm.doc.total_budgeted_assessments);\n        let cumulative = 0;\n        \n        distribution.forEach(function(d) {\n            let amount = total * d.percent / 100;\n            cumulative = cumulative + amount;\n            \n            let row = frm.add_child('distribution');\n            row.month = d.month;\n            row.distribution_percent = d.percent;\n            row.budgeted_amount = amount;\n            row.cumulative_budget = cumulative;\n            row.current_collection = 0;\n            row.old_debt_collection = 0;\n            row.total_collection = 0;\n            row.cumulative_collection = 0;\n            row.variance = 0 - amount;\n        });\n        \n        frm.refresh_field('distribution');\n        frappe.show_alert({message: __('12 months populated with distribution'), indicator: 'blue'});\n    },\n    \n    calculate_totals: function(frm) {\n        let total_curr_employers = 0;\n        let total_curr_employees = 0;\n        let total_bud_employers = 0;\n        let total_bud_employees = 0;\n        let total_assessments = 0;\n        \n        (frm.doc.assessment_items || []).forEach(function(row) {\n            total_curr_employers = total_curr_employers + flt(row.current_employers);\n            total_curr_employees = total_curr_employees + flt(row.current_employees);\n            total_bud_employers = total_bud_employers + flt(row.budgeted_employers);\n            total_bud_employees = total_bud_employees + flt(row.budgeted_employees);\n            total_assessments = total_assessments + flt(row.budgeted_assessments);\n        });\n        \n        frm.set_value('total_current_employers', total_curr_employers);\n        frm.set_value('total_current_employees', total_curr_employees);\n        frm.set_value('total_budgeted_employers', total_bud_employers);\n        frm.set_value('total_budgeted_employees', total_bud_employees);\n        frm.set_value('total_budgeted_assessments', total_assessments);\n        \n        let total_current = 0;\n        let total_old = 0;\n        let total_coll = 0;\n        \n        (frm.doc.distribution || []).forEach(function(row) {\n            total_current = total_current + flt(row.current_collection);\n            total_old = total_old + flt(row.old_debt_collection);\n            total_coll = total_coll + flt(row.total_collection);\n        });\n        \n        let variance = total_coll - total_assessments;\n        let variance_pct = total_assessments ? (variance / total_assessments) * 100 : 0;\n        \n        frm.set_value('total_current_collection', total_current);\n        frm.set_value('total_old_debt_collection', total_old);\n        frm.set_value('total_collection', total_coll);\n        frm.set_value('total_variance', variance);\n        frm.set_value('variance_percentage', variance_pct);\n    },\n    \n    pull_actuals: function(frm) {\n        if (!frm.doc.cost_centre) {\n            frappe.msgprint(__('Please set a Cost Centre first.'));\n            return;\n        }\n        \n        let fy = frm.doc.fiscal_year;\n        let start_date = fy + '-01-01';\n        let end_date = fy + '-12-31';\n        \n        frappe.confirm(\n            __('Fetch GL Entries for Cost Centre {0} from {1} to {2}?', [frm.doc.cost_centre, start_date, end_date]),\n            function() {\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['cost_center', '=', frm.doc.cost_centre],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date],\n                            ['account', 'like', '100005%']\n                        ],\n                        fields: ['posting_date', 'credit', 'account', 'voucher_no'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        if (r.message && r.message.length > 0) {\n                            let entries = r.message;\n                            let monthly_totals = {\n                                'January': 0, 'February': 0, 'March': 0,\n                                'April': 0, 'May': 0, 'June': 0,\n                                'July': 0, 'August': 0, 'September': 0,\n                                'October': 0, 'November': 0, 'December': 0\n                            };\n                            \n                            let months = ['January', 'February', 'March', 'April', 'May', 'June',\n                                         'July', 'August', 'September', 'October', 'November', 'December'];\n                            \n                            entries.forEach(function(entry) {\n                                let date = new Date(entry.posting_date);\n                                let month_idx = date.getMonth();\n                                let month_name = months[month_idx];\n                                monthly_totals[month_name] = monthly_totals[month_name] + flt(entry.credit);\n                            });\n                            \n                            let updated = 0;\n                            let cumulative = 0;\n                            \n                            (frm.doc.distribution || []).forEach(function(row) {\n                                let new_collection = monthly_totals[row.month] || 0;\n                                cumulative = cumulative + new_collection;\n                                \n                                frappe.model.set_value(row.doctype, row.name, 'current_collection', new_collection);\n                                frappe.model.set_value(row.doctype, row.name, 'total_collection', new_collection + flt(row.old_debt_collection));\n                                frappe.model.set_value(row.doctype, row.name, 'cumulative_collection', cumulative);\n                                frappe.model.set_value(row.doctype, row.name, 'variance', (new_collection + flt(row.old_debt_collection)) - flt(row.budgeted_amount));\n                                \n                                if (new_collection > 0) {\n                                    updated = updated + 1;\n                                }\n                            });\n                            \n                            frm.trigger('calculate_totals');\n                            \n                            if (frm.doc.status === 'Budget Created' && updated > 0) {\n                                frm.set_value('status', 'Actuals Entered');\n                            }\n                            \n                            frm.save().then(function() {\n                                frappe.show_alert({\n                                    message: __('Updated {0} months from {1} GL Entries', [updated, entries.length]),\n                                    indicator: 'green'\n                                });\n                            });\n                        } else {\n                            frappe.msgprint(__('No GL Entries found for cost centre {0} on account 100005 in fiscal year {1}', \n                                [frm.doc.cost_centre, frm.doc.fiscal_year]));\n                        }\n                    }\n                });\n            }\n        );\n    },\n    \n    cancel_amend_and_pull: function(frm) {\n        frappe.confirm(\n            __('This will cancel the current document, create an amendment, and pull latest actuals. Continue?'),\n            function() {\n                let fy = frm.doc.fiscal_year;\n                let start_date = fy + '-01-01';\n                let end_date = fy + '-12-31';\n                \n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'GL Entry',\n                        filters: [\n                            ['cost_center', '=', frm.doc.cost_centre],\n                            ['is_cancelled', '=', 0],\n                            ['credit', '>', 0],\n                            ['posting_date', '>=', start_date],\n                            ['posting_date', '<=', end_date],\n                            ['account', 'like', '100005%']\n                        ],\n                        fields: ['posting_date', 'credit'],\n                        limit_page_length: 0\n                    },\n                    freeze: true,\n                    freeze_message: __('Fetching GL Entries...'),\n                    callback: function(r) {\n                        let entries = r.message || [];\n                        let monthly_totals = {};\n                        let months = ['January', 'February', 'March', 'April', 'May', 'June',\n                                     'July', 'August', 'September', 'October', 'November', 'December'];\n                        months.forEach(function(m) { monthly_totals[m] = 0; });\n                        \n                        entries.forEach(function(entry) {\n                            let date = new Date(entry.posting_date);\n                            let month_name = months[date.getMonth()];\n                            monthly_totals[month_name] = monthly_totals[month_name] + flt(entry.credit);\n                        });\n                        \n                        frappe.call({\n                            method: 'frappe.client.cancel',\n                            args: { doctype: 'Assessment Budget', name: frm.doc.name },\n                            freeze: true,\n                            freeze_message: __('Cancelling...'),\n                            callback: function() {\n                                let new_doc = {\n                                    doctype: 'Assessment Budget',\n                                    amended_from: frm.doc.name,\n                                    fiscal_year: frm.doc.fiscal_year,\n                                    fund: frm.doc.fund,\n                                    branch: frm.doc.branch,\n                                    branch_code: frm.doc.branch_code,\n                                    cost_centre: frm.doc.cost_centre,\n                                    directorate: frm.doc.directorate,\n                                    department: frm.doc.department,\n                                    location_code: frm.doc.location_code,\n                                    status: 'Actuals Entered',\n                                    project: frm.doc.project,\n                                    budget_link: frm.doc.budget_link,\n                                    assumptions: frm.doc.assumptions,\n                                    notes: frm.doc.notes,\n                                    assessment_items: [],\n                                    distribution: []\n                                };\n                                \n                                (frm.doc.assessment_items || []).forEach(function(row) {\n                                    new_doc.assessment_items.push({\n                                        employer_class: row.employer_class,\n                                        category: row.category,\n                                        current_employers: row.current_employers,\n                                        current_employees: row.current_employees,\n                                        budgeted_employers: row.budgeted_employers,\n                                        budgeted_employees: row.budgeted_employees,\n                                        average_salary: row.average_salary,\n                                        assessment_rate: row.assessment_rate,\n                                        budgeted_assessments: row.budgeted_assessments\n                                    });\n                                });\n                                \n                                let cumulative = 0;\n                                (frm.doc.distribution || []).forEach(function(row) {\n                                    let new_coll = monthly_totals[row.month] || 0;\n                                    cumulative = cumulative + new_coll;\n                                    new_doc.distribution.push({\n                                        month: row.month,\n                                        distribution_percent: row.distribution_percent,\n                                        budgeted_amount: row.budgeted_amount,\n                                        cumulative_budget: row.cumulative_budget,\n                                        current_collection: new_coll,\n                                        old_debt_collection: row.old_debt_collection,\n                                        total_collection: new_coll + flt(row.old_debt_collection),\n                                        cumulative_collection: cumulative,\n                                        variance: (new_coll + flt(row.old_debt_collection)) - flt(row.budgeted_amount)\n                                    });\n                                });\n                                \n                                frappe.call({\n                                    method: 'frappe.client.insert',\n                                    args: { doc: new_doc },\n                                    freeze: true,\n                                    freeze_message: __('Creating Amendment...'),\n                                    callback: function(insert_response) {\n                                        if (insert_response.message) {\n                                            frappe.show_alert({ message: __('Amendment created'), indicator: 'green' });\n                                            frappe.set_route('Form', 'Assessment Budget', insert_response.message.name);\n                                        }\n                                    }\n                                });\n                            }\n                        });\n                    }\n                });\n            }\n        );\n    },\n    \n    create_project: function(frm) {\n        frappe.confirm(__('Create a new Project for this assessment budget?'), function() {\n            let project_name = frm.doc.branch + ' - Assessment Budget - ' + frm.doc.fiscal_year;\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Project',\n                        project_name: project_name,\n                        project_type: 'Internal',\n                        status: 'Open',\n                        expected_start_date: frappe.datetime.get_today(),\n                        company: frappe.defaults.get_default('company'),\n                        cost_center: frm.doc.cost_centre,\n                        notes: 'Assessment Budget: ' + frm.doc.name\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Project...'),\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('project', r.message.name);\n                        frm.set_value('status', 'Project Created');\n                        frm.save().then(() => {\n                            frappe.show_alert({message: __('Project created: ') + r.message.name, indicator: 'green'});\n                        });\n                    }\n                }\n            });\n        });\n    },\n    \n    create_budget: function(frm) {\n        if (!frm.doc.project) {\n            frappe.msgprint(__('Please create a Project first.'));\n            return;\n        }\n        \n        if (!frm.doc.distribution || frm.doc.distribution.length === 0) {\n            frappe.msgprint(__('Please populate monthly distribution first.'));\n            return;\n        }\n        \n        frappe.confirm(__('Create Budget with Monthly Distribution linked to Cost Centre?'), function() {\n            let dist_name = frm.doc.branch + ' - ' + frm.doc.fiscal_year + ' - Assessment';\n            \n            let percentages = [];\n            (frm.doc.distribution || []).forEach(function(row) {\n                percentages.push({\n                    month: row.month,\n                    percentage_allocation: row.distribution_percent\n                });\n            });\n            \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Monthly Distribution',\n                        distribution_id: dist_name,\n                        fiscal_year: frm.doc.fiscal_year,\n                        percentages: percentages\n                    }\n                },\n                freeze: true,\n                freeze_message: __('Creating Monthly Distribution...'),\n                callback: function(dist_response) {\n                    if (dist_response.message) {\n                        let monthly_dist_name = dist_response.message.name;\n                        let total_amount = -1 * Math.abs(frm.doc.total_budgeted_assessments || 0);\n                        \n                        frappe.call({\n                            method: 'frappe.client.insert',\n                            args: {\n                                doc: {\n                                    doctype: 'Budget',\n                                    naming_series: 'PRJ-BUD-.{project}.-FY-.YYYY.-',\n                                    budget_against: 'Cost Center',\n                                    cost_center: frm.doc.cost_centre,\n                                    fiscal_year: frm.doc.fiscal_year,\n                                    company: frappe.defaults.get_default('company'),\n                                    monthly_distribution: monthly_dist_name,\n                                    docstatus: 0,\n                                    accounts: [{\n                                        account: '100005 - Assessment Raised - WCFCB',\n                                        budget_amount: total_amount\n                                    }]\n                                }\n                            },\n                            freeze: true,\n                            freeze_message: __('Creating Budget...'),\n                            callback: function(r) {\n                                if (r.message) {\n                                    frm.set_value('budget_link', r.message.name);\n                                    frm.set_value('status', 'Budget Created');\n                                    frm.save().then(() => {\n                                        frappe.show_alert({\n                                            message: __('Budget created: {0} with Monthly Distribution: {1}', \n                                                [r.message.name, monthly_dist_name]),\n                                            indicator: 'green'\n                                        });\n                                    });\n                                }\n                            }\n                        });\n                    }\n                },\n                error: function(err) {\n                    frappe.call({\n                        method: 'frappe.client.get_value',\n                        args: {\n                            doctype: 'Monthly Distribution',\n                            filters: { distribution_id: dist_name },\n                            fieldname: 'name'\n                        },\n                        callback: function(existing) {\n                            let monthly_dist_name = existing.message ? existing.message.name : null;\n                            \n                            if (!monthly_dist_name) {\n                                frappe.msgprint(__('Error creating Monthly Distribution. Please try again.'));\n                                return;\n                            }\n                            \n                            let total_amount = -1 * Math.abs(frm.doc.total_budgeted_assessments || 0);\n                            \n                            frappe.call({\n                                method: 'frappe.client.insert',\n                                args: {\n                                    doc: {\n                                        doctype: 'Budget',\n                                        naming_series: 'PRJ-BUD-.{project}.-FY-.YYYY.-',\n                                        budget_against: 'Cost Center',\n                                        cost_center: frm.doc.cost_centre,\n                                        fiscal_year: frm.doc.fiscal_year,\n                                        company: frappe.defaults.get_default('company'),\n                                        monthly_distribution: monthly_dist_name,\n                                        docstatus: 0,\n                                        accounts: [{\n                                            account: '100005 - Assessment Raised - WCFCB',\n                                            budget_amount: total_amount\n                                        }]\n                                    }\n                                },\n                                freeze: true,\n                                freeze_message: __('Creating Budget...'),\n                                callback: function(r) {\n                                    if (r.message) {\n                                        frm.set_value('budget_link', r.message.name);\n                                        frm.set_value('status', 'Budget Created');\n                                        frm.save().then(() => {\n                                            frappe.show_alert({\n                                                message: __('Budget created: {0}', [r.message.name]),\n                                                indicator: 'green'\n                                            });\n                                        });\n                                    }\n                                }\n                            });\n                        }\n                    });\n                }\n            });\n        });\n    }\n});\n\nfrappe.ui.form.on('Assessment Budget Item', {\n    budgeted_employees: function(frm, cdt, cdn) {\n        frm.events.calculate_item_row(frm, cdt, cdn);\n    },\n    \n    average_salary: function(frm, cdt, cdn) {\n        frm.events.calculate_item_row(frm, cdt, cdn);\n    },\n    \n    assessment_rate: function(frm, cdt, cdn) {\n        frm.events.calculate_item_row(frm, cdt, cdn);\n    },\n    \n    assessment_items_add: function(frm) {\n        frm.trigger('calculate_totals');\n    },\n    \n    assessment_items_remove: function(frm) {\n        frm.trigger('calculate_totals');\n    }\n});\n\nfrappe.ui.form.on('Assessment Budget', {\n    calculate_item_row: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let budgeted = flt(row.budgeted_employees) * flt(row.average_salary) * (flt(row.assessment_rate) / 100) * 12;\n        frappe.model.set_value(cdt, cdn, 'budgeted_assessments', budgeted);\n        frm.trigger('calculate_totals');\n    }\n});\n\nfrappe.ui.form.on('Assessment Budget Distribution', {\n    current_collection: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let total = flt(row.current_collection) + flt(row.old_debt_collection);\n        let variance = total - flt(row.budgeted_amount);\n        frappe.model.set_value(cdt, cdn, 'total_collection', total);\n        frappe.model.set_value(cdt, cdn, 'variance', variance);\n        frm.trigger('recalculate_cumulative');\n    },\n    \n    old_debt_collection: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let total = flt(row.current_collection) + flt(row.old_debt_collection);\n        let variance = total - flt(row.budgeted_amount);\n        frappe.model.set_value(cdt, cdn, 'total_collection', total);\n        frappe.model.set_value(cdt, cdn, 'variance', variance);\n        frm.trigger('recalculate_cumulative');\n    },\n    \n    distribution_remove: function(frm) {\n        frm.trigger('calculate_totals');\n    }\n});\n\nfrappe.ui.form.on('Assessment Budget', {\n    recalculate_cumulative: function(frm) {\n        let cumulative = 0;\n        (frm.doc.distribution || []).forEach(function(row) {\n            cumulative = cumulative + flt(row.total_collection);\n            frappe.model.set_value(row.doctype, row.name, 'cumulative_collection', cumulative);\n        });\n        frm.trigger('calculate_totals');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Master Procurement Plan",
  "enabled": 1,
  "modified": "2025-12-10 06:16:36.947240",
  "module": null,
  "name": "Master Procurement Plan-Form",
  "script": "\nfrappe.ui.form.on('Master Procurement Plan', {\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 0) {\n            frm.add_custom_button(__('Consolidate Budgets'), function() {\n                frappe.confirm(__('This will consolidate budget items. Continue?'), function() {\n                    frappe.call({\n                        method: 'mpp_consolidate_budgets',\n                        args: { doc_name: frm.doc.name },\n                        freeze: true,\n                        freeze_message: __('Consolidating...'),\n                        callback: function(r) {\n                            if (r.message && r.message.status === 'success') {\n                                frm.reload_doc();\n                            }\n                        }\n                    });\n                });\n            }, __('Actions'));\n            \n            if (frm.doc.items && frm.doc.items.length > 0) {\n                frm.add_custom_button(__('Create Procurement Plans'), function() {\n                    var selected_items = [];\n                    frm.doc.items.forEach(function(item) {\n                        if (item.is_selected === 1 || item.is_selected === '1' || item.is_selected === true) {\n                            selected_items.push(item.item_key);\n                        }\n                    });\n                    \n                    if (selected_items.length === 0) {\n                        frappe.msgprint(__('Please select at least one item using the checkbox'));\n                        return;\n                    }\n                    \n                    var d = new frappe.ui.Dialog({\n                        title: __('Create Procurement Plans'),\n                        fields: [\n                            {\n                                fieldname: 'info',\n                                fieldtype: 'HTML',\n                                options: '<p><strong>' + selected_items.length + ' item(s) selected</strong></p>'\n                            },\n                            {\n                                fieldname: 'mode',\n                                fieldtype: 'Select',\n                                label: __('Creation Mode'),\n                                options: 'individual\\nbatch\\nsingle',\n                                default: 'individual',\n                                reqd: 1,\n                                description: __('Individual: One plan per item. Batch: Group by batch_group field. Single: All selected items in one plan.')\n                            }\n                        ],\n                        primary_action_label: __('Create'),\n                        primary_action: function(values) {\n                            frappe.call({\n                                method: 'mpp_create_procurement_plans',\n                                args: {\n                                    doc_name: frm.doc.name,\n                                    mode: values.mode,\n                                    override: 0,\n                                    selected_items: selected_items.join(',')\n                                },\n                                freeze: true,\n                                freeze_message: __('Creating Procurement Plans...'),\n                                callback: function(r) {\n                                    if (r.message) {\n                                        if (r.message.status === 'success') {\n                                            d.hide();\n                                            frm.reload_doc();\n                                        } else if (r.message.status === 'has_existing_plans') {\n                                            d.hide();\n                                            var plan_details = r.message.plan_details.join('<br>');\n                                            frappe.confirm(\n                                                __('The following selected items already have Procurement Plans:') + \n                                                '<br><br><code>' + plan_details + '</code><br><br>' +\n                                                __('Do you want to create NEW Procurement Plans for these items?'),\n                                                function() {\n                                                    frappe.call({\n                                                        method: 'mpp_create_procurement_plans',\n                                                        args: {\n                                                            doc_name: frm.doc.name,\n                                                            mode: values.mode,\n                                                            override: 1,\n                                                            selected_items: selected_items.join(',')\n                                                        },\n                                                        freeze: true,\n                                                        freeze_message: __('Creating Procurement Plans (Override)...'),\n                                                        callback: function(r2) {\n                                                            if (r2.message && r2.message.status === 'success') {\n                                                                frm.reload_doc();\n                                                            }\n                                                        }\n                                                    });\n                                                }\n                                            );\n                                        }\n                                    }\n                                }\n                            });\n                        }\n                    });\n                    d.show();\n                }, __('Actions'));\n                \n                frm.add_custom_button(__('Create Purchase Order'), function() {\n                    var selected_items = [];\n                    frm.doc.items.forEach(function(item) {\n                        if (item.is_selected === 1 || item.is_selected === '1' || item.is_selected === true) {\n                            selected_items.push(item.item_key);\n                        }\n                    });\n                    \n                    if (selected_items.length === 0) {\n                        frappe.msgprint(__('Please select at least one item using the checkbox'));\n                        return;\n                    }\n                    \n                    var d = new frappe.ui.Dialog({\n                        title: __('Create Purchase Order'),\n                        fields: [\n                            {\n                                fieldname: 'info',\n                                fieldtype: 'HTML',\n                                options: '<p><strong>' + selected_items.length + ' item(s) selected</strong></p>'\n                            },\n                            { fieldname: 'supplier', fieldtype: 'Link', options: 'Supplier', label: __('Supplier'), reqd: 1 },\n                            { fieldname: 'warehouse', fieldtype: 'Link', options: 'Warehouse', label: __('Warehouse') },\n                            { fieldname: 'schedule_date', fieldtype: 'Date', label: __('Schedule Date'), default: frappe.datetime.add_days(frappe.datetime.nowdate(), 30) }\n                        ],\n                        primary_action_label: __('Create'),\n                        primary_action: function(values) {\n                            frappe.call({\n                                method: 'mpp_create_po_or_contract',\n                                args: {\n                                    doc_name: frm.doc.name,\n                                    doc_type: 'Purchase Order',\n                                    supplier: values.supplier,\n                                    warehouse: values.warehouse,\n                                    schedule_date: values.schedule_date,\n                                    selected_items: selected_items.join(',')\n                                },\n                                freeze: true,\n                                freeze_message: __('Creating Purchase Order...'),\n                                callback: function(r) {\n                                    if (r.message && r.message.status === 'success') {\n                                        d.hide();\n                                        frm.reload_doc();\n                                    }\n                                }\n                            });\n                        }\n                    });\n                    d.show();\n                }, __('Actions'));\n                \n                frm.add_custom_button(__('Create Contract'), function() {\n                    var selected_items = [];\n                    frm.doc.items.forEach(function(item) {\n                        if (item.is_selected === 1 || item.is_selected === '1' || item.is_selected === true) {\n                            selected_items.push(item.item_key);\n                        }\n                    });\n                    \n                    if (selected_items.length === 0) {\n                        frappe.msgprint(__('Please select at least one item using the checkbox'));\n                        return;\n                    }\n                    \n                    var d = new frappe.ui.Dialog({\n                        title: __('Create Contract'),\n                        fields: [\n                            {\n                                fieldname: 'info',\n                                fieldtype: 'HTML',\n                                options: '<p><strong>' + selected_items.length + ' item(s) selected</strong></p>'\n                            },\n                            { fieldname: 'supplier', fieldtype: 'Link', options: 'Supplier', label: __('Party'), reqd: 1 },\n                            { fieldname: 'contract_template', fieldtype: 'Link', options: 'Contract Template', label: __('Contract Template') },\n                            { fieldname: 'start_date', fieldtype: 'Date', label: __('Start Date'), default: frappe.datetime.nowdate() },\n                            { fieldname: 'end_date', fieldtype: 'Date', label: __('End Date') }\n                        ],\n                        primary_action_label: __('Create'),\n                        primary_action: function(values) {\n                            frappe.call({\n                                method: 'mpp_create_po_or_contract',\n                                args: {\n                                    doc_name: frm.doc.name,\n                                    doc_type: 'Contract',\n                                    supplier: values.supplier,\n                                    contract_template: values.contract_template,\n                                    start_date: values.start_date,\n                                    end_date: values.end_date,\n                                    selected_items: selected_items.join(',')\n                                },\n                                freeze: true,\n                                freeze_message: __('Creating Contract...'),\n                                callback: function(r) {\n                                    if (r.message && r.message.status === 'success') {\n                                        d.hide();\n                                        frm.reload_doc();\n                                    }\n                                }\n                            });\n                        }\n                    });\n                    d.show();\n                }, __('Actions'));\n            }\n        }\n        \n        // Show summary\n        if (frm.doc.items && frm.doc.items.length > 0) {\n            var plans = [];\n            var items_with_plans = 0;\n            var items_without_plans = 0;\n            \n            for (var i = 0; i < frm.doc.items.length; i++) {\n                var item = frm.doc.items[i];\n                if (item.procurement_plan) {\n                    items_with_plans++;\n                    if (plans.indexOf(item.procurement_plan) === -1) {\n                        plans.push(item.procurement_plan);\n                    }\n                } else {\n                    items_without_plans++;\n                }\n            }\n            \n            var wrapper = frm.fields_dict.items.$wrapper.find('.procurement-plans-summary');\n            if (wrapper.length === 0) {\n                wrapper = $('<div class=\"procurement-plans-summary\" style=\"margin-bottom: 10px;\"></div>');\n                frm.fields_dict.items.$wrapper.prepend(wrapper);\n            }\n            \n            var html = '<div class=\"alert alert-info\" style=\"margin-bottom: 10px;\">';\n            html += '<strong>Summary:</strong> ' + items_with_plans + ' items have Procurement Plans, ' + items_without_plans + ' items pending';\n            html += '</div>';\n            \n            if (plans.length > 0) {\n                html += '<table class=\"table table-bordered table-sm\"><thead><tr><th>Procurement Plan</th><th>Items</th></tr></thead><tbody>';\n                for (var j = 0; j < plans.length; j++) {\n                    var p = plans[j];\n                    var cnt = 0;\n                    for (var k = 0; k < frm.doc.items.length; k++) {\n                        if (frm.doc.items[k].procurement_plan === p) {\n                            cnt++;\n                        }\n                    }\n                    html += '<tr><td><a href=\"/app/procurement-plan/' + p + '\">' + p + '</a></td><td>' + cnt + '</td></tr>';\n                }\n                html += '</tbody></table>';\n            }\n            wrapper.html(html);\n        }\n    },\n    \n    procurement_category: function(frm) {\n        if (frm.doc.items && frm.doc.items.length > 0) {\n            frappe.confirm(__('Update suggested procurement methods for all items?'), function() {\n                frm.doc.items.forEach(function(item) {\n                    if (item.total_estimated_value) {\n                        frappe.call({\n                            method: 'mpp_get_suggested_method',\n                            args: {\n                                procurement_category: frm.doc.procurement_category,\n                                value: item.total_estimated_value\n                            },\n                            async: false,\n                            callback: function(r) {\n                                if (r.message) {\n                                    item.suggested_procurement_method = r.message;\n                                }\n                            }\n                        });\n                    }\n                });\n                frm.refresh_field('items');\n            });\n        }\n    }\n});\n\nfrappe.ui.form.on('Master Procurement Plan Item', {\n    is_selected: function(frm, cdt, cdn) {\n        frm.refresh_field('items');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Procurement Plan",
  "enabled": 1,
  "modified": "2025-12-10 07:03:01.194566",
  "module": null,
  "name": "Procurement Plan-Form",
  "script": "\nfrappe.ui.form.on('Procurement Plan', {\n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.docstatus === 0) {\n            \n            // Create Purchase Order button\n            frm.add_custom_button(__('Purchase Order'), function() {\n                // Get selected items from child table\n                var selected_items = [];\n                var items_without_supplier = [];\n                var items_with_po = [];\n                \n                (frm.doc.items || []).forEach(function(item) {\n                    if (item.is_selected) {\n                        if (item.po_status === \"PO Created\") {\n                            items_with_po.push(item.idx);\n                        } else if (!item.supplier) {\n                            items_without_supplier.push(item.idx);\n                        } else {\n                            selected_items.push(item.idx);\n                        }\n                    }\n                });\n                \n                if (selected_items.length === 0 && items_without_supplier.length === 0 && items_with_po.length === 0) {\n                    frappe.msgprint(__('Please select items using the checkbox in the items table'));\n                    return;\n                }\n                \n                if (items_with_po.length > 0) {\n                    frappe.msgprint(__('Row(s) ' + items_with_po.join(', ') + ' already have Purchase Orders. Please deselect them.'));\n                    return;\n                }\n                \n                if (items_without_supplier.length > 0) {\n                    frappe.msgprint(__('Row(s) ' + items_without_supplier.join(', ') + ' do not have a Supplier assigned. Please assign suppliers first.'));\n                    return;\n                }\n                \n                // Group by supplier for display\n                var supplier_groups = {};\n                (frm.doc.items || []).forEach(function(item) {\n                    if (selected_items.indexOf(item.idx) !== -1) {\n                        if (!supplier_groups[item.supplier]) {\n                            supplier_groups[item.supplier] = [];\n                        }\n                        supplier_groups[item.supplier].push(item);\n                    }\n                });\n                \n                // Build summary HTML\n                var summary_html = '<div class=\"alert alert-info\"><strong>' + selected_items.length + ' item(s) selected</strong></div>';\n                summary_html += '<table class=\"table table-bordered table-sm\"><thead><tr><th>Supplier</th><th>Items</th><th>Total Value</th></tr></thead><tbody>';\n                \n                for (var supplier in supplier_groups) {\n                    var items = supplier_groups[supplier];\n                    var total = 0;\n                    items.forEach(function(item) {\n                        total += flt(item.amount) || (flt(item.quantity) * flt(item.rate)) || 0;\n                    });\n                    summary_html += '<tr><td>' + supplier + '</td><td>' + items.length + '</td><td>' + format_currency(total) + '</td></tr>';\n                }\n                summary_html += '</tbody></table>';\n                summary_html += '<p class=\"text-muted\">One Purchase Order will be created per supplier.</p>';\n                \n                var d = new frappe.ui.Dialog({\n                    title: __('Create Purchase Orders'),\n                    fields: [\n                        {\n                            fieldtype: 'HTML',\n                            fieldname: 'summary',\n                            options: summary_html\n                        },\n                        {\n                            fieldtype: 'Section Break',\n                            label: __('Options')\n                        },\n                        {\n                            fieldtype: 'Link',\n                            fieldname: 'warehouse',\n                            label: __('Target Warehouse'),\n                            options: 'Warehouse'\n                        },\n                        {\n                            fieldtype: 'Date',\n                            fieldname: 'schedule_date',\n                            label: __('Required By'),\n                            default: frappe.datetime.add_days(frappe.datetime.nowdate(), 30)\n                        }\n                    ],\n                    primary_action_label: __('Create'),\n                    primary_action: function(values) {\n                        frappe.call({\n                            method: 'pp_create_po_split_by_supplier',\n                            args: {\n                                doc_name: frm.doc.name,\n                                selected_items: selected_items.join(','),\n                                warehouse: values.warehouse || '',\n                                schedule_date: values.schedule_date || ''\n                            },\n                            freeze: true,\n                            freeze_message: __('Creating Purchase Orders...'),\n                            callback: function(r) {\n                                d.hide();\n                                if (r.message && r.message.status === 'success') {\n                                    frm.reload_doc();\n                                }\n                            }\n                        });\n                    }\n                });\n                \n                d.show();\n            }, __('Create'));\n            \n            // Create Contract button\n            frm.add_custom_button(__('Contract'), function() {\n                var selected_items = [];\n                (frm.doc.items || []).forEach(function(item) {\n                    if (item.is_selected) {\n                        selected_items.push(item.idx);\n                    }\n                });\n                \n                if (selected_items.length === 0) {\n                    frappe.msgprint(__('Please select items using the checkbox in the items table'));\n                    return;\n                }\n                \n                var total_value = 0;\n                (frm.doc.items || []).forEach(function(item) {\n                    if (selected_items.indexOf(item.idx) !== -1) {\n                        total_value += flt(item.amount) || (flt(item.quantity) * flt(item.rate)) || 0;\n                    }\n                });\n                \n                var d = new frappe.ui.Dialog({\n                    title: __('Create Contract'),\n                    fields: [\n                        {\n                            fieldtype: 'HTML',\n                            fieldname: 'summary',\n                            options: '<div class=\"alert alert-info\">Items: <strong>' + selected_items.length + '</strong><br>Total Value: <strong>' + format_currency(total_value) + '</strong></div>'\n                        },\n                        {\n                            fieldtype: 'Section Break',\n                            label: __('Details')\n                        },\n                        {\n                            fieldtype: 'Link',\n                            fieldname: 'supplier',\n                            label: __('Party'),\n                            options: 'Supplier',\n                            reqd: 1\n                        },\n                        {\n                            fieldtype: 'Link',\n                            fieldname: 'contract_template',\n                            label: __('Contract Template'),\n                            options: 'Contract Template'\n                        },\n                        {\n                            fieldtype: 'Section Break'\n                        },\n                        {\n                            fieldtype: 'Date',\n                            fieldname: 'start_date',\n                            label: __('Contract Start Date'),\n                            default: frappe.datetime.nowdate()\n                        },\n                        {\n                            fieldtype: 'Column Break'\n                        },\n                        {\n                            fieldtype: 'Date',\n                            fieldname: 'end_date',\n                            label: __('Contract End Date')\n                        }\n                    ],\n                    primary_action_label: __('Create'),\n                    primary_action: function(values) {\n                        frappe.call({\n                            method: 'pp_create_po_or_contract',\n                            args: {\n                                doc_name: frm.doc.name,\n                                doc_type: 'Contract',\n                                supplier: values.supplier,\n                                contract_template: values.contract_template || '',\n                                start_date: values.start_date || '',\n                                end_date: values.end_date || ''\n                            },\n                            freeze: true,\n                            freeze_message: __('Creating Contract...'),\n                            callback: function(r) {\n                                d.hide();\n                                if (r.message && r.message.name) {\n                                    frappe.set_route('Form', 'Contract', r.message.name);\n                                }\n                            }\n                        });\n                    }\n                });\n                \n                d.show();\n            }, __('Create'));\n        }\n        \n        // Show PO summary\n        if (frm.doc.items && frm.doc.items.length > 0) {\n            var pos = {};\n            var items_with_po = 0;\n            var items_pending = 0;\n            \n            frm.doc.items.forEach(function(item) {\n                if (item.purchase_order) {\n                    items_with_po++;\n                    if (!pos[item.purchase_order]) {\n                        pos[item.purchase_order] = 0;\n                    }\n                    pos[item.purchase_order]++;\n                } else {\n                    items_pending++;\n                }\n            });\n            \n            var wrapper = frm.fields_dict.items.$wrapper.find('.po-summary');\n            if (wrapper.length === 0) {\n                wrapper = $('<div class=\"po-summary\" style=\"margin-bottom: 10px;\"></div>');\n                frm.fields_dict.items.$wrapper.prepend(wrapper);\n            }\n            \n            var html = '<div class=\"alert alert-info\"><strong>PO Status:</strong> ' + items_with_po + ' items have POs, ' + items_pending + ' pending</div>';\n            \n            var po_names = Object.keys(pos);\n            if (po_names.length > 0) {\n                html += '<table class=\"table table-bordered table-sm\"><thead><tr><th>Purchase Order</th><th>Items</th></tr></thead><tbody>';\n                po_names.forEach(function(po_name) {\n                    html += '<tr><td><a href=\"/app/purchase-order/' + po_name + '\">' + po_name + '</a></td><td>' + pos[po_name] + '</td></tr>';\n                });\n                html += '</tbody></table>';\n            }\n            \n            wrapper.html(html);\n        }\n    }\n});\n\n// Child table events - use correct DocType name: Procurement Items\nfrappe.ui.form.on('Procurement Items', {\n    item_code: function(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n        if (row.item_code) {\n            frappe.db.get_value('Item', row.item_code, ['item_name', 'stock_uom'], function(r) {\n                if (r) {\n                    frappe.model.set_value(cdt, cdn, 'item_name', r.item_name);\n                    frappe.model.set_value(cdt, cdn, 'unit', r.stock_uom);\n                }\n            });\n        }\n    },\n    \n    quantity: function(frm, cdt, cdn) {\n        calculate_amount(frm, cdt, cdn);\n    },\n    \n    rate: function(frm, cdt, cdn) {\n        calculate_amount(frm, cdt, cdn);\n    },\n    \n    is_selected: function(frm, cdt, cdn) {\n        frm.refresh_field('items');\n    }\n});\n\nfunction calculate_amount(frm, cdt, cdn) {\n    var row = locals[cdt][cdn];\n    var amount = flt(row.quantity) * flt(row.rate);\n    frappe.model.set_value(cdt, cdn, 'amount', amount);\n    \n    // Update total\n    var total = 0;\n    (frm.doc.items || []).forEach(function(item) {\n        total += flt(item.amount);\n    });\n    frm.set_value('total_value', total);\n}\n",
  "view": "Form"
 }
]