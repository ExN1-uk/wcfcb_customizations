[
 {
  "allow_guest": 0,
  "api_method": "trigger_webhook",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-12 10:20:15.574055",
  "module": null,
  "name": "Trigger Webhook",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def trigger_webhook():\n    webhook_url = \"http://n8n:5678/webhook-test/06fb4415-b1a0-4c5e-a9e5-d6df68f53bca\"\n    production_url = \"http://n8n:5678/webhook/06fb4415-b1a0-4c5e-a9e5-d6df68f53bca\"\n    try:\n        response = frappe.make_get_request(production_url)\n        # Check if the response is a dict and contains the expected message\n        print(response)\n        print(response.get(\"message\"))\n        if isinstance(response, dict) and response.get(\"message\") == \"Workflow was started\":\n            print(\"run okay\")\n            return {\"success\": True, \"message\": \"Webhook triggered successfully: Workflow was started\"}\n        else:\n            print('not okay')\n            return {\"success\": False, \"message\": f\"Failed to trigger webhook: Unexpected response {response}\"}\n    except Exception as e:\n        print('test is done')\n        return {\"success\": False, \"message\": f\"Error triggering webhook: {str(e)}\"}\n        \n        \ntrigger_webhook();",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_pensioners",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-11 08:26:59.231005",
  "module": null,
  "name": "get_pensioners",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\r\n\r\ndef get_pensioners():\r\n    pas_number = frappe.form_dict.pas_number\r\n    api_url = f\"https://cbstest.workers.com.zm/api/v1/eworkers/employer/erp/pensioner/{pas_number}\"\r\n    try:\r\n        response = frappe.make_get_request(\r\n            api_url,\r\n            headers={\"accept\": \"application/json\"}\r\n        )\r\n        # Check if the response is a dict and contains expected data\r\n        if isinstance(response, dict):\r\n            if 'pensionerCode' in response:  # Check for any unique field in response\r\n                frappe.response[\"response\"]=   {\r\n                    \"success\": True,\r\n                    \"message\": \"Pensioner data retrieved successfully\",\r\n                    \"data\": response\r\n                }\r\n            else:\r\n                frappe.response[\"response\"]=   {\r\n                    \"success\": False,\r\n                    \"message\": \"Pensioner not found\",\r\n                    \"error\": \"No pensioner data found for the provided PAS number\"\r\n                }\r\n        else:\r\n            frappe.response[\"response\"]=   {\r\n                \"success\": False,\r\n                \"message\": \"Unexpected response format from API\",\r\n                \"error\": str(response)\r\n            }\r\n            \r\n    except Exception as e:\r\n        frappe.log_error(_(\"Pensioner API Failed\"), str(e))\r\n        frappe.response[\"response\"]=  {\r\n            \"success\": False,\r\n            \"message\": \"Error getting pensioner data\",\r\n            \"error\": str(e)\r\n        }\r\n    \r\nget_pensioners();",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "verify_supplier",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-09 21:18:39.021324",
  "module": null,
  "name": "supplier verification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier",
  "script": "def verify_supplier():\r\n    tpin = frappe.form_dict.tpin\r\n    api_url = f\"http://n8n:5678/webhook/supplierCheck?supplierId={tpin}\"\r\n    \r\n    try:\r\n        response = frappe.make_get_request(\r\n            api_url,\r\n            headers={\r\n                \"accept\": \"application/json\",\r\n                \"Authorization\": \"Basic YWRtaW46NDM2Mzc0OEtpbmch\"\r\n            }\r\n        )\r\n        \r\n        # Check if response exists and is a list with at least one item\r\n        if not response or not isinstance(response, list) or len(response) == 0:\r\n            frappe.response[\"response\"] = {\r\n                \"success\": False,\r\n                \"message\": \"Invalid response format from supplier API\",\r\n                \"error\": \"Expected array response with at least one item\"\r\n            }\r\n            return\r\n            \r\n        api_result = response[0]  # Get the first item in the response array\r\n        \r\n        # Handle success cases (000 = found, 001 = not found)\r\n        if api_result.get(\"resultCd\") in (\"000\", \"001\"):\r\n            frappe.response[\"response\"] = {\r\n                \"success\": True,\r\n                \"status\": api_result.get(\"resultCd\"),\r\n                \"message\": api_result.get(\"resultMsg\"),\r\n                \"data\": api_result.get(\"data\"),\r\n                \"supplier_found\": api_result.get(\"resultCd\") == \"000\"\r\n            }\r\n        else:\r\n            # For error cases\r\n            frappe.response[\"response\"] = {\r\n                \"success\": False,\r\n                \"status\": api_result.get(\"resultCd\"),\r\n                \"message\": api_result.get(\"resultMsg\"),\r\n                \"error\": api_result.get(\"data\")\r\n            }\r\n            \r\n    except Exception as e:\r\n        frappe.log_error(_(\"Supplier API Failed\"), str(e))\r\n        frappe.response[\"response\"] = {\r\n            \"success\": False,\r\n            \"message\": \"Error processing supplier API response\",\r\n            \"error\": str(e)\r\n        }\r\n    \r\nverify_supplier()",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-17 01:35:26.209449",
  "module": null,
  "name": "Purchase Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "# Webhook URL\nwebhook_url = \"http://erpdev.workers.com.zm:5678/webhook-test/purchase-invoice-zra\"\n\n# Send minimal trigger data - let n8n fetch the full document\ntry:\n    response = frappe.make_post_request(\n        url=webhook_url,\n        json={\n            \"doctype\": \"Purchase Invoice\",\n            \"docname\": doc.name,\n            \"supplier\": doc.supplier,\n            \"supplier_name\": doc.supplier_name,\n            \"posting_date\": str(doc.posting_date),\n            \"grand_total\": doc.grand_total,\n            \"event\": \"on_submit\"\n        },\n        headers={\"Content-Type\": \"application/json\"}\n    )\n    \n    frappe.msgprint(\"Purchase Invoice has been queued for ZRA submission. Please refresh after a minute to see the response.\")\n    frappe.log_error(\n        \"Purchase Invoice \" + doc.name + \" triggered for ZRA submission. Response: \" + str(response),\n        \"ZRA PI Trigger Success\"\n    )\n\nexcept Exception as e:\n    error_msg = \"Failed to trigger ZRA submission: \" + str(e)\n    frappe.msgprint(error_msg)\n    frappe.log_error(\n        \"Error triggering ZRA submission for \" + doc.name + \": \" + str(e),\n        \"ZRA PI Trigger Error\"\n    )\n    # Uncomment to block submission on webhook failure:\n    # raise",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-27 20:11:18.712819",
  "module": null,
  "name": "Sale Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/erpnext/invoice/submit\"\ntest_url = \"http://n8n:5678/webhook-test/erpnext/invoice/submit\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n# Check if should_submit_to_zra is 1\nif invoice_data.get(\"custom_should_submit_to_zra\") == 1:\n    # Linked field retrieval function\n    def get_linked_code_fields(linked_value, doctype_name, code_fields):\n        if not linked_value:\n            frappe.log_error(f\"No linked value provided for {doctype_name}\")\n            return {}\n\n        try:\n            try:\n                linked_doc = frappe.get_doc(doctype_name, linked_value)\n            except frappe.DoesNotExistError:\n                # Try looking it up by another field if needed (e.g., code_name)\n                linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n            # Extract the fields you need\n            result = {field: linked_doc.get(field) for field in code_fields if linked_doc.get(field) is not None}\n            #frappe.msgprint(f\"Linked fields for {doctype_name} ({linked_value}): {str(result)}\")\n            return result\n\n        except Exception as e:\n            frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n            return {}\n\n    # --- Linked Fields Section ---\n\n    # 1. Sale_status from ZRA\n    sale_status_data = get_linked_code_fields(doc.get(\"sale_status\"), \"ZRA Transaction Progress\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sale_status\": sale_status_data.get(\"code\"),\n    })\n\n    # 2. Payment Type Code from ZRA Payment Method\n    payment_type_data = get_linked_code_fields(doc.get(\"mode_of_payment\"), \"ZRA Payment Method\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"mode_of_payment\": payment_type_data.get(\"code\")\n    })\n    \n    \n    # 2. Sale TAX Code from ZRA TAX type\n    sale_tax_type_data = get_linked_code_fields(doc.get(\"sale_tax_type\"), \"ZRA TAX Type\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sale_tax_type\": sale_tax_type_data.get(\"code\")\n    })\n\n    # 3. sales_type_code from ZRA Transaction Type\n    sale_type_data = get_linked_code_fields(doc.get(\"sales_type_code\"), \"ZRA Transaction Type\",\n                                               [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sales_type_code\": sale_type_data.get(\"code\"),\n    })\n    # 5. Debit Note Reason from ZRA Debit Note Reason\n    debit_note_reason_data = get_linked_code_fields(doc.get(\"debit_note_reason\"), \"ZRA Debit Note Reason\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"debit_note_reason\": debit_note_reason_data.get(\"code\"),\n    })\n\n    # 6. Receipt Type Code from ZRA Sale Receipt Type\n    receipt_type_data = get_linked_code_fields(doc.get(\"type_of_receipt\"), \"ZRA Sales Receipt Type\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"receipt_type\": receipt_type_data.get(\"code\"),\n    })\n\n    # --- Process Items ---\n    items = invoice_data.get(\"items\", [])\n    if not items:\n        frappe.msgprint(\"Warning: No items found in the invoice.\")\n    else:\n        processed_items = []\n        for item in items:\n            # Fetch linked fields for each item\n            # 1. Item Type Code from ZRA Product Type\n            item_type_data = get_linked_code_fields(item.get(\"item_type_code\"), \"ZRA Product Type\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 2. Origin Place Code from ZRA Country Code\n            origin_place_data = get_linked_code_fields(item.get(\"origin_place_code\"), \"ZRA Country Code\",\n                                                      [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 3. Packaging Unit Code from ZRA Packaging Unit\n            packaging_unit_data = get_linked_code_fields(item.get(\"packaging_unit_code\"), \"ZRA Packaging Unit\",\n                                                        [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 4. Quantity Unit Code from ZRA Unit of Measure\n            quantity_unit_data = get_linked_code_fields(item.get(\"quantity_unit_code\"), \"ZRA Unit of Measure\",\n                                                       [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 5. Tax Type from ZRA TAX Type\n            tax_type_data = get_linked_code_fields(item.get(\"tax_type\"), \"ZRA TAX Type\",\n                                                  [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 6. Item Class Code from ZRA UNSPSC Classification\n            item_class_data = get_linked_code_fields(item.get(\"item_classification_code\"), \"ZRA UNSPSC Classification\",\n                                                    [\"item_class_code\", \"item_class_name\"])\n            # 7. ZRA Item Code from Item\n            zra_item_data = get_linked_code_fields(item.get(\"item_code\"), \"Item\",\n                                                  [\"zra_item_code\"])\n\n            # Update item dictionary with linked fields\n            processed_item = item.copy()\n            processed_item.update({\n                \"item_type_code\": item_type_data.get(\"code\"),\n                \"item_type_class\": item_type_data.get(\"zra_code_class\"),\n                \"item_type_user_define_code\": item_type_data.get(\"user_define_code\"),\n                \"origin_place_code\": origin_place_data.get(\"code\"),\n                \"origin_place_class\": origin_place_data.get(\"zra_code_class\"),\n                \"origin_place_user_define_code\": origin_place_data.get(\"user_define_code\"),\n                \"packaging_unit_code\": packaging_unit_data.get(\"code\"),\n                \"packaging_unit_class\": packaging_unit_data.get(\"zra_code_class\"),\n                \"packaging_unit_user_define_code\": packaging_unit_data.get(\"user_define_code\"),\n                \"quantity_unit_code\": quantity_unit_data.get(\"code\"),\n                \"tax_type\": tax_type_data.get(\"code\"),\n                \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n                \"item_class_name\": item_class_data.get(\"item_class_name\"),\n                \"zra_item_code\": zra_item_data.get(\"zra_item_code\"),\n            })\n            processed_items.append(processed_item)\n\n        # Update invoice_data with processed items\n        invoice_data[\"items\"] = processed_items\n\n    # Debug: Print invoice_data to verify content\n    #frappe.msgprint(f\"Invoice Data: {json.dumps(invoice_data, indent=2)}\")\n    if not invoice_data:\n        frappe.msgprint(\"Error: invoice_data is empty. Check doc.as_dict() and linked field data.\")\n        raise frappe.ValidationError(\"Invoice data is empty\")\n\n    # --- Send the Webhook ---\n    try:\n        # Serialize data to JSON and set headers\n        payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n        #frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n        response = frappe.make_post_request(\n            url=production_url,\n            data=payload,\n            headers={\"Content-Type\": \"application/json\"}\n        )\n\n        #frappe.msgprint(f\"Webhook Response: {str(response)}\")\n        frappe.msgprint(\"Sales Invoice has been sent to ZRA. Please refresh after a minute.\")\n\n\n    except Exception as e:\n        frappe.msgprint(f\"ZRA Codes Webhook Failed: {str(e)}\")\n        frappe.log_error(f\"ZRA Codes Webhook Error for {doc.name}: {str(e)}\", \"ZRA Codes Webhook\")\nelse:\n    frappe.msgprint(\"Invoice not submitted to ZRA: should_submit_to_zra is not 1\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-23 22:48:27.118995",
  "module": null,
  "name": "Auto-Increment for ZRA Count on Item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# Count existing items\nexisting_items = frappe.db.count(\"Item\")\n\n# Set item_count to total + 1\ndoc.item_count = existing_items + 1",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "item_save",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-17 09:42:59.798138",
  "module": null,
  "name": "Item Save",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/getItemLog\"\ntest_url = \"http://n8n:5678/webhook-test/getItemLog\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n# Linked field retrieval function\ndef get_linked_code_fields(linked_value, doctype_name, code_fields):\n    if not linked_value:\n        frappe.log_error(f\"No linked value provided for {doctype_name}\")\n        return {}\n\n    try:\n        try:\n            linked_doc = frappe.get_doc(doctype_name, linked_value)\n        except frappe.DoesNotExistError:\n            # Try looking it up by another field if needed (e.g., code_name)\n            linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n        # Extract the fields you need\n        result = {field: linked_doc.get(field) for field in code_fields if linked_doc.get(field) is not None}\n        frappe.msgprint(f\"Linked fields for {doctype_name} ({linked_value}): {str(result)}\")\n        return result\n\n    except Exception as e:\n        frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n        return {}\n\n# --- Linked Fields Section ---\n\n# 1. Item Type Code from New ZRA Product Type\nitem_type_data = get_linked_code_fields(doc.get(\"item_type_code\"), \"ZRA Product Type\",\n                                       [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"item_type_code\": item_type_data.get(\"code\"),\n    \"item_type_class\": item_type_data.get(\"zra_code_class\"),\n    \"item_type_user_define_code\": item_type_data.get(\"user_define_code\"),\n})\n\n# 2. Origin Place Code from New ZRA Country Code\norigin_place_data = get_linked_code_fields(doc.get(\"origin_place_code\"), \"ZRA Country Code\",\n                                          [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"origin_place_code\": origin_place_data.get(\"code\"),\n    \"origin_place_class\": origin_place_data.get(\"zra_code_class\"),\n    \"origin_place_user_define_code\": origin_place_data.get(\"user_define_code\"),\n})\n\n# 3. Packaging Unit Code from New ZRA Packaging Unit\npackaging_unit_data = get_linked_code_fields(doc.get(\"packaging_unit_code\"), \"ZRA Packaging Unit\",\n                                            [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"packaging_unit_code\": packaging_unit_data.get(\"code\"),\n    \"packaging_unit_class\": packaging_unit_data.get(\"zra_code_class\"),\n    \"packaging_unit_user_define_code\": packaging_unit_data.get(\"user_define_code\"),\n})\n\n# 4. Quantity Unit Code from New ZRA Unit of Measure\nquantity_unit_data = get_linked_code_fields(doc.get(\"quantity_unit_code\"), \"ZRA Unit of Measure\",\n                                           [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"quantity_unit_code\": quantity_unit_data.get(\"code\")\n})\n\n# 5. Tax Type from New ZRA TAX Type\ntax_type_data = get_linked_code_fields(doc.get(\"tax_type\"), \"ZRA TAX Type\",\n                                      [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"tax_type\": tax_type_data.get(\"code\"),\n})\n\n# 6. Item Class Code from ZRA UNSPSC Classification\nitem_class_data = get_linked_code_fields(doc.get(\"item_classification_code\"), \"ZRA UNSPSC Classification\",\n                                        [\"item_class_code\", \"item_class_name\"])\ninvoice_data.update({\n    \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n    \"item_class_name\": item_class_data.get(\"item_class_name\"),\n})\n\n# Debug: Print invoice_data to verify content\n# frappe.msgprint(f\"Invoice Data: {json.dumps(invoice_data, indent=2)}\")\nif not invoice_data:\n    frappe.msgprint(\"Error: invoice_data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Invoice data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON and set headers\n    payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n    # frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # frappe.msgprint(f\"Webhook Response: {str(response)}\")\n    # frappe.msgprint(\"Item Webhook Success\")\n\nexcept Exception as e:\n    frappe.msgprint(f\"Item Sync to ZRA Failed: {str(e)}\")\n    frappe.log_error(f\"Item Sync to ZRA Error for {doc.name}: {str(e)}\", \"Item Webhook\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_travel_request_details",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-01 09:00:30.943509",
  "module": null,
  "name": "get_travel_request_details",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Script Name: get_travel_request_details\r\n# Script Type: API\r\n\r\ndef get_travel_days(travel_request):\r\n    # Get all departure dates for this request\r\n    departures = frappe.get_all('Travel Itinerary',\r\n        filters={'parent': travel_request},\r\n        fields=['departure_date'],\r\n        order_by='departure_date')\r\n    \r\n    if not departures:\r\n        return 0\r\n    \r\n    # Filter out empty dates and convert to date objects\r\n    valid_dates = []\r\n    for d in departures:\r\n        if d.departure_date:\r\n            valid_dates.append(frappe.utils.getdate(d.departure_date))\r\n    \r\n    if not valid_dates:\r\n        return 0\r\n    \r\n    # Get minimum and maximum dates\r\n    min_date = min(valid_dates)\r\n    max_date = max(valid_dates)\r\n    \r\n    # Calculate the difference in days (inclusive)\r\n    travel_days = frappe.utils.date_diff(max_date, min_date) + 1\r\n    \r\n    return travel_days\r\n\r\nif frappe.request.method == \"POST\":\r\n    try:\r\n        travel_request = frappe.form_dict.travel_request\r\n        if not travel_request:\r\n            frappe.response[\"message\"] = {\"error\": \"travel_request parameter missing\"}\r\n        else:\r\n            days = get_travel_days(travel_request)\r\n            frappe.response[\"message\"] = {\r\n                \"travel_days\": days,\r\n                \"message\": f\"Calculated {days} days between earliest and latest departure dates\"\r\n            }\r\n    except Exception as e:\r\n        frappe.response[\"message\"] = {\r\n            \"error\": f\"Error processing request: {str(e)}\",\r\n            \"traceback\": frappe.get_traceback()\r\n        }",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "per_diem_calc",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-01 09:01:03.690609",
  "module": null,
  "name": "per_diem_calc",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Script Name: calculate_per_diem\r\n# Script Type: API\r\ndef get_per_diem_amount(employee, days):\r\n    grade = frappe.db.get_value('Employee', employee, 'grade')\r\n    if not grade:\r\n        return {\"error\": f\"No grade set for employee {employee}\"}\r\n    \r\n    # Fixed: Using correct doctype name 'Per Diem Rates' (plural) and field names\r\n    rate = frappe.db.get_value('Per Diem Rates', \r\n        {'grade': grade}, 'amount')\r\n    if not rate:\r\n        return {\"error\": f\"No rate found for grade {grade}\"}\r\n    \r\n    return {\r\n        \"days\": days,\r\n        \"rate\": rate,\r\n        \"amount\": float(days) * float(rate)\r\n    }\r\n\r\nif frappe.request.method == \"POST\":\r\n    employee = frappe.form_dict.employee\r\n    travel_days = frappe.form_dict.travel_days\r\n    \r\n    if not all([employee, travel_days]):\r\n        frappe.response[\"message\"] = {\"error\": \"Missing employee or travel_days\"}\r\n    else:\r\n        frappe.response[\"message\"] = get_per_diem_amount(employee, travel_days)",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-23 14:25:19.057038",
  "module": null,
  "name": "ADD Beneficiary",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/postcustomer\"\ntest_url = \"http://n8n:5678/webhook-test/postcustomer\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n\n# Debug: Print invoice_data to verify content\nfrappe.msgprint(f\"Beneficiary Data: {json.dumps(invoice_data, indent=2)}\")\nif not invoice_data:\n    frappe.msgprint(\"Error: Beneficiary is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Beneficiary data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON and set headers\n    payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n    frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    frappe.msgprint(f\"Beneficiary Webhook Response: {str(response)}\")\n    frappe.msgprint(\"Beneficiary Webhook Success\")\n\nexcept Exception as e:\n    frappe.msgprint(f\"Beneficiary WebhooK Failed: {str(e)}\")\n    frappe.log_error(f\"Beneficiary Webhook Error for {doc.name}: {str(e)}\", \"Beneficiary Webhook\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-09 09:02:27.973741",
  "module": null,
  "name": "Add Supplier",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/save-supplier\"\ntest_url = \"http://n8n:5678/webhook-test/save-supplier\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n\n# Debug: Print invoice_data to verify content\nfrappe.msgprint(f\"Beneficiary Data: {json.dumps(invoice_data, indent=2)}\")\nif not invoice_data:\n    frappe.msgprint(\"Error: Beneficiary is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Beneficiary data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON and set headers\n    payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n    frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    frappe.msgprint(f\"Beneficiary Webhook Response: {str(response)}\")\n    frappe.msgprint(\"Beneficiary Webhook Success\")\n\nexcept Exception as e:\n    frappe.msgprint(f\"Beneficiary WebhooK Failed: {str(e)}\")\n    frappe.log_error(f\"Beneficiary Webhook Error for {doc.name}: {str(e)}\", \"Beneficiary Webhook\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-04 09:23:13.377922",
  "module": null,
  "name": "update Sale Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/erpnext/invoice/submit\"\ntest_url = \"http://n8n:5678/webhook-test/erpnext/invoice/submit\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n# Check if should_submit_to_zra is 1\nif invoice_data.get(\"should_submit_to_zra\") == 1:\n    # Linked field retrieval function\n    def get_linked_code_fields(linked_value, doctype_name, code_fields):\n        if not linked_value:\n            frappe.log_error(f\"No linked value provided for {doctype_name}\")\n            return {}\n\n        try:\n            try:\n                linked_doc = frappe.get_doc(doctype_name, linked_value)\n            except frappe.DoesNotExistError:\n                # Try looking it up by another field if needed (e.g., code_name)\n                linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n            # Extract the fields you need\n            result = {field: linked_doc.get(field) for field in code_fields if linked_doc.get(field) is not None}\n            frappe.msgprint(f\"Linked fields for {doctype_name} ({linked_value}): {str(result)}\")\n            return result\n\n        except Exception as e:\n            frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n            return {}\n\n    # --- Linked Fields Section ---\n\n    # 1. Sale_status from ZRA\n    sale_status_data = get_linked_code_fields(doc.get(\"sale_status\"), \"ZRA Transaction Progress\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sale_status\": sale_status_data.get(\"code\"),\n    })\n\n    # 2. Payment Type Code from ZRA Payment Method\n    payment_type_data = get_linked_code_fields(doc.get(\"mode_of_payment\"), \"ZRA Payment Method\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"mode_of_payment\": payment_type_data.get(\"code\")\n    })\n    \n    \n    # 2. Sale TAX Code from ZRA TAX type\n    sale_tax_type_data = get_linked_code_fields(doc.get(\"sale_tax_type\"), \"ZRA TAX Type\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sale_tax_type\": sale_tax_type_data.get(\"code\")\n    })\n\n    # 3. sales_type_code from ZRA Transaction Type\n    sale_type_data = get_linked_code_fields(doc.get(\"sales_type_code\"), \"ZRA Transaction Type\",\n                                               [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"sales_type_code\": sale_type_data.get(\"code\"),\n    })\n    # 5. Debit Note Reason from ZRA Debit Note Reason\n    debit_note_reason_data = get_linked_code_fields(doc.get(\"debit_note_reason\"), \"ZRA Debit Note Reason\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"debit_note_reason\": debit_note_reason_data.get(\"code\"),\n    })\n\n    # 6. Receipt Type Code from ZRA Sale Receipt Type\n    receipt_type_data = get_linked_code_fields(doc.get(\"type_of_receipt\"), \"ZRA Sales Receipt Type\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"receipt_type\": receipt_type_data.get(\"code\"),\n    })\n\n    # --- Process Items ---\n    items = invoice_data.get(\"items\", [])\n    if not items:\n        frappe.msgprint(\"Warning: No items found in the invoice.\")\n    else:\n        processed_items = []\n        for item in items:\n            # Fetch linked fields for each item\n            # 1. Item Type Code from ZRA Product Type\n            item_type_data = get_linked_code_fields(item.get(\"item_type_code\"), \"ZRA Product Type\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 2. Origin Place Code from ZRA Country Code\n            origin_place_data = get_linked_code_fields(item.get(\"origin_place_code\"), \"ZRA Country Code\",\n                                                      [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 3. Packaging Unit Code from ZRA Packaging Unit\n            packaging_unit_data = get_linked_code_fields(item.get(\"packaging_unit_code\"), \"ZRA Packaging Unit\",\n                                                        [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 4. Quantity Unit Code from ZRA Unit of Measure\n            quantity_unit_data = get_linked_code_fields(item.get(\"quantity_unit_code\"), \"ZRA Unit of Measure\",\n                                                       [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 5. Tax Type from ZRA TAX Type\n            tax_type_data = get_linked_code_fields(item.get(\"tax_type\"), \"ZRA TAX Type\",\n                                                  [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 6. Item Class Code from ZRA UNSPSC Classification\n            item_class_data = get_linked_code_fields(item.get(\"item_classification_code\"), \"ZRA UNSPSC Classification\",\n                                                    [\"item_class_code\", \"item_class_name\"])\n            # 7. ZRA Item Code from Item\n            zra_item_data = get_linked_code_fields(item.get(\"item_code\"), \"Item\",\n                                                  [\"zra_item_code\"])\n\n            # Update item dictionary with linked fields\n            processed_item = item.copy()\n            processed_item.update({\n                \"item_type_code\": item_type_data.get(\"code\"),\n                \"item_type_class\": item_type_data.get(\"zra_code_class\"),\n                \"item_type_user_define_code\": item_type_data.get(\"user_define_code\"),\n                \"origin_place_code\": origin_place_data.get(\"code\"),\n                \"origin_place_class\": origin_place_data.get(\"zra_code_class\"),\n                \"origin_place_user_define_code\": origin_place_data.get(\"user_define_code\"),\n                \"packaging_unit_code\": packaging_unit_data.get(\"code\"),\n                \"packaging_unit_class\": packaging_unit_data.get(\"zra_code_class\"),\n                \"packaging_unit_user_define_code\": packaging_unit_data.get(\"user_define_code\"),\n                \"quantity_unit_code\": quantity_unit_data.get(\"code\"),\n                \"tax_type\": tax_type_data.get(\"code\"),\n                \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n                \"item_class_name\": item_class_data.get(\"item_class_name\"),\n                \"zra_item_code\": zra_item_data.get(\"zra_item_code\"),\n            })\n            processed_items.append(processed_item)\n\n        # Update invoice_data with processed items\n        invoice_data[\"items\"] = processed_items\n\n    # Debug: Print invoice_data to verify content\n    frappe.msgprint(f\"Invoice Data: {json.dumps(invoice_data, indent=2)}\")\n    if not invoice_data:\n        frappe.msgprint(\"Error: invoice_data is empty. Check doc.as_dict() and linked field data.\")\n        raise frappe.ValidationError(\"Invoice data is empty\")\n\n    # --- Send the Webhook ---\n    try:\n        # Serialize data to JSON and set headers\n        payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n        frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n        response = frappe.make_post_request(\n            url=production_url,\n            data=payload,\n            headers={\"Content-Type\": \"application/json\"}\n        )\n\n        frappe.msgprint(f\"Webhook Response: {str(response)}\")\n        frappe.msgprint(\"ZRA Codes Webhook Success\")\n\n    except Exception as e:\n        frappe.msgprint(f\"ZRA Codes Webhook Failed: {str(e)}\")\n        frappe.log_error(f\"ZRA Codes Webhook Error for {doc.name}: {str(e)}\", \"ZRA Codes Webhook\")\nelse:\n    frappe.msgprint(\"Invoice not submitted to ZRA: should_submit_to_zra is not 1\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-07 08:17:33.764445",
  "module": null,
  "name": "Update Purchase Invoice",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/68646e88-e5aa-4cc6-a102-ef1e02838a3a\"\ntest_url = \"http://n8n:5678/webhook-test/68646e88-e5aa-4cc6-a102-ef1e02838a3a\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n# Check if should_submit_to_zra is 1\nif invoice_data.get(\"should_submit_to_zra\") == 1:\n    # Linked field retrieval function\n    def get_linked_code_fields(linked_value, doctype_name, code_fields):\n        if not linked_value:\n            frappe.log_error(f\"No linked value provided for {doctype_name}\")\n            return {}\n\n        try:\n            try:\n                linked_doc = frappe.get_doc(doctype_name, linked_value)\n            except frappe.DoesNotExistError:\n                # Try looking it up by another field if needed (e.g., code_name)\n                linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n            # Extract the fields you need\n            result = {field: linked_doc.get(field) for field in code_fields if linked_doc.get(field) is not None}\n            frappe.msgprint(f\"Linked fields for {doctype_name} ({linked_value}): {str(result)}\")\n            return result\n\n        except Exception as e:\n            frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n            return {}\n\n    # --- Linked Fields Section ---\n\n    # 1. Registration Type Code from ZRA Registration Type\n    registration_type_data = get_linked_code_fields(doc.get(\"registration_type_code\"), \"ZRA Registration Type\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"registration_type_code\": registration_type_data.get(\"code\"),\n    })\n\n    # 2. Payment Type Code from ZRA Payment Method\n    payment_type_data = get_linked_code_fields(doc.get(\"payment_type_code\"), \"ZRA Payment Method\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"payment_type_code\": payment_type_data.get(\"code\")\n    })\n\n    # 3. Type of Purchase from ZRA Transaction Type\n    purchase_type_data = get_linked_code_fields(doc.get(\"type_of_purchase\"), \"ZRA Transaction Type\",\n                                               [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"type_of_purchase\": purchase_type_data.get(\"code\"),\n        \"purchase_type_class\": purchase_type_data.get(\"zra_code_class\"),\n        \"purchase_type_user_define_code\": purchase_type_data.get(\"user_define_code\"),\n    })\n\n    # 4. Purchase Status Code from ZRA Transaction Progress\n    purchase_status_data = get_linked_code_fields(doc.get(\"purchase_status_code\"), \"ZRA Transaction Progress\",\n                                                 [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"purchase_status_code\": purchase_status_data.get(\"code\"),\n    })\n\n    # 5. Debit Note Reason from ZRA Debit Note Reason\n    debit_note_reason_data = get_linked_code_fields(doc.get(\"debit_note_reason\"), \"ZRA Debit Note Reason\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"debit_note_reason\": debit_note_reason_data.get(\"code\"),\n    })\n\n    # 6. Receipt Type Code from ZRA Purchase Receipt Type\n    receipt_type_data = get_linked_code_fields(doc.get(\"receipt_type_code\"), \"ZRA Purchase Receipt Type\",\n                                              [\"code\", \"zra_code_class\", \"user_define_code\"])\n    invoice_data.update({\n        \"receipt_type_code\": receipt_type_data.get(\"code\"),\n    })\n\n    # --- Process Items ---\n    items = invoice_data.get(\"items\", [])\n    if not items:\n        frappe.msgprint(\"Warning: No items found in the invoice.\")\n    else:\n        processed_items = []\n        for item in items:\n            # Fetch linked fields for each item\n            # 1. Item Type Code from ZRA Product Type\n            item_type_data = get_linked_code_fields(item.get(\"item_type_code\"), \"ZRA Product Type\",\n                                                   [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 2. Origin Place Code from ZRA Country Code\n            origin_place_data = get_linked_code_fields(item.get(\"origin_place_code\"), \"ZRA Country Code\",\n                                                      [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 3. Packaging Unit Code from ZRA Packaging Unit\n            packaging_unit_data = get_linked_code_fields(item.get(\"packaging_unit_code\"), \"ZRA Packaging Unit\",\n                                                        [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 4. Quantity Unit Code from ZRA Unit of Measure\n            quantity_unit_data = get_linked_code_fields(item.get(\"quantity_unit_code\"), \"ZRA Unit of Measure\",\n                                                       [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 5. Tax Type from ZRA TAX Type\n            tax_type_data = get_linked_code_fields(item.get(\"tax_type\"), \"ZRA TAX Type\",\n                                                  [\"code\", \"zra_code_class\", \"user_define_code\"])\n            # 6. Item Class Code from ZRA UNSPSC Classification\n            item_class_data = get_linked_code_fields(item.get(\"custom_item_classification\"), \"ZRA UNSPSC Classification\",\n                                                    [\"item_class_code\", \"item_class_name\"])\n            # 7. ZRA Item Code from Item\n            zra_item_data = get_linked_code_fields(item.get(\"item_code\"), \"Item\",\n                                                  [\"zra_item_code\"])\n\n            # Update item dictionary with linked fields\n            processed_item = item.copy()\n            processed_item.update({\n                \"item_type_code\": item_type_data.get(\"code\"),\n                \"item_type_class\": item_type_data.get(\"zra_code_class\"),\n                \"item_type_user_define_code\": item_type_data.get(\"user_define_code\"),\n                \"origin_place_code\": origin_place_data.get(\"code\"),\n                \"origin_place_class\": origin_place_data.get(\"zra_code_class\"),\n                \"origin_place_user_define_code\": origin_place_data.get(\"user_define_code\"),\n                \"packaging_unit_code\": packaging_unit_data.get(\"code\"),\n                \"packaging_unit_class\": packaging_unit_data.get(\"zra_code_class\"),\n                \"packaging_unit_user_define_code\": packaging_unit_data.get(\"user_define_code\"),\n                \"quantity_unit_code\": quantity_unit_data.get(\"code\"),\n                \"tax_type\": tax_type_data.get(\"code\"),\n                \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n                \"item_class_name\": item_class_data.get(\"item_class_name\"),\n                \"zra_item_code\": zra_item_data.get(\"zra_item_code\"),\n            })\n            processed_items.append(processed_item)\n\n        # Update invoice_data with processed items\n        invoice_data[\"items\"] = processed_items\n\n    # Debug: Print invoice_data to verify content\n    #frappe.msgprint(f\"Invoice Data: {json.dumps(invoice_data, indent=2)}\")\n    if not invoice_data:\n        frappe.msgprint(\"Error: invoice_data is empty. Check doc.as_dict() and linked field data.\")\n        raise frappe.ValidationError(\"Invoice data is empty\")\n\n    # --- Send the Webhook ---\n    try:\n        # Serialize data to JSON and set headers\n        payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n        frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n        response = frappe.make_post_request(\n            url=production_url,\n            data=payload,\n            headers={\"Content-Type\": \"application/json\"}\n        )\n\n        #frappe.msgprint(f\"Webhook Response: {str(response)}\")\n        frappe.msgprint(\"ZRA Is Success\")\n\n    except Exception as e:\n        frappe.msgprint(f\"ZRA Codes Webhook Failed: {str(e)}\")\n        frappe.log_error(f\"ZRA Codes Webhook Error for {doc.name}: {str(e)}\", \"ZRA Codes Webhook\")\nelse:\n    frappe.msgprint(\"Invoice not submitted to ZRA: should_submit_to_zra is not 1\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-04 14:59:39.693022",
  "module": null,
  "name": "Update Item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/updateItem\"\ntest_url = \"http://n8n:5678/webhook-test/updateItem\"\n\n# Convert doc to dictionary\ninvoice_data = doc.as_dict()\n\n# Linked field retrieval function\ndef get_linked_code_fields(linked_value, doctype_name, code_fields):\n    if not linked_value:\n        frappe.log_error(f\"No linked value provided for {doctype_name}\")\n        return {}\n\n    try:\n        try:\n            linked_doc = frappe.get_doc(doctype_name, linked_value)\n        except frappe.DoesNotExistError:\n            # Try looking it up by another field if needed (e.g., code_name)\n            linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n        # Extract the fields you need\n        result = {field: linked_doc.get(field) for field in code_fields if linked_doc.get(field) is not None}\n        frappe.msgprint(f\"Linked fields for {doctype_name} ({linked_value}): {str(result)}\")\n        return result\n\n    except Exception as e:\n        frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n        return {}\n\n# --- Linked Fields Section ---\n\n# 1. Item Type Code from New ZRA Product Type\nitem_type_data = get_linked_code_fields(doc.get(\"item_type_code\"), \"ZRA Product Type\",\n                                       [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"item_type_code\": item_type_data.get(\"code\"),\n    \"item_type_class\": item_type_data.get(\"zra_code_class\"),\n    \"item_type_user_define_code\": item_type_data.get(\"user_define_code\"),\n})\n\n# 2. Origin Place Code from New ZRA Country Code\norigin_place_data = get_linked_code_fields(doc.get(\"origin_place_code\"), \"ZRA Country Code\",\n                                          [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"origin_place_code\": origin_place_data.get(\"code\"),\n    \"origin_place_class\": origin_place_data.get(\"zra_code_class\"),\n    \"origin_place_user_define_code\": origin_place_data.get(\"user_define_code\"),\n})\n\n# 3. Packaging Unit Code from New ZRA Packaging Unit\npackaging_unit_data = get_linked_code_fields(doc.get(\"packaging_unit_code\"), \"ZRA Packaging Unit\",\n                                            [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"packaging_unit_code\": packaging_unit_data.get(\"code\"),\n    \"packaging_unit_class\": packaging_unit_data.get(\"zra_code_class\"),\n    \"packaging_unit_user_define_code\": packaging_unit_data.get(\"user_define_code\"),\n})\n\n# 4. Quantity Unit Code from New ZRA Unit of Measure\nquantity_unit_data = get_linked_code_fields(doc.get(\"quantity_unit_code\"), \"ZRA Unit of Measure\",\n                                           [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"quantity_unit_code\": quantity_unit_data.get(\"code\")\n})\n\n# 5. Tax Type from New ZRA TAX Type\ntax_type_data = get_linked_code_fields(doc.get(\"tax_type\"), \"ZRA TAX Type\",\n                                      [\"code\", \"zra_code_class\", \"user_define_code\"])\ninvoice_data.update({\n    \"tax_type\": tax_type_data.get(\"code\"),\n})\n\n# 6. Item Class Code from ZRA UNSPSC Classification\nitem_class_data = get_linked_code_fields(doc.get(\"item_classification_code\"), \"ZRA UNSPSC Classification\",\n                                        [\"item_class_code\", \"item_class_name\"])\ninvoice_data.update({\n    \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n    \"item_class_name\": item_class_data.get(\"item_class_name\"),\n})\n\n# Debug: Print invoice_data to verify content\nfrappe.msgprint(f\"Invoice Data: {json.dumps(invoice_data, indent=2)}\")\nif not invoice_data:\n    frappe.msgprint(\"Error: invoice_data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Invoice data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON and set headers\n    payload = json.dumps(invoice_data, default=str)  # Handle non-serializable objects\n    frappe.msgprint(f\"Sending payload to {test_url}: {payload}\")\n\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    frappe.msgprint(f\"Webhook Response: {str(response)}\")\n    frappe.msgprint(\"Item Webhook Success\")\n\nexcept Exception as e:\n    frappe.msgprint(f\"Item Webhook Failed: {str(e)}\")\n    frappe.log_error(f\"Item Webhook Error for {doc.name}: {str(e)}\", \"Item Webhook\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-25 11:45:16.829142",
  "module": null,
  "name": "Import Declaration  Save",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Import Declaration",
  "script": "# --- Webhook URLs ---\nproduction_url = \"http://n8n:5678/webhook/Import-Post\"\ntest_url = \"http://n8n:5678/webhook-test/Import-Post\"\n\n# --- Convert document to dictionary ---\nimport_data = doc.as_dict()\n\n# --- Helper: Fetch linked code fields ---\ndef get_linked_code_fields(linked_value, doctype_name, code_fields):\n    if not linked_value:\n        frappe.log_error(f\"No linked value provided for {doctype_name}\")\n        return {}\n\n    try:\n        try:\n            linked_doc = frappe.get_doc(doctype_name, linked_value)\n        except frappe.DoesNotExistError:\n            # Try alternative lookup by field like 'code_name'\n            linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\n\n        # Extract required fields from the linked document\n        return {\n            field: linked_doc.get(field)\n            for field in code_fields\n            if linked_doc.get(field) is not None\n        }\n\n    except Exception as e:\n        frappe.log_error(f\"Error fetching linked {doctype_name} for '{linked_value}': {str(e)}\")\n        return {}\n\n# --- Process Items in Import Data ---\nitems = import_data.get(\"items\", [])\nif not items:\n    frappe.msgprint(\"Warning: No items found in the invoice.\")\nelse:\n    processed_items = []\n    for item in items:\n        # Fetch linked fields for item classification\n        item_class_data = get_linked_code_fields(\n            item.get(\"item_classification\"),\n            \"ZRA UNSPSC Classification\",\n            [\"item_class_code\", \"item_class_name\"]\n        )\n        \n        import_status_data = get_linked_code_fields(\n            item.get(\"item_classification\"),\n            \"ZRA UNSPSC Classification\",\n            [\"item_class_code\", \"item_class_name\"]\n        )\n\n        # Fetch linked fields for ZRA item code\n        zra_item_import_status = get_linked_code_fields(\n            item.get(\"import_item_status\"),\n            \"ZRA Import Item status\",\n          [\"code\", \"zra_code_class\", \"user_define_code\"]\n        )\n        \n         # Fetch linked fields for ZRA item code\n        zra_item_data = get_linked_code_fields(\n            item.get(\"item_code\"),\n            \"Item\",\n            [\"zra_item_code\"]\n        )\n\n\n        # Merge linked data into the item\n        processed_item = item.copy()\n        processed_item.update({\n            \"item_classification_code\": item_class_data.get(\"item_class_code\"),\n            \"item_class_name\": item_class_data.get(\"item_class_name\"),\n            \"zra_item_code\": zra_item_data.get(\"zra_item_code\"),\n            \"Item_import_Status\": zra_item_import_status.get('code')\n        })\n        processed_items.append(processed_item)\n\n    # Update the import_data dictionary\n    import_data[\"items\"] = processed_items\n\n# --- Validate Final Data ---\nif not import_data:\n    frappe.msgprint(\"Error: import_data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Import data is empty\")\n\n# --- Send the Webhook to ZRA ---\ntry:\n    payload = json.dumps(import_data, default=str)  # Ensure all values are serializable\n\n    response = frappe.make_post_request(\n        url=test_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    frappe.msgprint(\"Import has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    frappe.msgprint(f\"Import Webhook Failed: {str(e)}\")\n    frappe.log_error(f\"Import Webhook Error for {doc.name}: {str(e)}\", \"Import Codes Webhook\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-16 15:50:30.548857",
  "module": "ZRA INTERGRATION",
  "name": "Add ZRA Device Initialization",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ZRA Device Initialization",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/add-device\"\ntest_url = \"http://n8n:5678/webhook-test/add-device\"\n\n# Convert doc to dictionary\ndevice_data = doc.as_dict()\n\n# Check if device_data is empty\nif not device_data:\n    frappe.msgprint(\"Error: Device data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Device data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON (handle non-serializable objects)\n    payload = json.dumps(device_data, default=str)\n\n    # Send POST request to the production webhook URL\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # Success message\n    frappe.msgprint(\"Device Initialization has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    # Error handling\n    frappe.msgprint(f\"Device Initialization failed to send to ZRA: {str(e)}\")\n    frappe.log_error(f\"Device Initialization Error for {doc.name}: {str(e)}\", \"ZRA Device Initialization\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "Update_ZRA_Device_Intialization",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-24 11:06:43.232778",
  "module": "ZRA INTERGRATION",
  "name": "Update ZRA Device Initialization",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/add-device\"\ntest_url = \"http://n8n:5678/webhook-test/add-device\"\n\n# Convert doc to dictionary\ndevice_data = doc.as_dict()\n\n# Check if device_data is empty\nif not device_data:\n    frappe.msgprint(\"Error: Device data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Device data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON (handle non-serializable objects)\n    payload = json.dumps(device_data, default=str)\n\n    # Send POST request to the production webhook URL\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # Success message\n    frappe.msgprint(\"Device Initialization has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    # Error handling\n    frappe.msgprint(f\"Device Initialization failed to send to ZRA: {str(e)}\")\n    frappe.log_error(f\"Device Initialization Error for {doc.name}: {str(e)}\", \"ZRA Device Initialization\")\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_all_item_from_zra",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-03 15:48:32.750763",
  "module": null,
  "name": "Get All Item From ZRA",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_all_item_from_zra():\n    webhook_url = \"http://n8n:5678/webhook-test/getAllitem\"\n    production_url = \"http://n8n:5678/webhook/getAllitem\"\n    \n    test_url = \"http://n8n:5678/webhook-test/Import-Post\"\n\n    try:\n        response = frappe.make_get_request(production_url)\n        # Check if the response is a dict and contains the expected message\n        print(response)\n        print(response.get(\"message\"))\n        if isinstance(response, dict) and response.get(\"message\") == \"Workflow was started\":\n            print(\"run okay\")\n            return {\"success\": True, \"message\": \"Webhook triggered successfully: Workflow was started\"}\n        else:\n            print('not okay')\n            return {\"success\": False, \"message\": f\"Failed to trigger webhook: Unexpected response {response}\"}\n    except Exception as e:\n        print('test is done')\n        return {\"success\": False, \"message\": f\"Error triggering webhook: {str(e)}\"}\n        \n        \nget_all_item_from_zra();",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-17 13:29:09.758365",
  "module": null,
  "name": "Add Zra Branch User",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ZRA Branch User",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/add_branch_user\"\ntest_url = \"http://n8n:5678/webhook-test/add_branch_user\"\n\n# Convert doc to dictionary\nbranch_user_data = doc.as_dict()\n\n# Check if device_data is empty\nif not branch_user_data:\n    frappe.msgprint(\"Error: Device data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Device data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON (handle non-serializable objects)\n    payload = json.dumps(branch_user_data, default=str)\n\n    # Send POST request to the production webhook URL\n    response = frappe.make_post_request(\n        url=production_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # Success message\n    frappe.msgprint(\"Branch User has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    # Error handling\n    frappe.msgprint(f\"Branch User failed to send to ZRA: {str(e)}\")\n    frappe.log_error(f\"Branch User Error for {doc.name}: {str(e)}\", \"ZRA Device Initialization\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_all_branch_from_zra",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-24 16:11:24.739871",
  "module": null,
  "name": "Get All Branch From ZRA",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_all_branch_from_zra():\n    webhook_url = \"http://n8n:5678/webhook-test/getAllbranch\"\n    production_url = \"http://n8n:5678/webhook/getAllBrach\"\n\n\n    try:\n        response = frappe.make_get_request(production_url)\n        # Check if the response is a dict and contains the expected message\n        print(response)\n        print(response.get(\"message\"))\n        if isinstance(response, dict) and response.get(\"message\") == \"Workflow was started\":\n            print(\"run okay\")\n            return {\"success\": True, \"message\": \"Webhook triggered successfully: Workflow was started\"}\n        else:\n            print('not okay')\n            return {\"success\": False, \"message\": f\"Failed to trigger webhook: Unexpected response {response}\"}\n    except Exception as e:\n        print('test is done')\n        return {\"success\": False, \"message\": f\"Error triggering webhook: {str(e)}\"}\n        \n        \nget_all_branch_from_zra();",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 15:06:17.178951",
  "module": null,
  "name": "Save Item Composition",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ZRA ITEM COMPOSITION",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/add-compositions\"\ntest_url = \"http://n8n:5678/webhook-test/add-compositions\"\n\n# Convert doc to dictionary\nbranch_user_data = doc.as_dict()\n\n# Check if device_data is empty\nif not branch_user_data:\n    frappe.msgprint(\"Error: Device data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Device data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON (handle non-serializable objects)\n    payload = json.dumps(branch_user_data, default=str)\n\n    # Send POST request to the production webhook URL\n    response = frappe.make_post_request(\n        url=test_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # Success message\n    frappe.msgprint(\"Branch User has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    # Error handling\n    frappe.msgprint(f\"Branch User failed to send to ZRA: {str(e)}\")\n    frappe.log_error(f\"Branch User Error for {doc.name}: {str(e)}\", \"ZRA Device Initialization\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 14:51:29.431073",
  "module": null,
  "name": "Save RRP Item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "ZRA RRP ITEM",
  "script": "# Webhook URLs\nproduction_url = \"http://n8n:5678/webhook/addrrp\"\ntest_url = \"http://n8n:5678/webhook-test/addrrp\"\n\n# Convert doc to dictionary\nbranch_user_data = doc.as_dict()\n\n# Check if device_data is empty\nif not branch_user_data:\n    frappe.msgprint(\"Error: Device data is empty. Check doc.as_dict() and linked field data.\")\n    raise frappe.ValidationError(\"Device data is empty\")\n\n# --- Send the Webhook ---\ntry:\n    # Serialize data to JSON (handle non-serializable objects)\n    payload = json.dumps(branch_user_data, default=str)\n\n    # Send POST request to the production webhook URL\n    response = frappe.make_post_request(\n        url=test_url,\n        data=payload,\n        headers={\"Content-Type\": \"application/json\"}\n    )\n\n    # Success message\n    frappe.msgprint(\"Branch User has been sent to ZRA. Please refresh after a minute.\")\n\nexcept Exception as e:\n    # Error handling\n    frappe.msgprint(f\"Branch User failed to send to ZRA: {str(e)}\")\n    frappe.log_error(f\"Branch User Error for {doc.name}: {str(e)}\", \"ZRA Device Initialization\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_all_import_from_zra",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-28 10:10:20.836419",
  "module": null,
  "name": "Get All Import Items from ZRA",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_all_import_from_zra(param=None):\n    production_url = \"http://n8n:5678/webhook/import_Items\"\n    \n    try:\n        # Add param as a query parameter if provided\n   \n        response = frappe.make_post_request(\n            url=production_url,\n            data=param,\n            headers={\"Content-Type\": \"application/json\"}\n        )\n        \n        # Check if the response indicates success\n        if response_data.get(\"message\") == \"Workflow was started\":\n            return {\n                \"success\": True,\n                \"message\": \"Webhook triggered successfully: Workflow was started\"\n            }\n        else:\n            return {\n                \"success\": False,\n                \"message\": f\"Failed to trigger webhook: Unexpected response {response_data}\"\n            }\n    except Exception as e:\n        return {\n            \"success\": False,\n            \"message\": f\"Error triggering webhook: {str(e)}\"\n        }\n        \nget_all_import_from_zra(param)",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-22 23:50:50.266789",
  "module": "Accounts",
  "name": "Budget Validations",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Budget",
  "script": "# Server Script (API)\n# API Method: validate_budget\n# Called from client with:\n# frappe.call(\"validate_budget\", { doc: frm.doc })\n\n# Get the incoming document from the request\nincoming_doc = frappe.form_dict.get(\"doc\") or {}\ndoc = incoming_doc  # doc is a plain dict\n\nissues = []      # strong recommendations / gaps\nwarnings = []    # softer checks\ninfo_lines = []  # comparison information, etc.\n\nbudget_name = doc.get(\"name\") or \"New Budget\"\nbudget_type = doc.get(\"budget_type\")\nfiscal_year = doc.get(\"fiscal_year\")\ncost_center = doc.get(\"cost_center\")\nproject = doc.get(\"project\")\nconsolidation_group = doc.get(\"custom_consolidation_group\")\naccounts = doc.get(\"accounts\") or []\n\n# -------------------------------------------------------------------\n# 1. Basic sanity checks\n# -------------------------------------------------------------------\n\nif not accounts:\n    issues.append(\"Budget Accounts table is empty. Please add at least one Budget Account line.\")\n\n# -------------------------------------------------------------------\n# 2. OPEX rules\n#    - Monthly distribution per line item (custom_monthly_distribution)\n#    - Remarks per line item (custom_remarks)\n# -------------------------------------------------------------------\n\nif budget_type == \"OPEX\":\n    missing_remarks_rows = []\n    missing_distribution_rows = []\n\n    for row in accounts:\n        row_idx = row.get(\"idx\") or row.get(\"name\") or \"?\"\n\n        if not row.get(\"custom_remarks\"):\n            missing_remarks_rows.append(str(row_idx))\n\n        if not row.get(\"custom_monthly_distribution\"):\n            missing_distribution_rows.append(str(row_idx))\n\n    if missing_remarks_rows:\n        issues.append(\n            \"OPEX budget: Remarks (custom_remarks) are missing on Budget Account rows: \"\n            + \", \".join(missing_remarks_rows)\n        )\n\n    if missing_distribution_rows:\n        issues.append(\n            \"OPEX budget: Monthly Distribution (custom_monthly_distribution) is missing on Budget Account rows: \"\n            + \", \".join(missing_distribution_rows)\n        )\n\n# -------------------------------------------------------------------\n# 3. CAPEX rules\n#    - Asset Category per line (custom_asset_category)\n#    - Number of Units per line (custom_number_of_units)\n#    - Expected Price per line (custom_expected_price)\n#    - Remarks per line (custom_remarks)\n# -------------------------------------------------------------------\n\nif budget_type == \"CAPEX\":\n    missing_asset_category_rows = []\n    missing_units_rows = []\n    missing_price_rows = []\n    missing_remarks_rows_capex = []\n\n    for row in accounts:\n        row_idx = row.get(\"idx\") or row.get(\"name\") or \"?\"\n\n        if not row.get(\"custom_asset_category\"):\n            missing_asset_category_rows.append(str(row_idx))\n\n        if not row.get(\"custom_number_of_units\"):\n            missing_units_rows.append(str(row_idx))\n\n        if not row.get(\"custom_expected_price\"):\n            missing_price_rows.append(str(row_idx))\n\n        if not row.get(\"custom_remarks\"):\n            missing_remarks_rows_capex.append(str(row_idx))\n\n    if missing_asset_category_rows:\n        issues.append(\n            \"CAPEX budget: Asset Category (custom_asset_category) is missing on Budget Account rows: \"\n            + \", \".join(missing_asset_category_rows)\n        )\n\n    if missing_units_rows:\n        issues.append(\n            \"CAPEX budget: Number of Units (custom_number_of_units) is missing on Budget Account rows: \"\n            + \", \".join(missing_units_rows)\n        )\n\n    if missing_price_rows:\n        issues.append(\n            \"CAPEX budget: Expected Price (custom_expected_price) is missing on Budget Account rows: \"\n            + \", \".join(missing_price_rows)\n        )\n\n    if missing_remarks_rows_capex:\n        issues.append(\n            \"CAPEX budget: Remarks (custom_remarks) are missing on Budget Account rows: \"\n            + \", \".join(missing_remarks_rows_capex)\n        )\n\n# -------------------------------------------------------------------\n# 4. Property CAPEX / Property Expenses rules\n#    - Project is expected on the header (project)\n# -------------------------------------------------------------------\n\nif budget_type in [\"Property CAPEX\", \"Property Expenses\"]:\n    if not project:\n        issues.append(\n            \"Property budget: A linked Project is expected on the Budget header for Property CAPEX/Property Expenses.\"\n        )\n\n# -------------------------------------------------------------------\n# 5. Training budgets  HR - Training consolidation group\n# -------------------------------------------------------------------\n\nif consolidation_group == \"HR - Training\":\n    non_training_accounts = []\n\n    for row in accounts:\n        acc_name = (row.get(\"account\") or \"\").lower()\n        if \"train\" not in acc_name:\n            non_training_accounts.append(row.get(\"account\") or \"?\")\n\n    if non_training_accounts:\n        warnings.append(\n            \"Training budget: Consolidation Group is 'HR - Training', but the following accounts may not be training accounts: \"\n            + \", \".join(non_training_accounts)\n        )\n\n# -------------------------------------------------------------------\n# 6. Compute current budget total (for comparison)\n# -------------------------------------------------------------------\n\ntotal_current = 0.0\nfor row in accounts:\n    amount = row.get(\"budget_amount\") or 0.0\n    total_current = total_current + amount\n\n# -------------------------------------------------------------------\n# 7. Compare against similar budgets in previous fiscal year\n# -------------------------------------------------------------------\n\nif project and cost_center and budget_type and fiscal_year:\n    fy_info = frappe.db.get_value(\n        \"Fiscal Year\",\n        fiscal_year,\n        [\"year_start_date\"],\n        as_dict=True\n    )\n\n    if fy_info and fy_info.get(\"year_start_date\"):\n        prev_fys = frappe.get_all(\n            \"Fiscal Year\",\n            filters={\"year_start_date\": [\"<\", fy_info.get(\"year_start_date\")]},\n            fields=[\"name\", \"year_start_date\"],\n            order_by=\"year_start_date desc\",\n            limit=1\n        )\n\n        if prev_fys:\n            prev_fy_name = prev_fys[0].get(\"name\")\n\n            similar_filters = {\n                \"fiscal_year\": prev_fy_name,\n                \"budget_type\": budget_type,\n                \"cost_center\": cost_center,\n            }\n\n            if doc.get(\"budget_against\") == \"Project\":\n                similar_filters[\"budget_against\"] = \"Project\"\n\n            prev_budgets = frappe.get_all(\n                \"Budget\",\n                filters=similar_filters,\n                fields=[\"name\"]\n            )\n\n            prev_totals = []\n\n            for b in prev_budgets:\n                parent_name = b.get(\"name\")\n                if not parent_name:\n                    continue\n\n                ba_rows = frappe.get_all(\n                    \"Budget Account\",\n                    filters={\"parent\": parent_name},\n                    fields=[\"budget_amount\"]\n                )\n\n                total_prev = 0.0\n                for r in ba_rows:\n                    amt = r.get(\"budget_amount\") or 0.0\n                    total_prev = total_prev + amt\n\n                prev_totals.append(total_prev)\n\n            if prev_totals:\n                count_prev = len(prev_totals)\n                sum_prev = 0.0\n                min_prev = None\n                max_prev = None\n\n                for v in prev_totals:\n                    sum_prev = sum_prev + v\n                    if min_prev is None or v < min_prev:\n                        min_prev = v\n                    if max_prev is None or v > max_prev:\n                        max_prev = v\n\n                if count_prev:\n                    avg_prev = sum_prev / count_prev\n                else:\n                    avg_prev = 0.0\n\n                comparison_text_lines = []\n                comparison_text_lines.append(\n                    \"Comparison with similar budgets in previous Fiscal Year \"\n                    + str(prev_fy_name)\n                    + \" (same Budget Type and Cost Center):\"\n                )\n                comparison_text_lines.append(\"- Number of previous budgets: \" + str(count_prev))\n                comparison_text_lines.append(\"- Average total (company currency): \" + str(avg_prev))\n                comparison_text_lines.append(\"- Minimum total (company currency): \" + str(min_prev))\n                comparison_text_lines.append(\"- Maximum total (company currency): \" + str(max_prev))\n                comparison_text_lines.append(\"- Current budget total (company currency): \" + str(total_current))\n\n                info_lines.append(\"\\n\".join(comparison_text_lines))\n\n        else:\n            info_lines.append(\n                \"No previous Fiscal Year found before \" + str(fiscal_year) + \" for comparison.\"\n            )\n    else:\n        info_lines.append(\n            \"Fiscal Year '\" + str(fiscal_year) + \"' has no year_start_date, comparison skipped.\"\n        )\n\n# -------------------------------------------------------------------\n# 8. Build HTML \"page\" for the dialog\n# -------------------------------------------------------------------\n\nhtml_lines = []\n\nhtml_lines.append(\"<div style='max-height: 70vh; overflow:auto;'>\")\nhtml_lines.append(\"<h3>Budget Validation  \" + str(budget_name) + \"</h3>\")\nhtml_lines.append(\n    \"<p><b>Type:</b> \" + str(budget_type or \"\") +\n    \" &nbsp; <b>Fiscal Year:</b> \" + str(fiscal_year or \"\") +\n    \" &nbsp; <b>Cost Center:</b> \" + str(cost_center or \"\") +\n    \" &nbsp; <b>Project:</b> \" + str(project or \"\") + \"</p>\"\n)\n\nif issues:\n    html_lines.append(\"<h4>Issues / Gaps (review recommended)</h4>\")\n    html_lines.append(\"<ul>\")\n    for e in issues:\n        html_lines.append(\"<li>\" + str(e) + \"</li>\")\n    html_lines.append(\"</ul>\")\nelse:\n    html_lines.append(\"<h4>Issues / Gaps</h4><p>No issues detected based on current rules.</p>\")\n\nif warnings:\n    html_lines.append(\"<h4>Warnings</h4>\")\n    html_lines.append(\"<ul>\")\n    for w in warnings:\n        html_lines.append(\"<li>\" + str(w) + \"</li>\")\n    html_lines.append(\"</ul>\")\n\nif info_lines:\n    html_lines.append(\"<h4>Comparative Information</h4>\")\n    for info in info_lines:\n        html_lines.append(\n            \"<pre style='background:#f8f9fa; padding:8px; border-radius:4px;'>\" +\n            str(info) +\n            \"</pre>\"\n        )\n\nhtml_lines.append(\"<h4>Totals</h4>\")\nhtml_lines.append(\n    \"<p><b>Current budget total:</b> \" + str(total_current) + \" (company currency)</p>\"\n)\n\nhtml_lines.append(\n    \"<p style='margin-top:16px; font-size:90%; color:#666;'>\"\n    \"Validation is advisory only and does not block saving or submission.\"\n    \"</p>\"\n)\nhtml_lines.append(\"</div>\")\n\nhtml = \"\\n\".join(html_lines)\n\nfrappe.response[\"message\"] = {\n    \"html\": html,\n    \"has_issues\": bool(issues),\n    \"has_warnings\": bool(warnings),\n}\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_current_logs",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-11 09:02:18.000685",
  "module": null,
  "name": "get_current_logs",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_current_logs():\n    webhook_url = \"http://n8n:5678/webhook-test/fad808da-0d88-42ce-baa2-1a7126db8daf\"\n    production_url = \"http://n8n:5678/webhook/6da76e05-ace4-42aa-9a1b-98ab9448876e\"\n   \n    try:\n        response = frappe.make_get_request(production_url)\n        # Check if the response is a dict and contains the expected message\n        print(response)\n        print(response.get(\"message\"))\n        if isinstance(response, dict) and response.get(\"message\") == \"Workflow was started\":\n            print(\"run okay\")\n            return {\"success\": True, \"message\": \"Webhook triggered successfully: Workflow was started\"}\n        else:\n            print('not okay')\n            return {\"success\": False, \"message\": f\"Failed to trigger webhook: Unexpected response {response}\"}\n    except Exception as e:\n        print('test is done')\n        return {\"success\": False, \"message\": f\"Error triggering webhook: {str(e)}\"}\n        \n        \nget_current_logs();",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-11 00:43:32.069212",
  "module": "Accounts",
  "name": "Total",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Budget",
  "script": "# Sum Budget Account.budget_amount into Budget.total_budget_value\ntotal = 0.0\nfor row in (doc.get(\"accounts\") or []):\n    amt = row.get(\"budget_amount\") or 0.0\n    try:\n        amt = float(amt)\n    except Exception:\n        amt = 0.0\n    total = total + amt  # avoid \"+=\" in RestrictedPython\n\ndoc.custom_total_budget_value = total",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-12 10:46:37.289561",
  "module": null,
  "name": "Project",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "doc.custom_project = 0\nfor row in (doc.items or []):\n    if row.project:\n        doc.custom_project = 1\n        break\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-19 14:36:26.056628",
  "module": "WCFCB ZM",
  "name": "ZPPA Rules",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Procurement Plan",
  "script": "def before_save(doc, method=None):\n    # === thresholds from the table ===\n    ZMW_1M = 1000000\n    ZMW_20K = 20000\n    ZMW_600K = 600000\n\n    # helpers\n    def clean(v):\n        return \"\" if v is None else str(v).strip()\n    def trueish(v):\n        return v in (1, \"1\", True, \"true\", \"True\", \"YES\", \"Yes\", \"Y\", \"y\")\n\n    # allow flexible input labels\n    type_alias = {\n        \"goods\": \"Goods and Non-Consulting Services\",\n        \"goods and non-consulting services\": \"Goods and Non-Consulting Services\",\n        \"works\": \"Works\",\n        \"consulting\": \"Consulting Services\",\n        \"consulting services\": \"Consulting Services\",\n    }\n    method_alias = {\n        # goods/works\n        \"open national bidding\": \"Open National Bidding\",\n        \"onb\": \"Open National Bidding\",\n        \"open international bidding\": \"Open International Bidding\",\n        \"oib\": \"Open International Bidding\",\n        \"limited bidding\": \"Limited Bidding\",\n        \"lb\": \"Limited Bidding\",\n        \"simplified bidding\": \"Simplified Bidding\",\n        \"sb\": \"Simplified Bidding\",\n        \"direct bidding\": \"Direct Bidding on account of low value\",\n        \"direct bidding on account of low value\": \"Direct Bidding on account of low value\",\n        \"db\": \"Direct Bidding on account of low value\",\n        # consulting\n        \"open national selection\": \"Open National Selection\",\n        \"ons\": \"Open National Selection\",\n        \"open international selection\": \"Open International Selection\",\n        \"ois\": \"Open International Selection\",\n        \"limited selection\": \"Limited Selection\",\n        \"ls\": \"Limited Selection\",\n        \"simplified selection\": \"Simplified Selection\",\n        \"ss\": \"Simplified Selection\",\n        \"direct selection\": \"Direct Selection\",\n        \"ds\": \"Direct Selection\",\n    }\n\n    # read and normalise\n    ptype_raw = clean(doc.get(\"procurement_type\"))\n    pmethod_raw = clean(doc.get(\"procurement_method\"))\n    amount = float(doc.get(\"total_value\") or 0)\n    appropriate = trueish(doc.get(\"appropriate_circumstances\"))\n\n    ptype = type_alias.get(ptype_raw.lower(), ptype_raw)\n    pmethod = method_alias.get(pmethod_raw.lower(), pmethod_raw)\n\n    ok = False\n    notes = []\n\n    if not ptype or not pmethod:\n        notes.append(\"Missing procurement type or method.\")\n    else:\n        # GOODS and WORKS share the same thresholds in your table\n        if ptype in (\"Goods and Non-Consulting Services\", \"Works\"):\n            if pmethod == \"Open National Bidding\":\n                ok = amount > ZMW_1M\n                notes.append(\"Open National Bidding requires amount > ZMW {:,}.\".format(ZMW_1M))\n            elif pmethod == \"Open International Bidding\":\n                ok = appropriate\n                notes.append(\"Open International Bidding allowed only in appropriate circumstances.\")\n            elif pmethod == \"Limited Bidding\":\n                ok = (amount > ZMW_1M) and appropriate\n                if amount <= ZMW_1M:\n                    notes.append(\"Limited Bidding requires amount > ZMW {:,}.\".format(ZMW_1M))\n                if not appropriate:\n                    notes.append(\"Limited Bidding requires appropriate circumstances.\")\n            elif pmethod == \"Simplified Bidding\":\n                ok = amount <= ZMW_1M\n                notes.append(\"Simplified Bidding valid up to ZMW {:,}.\".format(ZMW_1M))\n            elif pmethod == \"Direct Bidding on account of low value\":\n                ok = (amount <= ZMW_20K) or appropriate\n                if amount <= ZMW_20K:\n                    notes.append(\"Direct Bidding valid up to ZMW {:,}.\".format(ZMW_20K))\n                elif appropriate:\n                    notes.append(\"Direct Bidding allowed based on appropriate circumstances.\")\n                else:\n                    notes.append(\"Direct Bidding requires amount  ZMW {:,} or appropriate circumstances.\".format(ZMW_20K))\n            else:\n                notes.append(\"Unsupported method for Goods/Works: {}\".format(pmethod))\n\n        # CONSULTING\n        elif ptype == \"Consulting Services\":\n            if pmethod == \"Open National Selection\":\n                ok = amount > ZMW_600K\n                notes.append(\"Open National Selection requires amount > ZMW {:,}.\".format(ZMW_600K))\n            elif pmethod == \"Open International Selection\":\n                ok = appropriate\n                notes.append(\"Open International Selection allowed only in appropriate circumstances.\")\n            elif pmethod == \"Limited Selection\":\n                ok = (amount > ZMW_600K) and appropriate\n                if amount <= ZMW_600K:\n                    notes.append(\"Limited Selection requires amount > ZMW {:,}.\".format(ZMW_600K))\n                if not appropriate:\n                    notes.append(\"Limited Selection requires appropriate circumstances.\")\n            elif pmethod == \"Simplified Selection\":\n                ok = amount <= ZMW_600K\n                notes.append(\"Simplified Selection valid up to ZMW {:,}.\".format(ZMW_600K))\n            elif pmethod == \"Direct Selection\":\n                ok = appropriate\n                notes.append(\"Direct Selection allowed only in appropriate circumstances.\")\n            else:\n                notes.append(\"Unsupported method for Consulting Services: {}\".format(pmethod))\n        else:\n            notes.append(\"Unsupported procurement type: {}\".format(ptype))\n\n    # set checkbox\n    try:\n        doc.zppa_compliant = 1 if ok else 0\n    except Exception:\n        pass\n\n    # persist message on the document if the field exists\n    status = \"Compliant\" if ok else \"Not Compliant\"\n    message = \"ZPPA Compliance Check: {}\\nType: {}\\nMethod: {}\\nAmount: ZMW {:,}\\n{}\".format(\n        status, ptype or \"-\", pmethod or \"-\", amount, \"\\n\".join(notes)\n    )\n    try:\n        if \"zppa_message\" in doc.as_dict():\n            doc.zppa_message = message\n    except Exception:\n        pass\n\n    # lightweight toast (ignored if UI suppresses it)\n    try:\n        frappe.msgprint(message)\n    except Exception:\n        pass\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-19 14:36:42.836939",
  "module": "WCFCB ZM",
  "name": "ZPPA Rules post",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Procurement Plan",
  "script": "def after_save(doc, method=None):\n    try:\n        text = doc.get(\"zppa_message\") or \"\"\n        if text:\n            doc.add_comment(\"Comment\", text)\n    except Exception:\n        pass\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-07 14:19:57.959695",
  "module": null,
  "name": "Auto Assign",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Asset Movement",
  "script": "import frappe\n\n# Collect assignees from the built-in _assign field\nassignees = set()\nraw_assign = doc.get(\"_assign\")\n\nif raw_assign:\n    try:\n        parsed = frappe.parse_json(raw_assign) if isinstance(raw_assign, str) else raw_assign\n    except Exception:\n        parsed = []\n\n    if isinstance(parsed, (list, tuple)):\n        for u in parsed:\n            if isinstance(u, str) and u.strip():\n                assignees.add(u.strip())\n\n# Collect assignees from open ToDos referencing this document\ntodo_users = frappe.get_all(\n    \"ToDo\",\n    filters={\n        \"reference_type\": doc.doctype,\n        \"reference_name\": doc.name,\n        \"status\": \"Open\",\n        \"allocated_to\": [\"!=\", \"\"],\n    },\n    pluck=\"allocated_to\",\n)\n\nfor u in todo_users or []:\n    if isinstance(u, str) and u.strip():\n        assignees.add(u.strip())\n\n# Keep only enabled users\nenabled_assignees = set()\nif assignees:\n    enabled_assignees = set(\n        frappe.get_all(\n            \"User\",\n            filters={\"name\": [\"in\", list(assignees)], \"enabled\": 1},\n            pluck=\"name\",\n        )\n    )\n\n# Enforce requirement (skip if you want Administrator exempted)\nif not enabled_assignees:\n    frappe.throw(\n        title=\"Assignment Required\",\n        msg=(\n            \"You must assign this Asset Movement to at least one <b>active</b> user \"\n            \"before submitting. Use <em>Assign</em> on the form header.\"\n        ),\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-09 20:36:55.259371",
  "module": null,
  "name": "Script to fetch overtime",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "# Collate hours from Timesheets into:\n#  - doc.custom_normal_overtime_hours\n#  - doc.custom_sunday_overtime_hours\n# Activity Type names matched case-insensitively.\n\nnormal_set = {\"normal overtime\"}\nsunday_set = {\"sunday overtime\"}\n\ntotal_normal = 0.0\ntotal_sunday = 0.0\n\n# 1) Collect timesheet names already linked to the slip\nlinked_ts = []\nrows = doc.timesheets or []\ni = 0\nwhile i < len(rows):\n    r = rows[i]\n    if r and r.time_sheet:\n        linked_ts.append(r.time_sheet)\n    i = i + 1\n\n# 2) If none linked, fetch submitted timesheets overlapping the slip period\nif not linked_ts:\n    start_date = doc.get(\"start_date\")\n    end_date = doc.get(\"end_date\")\n    emp = doc.get(\"employee\")\n    if start_date and end_date and emp:\n        ts_list = frappe.get_all(\n            \"Timesheet\",\n            filters={\n                \"employee\": emp,\n                \"docstatus\": 1,            # submitted\n                \"start_date\": (\"<=\", end_date),\n                \"end_date\": (\">=\", start_date),\n            },\n            pluck=\"name\",\n            limit_page_length=500\n        )\n        j = 0\n        while j < len(ts_list):\n            linked_ts.append(ts_list[j])\n            j = j + 1\n\n# 3) Walk through each timesheet and total hours by activity\nk = 0\nwhile k < len(linked_ts):\n    ts_name = linked_ts[k]\n    ts = frappe.get_doc(\"Timesheet\", ts_name)\n    logs = ts.get(\"time_logs\") or []\n\n    m = 0\n    while m < len(logs):\n        d = logs[m]\n        # activity type (lowercased)\n        at = \"\"\n        try:\n            at = (d.activity_type or \"\").strip().lower()\n        except Exception:\n            at = \"\"\n\n        # hours: prefer explicit d.hours; else compute from timestamps\n        hrs = 0.0\n        try:\n            # try to read a 'hours' key via as_dict (avoids getattr)\n            row = None\n            try:\n                row = d.as_dict()\n            except Exception:\n                row = None\n\n            if row and (\"hours\" in row) and (row[\"hours\"] not in (None, \"\")):\n                try:\n                    hrs = float(row[\"hours\"])\n                except Exception:\n                    hrs = 0.0\n            else:\n                # fallback: compute from to_time / from_time\n                try:\n                    secs = (d.to_time - d.from_time).total_seconds()\n                    if secs > 0:\n                        hrs = secs / 3600.0\n                except Exception:\n                    hrs = 0.0\n        except Exception:\n            hrs = 0.0\n\n        if at in normal_set:\n            total_normal = total_normal + hrs\n        elif at in sunday_set:\n            total_sunday = total_sunday + hrs\n\n        m = m + 1\n\n    k = k + 1\n\n# 4) Write totals back to the slip\ndoc.custom_normal_overtime_hours  = round(total_normal, 2)\ndoc.custom_sunday_overtime_hours  = round(total_sunday, 2)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-09-09 21:46:05.778714",
  "module": null,
  "name": "Inser Overtime",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "# --- SETTINGS ---\nworking_days_per_year = 260.0\nhours_per_day = 8.0\nmult_normal = 1.5\nmult_sunday = 2.0\n\n# Timesheet Activity names (case-insensitive)\nnormal_act = \"normal overtime\"\nsunday_act = \"sunday overtime\"\n\n# Target earnings (match by ABBR)\nabbr_normal = \"OOVERTI\"            # Overtime\nabbr_sunday = \"PHOVERT\"            # Sunday/PH Overtime\n\n# --- 1) Basic monthly from Salary Structure Assignment (fallback to slip) ---\nbasic_monthly = 0.0\nemp = doc.employee\nend_date = doc.end_date\n\nif emp and end_date:\n    ssa_list = frappe.get_all(\n        \"Salary Structure Assignment\",\n        filters={\"employee\": emp, \"docstatus\": 1, \"from_date\": (\"<=\", end_date)},\n        fields=[\"name\"],\n        order_by=\"from_date desc\",\n        limit_page_length=1\n    )\n    if ssa_list:\n        ssa = frappe.get_doc(\"Salary Structure Assignment\", ssa_list[0][\"name\"])\n        rows_ssa = ssa.earnings or []\n        ii = 0\n        while ii < len(rows_ssa):\n            r = rows_ssa[ii]\n            nm = (r.salary_component or \"\").strip().lower()\n            if nm in {\"basic pay\", \"basic pay earnings\"}:\n                try:\n                    basic_monthly = float(r.amount) or 0.0\n                except Exception:\n                    basic_monthly = 0.0\n                break\n            ii = ii + 1\n\nif basic_monthly == 0.0:\n    rows_er = doc.earnings or []\n    jj = 0\n    while jj < len(rows_er):\n        er = rows_er[jj]\n        nm = (er.salary_component or \"\").strip().lower()\n        if nm in {\"basic pay\", \"basic pay earnings\"}:\n            try:\n                basic_monthly = float(er.amount) or 0.0\n            except Exception:\n                basic_monthly = 0.0\n            break\n        jj = jj + 1\n\n# --- 2) Hourly rate ---\nhourly_rate = 0.0\nif basic_monthly > 0:\n    hourly_rate = (basic_monthly * 12.0) / (working_days_per_year * hours_per_day)\n\n# --- 3) Gather Timesheets for period (use linked if present; else fetch) ---\nlinked_ts = []\nrows_ts = doc.timesheets or []\nkk = 0\nwhile kk < len(rows_ts):\n    r = rows_ts[kk]\n    if r and r.time_sheet:\n        linked_ts.append(r.time_sheet)\n    kk = kk + 1\n\nif not linked_ts:\n    start_date = doc.get(\"start_date\")\n    end_date2 = doc.get(\"end_date\")\n    if emp and start_date and end_date2:\n        ts_list = frappe.get_all(\n            \"Timesheet\",\n            filters={\n                \"employee\": emp,\n                \"docstatus\": 1,             # submitted\n                \"start_date\": (\"<=\", end_date2),\n                \"end_date\": (\">=\", start_date),\n            },\n            pluck=\"name\",\n            limit_page_length=500\n        )\n        mm = 0\n        while mm < len(ts_list):\n            linked_ts.append(ts_list[mm])\n            mm = mm + 1\n\n# --- 4) Total hours by activity ---\ntotal_normal = 0.0\ntotal_sunday = 0.0\n\nnn = 0\nwhile nn < len(linked_ts):\n    ts = frappe.get_doc(\"Timesheet\", linked_ts[nn])\n    logs = ts.get(\"time_logs\") or []\n    pp = 0\n    while pp < len(logs):\n        d = logs[pp]\n        # activity type\n        at = \"\"\n        try:\n            at = (d.activity_type or \"\").strip().lower()\n        except Exception:\n            at = \"\"\n\n        # hours: prefer 'hours'; else compute from times\n        hrs = 0.0\n        try:\n            row = None\n            try:\n                row = d.as_dict()\n            except Exception:\n                row = None\n\n            if row and (\"hours\" in row) and (row[\"hours\"] not in (None, \"\")):\n                try:\n                    hrs = float(row[\"hours\"])\n                except Exception:\n                    hrs = 0.0\n            else:\n                try:\n                    secs = (d.to_time - d.from_time).total_seconds()\n                    if secs > 0:\n                        hrs = secs / 3600.0\n                except Exception:\n                    hrs = 0.0\n        except Exception:\n            hrs = 0.0\n\n        if at == normal_act:\n            total_normal = total_normal + hrs\n        elif at == sunday_act:\n            total_sunday = total_sunday + hrs\n\n        pp = pp + 1\n    nn = nn + 1\n\n# --- 5) Compute amounts ---\nnormal_amt = round(hourly_rate * total_normal * mult_normal, 2)\nsunday_amt = round(hourly_rate * total_sunday * mult_sunday, 2)\n\n# --- 6) Upsert earnings by ABBR (no helper function) ---\nfound_normal = False\nfound_sunday = False\nrows_er2 = doc.earnings or []\nqq = 0\nwhile qq < len(rows_er2):\n    er2 = rows_er2[qq]\n    ab = (er2.abbr or \"\").strip()\n    if ab == abbr_normal:\n        er2.amount = normal_amt\n        er2.do_not_include_in_total = 0\n        found_normal = True\n    elif ab == abbr_sunday:\n        er2.amount = sunday_amt\n        er2.do_not_include_in_total = 0\n        found_sunday = True\n    qq = qq + 1\n\nif not found_normal:\n    new1 = doc.append(\"earnings\", {})\n    new1.salary_component = \"Overtime\"\n    new1.abbr = abbr_normal\n    new1.amount = normal_amt\n    new1.do_not_include_in_total = 0\n\nif not found_sunday:\n    new2 = doc.append(\"earnings\", {})\n    new2.salary_component = \"Sunday/PH Overtime\"\n    new2.abbr = abbr_sunday\n    new2.amount = sunday_amt\n    new2.do_not_include_in_total = 0\n\n# Optional: write a tiny debug trace so you can confirm quickly\ndbg = f\"OT: base={basic_monthly}, hr={hourly_rate:.4f}, nH={total_normal}, sH={total_sunday}, nA={normal_amt}, sA={sunday_amt}\"\nif not doc.remarks:\n    doc.remarks = dbg\nelse:\n    doc.remarks = f\"{doc.remarks}\\n{dbg}\"\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-06 10:34:57.025072",
  "module": null,
  "name": "Salary Advance",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Advance",
  "script": "def validate_employee_advance(doc):\n    # --- Config kept local (avoid global lookups)\n    repayment_components = [\"Salary Advance Recovery\", \"Advance Repayment\"]  # adjust names as needed\n\n    # --- Guards\n    if not doc.get(\"employee\"):\n        frappe.throw(\"Please select an Employee before saving the Employee Advance.\")\n\n    company = doc.get(\"company\")\n    company_currency = frappe.db.get_value(\"Company\", company, \"default_currency\") if company else None\n    if not company_currency:\n        default_cur = frappe.db.get_single_value(\"Global Defaults\", \"default_currency\")\n        company_currency = default_cur if default_cur else \"USD\"\n\n    # --- Latest submitted Salary Slip  Gross\n    slips = frappe.get_all(\n        \"Salary Slip\",\n        filters={\"employee\": doc.get(\"employee\"), \"docstatus\": 1},\n        fields=[\"name\", \"start_date\", \"end_date\", \"gross_pay\", \"net_pay\"],\n        order_by=\"end_date desc\",\n        limit_page_length=1,\n    )\n    if not slips:\n        frappe.throw(\"No submitted Salary Slip found for this Employee. Cannot compute 50% of Gross.\")\n\n    slip = slips[0]\n    gross_val = frappe.utils.flt(slip.get(\"gross_pay\") or 0)\n    if gross_val <= 0:\n        frappe.throw(\"Latest Salary Slip has zero/invalid Gross Pay. Cannot compute 50% of Gross.\")\n\n    allowed_val = 0.50 * gross_val\n    requested_val = frappe.utils.flt(doc.get(\"advance_amount\") or 0)\n\n    gross = frappe.utils.fmt_money(gross_val, currency=company_currency)\n    allowed = frappe.utils.fmt_money(allowed_val, currency=company_currency)\n    requested = frappe.utils.fmt_money(requested_val, currency=company_currency)\n\n    # --- Enforce 50% rule\n    if requested_val > allowed_val:\n        frappe.throw(f\"Requested amount {requested} exceeds 50% of Gross ({allowed}).\")\n\n    # --- Deductions from latest slip (parentfield='deductions')\n    deductions = frappe.get_all(\n        \"Salary Detail\",\n        filters={\"parenttype\": \"Salary Slip\", \"parent\": slip[\"name\"], \"parentfield\": \"deductions\"},\n        fields=[\"salary_component\", \"amount\"],\n        order_by=\"amount desc\",\n    )\n\n    total_ded_val = 0.0\n    total_repay_val = 0.0\n    rows_html = \"\"\n\n    for row in (deductions or []):\n        amt_val = frappe.utils.flt(row.get(\"amount\") or 0)\n        total_ded_val = total_ded_val + amt_val\n\n        comp = (row.get(\"salary_component\") or \"\").strip()\n        if comp in repayment_components:\n            total_repay_val = total_repay_val + amt_val\n\n        comp_safe = frappe.utils.escape_html(comp)\n        amt_fmt = frappe.utils.fmt_money(amt_val, currency=company_currency)\n        rows_html = (\n            rows_html\n            + \"<tr>\"\n            + \"<td style=\\\"padding:4px 8px;border:1px solid #ddd;\\\">\" + comp_safe + \"</td>\"\n            + \"<td style=\\\"padding:4px 8px;border:1px solid #ddd;text-align:right;\\\">\" + amt_fmt + \"</td>\"\n            + \"</tr>\"\n        )\n\n    if not rows_html:\n        rows_html = (\n            \"<tr><td colspan=\\\"2\\\" style=\\\"padding:6px;border:1px solid #ddd;text-align:center;color:#666;\\\">\"\n            \"No deductions found on the last Salary Slip.\"\n            \"</td></tr>\"\n        )\n\n    total_ded = frappe.utils.fmt_money(total_ded_val, currency=company_currency)\n    total_repay = frappe.utils.fmt_money(total_repay_val, currency=company_currency)\n\n    # Build rc string without .join (avoid attribute reads)\n    rc_str = \"\"\n    for i in range(len(repayment_components or [])):\n        if i == 0:\n            rc_str = rc_str + repayment_components[i]\n        else:\n            rc_str = rc_str + \", \" + repayment_components[i]\n    if not rc_str:\n        rc_str = \"\"\n\n    # --- Summary popup (informational)  no .format used\n    slip_name = slip[\"name\"]\n    sd = frappe.utils.formatdate(slip[\"start_date\"])\n    ed = frappe.utils.formatdate(slip[\"end_date\"])\n\n    summary_html = (\n        \"<div style=\\\"margin-top:8px;\\\">\"\n        + \"<b>Latest Salary Slip:</b> \" + slip_name + \" (\" + sd + \"  \" + ed + \")<br>\"\n        + \"<b>Gross Pay:</b> \" + gross + \"<br>\"\n        + \"<b>50% of Gross (Max Advance):</b> \" + allowed + \"<br>\"\n        + \"<b>Requested Advance:</b> \" + requested + \"<br>\"\n        + \"<b>Repayment Components Monitored:</b> \" + rc_str + \"<br>\"\n        + \"<b>Total Repayments on Last Slip:</b> \" + total_repay + \"<br>\"\n        + \"</div>\"\n        + \"<div style=\\\"margin-top:10px;\\\">\"\n        + \"<b>Last Payroll Deductions</b>\"\n        + \"<table style=\\\"border-collapse:collapse;margin-top:6px;\\\">\"\n        + \"<thead>\"\n        + \"<tr><th style=\\\"padding:6px;border:1px solid #ddd;\\\">Salary Component</th>\"\n        + \"<th style=\\\"padding:6px;border:1px solid #ddd;\\\">Amount</th></tr>\"\n        + \"</thead>\"\n        + \"<tbody>\"\n        + rows_html\n        + \"<tr>\"\n        + \"<td style=\\\"padding:6px;border:1px solid #ddd;text-align:right;\\\"><b>Total Deductions</b></td>\"\n        + \"<td style=\\\"padding:6px;border:1px solid #ddd;text-align:right;\\\"><b>\" + total_ded + \"</b></td>\"\n        + \"</tr>\"\n        + \"</tbody>\"\n        + \"</table>\"\n        + \"</div>\"\n    )\n\n    frappe.msgprint(summary_html, title=\"Employee Advance Validation\", indicator=\"blue\")\n\n# Run for this doc event\nvalidate_employee_advance(doc)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-06 01:13:18.345698",
  "module": null,
  "name": "PAssport",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "# DocType: Employee\n# Script Type: Before Save\n\nimport frappe\nfrom frappe.utils import getdate, today\nfrom frappe import _\n\nif doc.get(\"date_of_issue\") and getdate(doc.date_of_issue) > getdate(today()):\n    frappe.throw(_(\"Date of Issue cannot be in the future.\"))\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-06 23:50:24.320697",
  "module": null,
  "name": "Asset Final Date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Asset",
  "script": "# Align Asset Finance Book.depreciation_start_date to the last day of its month,\n# and (optionally) align Asset.next_depreciation_date as well.\n# NOTE: No imports allowed in Server Script safe_exec.\n\ndef month_end(date_like):\n    if not date_like:\n        return None\n    # frappe and frappe.utils are available in the safe context\n    return frappe.utils.get_last_day(frappe.utils.getdate(date_like))\n\ndef before_save(doc, method=None):\n    # Prefer available_for_use_date, fallback to purchase_date\n    base_asset_date = doc.get(\"available_for_use_date\") or doc.get(\"purchase_date\")\n\n    # Child table is typically fieldname 'finance_books'\n    for row in (doc.get(\"finance_books\") or []):\n        candidate = row.get(\"depreciation_start_date\") or base_asset_date\n        final_date = month_end(candidate)\n        if final_date:\n            row.depreciation_start_date = final_date\n\n    # OPTIONAL: keep parent-level next_depreciation_date aligned to month-end\n    if doc.get(\"next_depreciation_date\"):\n        nd = month_end(doc.next_depreciation_date)\n        if nd:\n            doc.next_depreciation_date = nd\n    elif base_asset_date:\n        nd = month_end(base_asset_date)\n        if nd:\n            doc.next_depreciation_date = nd\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-07 11:16:08.549522",
  "module": null,
  "name": "Validation of Date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "# Strict lock: allow SUBMIT only when start_date and end_date are both\n# in the CURRENT calendar month & year (and within the same month).\n# NOTE: No imports. No tuple unpacking. Body script (DocType Event).\n\ndef get_month_year(date_val):\n    d = frappe.utils.getdate(date_val)\n    return {\"month\": d.month, \"year\": d.year}\n\n# Ensure payroll dates exist\nif not doc.get(\"start_date\") or not doc.get(\"end_date\"):\n    frappe.throw(\"Start Date and End Date are required to submit a Salary Slip.\")\n\n# Derive months/years (no tuple-unpack  sandbox safe)\ncur = get_month_year(frappe.utils.nowdate())\ncur_m = cur[\"month\"]; cur_y = cur[\"year\"]\n\nst = get_month_year(doc.get(\"start_date\"))\nstart_m = st[\"month\"]; start_y = st[\"year\"]\n\nen = get_month_year(doc.get(\"end_date\"))\nend_m = en[\"month\"]; end_y = en[\"year\"]\n\n# Debug (remove when confirmed)\nfrappe.msgprint(\n    \"DEBUG (Before Submit):\\n\"\n    f\"Start: {frappe.utils.formatdate(doc.start_date)} -> {start_m:02d}/{start_y}\\n\"\n    f\"End:   {frappe.utils.formatdate(doc.end_date)} -> {end_m:02d}/{end_y}\\n\"\n    f\"Now:   {frappe.utils.formatdate(frappe.utils.nowdate())} -> {cur_m:02d}/{cur_y}\"\n)\n\n# Must be one calendar month\nif (start_y != end_y) or (start_m != end_m):\n    frappe.throw(\"Monthly payroll must have Start Date and End Date within the SAME calendar month.\")\n\n# Must be the CURRENT month/year\nif (start_m != cur_m) or (start_y != cur_y) or (end_m != cur_m) or (end_y != cur_y):\n    frappe.throw(\n        \"Salary Slip can only be submitted for the CURRENT month.\\n\"\n        f\"Slip period: {frappe.utils.formatdate(doc.start_date, 'MMM yyyy')} \"\n        f\"to {frappe.utils.formatdate(doc.end_date, 'MMM yyyy')}; \"\n        f\"Current month: {frappe.utils.formatdate(frappe.utils.nowdate(), 'MMM yyyy')}.\"\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "item_sync",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-16 20:26:08.387444",
  "module": "ExN",
  "name": "ManualItemSync",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Item Webhook Server Script\r\n\r\n# Configuration\r\nWEBHOOK_CONFIG = {\r\n    'production_url': \"http://n8n:5678/webhook/getItemLog\",\r\n    'test_url': \"http://n8n:5678/webhook-test/getItemLog\"\r\n}\r\n\r\n# Extract form inputs\r\nitem_name = frappe.form_dict.get('item_name')\r\n\r\ndef send_item_webhook(item_name):\r\n    \"\"\"Send item data to webhook endpoint with linked field resolution\"\"\"\r\n    try:\r\n        if not item_name:\r\n            frappe.response['message'] = {\r\n                'error': True,\r\n                'message': _('Item name is required')\r\n            }\r\n            return\r\n\r\n        # Get item document\r\n        try:\r\n            doc = frappe.get_doc('Item', item_name)\r\n        except frappe.DoesNotExistError:\r\n            frappe.response['message'] = {\r\n                'error': True,\r\n                'message': _('Item not found: {}').format(item_name)\r\n            }\r\n            return\r\n\r\n        # Convert doc to dictionary\r\n        item_data = doc.as_dict()\r\n\r\n        # Process linked fields - use working code approach\r\n        linked_fields_data = process_linked_fields(doc)\r\n\r\n        # Update item_data with linked fields like working code\r\n        for key, value in linked_fields_data.items():\r\n            item_data[key] = value\r\n\r\n        # Validate data before sending\r\n        if not item_data:\r\n            frappe.response['message'] = {\r\n                'error': True,\r\n                'message': _('Item data is empty')\r\n            }\r\n            return\r\n\r\n        # Send webhook\r\n        webhook_result = send_webhook_request(item_data)\r\n\r\n        frappe.response['message'] = {\r\n            'success': True,\r\n            'item_name': item_name,\r\n            'webhook_response': webhook_result,\r\n            'linked_fields': linked_fields_data,\r\n            'data_size': len(str(item_data))\r\n        }\r\n\r\n    except Exception as e:\r\n        error_str = str(e)\r\n        frappe.log_error(\"Error sending item webhook: \" + error_str, \"Item Webhook\")\r\n        frappe.response['message'] = {\r\n            'error': True,\r\n            'message': _('Error sending webhook: ') + error_str\r\n        }\r\n\r\ndef process_linked_fields(doc):\r\n    \"\"\"Process all linked fields and extract required codes\"\"\"\r\n    linked_data = {}\r\n    \r\n    try:\r\n        # 1. Item Type Code from ZRA Product Type\r\n        item_type_data = get_linked_code_fields(\r\n            doc.get(\"item_type_code\"), \r\n            \"ZRA Product Type\",\r\n            [\"code\", \"zra_code_class\", \"user_define_code\"]\r\n        )\r\n        linked_data[\"item_type_code\"] = item_type_data.get(\"code\")\r\n        linked_data[\"item_type_class\"] = item_type_data.get(\"zra_code_class\")\r\n        linked_data[\"item_type_user_define_code\"] = item_type_data.get(\"user_define_code\")\r\n\r\n        # 2. Origin Place Code from ZRA Country Code\r\n        origin_place_data = get_linked_code_fields(\r\n            doc.get(\"origin_place_code\"),\r\n            \"ZRA Country Code\",\r\n            [\"code\", \"zra_code_class\", \"user_define_code\"]\r\n        )\r\n        linked_data[\"origin_place_code\"] = origin_place_data.get(\"code\")\r\n        linked_data[\"origin_place_class\"] = origin_place_data.get(\"zra_code_class\")\r\n        linked_data[\"origin_place_user_define_code\"] = origin_place_data.get(\"user_define_code\")\r\n\r\n        # 3. Packaging Unit Code from ZRA Packaging Unit\r\n        packaging_unit_data = get_linked_code_fields(\r\n            doc.get(\"packaging_unit_code\"),\r\n            \"ZRA Packaging Unit\",\r\n            [\"code\", \"zra_code_class\", \"user_define_code\"]\r\n        )\r\n        linked_data[\"packaging_unit_code\"] = packaging_unit_data.get(\"code\")\r\n        linked_data[\"packaging_unit_class\"] = packaging_unit_data.get(\"zra_code_class\")\r\n        linked_data[\"packaging_unit_user_define_code\"] = packaging_unit_data.get(\"user_define_code\")\r\n\r\n        # 4. Quantity Unit Code from ZRA Unit of Measure\r\n        quantity_unit_data = get_linked_code_fields(\r\n            doc.get(\"quantity_unit_code\"),\r\n            \"ZRA Unit of Measure\",\r\n            [\"code\", \"zra_code_class\", \"user_define_code\"]\r\n        )\r\n        linked_data[\"quantity_unit_code\"] = quantity_unit_data.get(\"code\")\r\n\r\n        # 5. Tax Type from ZRA TAX Type\r\n        tax_type_data = get_linked_code_fields(\r\n            doc.get(\"tax_type\"),\r\n            \"ZRA TAX Type\",\r\n            [\"code\", \"zra_code_class\", \"user_define_code\"]\r\n        )\r\n        linked_data[\"tax_type\"] = tax_type_data.get(\"code\")\r\n\r\n        # 6. Item Class Code from ZRA UNSPSC Classification\r\n        item_class_data = get_linked_code_fields(\r\n            doc.get(\"item_classification_code\"),\r\n            \"ZRA UNSPSC Classification\",\r\n            [\"item_class_code\", \"item_class_name\"]\r\n        )\r\n        linked_data[\"item_classification_code\"] = item_class_data.get(\"item_class_code\")\r\n        linked_data[\"item_class_name\"] = item_class_data.get(\"item_class_name\")\r\n\r\n        return linked_data\r\n\r\n    except Exception as e:\r\n        frappe.log_error(\"Error processing linked fields: \" + str(e), \"Item Webhook\")\r\n        return {}\r\n\r\ndef get_linked_code_fields(linked_value, doctype_name, code_fields):\r\n    \"\"\"Retrieve linked field data from specified doctype\"\"\"\r\n    if not linked_value:\r\n        frappe.log_error(\"No linked value provided for \" + doctype_name)\r\n        return {}\r\n\r\n    try:\r\n        try:\r\n            linked_doc = frappe.get_doc(doctype_name, linked_value)\r\n        except frappe.DoesNotExistError:\r\n            # Try looking it up by another field if needed (e.g., code_name)\r\n            linked_doc = frappe.get_doc(doctype_name, {\"code_name\": linked_value})\r\n\r\n        # Extract the fields you need - use working code approach\r\n        result = {}\r\n        for field in code_fields:\r\n            if linked_doc.get(field) is not None:\r\n                result[field] = linked_doc.get(field)\r\n\r\n        return result\r\n\r\n    except Exception as e:\r\n        frappe.log_error(\"Error fetching linked \" + doctype_name + \" for '\" + str(linked_value) + \"': \" + str(e))\r\n        return {}\r\n\r\ndef send_webhook_request(item_data):\r\n    \"\"\"Send HTTP request to webhook endpoint\"\"\"\r\n    try:\r\n        # Use the same approach as working code - create JSON string manually\r\n        # Since we can't import json, create a simple JSON representation\r\n        def dict_to_json_str(data):\r\n            if not isinstance(data, dict):\r\n                return str(data)\r\n\r\n            json_parts = []\r\n            for key, value in data.items():\r\n                key_str = '\"' + str(key) + '\"'\r\n                if value is None:\r\n                    value_str = 'null'\r\n                elif isinstance(value, bool):\r\n                    value_str = 'true' if value else 'false'\r\n                elif isinstance(value, (int, float)):\r\n                    value_str = str(value)\r\n                else:\r\n                    # Escape quotes and newlines in string values\r\n                    escaped_value = str(value).replace('\"', '\\\\\"').replace('\\n', '\\\\n')\r\n                    value_str = '\"' + escaped_value + '\"'\r\n\r\n                json_parts.append(key_str + ':' + value_str)\r\n\r\n            return '{' + ','.join(json_parts) + '}'\r\n\r\n        payload = dict_to_json_str(item_data)\r\n\r\n        response = frappe.make_post_request(\r\n            url=WEBHOOK_CONFIG['production_url'],\r\n            data=payload,\r\n            headers={\"Content-Type\": \"application/json\"}\r\n        )\r\n\r\n        return {\r\n            'status': 'success',\r\n            'response': response,\r\n            'payload_size': len(payload)\r\n        }\r\n\r\n    except Exception as e:\r\n        error_str = str(e)\r\n        frappe.log_error(\"Webhook request failed: \" + error_str, \"Item Webhook\")\r\n        return {\r\n            'status': 'failed',\r\n            'error': error_str\r\n        }\r\n\r\n# Execute the webhook sending\r\nif frappe.request.method == \"POST\":\r\n    if item_name:\r\n        send_item_webhook(item_name)\r\n    else:\r\n        frappe.response['message'] = {\r\n            'error': True,\r\n            'message': _('Item name is required')\r\n        }\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-25 09:45:21.950736",
  "module": "ExN",
  "name": "Asset naming",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "updated_rows = []\nskipped_rows = []\n\n# Safely get the child table\nfor row in doc.get(\"items\", []):\n    try:\n        # Check if row is asset-related\n        is_asset_related = (\n            row.get(\"asset\")\n            or row.get(\"asset_category\")\n            or row.get(\"is_fixed_asset\")\n        )\n\n        if not is_asset_related:\n            continue\n\n        # If description exists, update item_name\n        if row.get(\"description\"):\n            row.item_name = row.description\n            updated_rows.append(str(row.idx or row.name))\n        else:\n            # Asset-related row but no description: warn only, don't block\n            skipped_rows.append(str(row.idx or row.name))\n\n    except Exception:\n        # Log but don't block saving the document\n        frappe.log_error(\n            frappe.get_traceback(),\n            \"Error updating item_name from description on asset line\"\n        )\n\n# Info message for successful updates\nif updated_rows:\n    frappe.msgprint(\n        \"Item Name was set from Description for asset-related rows: \"\n        + \", \".join(updated_rows),\n        alert=True,\n    )\n\n# Warning for rows we could not update (no description)\nif skipped_rows:\n    frappe.msgprint(\n        \"Warning: Item Name was not updated for asset-related rows without Description: \"\n        + \", \".join(skipped_rows),\n        title=\"Missing Description\",\n        indicator=\"orange\",\n        alert=True,\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "customer_exist",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 17:36:54.687385",
  "module": "ExN",
  "name": "customer_exist",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "# CBS Customer Exist or Create Script\r\n# Single customer lookup/create from CBS\r\n\r\nEMPLOYER_API = \"https://cbstest.workers.com.zm/api/v1/eworkers/employer/searchEmployer/\"\r\nPENSIONER_API = \"https://cbstest.workers.com.zm/api/v1/eworkers/employer/erp/pensioner/\"\r\n\r\n\r\ndef fetch_from_cbs(pas_number, is_pensioner):\r\n    url = (PENSIONER_API + str(pas_number)) if is_pensioner else (EMPLOYER_API + str(pas_number))\r\n    try:\r\n        response = frappe.make_get_request(url, headers={\"accept\": \"application/json\"})\r\n        if not isinstance(response, dict):\r\n            return {\"data\": None, \"error\": \"Invalid CBS response format\"}\r\n        return {\"data\": response, \"error\": None}\r\n    except Exception as e:\r\n        return {\"data\": None, \"error\": str(e)}\r\n\r\n\r\ndef create_customer_from_employer(data):\r\n    doc = frappe.new_doc(\"Customer\")\r\n    doc.customer_type = \"Employer\"\r\n    doc.customer_name = data.get(\"employerName\") or data.get(\"businessName\")\r\n    doc.custom_pas_number = data.get(\"employerNumber\")\r\n    doc.customer_tpin = data.get(\"tpin\") or \"\"\r\n    doc.custom_nrc_number = data.get(\"nrcPrcNumber\")\r\n    doc.territory = \"Zambia\"\r\n    doc.primary_address = data.get(\"addressLine1\")\r\n    doc.insert(ignore_permissions=True)\r\n    frappe.db.commit()\r\n    return doc.name\r\n\r\n\r\ndef create_customer_from_pensioner(data):\r\n    doc = frappe.new_doc(\"Customer\")\r\n    doc.customer_type = \"Pensioner\"\r\n    doc.customer_name = (data.get(\"firstName\") or \"\") + \" \" + (data.get(\"lastName\") or \"\")\r\n    doc.custom_pas_number = data.get(\"pensionerNumber\")\r\n    doc.custom_claim_number = data.get(\"claimNumber\")\r\n    doc.custom_claim_code = data.get(\"claimCode\")\r\n    doc.custom_nrc_number = data.get(\"nrcNumber\")\r\n    doc.gender = \"Male\" if data.get(\"sex\") == \"M\" else \"Female\"\r\n    doc.custom_date_of_birth = data.get(\"dateOfBirth\")\r\n    doc.custom_last_payment_date = data.get(\"lastPaymentDate\")\r\n    doc.custom_monthly_pension = data.get(\"monthlyPension\")\r\n    doc.territory = \"Zambia\"\r\n    doc.customer_tpin = \"\"\r\n    doc.insert(ignore_permissions=True)\r\n    frappe.db.commit()\r\n    return doc.name\r\n\r\n\r\ndef create_customer_minimal(pas_number, is_pensioner):\r\n    doc = frappe.new_doc(\"Customer\")\r\n    doc.customer_type = \"Pensioner\" if is_pensioner else \"Employer\"\r\n    doc.customer_name = str(pas_number)\r\n    doc.custom_pas_number = str(pas_number)\r\n    doc.territory = \"Zambia\"\r\n    doc.customer_tpin = \"\"\r\n    doc.insert(ignore_permissions=True)\r\n    frappe.db.commit()\r\n    return doc.name\r\n\r\n\r\ndef customer_exist_or_create():\r\n    employer = frappe.form_dict.get(\"employer\")\r\n    party = frappe.form_dict.get(\"party\")\r\n\r\n    employer = None if employer in (\"null\", \"\", None) else employer\r\n    party = None if party in (\"null\", \"\", None) else party\r\n\r\n    pas_number = party or employer\r\n    is_pensioner = True if party else False\r\n\r\n    if not pas_number:\r\n        return {\"success\": False, \"message\": \"Missing employer or party number\"}\r\n\r\n    # check if exists\r\n    existing = frappe.db.exists(\"Customer\", {\"custom_pas_number\": pas_number})\r\n    if existing:\r\n        customer_name = frappe.db.get_value(\"Customer\", existing, \"customer_name\")\r\n        return {\"success\": True, \"exists\": True, \"name\": existing, \"customer_name\": customer_name, \"searched_pas\": pas_number}\r\n\r\n    # fetch from CBS - no tuple unpacking\r\n    result = fetch_from_cbs(pas_number, is_pensioner)\r\n    data = result.get(\"data\")\r\n    error = result.get(\"error\")\r\n\r\n    # Check if CBS has valid data\r\n    has_cbs_data = False\r\n    if data:\r\n        if is_pensioner and data.get(\"pensionerCode\"):\r\n            has_cbs_data = True\r\n        elif not is_pensioner and data.get(\"employerCode\"):\r\n            has_cbs_data = True\r\n\r\n    # create\r\n    try:\r\n        if has_cbs_data:\r\n            # Create with full CBS data\r\n            if is_pensioner:\r\n                name = create_customer_from_pensioner(data)\r\n            else:\r\n                name = create_customer_from_employer(data)\r\n            customer_name = frappe.db.get_value(\"Customer\", name, \"customer_name\")\r\n            return {\"success\": True, \"created\": True, \"source\": \"cbs\", \"name\": name, \"customer_name\": customer_name}\r\n        else:\r\n            # Create customer with pas_number as name - will be updated later via customer_sync\r\n            name = create_customer_minimal(pas_number, is_pensioner)\r\n            return {\"success\": True, \"created\": True, \"source\": \"manual\", \"name\": name, \"customer_name\": pas_number}\r\n    except Exception as e:\r\n        frappe.log_error(str(e)[:500], \"Customer Create Failed\")\r\n        return {\"success\": False, \"message\": \"Failed to create customer\", \"error\": str(e)[:200]}\r\n\r\n\r\nfrappe.response[\"message\"] = customer_exist_or_create()\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "cbs_sync",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 10:35:18.679709",
  "module": null,
  "name": "cbs_sync",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def sync_pensioner():\r\n    data = frappe.form_dict\r\n\r\n    pas = data.get(\"custom_pas_number\")\r\n    if not pas:\r\n        return {\"status\": \"error\", \"message\": \"Missing custom_pas_number\"}\r\n\r\n    existing = frappe.get_all(\r\n        \"Customer\",\r\n        filters={\"custom_pas_number\": pas},\r\n        limit=1\r\n    )\r\n\r\n    payload = {\r\n        \"customer_name\": data.get(\"customer_name\"),\r\n        \"customer_type\": \"Individual\",\r\n        \"custom_pas_number\": pas,\r\n        \"custom_employer_number\": data.get(\"custom_employer_number\"),\r\n        \"gender\": data.get(\"gender\"),\r\n        \"date_of_birth\": data.get(\"date_of_birth\"),\r\n        \"custom_pension_enabled1\": data.get(\"custom_pension_enabled1\"),\r\n        \"custom_marital_status1\": data.get(\"custom_marital_status1\"),\r\n        \"custom_monthly_pension\": data.get(\"custom_monthly_pension\"),\r\n        \"custom_last_payment_date\": data.get(\"custom_last_payment_date\"),\r\n        \"custom_pension_commencment_date\": data.get(\"custom_pension_commencment_date\"),\r\n        \"custom_claim_number\": data.get(\"custom_claim_number\"),\r\n        \"custom_claim_code\": data.get(\"custom_claim_code\"),\r\n        \"custom_user_branch_code\": data.get(\"custom_user_branch_code\"),\r\n    }\r\n\r\n    if not existing:\r\n        doc = frappe.new_doc(\"Customer\")\r\n        for k, v in payload.items():\r\n            doc.set(k, v)\r\n        doc.insert(ignore_permissions=True)\r\n        frappe.db.commit()\r\n        return {\"status\": \"created\", \"name\": doc.name}\r\n\r\n    name = existing[0].name\r\n    doc = frappe.get_doc(\"Customer\", name)\r\n\r\n    changed = False\r\n    for k, v in payload.items():\r\n        if str(doc.get(k)) != str(v):\r\n            doc.set(k, v)\r\n            changed = True\r\n\r\n    if not changed:\r\n        return {\"status\": \"skipped\", \"name\": name}\r\n\r\n    doc.save(ignore_permissions=True)\r\n    frappe.db.commit()\r\n    return {\"status\": \"updated\", \"name\": name}",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "pensioner_sync",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 14:35:43.607719",
  "module": null,
  "name": "cbs_pas_sync",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# CBS Customer Sync Script\r\n# Receives employer and pensioner data from CBS and creates/updates customers in ERPNext\r\n\r\nPENSIONER_LIST_API = \"https://cbstest.workers.com.zm/api/v1/eworkers/employer/erp/pensioner\"\r\nEMPLOYER_LIST_API = \"https://cbstest.workers.com.zm/api/v1/eworkers/employer\"\r\n\r\n\r\ndef get_employer_fields(data):\r\n    \"\"\"Map employer CBS data to Customer doctype fields\"\"\"\r\n    # NRC is NOT unique - multiple companies can have same owner\r\n    # Don't set it if it would cause duplicates\r\n    return {\r\n        \"customer_type\": \"Employer\",\r\n        \"customer_name\": data.get(\"employerName\") or data.get(\"businessName\"),\r\n        \"custom_pas_number\": data.get(\"employerNumber\"),\r\n        \"custom_nrc_number\": None,  # Skip NRC - not unique across employers\r\n        \"customer_tpin\": data.get(\"zraNumber\") or \"\",\r\n        \"territory\": \"Zambia\",\r\n    }\r\n\r\n\r\ndef get_pensioner_fields(data):\r\n    \"\"\"Map pensioner CBS data to Customer doctype fields\"\"\"\r\n    first_name = data.get(\"firstName\") or \"\"\r\n    last_name = data.get(\"lastName\") or \"\"\r\n    return {\r\n        \"customer_type\": \"Pensioner\",\r\n        \"customer_name\": f\"{first_name} {last_name}\".strip(),\r\n        \"custom_pas_number\": data.get(\"pensionerCode\"),\r\n        \"custom_claim_number\": data.get(\"claimNumber\"),\r\n        \"custom_claim_code\": data.get(\"claimCode\"),\r\n        \"custom_nrc_number\": data.get(\"nrcNumber\"),\r\n        \"gender\": \"Male\" if data.get(\"sex\") == \"M\" else \"Female\",\r\n        \"custom_date_of_birth\": data.get(\"dateOfBirth\", \"\")[:10] if data.get(\"dateOfBirth\") else None,\r\n        \"custom_pension_commencment_date\": data.get(\"pensionCommencementDate\", \"\")[:10] if data.get(\"pensionCommencementDate\") else None,\r\n        \"custom_last_payment_date\": data.get(\"lastPaymentDate\", \"\")[:10] if data.get(\"lastPaymentDate\") else None,\r\n        \"custom_monthly_pension\": str(data.get(\"monthlyPension\")) if data.get(\"monthlyPension\") else None,\r\n        \"custom_user_branch_code\": data.get(\"userBranchCode\"),\r\n        \"custom_marital_status1\": 1 if data.get(\"maritalStatus\") == \"1\" else 0,\r\n        \"custom_pension_enabled1\": 1 if data.get(\"enabledFlag\") == \"1\" else 0,\r\n        \"customer_tpin\": \"\",\r\n        \"territory\": \"Zambia\",\r\n    }\r\n\r\n\r\ndef has_changes(existing_doc, new_fields):\r\n    \"\"\"Check if any field values differ between existing doc and new data\"\"\"\r\n    for field, new_value in new_fields.items():\r\n        if new_value is None:\r\n            continue\r\n        existing_value = existing_doc.get(field)\r\n        # Normalize comparison\r\n        if str(existing_value or \"\") != str(new_value or \"\"):\r\n            return True\r\n    return False\r\n\r\n\r\ndef create_customer(fields):\r\n    \"\"\"Create new customer from field mapping\"\"\"\r\n    doc = frappe.new_doc(\"Customer\")\r\n    for field, value in fields.items():\r\n        if value is not None:\r\n            doc.set(field, value)\r\n    doc.insert(ignore_permissions=True)\r\n    return doc.name\r\n\r\n\r\ndef update_customer(name, fields):\r\n    \"\"\"Update existing customer with new field values\"\"\"\r\n    doc = frappe.get_doc(\"Customer\", name)\r\n    for field, value in fields.items():\r\n        if value is not None:\r\n            doc.set(field, value)\r\n    doc.save(ignore_permissions=True)\r\n    return doc.name\r\n\r\n\r\ndef detect_record_type(data):\r\n    \"\"\"Auto-detect if record is pensioner or employer based on fields\"\"\"\r\n    if data.get(\"pensionerCode\") or data.get(\"pensionerNumber\"):\r\n        return \"pensioner\"\r\n    if data.get(\"employerCode\") or data.get(\"employerNumber\"):\r\n        return \"employer\"\r\n    return None\r\n\r\n\r\ndef process_record(data):\r\n    \"\"\"Process a single employer or pensioner record\"\"\"\r\n    record_type = detect_record_type(data)\r\n    if not record_type:\r\n        return {\"status\": \"skipped\", \"reason\": \"unknown_record_type\"}\r\n\r\n    is_pensioner = record_type == \"pensioner\"\r\n    fields = get_pensioner_fields(data) if is_pensioner else get_employer_fields(data)\r\n    pas_number = fields.get(\"custom_pas_number\")\r\n\r\n    if not pas_number:\r\n        return {\"status\": \"skipped\", \"reason\": \"missing_pas_number\"}\r\n\r\n    # Check if customer exists\r\n    existing = frappe.db.exists(\"Customer\", {\"custom_pas_number\": pas_number})\r\n\r\n    if existing:\r\n        existing_doc = frappe.get_doc(\"Customer\", existing)\r\n        if has_changes(existing_doc, fields):\r\n            update_customer(existing, fields)\r\n            return {\"status\": \"updated\", \"name\": existing, \"type\": record_type}\r\n        return {\"status\": \"skipped\", \"reason\": \"no_changes\", \"name\": existing, \"type\": record_type}\r\n\r\n    # Create new customer\r\n    name = create_customer(fields)\r\n    return {\"status\": \"created\", \"name\": name, \"type\": record_type}\r\n\r\n\r\ndef sync_from_cbs():\r\n    \"\"\"Main sync function - receives data and processes employer/pensioner records\"\"\"\r\n    data = frappe.form_dict.get(\"data\")\r\n\r\n    if not data:\r\n        return {\"success\": False, \"message\": \"No data provided\"}\r\n\r\n    # Parse JSON string if needed\r\n    if isinstance(data, str):\r\n        try:\r\n            data = json.loads(data)\r\n        except json.JSONDecodeError:\r\n            return {\"success\": False, \"message\": \"Invalid JSON data\"}\r\n\r\n    # Handle single record or list\r\n    records = data if isinstance(data, list) else [data]\r\n\r\n    results = {\"created\": 0, \"updated\": 0, \"skipped\": 0, \"errors\": [], \"details\": []}\r\n\r\n    for record in records:\r\n        try:\r\n            result = process_record(record)\r\n            results[result[\"status\"]] = results.get(result[\"status\"], 0) + 1\r\n            results[\"details\"].append(result)\r\n        except Exception as e:\r\n            pas = record.get(\"employerNumber\") or record.get(\"pensionerCode\") or \"unknown\"\r\n            err_msg = str(e).split('\\n')[0][:500]  # First line only\r\n            frappe.log_error(err_msg, f\"Sync: {pas}\")\r\n            results[\"errors\"].append({\"pas_number\": pas, \"error\": err_msg[:100]})\r\n    \r\n    frappe.db.commit()\r\n    \r\n    return {\r\n        \"success\": True,\r\n        \"created\": results[\"created\"],\r\n        \"updated\": results[\"updated\"],\r\n        \"skipped\": results[\"skipped\"],\r\n        \"errors\": len(results[\"errors\"]),\r\n        \"details\": results[\"details\"]\r\n    }\r\n\r\n\r\nfrappe.response[\"message\"] = sync_from_cbs()\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 22:20:33.654426",
  "module": null,
  "name": "Master Procurement Plan On Submit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Master Procurement Plan",
  "script": "\nif not doc.items:\n    frappe.throw(\"Please consolidate budget items before submitting\")\ndoc.db_set(\"plan_status\", \"Consolidated\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 22:43:00.252280",
  "module": null,
  "name": "Master Procurement Plan Validate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Master Procurement Plan",
  "script": "\ntotal_items = len(doc.items) if doc.items else 0\ntotal_value = 0\nselected_count = 0\nselected_value = 0\n\nif doc.items:\n    for item in doc.items:\n        val = frappe.utils.flt(item.total_estimated_value)\n        total_value = total_value + val\n        if item.is_selected:\n            selected_count = selected_count + 1\n            selected_value = selected_value + val\n\ndoc.total_items = total_items\ndoc.total_estimated_value = total_value\ndoc.selected_items_count = selected_count\ndoc.selected_items_value = selected_value\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "pp_create_po_or_contract",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-27 06:27:47.544777",
  "module": null,
  "name": "Procurement Plan Create PO Contract",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ndoc_name = frappe.form_dict.get(\"doc_name\")\ndoc_type = frappe.form_dict.get(\"doc_type\")\nsupplier = frappe.form_dict.get(\"supplier\")\nwarehouse = frappe.form_dict.get(\"warehouse\")\nschedule_date = frappe.form_dict.get(\"schedule_date\")\ncontract_template = frappe.form_dict.get(\"contract_template\")\nstart_date = frappe.form_dict.get(\"start_date\")\nend_date = frappe.form_dict.get(\"end_date\")\n\nif not doc_name:\n    frappe.throw(\"Document name is required\")\nif not doc_type:\n    frappe.throw(\"Please select Purchase Order or Contract\")\nif not supplier:\n    frappe.throw(\"Please select a Supplier\")\n\ndoc = frappe.get_doc(\"Procurement Plan\", doc_name)\n\nif not doc.items or len(doc.items) == 0:\n    frappe.throw(\"No items found in Procurement Plan\")\n\n# Calculate total\ntotal_value = frappe.utils.flt(doc.total_value)\nif not total_value:\n    for item in doc.items:\n        total_value = total_value + frappe.utils.flt(item.quantity)\n\n# Map procurement category\nproc_category = \"Goods\"\nif doc.procurement_type == \"Services\":\n    proc_category = \"Consulting\"\nelif doc.procurement_type == \"Goods\":\n    proc_category = \"Goods\"\n\nproc_method = doc.procurement_method or \"\"\n\n# Get company from database\ncompany = frappe.db.get_default(\"Company\") or frappe.db.get_single_value(\"Global Defaults\", \"default_company\")\n\n# Get today from database\ntoday_result = frappe.db.sql(\"SELECT CURDATE()\", as_list=True)\ntoday = str(today_result[0][0]) if today_result else \"2025-01-01\"\n\nif not schedule_date:\n    schedule_date = today\n\nif doc_type == \"Purchase Order\":\n    po = frappe.new_doc(\"Purchase Order\")\n    \n    po.supplier = supplier\n    po.company = company\n    po.transaction_date = today\n    po.schedule_date = schedule_date\n    po.custom_procurement_category = proc_category\n    po.custom_procurement_method = proc_method\n    \n    if warehouse:\n        po.set_warehouse = warehouse\n    \n    for item in doc.items:\n        # Get valid UOM - default to Nos\n        item_uom = item.unit or \"Nos\"\n        if not frappe.db.exists(\"UOM\", item_uom):\n            item_uom = \"Nos\"\n        \n        po_item = po.append(\"items\", {})\n        po_item.item_name = item.description or \"Procurement Item\"\n        po_item.description = item.description or \"\"\n        po_item.qty = frappe.utils.flt(item.quantity) or 1\n        po_item.uom = item_uom\n        po_item.stock_uom = item_uom\n        po_item.conversion_factor = 1\n        po_item.rate = 0\n        po_item.schedule_date = schedule_date\n        if warehouse:\n            po_item.warehouse = warehouse\n    \n    po.insert()\n    \n    frappe.msgprint(\"Purchase Order \" + po.name + \" created successfully\")\n    frappe.response[\"message\"] = {\"status\": \"success\", \"doctype\": \"Purchase Order\", \"name\": po.name}\n\nelif doc_type == \"Contract\":\n    contract = frappe.new_doc(\"Contract\")\n    \n    contract_name = doc.name + \"-Contract\"\n    counter = 1\n    while frappe.db.exists(\"Contract\", contract_name):\n        contract_name = doc.name + \"-Contract-\" + str(counter)\n        counter = counter + 1\n    contract.name = contract_name\n    \n    contract.party_type = \"Supplier\"\n    contract.party_name = supplier\n    contract.start_date = start_date or today\n    contract.end_date = end_date or \"\"\n    contract.status = \"Unsigned\"\n    \n    if contract_template:\n        contract.contract_template = contract_template\n        template = frappe.get_doc(\"Contract Template\", contract_template)\n        if template.contract_terms:\n            contract.contract_terms = template.contract_terms\n    \n    if not contract.contract_terms:\n        terms = \"<h3>Procurement Items</h3>\"\n        terms = terms + \"<table border='1' cellpadding='5' cellspacing='0' style='border-collapse: collapse; width: 100%;'>\"\n        terms = terms + \"<tr><th>Description</th><th>Quantity</th><th>Unit</th></tr>\"\n        for item in doc.items:\n            desc = item.description or \"\"\n            qty = str(frappe.utils.flt(item.quantity) or 1)\n            unit = item.unit or \"Nos\"\n            terms = terms + \"<tr><td>\" + desc + \"</td><td>\" + qty + \"</td><td>\" + unit + \"</td></tr>\"\n        terms = terms + \"</table>\"\n        terms = terms + \"<p><strong>Total Estimated Value:</strong> \" + str(total_value) + \"</p>\"\n        terms = terms + \"<p><strong>Procurement Method:</strong> \" + proc_method + \"</p>\"\n        terms = terms + \"<p><strong>Reference:</strong> \" + doc.name + \"</p>\"\n        contract.contract_terms = terms\n    \n    contract.insert()\n    \n    frappe.msgprint(\"Contract \" + contract.name + \" created successfully\")\n    frappe.response[\"message\"] = {\"status\": \"success\", \"doctype\": \"Contract\", \"name\": contract.name}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 11:55:28.642783",
  "module": null,
  "name": "Budget Consolidation Before Save",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Budget Consolidation",
  "script": "\n# Only run if status is Draft\nif doc.docstatus == 0:\n    \n    fiscal_year = doc.fiscal_year\n    prev_fiscal_year = doc.previous_fiscal_year\n    \n    if not fiscal_year:\n        frappe.throw(\"Fiscal Year is required\")\n    \n    # Auto-detect previous fiscal year if not set\n    if not prev_fiscal_year:\n        fy_doc = frappe.get_doc(\"Fiscal Year\", fiscal_year)\n        fy_start = fy_doc.year_start_date\n        if fy_start:\n            prev_year_num = fy_start.year - 1\n            prev_fy_list = frappe.get_all(\"Fiscal Year\", \n                filters={\"year_start_date\": [\"like\", str(prev_year_num) + \"%\"]},\n                limit=1\n            )\n            if prev_fy_list:\n                prev_fiscal_year = prev_fy_list[0].name\n                doc.previous_fiscal_year = prev_fiscal_year\n    \n    # Track existing values for change detection\n    existing_summary = {}\n    existing_detail = {}\n    existing_budgets = {}\n    \n    for row in (doc.summary_items or []):\n        key = row.budget_type\n        if key:\n            existing_summary[key] = row.current_year_amount or 0\n    \n    for row in (doc.detail_items or []):\n        key = row.expense_account\n        if key:\n            existing_detail[key] = row.budget_curr or 0\n    \n    for row in (doc.budget_items or []):\n        key = row.budget\n        if key:\n            existing_budgets[key] = row.budget_amount or 0\n    \n    is_refresh = len(existing_summary) > 0\n    \n    # Clear child tables\n    doc.summary_items = []\n    doc.detail_items = []\n    doc.budget_items = []\n    \n    # ========== SUMMARY TAB ==========\n    summary_sql = \"\"\"\n        SELECT \n            COALESCE(b.budget_type, 'Unspecified') as budget_type,\n            COUNT(*) as budget_count,\n            SUM(CASE WHEN b.docstatus = 0 THEN 1 ELSE 0 END) as draft_count,\n            SUM(CASE WHEN b.docstatus = 1 THEN 1 ELSE 0 END) as submitted_count,\n            SUM(COALESCE(ba.budget_amount, 0)) as current_year_amount\n        FROM `tabBudget` b\n        LEFT JOIN `tabBudget Account` ba ON ba.parent = b.name\n        WHERE b.fiscal_year = %s AND b.docstatus < 2\n        GROUP BY COALESCE(b.budget_type, 'Unspecified')\n        ORDER BY budget_type\n    \"\"\"\n    summary_data = frappe.db.sql(summary_sql, (fiscal_year,), as_dict=1)\n    \n    # Previous year summary\n    prev_summary = {}\n    if prev_fiscal_year:\n        prev_sql = \"\"\"\n            SELECT \n                COALESCE(b.budget_type, 'Unspecified') as budget_type,\n                SUM(COALESCE(ba.budget_amount, 0)) as prev_amount\n            FROM `tabBudget` b\n            LEFT JOIN `tabBudget Account` ba ON ba.parent = b.name\n            WHERE b.fiscal_year = %s AND b.docstatus < 2\n            GROUP BY COALESCE(b.budget_type, 'Unspecified')\n        \"\"\"\n        for row in frappe.db.sql(prev_sql, (prev_fiscal_year,), as_dict=1):\n            prev_summary[row.budget_type] = row.prev_amount or 0\n    \n    total_income = 0\n    total_expenses = 0\n    \n    for row in summary_data:\n        budget_type = row.budget_type\n        curr_amt = row.current_year_amount or 0\n        prev_amt = prev_summary.get(budget_type, 0)\n        delta = curr_amt - prev_amt\n        delta_pct = 0\n        if prev_amt:\n            delta_pct = (delta / prev_amt) * 100\n        \n        has_changed = 0\n        change_details = \"\"\n        if budget_type in existing_summary:\n            old_amt = existing_summary[budget_type]\n            if abs(curr_amt - old_amt) > 0.01:\n                has_changed = 1\n                change_details = \"Changed from \" + str(old_amt) + \" to \" + str(curr_amt)\n        \n        doc.append(\"summary_items\", {\n            \"budget_type\": budget_type,\n            \"budget_count\": row.budget_count or 0,\n            \"draft_count\": row.draft_count or 0,\n            \"submitted_count\": row.submitted_count or 0,\n            \"previous_year_amount\": prev_amt,\n            \"current_year_amount\": curr_amt,\n            \"delta_amount\": delta,\n            \"delta_percent\": delta_pct,\n            \"has_changed\": has_changed,\n            \"change_details\": change_details\n        })\n        \n        if budget_type == \"Forecast\":\n            total_income = total_income + curr_amt\n        else:\n            total_expenses = total_expenses + curr_amt\n    \n    # ========== DETAIL TAB ==========\n    detail_sql = \"\"\"\n        SELECT \n            ba.account as expense_account,\n            a.parent_account,\n            a.account_name,\n            SUM(COALESCE(ba.budget_amount, 0)) as budget_curr\n        FROM `tabBudget` b\n        JOIN `tabBudget Account` ba ON ba.parent = b.name\n        LEFT JOIN `tabAccount` a ON a.name = ba.account\n        WHERE b.fiscal_year = %s AND b.docstatus < 2\n        GROUP BY ba.account, a.parent_account, a.account_name\n        ORDER BY ba.account\n    \"\"\"\n    detail_data = frappe.db.sql(detail_sql, (fiscal_year,), as_dict=1)\n    \n    # Previous year detail\n    prev_detail = {}\n    if prev_fiscal_year:\n        prev_detail_sql = \"\"\"\n            SELECT ba.account, SUM(COALESCE(ba.budget_amount, 0)) as prev_amt\n            FROM `tabBudget` b\n            JOIN `tabBudget Account` ba ON ba.parent = b.name\n            WHERE b.fiscal_year = %s AND b.docstatus < 2\n            GROUP BY ba.account\n        \"\"\"\n        for row in frappe.db.sql(prev_detail_sql, (prev_fiscal_year,), as_dict=1):\n            prev_detail[row.account] = row.prev_amt or 0\n    \n    for row in detail_data:\n        acct = row.expense_account\n        curr_amt = row.budget_curr or 0\n        prev_amt = prev_detail.get(acct, 0)\n        delta = curr_amt - prev_amt\n        delta_pct = 0\n        if prev_amt:\n            delta_pct = (delta / prev_amt) * 100\n        \n        has_changed = 0\n        change_details = \"\"\n        if acct in existing_detail:\n            old_amt = existing_detail[acct]\n            if abs(curr_amt - old_amt) > 0.01:\n                has_changed = 1\n                change_details = \"Changed from \" + str(old_amt) + \" to \" + str(curr_amt)\n        \n        doc.append(\"detail_items\", {\n            \"expense_account\": acct,\n            \"parent_account\": row.parent_account,\n            \"account_name\": row.account_name,\n            \"budget_prev\": prev_amt,\n            \"budget_curr\": curr_amt,\n            \"delta_budget\": delta,\n            \"delta_budget_percent\": delta_pct,\n            \"available_budget\": curr_amt,\n            \"has_changed\": has_changed,\n            \"change_details\": change_details\n        })\n    \n    # ========== BUDGETS TAB ==========\n    budgets_sql = \"\"\"\n        SELECT \n            b.name as budget,\n            b.budget_type,\n            b.budget_against,\n            b.cost_center,\n            b.project,\n            b.docstatus,\n            b.owner as creator,\n            SUM(COALESCE(ba.budget_amount, 0)) as budget_amount\n        FROM `tabBudget` b\n        LEFT JOIN `tabBudget Account` ba ON ba.parent = b.name\n        WHERE b.fiscal_year = %s AND b.docstatus < 2\n        GROUP BY b.name, b.budget_type, b.budget_against, b.cost_center, b.project, b.docstatus, b.owner\n        ORDER BY b.budget_type, b.name\n    \"\"\"\n    budgets_data = frappe.db.sql(budgets_sql, (fiscal_year,), as_dict=1)\n    \n    for row in budgets_data:\n        budget_name = row.budget\n        curr_amt = row.budget_amount or 0\n        \n        against_value = \"\"\n        budget_against = row.budget_against or \"\"\n        if budget_against == \"Cost Center\":\n            against_value = row.cost_center or \"\"\n        elif budget_against == \"Project\":\n            against_value = row.project or \"\"\n        \n        status_text = \"Unknown\"\n        if row.docstatus == 0:\n            status_text = \"Draft\"\n        elif row.docstatus == 1:\n            status_text = \"Submitted\"\n        elif row.docstatus == 2:\n            status_text = \"Cancelled\"\n        \n        has_changed = 0\n        change_details = \"\"\n        prev_amount = 0\n        if budget_name in existing_budgets:\n            old_amt = existing_budgets[budget_name]\n            prev_amount = old_amt\n            if abs(curr_amt - old_amt) > 0.01:\n                has_changed = 1\n                change_details = \"Changed from \" + str(old_amt) + \" to \" + str(curr_amt)\n        \n        doc.append(\"budget_items\", {\n            \"budget\": budget_name,\n            \"budget_type\": row.budget_type,\n            \"budget_against\": budget_against,\n            \"budget_against_value\": against_value,\n            \"budget_amount\": curr_amt,\n            \"budget_status\": status_text,\n            \"creator\": row.creator,\n            \"previous_amount\": prev_amount,\n            \"has_changed\": has_changed,\n            \"change_details\": change_details\n        })\n    \n    # ========== TOTALS ==========\n    doc.total_income = total_income\n    doc.total_expenses = total_expenses\n    doc.surplus_deficit = total_income - total_expenses\n    \n    # Previous year totals\n    if prev_fiscal_year:\n        prev_totals_sql = \"\"\"\n            SELECT \n                b.budget_type,\n                SUM(COALESCE(ba.budget_amount, 0)) as amt\n            FROM `tabBudget` b\n            LEFT JOIN `tabBudget Account` ba ON ba.parent = b.name\n            WHERE b.fiscal_year = %s AND b.docstatus < 2\n            GROUP BY b.budget_type\n        \"\"\"\n        prev_income = 0\n        prev_expense = 0\n        for row in frappe.db.sql(prev_totals_sql, (prev_fiscal_year,), as_dict=1):\n            if row.budget_type == \"Forecast\":\n                prev_income = row.amt or 0\n            else:\n                prev_expense = prev_expense + (row.amt or 0)\n        doc.prev_surplus_deficit = prev_income - prev_expense\n    \n    # ========== HISTORY ==========\n    action_type = \"Refresh\" if is_refresh else \"Initial Load\"\n    changed_count = 0\n    for r in (doc.summary_items or []):\n        if r.has_changed:\n            changed_count = changed_count + 1\n    for r in (doc.detail_items or []):\n        if r.has_changed:\n            changed_count = changed_count + 1\n    for r in (doc.budget_items or []):\n        if r.has_changed:\n            changed_count = changed_count + 1\n    \n    budget_count = len(doc.budget_items or [])\n    summary_text = \"Loaded \" + str(budget_count) + \" budgets\"\n    if changed_count > 0:\n        summary_text = summary_text + \", \" + str(changed_count) + \" items changed\"\n    \n    doc.append(\"history_items\", {\n        \"timestamp\": frappe.utils.now(),\n        \"action_type\": action_type,\n        \"performed_by\": frappe.session.user,\n        \"summary\": summary_text,\n        \"budgets_affected\": budget_count\n    })\n    \n    doc.consolidated_on = frappe.utils.now()\n    doc.consolidated_by = frappe.session.user\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 11:55:37.825058",
  "module": null,
  "name": "Budget Consolidation After Submit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Budget Consolidation",
  "script": "\nfiscal_year = doc.fiscal_year\nsubmitted_count = 0\nerror_count = 0\nnow = frappe.utils.now()\n\n# Get all draft budgets for this fiscal year\ndraft_budgets = frappe.get_all(\"Budget\",\n    filters={\"fiscal_year\": fiscal_year, \"docstatus\": 0},\n    fields=[\"name\"]\n)\n\nfor b in draft_budgets:\n    budget_name = b.name\n    try:\n        budget_doc = frappe.get_doc(\"Budget\", budget_name)\n        budget_doc.submit()\n        submitted_count = submitted_count + 1\n    except Exception as e:\n        error_count = error_count + 1\n        frappe.log_error(str(e), \"Budget Consolidation Submit Error: \" + str(budget_name))\n\nsummary = \"Submitted \" + str(submitted_count) + \" draft budgets for \" + str(fiscal_year)\nif error_count > 0:\n    summary = summary + \". Errors: \" + str(error_count)\n\n# Add history entry\ndoc.append(\"history_items\", {\n    \"timestamp\": now,\n    \"action_type\": \"Budget Submitted\",\n    \"performed_by\": frappe.session.user,\n    \"summary\": summary,\n    \"budgets_affected\": submitted_count\n})\n\ndoc.status = \"Approved\"\ndoc.save(ignore_permissions=True)\n\nif error_count > 0:\n    frappe.msgprint(\"Submitted \" + str(submitted_count) + \" budgets. Errors: \" + str(error_count) + \" (check Error Log)\")\nelse:\n    frappe.msgprint(\"Successfully submitted all \" + str(submitted_count) + \" draft budgets\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "mpp_get_suggested_method",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 23:54:29.304390",
  "module": null,
  "name": "Master Procurement Plan Get Method",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ncat = frappe.form_dict.get(\"procurement_category\")\nval = frappe.utils.flt(frappe.form_dict.get(\"value\", 0))\nresult = \"\"\nif cat and val:\n    thresholds = frappe.get_all(\"Procurement Method Threshold\", filters={\"procurement_category\": cat, \"is_enabled\": 1, \"require_appropriate_circumstances\": 0}, fields=[\"procurement_method\", \"min_amount\", \"max_amount\", \"allow_equal_at_min\", \"allow_equal_at_max\", \"priority\"], order_by=\"priority asc\")\n    for t in thresholds:\n        min_ok = True\n        max_ok = True\n        if t.min_amount:\n            if t.allow_equal_at_min:\n                min_ok = val >= frappe.utils.flt(t.min_amount)\n            else:\n                min_ok = val > frappe.utils.flt(t.min_amount)\n        if t.max_amount:\n            if t.allow_equal_at_max:\n                max_ok = val <= frappe.utils.flt(t.max_amount)\n            else:\n                max_ok = val < frappe.utils.flt(t.max_amount)\n        if min_ok and max_ok:\n            result = t.procurement_method\n            break\nfrappe.response[\"message\"] = result\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "mpp_create_po_or_contract",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 23:54:29.311801",
  "module": null,
  "name": "Master Procurement Plan Create PO Contract",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ndoc_name = frappe.form_dict.get(\"doc_name\")\ndoc_type = frappe.form_dict.get(\"doc_type\")\nsupplier = frappe.form_dict.get(\"supplier\")\nwarehouse = frappe.form_dict.get(\"warehouse\")\nschedule_date = frappe.form_dict.get(\"schedule_date\")\ncontract_template = frappe.form_dict.get(\"contract_template\")\nstart_date = frappe.form_dict.get(\"start_date\")\nend_date = frappe.form_dict.get(\"end_date\")\n\nif not doc_name:\n    frappe.throw(\"Document name is required\")\nif not doc_type:\n    frappe.throw(\"Document type is required\")\n\ndoc = frappe.get_doc(\"Master Procurement Plan\", doc_name)\n\nselected = []\nfor item in doc.items:\n    if item.is_selected and item.item_status == \"Procurement Created\" and not item.purchase_order and not item.contract:\n        selected.append(item)\n\nif not selected:\n    frappe.throw(\"Please select items with Procurement Plans that do not have PO/Contract yet\")\n\ncreated_docs = []\n\nif doc_type == \"Purchase Order\":\n    if not supplier:\n        frappe.throw(\"Supplier is required for Purchase Order\")\n    \n    po = frappe.new_doc(\"Purchase Order\")\n    po.supplier = supplier\n    po.schedule_date = schedule_date or frappe.utils.nowdate()\n    po.set_warehouse = warehouse\n    \n    for item in selected:\n        po.append(\"items\", {\n            \"item_code\": \"\",\n            \"item_name\": item.description or \"Procurement Item\",\n            \"description\": item.description,\n            \"qty\": item.total_quantity or 1,\n            \"rate\": item.average_unit_price or 0,\n            \"uom\": \"Nos\",\n            \"warehouse\": warehouse\n        })\n    \n    po.insert()\n    created_docs.append(po.name)\n    \n    for item in selected:\n        item.purchase_order = po.name\n        item.item_status = \"Purchase Order Created\"\n\nelif doc_type == \"Contract\":\n    if not supplier:\n        frappe.throw(\"Party is required for Contract\")\n    \n    contract = frappe.new_doc(\"Contract\")\n    contract.party_type = \"Supplier\"\n    contract.party_name = supplier\n    contract.start_date = start_date or frappe.utils.nowdate()\n    contract.end_date = end_date\n    contract.contract_template = contract_template\n    \n    total_val = 0\n    desc_parts = []\n    for item in selected:\n        total_val = total_val + frappe.utils.flt(item.total_estimated_value)\n        if item.description:\n            desc_parts.append(item.description)\n    \n    contract.contract_value = total_val\n    contract.contract_terms = \"; \".join(desc_parts)\n    \n    contract.insert()\n    created_docs.append(contract.name)\n    \n    for item in selected:\n        item.contract = contract.name\n        item.item_status = \"Contract Created\"\n\ndoc.purchase_orders_created = len([i for i in doc.items if i.purchase_order])\ndoc.save()\n\nfrappe.msgprint(\"Created \" + str(len(created_docs)) + \" \" + doc_type + \"(s)\")\nfrappe.response[\"message\"] = {\"status\": \"success\", \"documents\": created_docs}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-09 20:10:13.089948",
  "module": "ExN",
  "name": "Auto approve Depreciation Journal",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Journal Entry",
  "script": "# Auto-submit Journal Entries where Entry Type = \"Depreciation Entry\"\n# ERPNext 15 / Frappe 15 - Server Script (DocType Event) on Journal Entry\n# Constraints: no imports, no .format(), no frappe.get_traceback\n\nif doc.get(\"docstatus\") == 0 and doc.get(\"voucher_type\") == \"Depreciation Entry\":\n\n    # Try to ignore permissions (not strictly required, but useful)\n    try:\n        doc.flags.ignore_permissions = True\n    except Exception:\n        pass\n\n    try:\n        # Submit (auto-approve) this journal entry\n        doc.submit()\n\n        # Optional: notify the user\n        frappe.msgprint(\n            \"Journal Entry \" + doc.get(\"name\") +\n            \" was automatically submitted because Entry Type is 'Depreciation Entry'.\",\n            alert=True,\n        )\n\n    except Exception as e:\n        # Simple logging only  no get_traceback, no .format()\n        message = (\n            \"Auto-submit failed for Depreciation Entry Journal Entry \"\n            + doc.get(\"name\")\n            + \" Error: \"\n            + str(e)\n        )\n        frappe.log_error(message, \"Auto Submit Depreciation JE\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "mpp_consolidate_budgets",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-09 21:36:33.389606",
  "module": null,
  "name": "Master Procurement Plan Consolidate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ndoc_name = frappe.form_dict.get(\"doc_name\")\nif not doc_name:\n    frappe.throw(\"Document name is required\")\n\ndoc = frappe.get_doc(\"Master Procurement Plan\", doc_name)\n\n# Clear existing items\ndoc.items = []\ndoc.sources = []\n\n# Get budget types to include - FIXED: Using correct budget type names\nbudget_types = []\nif doc.include_capex:\n    budget_types.append(\"CAPEX\")\nif doc.include_property_capex:\n    budget_types.append(\"Property CAPEX\")\nif doc.include_property_expenses:\n    budget_types.append(\"Property Expenses\")\nif doc.include_hr_budget:\n    budget_types.append(\"HR\")\nif doc.include_opex:\n    budget_types.append(\"OPEX\")\nif doc.include_forecast:\n    budget_types.append(\"Forecast\")\n\nif not budget_types:\n    frappe.throw(\"Please select at least one budget type to consolidate\")\n\n# Helper function to get suggested method\ndef get_method(cat, val):\n    if not val:\n        return \"\"\n    thresholds = frappe.get_all(\"Procurement Method Threshold\", filters={\"procurement_category\": cat, \"is_enabled\": 1, \"require_appropriate_circumstances\": 0}, fields=[\"procurement_method\", \"min_amount\", \"max_amount\", \"allow_equal_at_min\", \"allow_equal_at_max\", \"priority\"], order_by=\"priority asc\")\n    for t in thresholds:\n        min_ok = True\n        max_ok = True\n        if t.min_amount:\n            if t.allow_equal_at_min:\n                min_ok = val >= frappe.utils.flt(t.min_amount)\n            else:\n                min_ok = val > frappe.utils.flt(t.min_amount)\n        if t.max_amount:\n            if t.allow_equal_at_max:\n                max_ok = val <= frappe.utils.flt(t.max_amount)\n            else:\n                max_ok = val < frappe.utils.flt(t.max_amount)\n        if min_ok and max_ok:\n            return t.procurement_method\n    return \"\"\n\n# Get budgets for the fiscal year\nbudgets = frappe.get_all(\"Budget\", filters={\"fiscal_year\": doc.fiscal_year, \"company\": doc.company, \"docstatus\": 1, \"budget_type\": [\"in\", budget_types]}, fields=[\"name\", \"budget_type\", \"cost_center\", \"project\"])\n\nif not budgets:\n    frappe.throw(\"No submitted budgets found for fiscal year \" + str(doc.fiscal_year) + \" with budget types: \" + \", \".join(budget_types))\n\n# Consolidation dictionaries\nasset_cons = {}\naccount_cons = {}\n\n# Process each budget\nfor budget in budgets:\n    budget_doc = frappe.get_doc(\"Budget\", budget.name)\n    is_capex = budget.budget_type == \"CAPEX\"\n    \n    for acc in budget_doc.accounts:\n        qty = frappe.utils.flt(acc.custom_number_of_units) or 1\n        price = frappe.utils.flt(acc.custom_expected_price) or frappe.utils.flt(acc.budget_amount)\n        amount = frappe.utils.flt(acc.budget_amount)\n        \n        # Skip zero amounts\n        if amount <= 0:\n            continue\n        \n        source_data = {\n            \"budget_type\": budget.budget_type,\n            \"budget\": budget.name,\n            \"budget_account\": acc.name,\n            \"account\": acc.account,\n            \"cost_center\": budget.cost_center,\n            \"project\": budget.project,\n            \"quantity\": qty,\n            \"unit_price\": price,\n            \"amount\": amount,\n            \"description\": acc.custom_remarks or \"\",\n            \"remarks\": acc.custom_remarks or \"\"\n        }\n        \n        if is_capex and acc.custom_asset_category:\n            ac = acc.custom_asset_category\n            if ac not in asset_cons:\n                asset_cons[ac] = {\"quantity\": 0, \"total_amount\": 0, \"descriptions\": [], \"sources\": []}\n            asset_cons[ac][\"quantity\"] = asset_cons[ac][\"quantity\"] + qty\n            asset_cons[ac][\"total_amount\"] = asset_cons[ac][\"total_amount\"] + amount\n            if acc.custom_remarks:\n                asset_cons[ac][\"descriptions\"].append(acc.custom_remarks)\n            asset_cons[ac][\"sources\"].append(source_data)\n        else:\n            acc_key = acc.account\n            if acc_key not in account_cons:\n                account_cons[acc_key] = {\"quantity\": 0, \"total_amount\": 0, \"descriptions\": [], \"sources\": []}\n            account_cons[acc_key][\"quantity\"] = account_cons[acc_key][\"quantity\"] + qty\n            account_cons[acc_key][\"total_amount\"] = account_cons[acc_key][\"total_amount\"] + amount\n            if acc.custom_remarks:\n                account_cons[acc_key][\"descriptions\"].append(acc.custom_remarks)\n            account_cons[acc_key][\"sources\"].append(source_data)\n\n# Create consolidated items from asset categories\nfor ac, d in asset_cons.items():\n    item_key = \"AC-\" + ac\n    desc_list = d[\"descriptions\"]\n    unique_descs = []\n    for desc in desc_list:\n        if desc and desc not in unique_descs:\n            unique_descs.append(desc)\n    desc_text = \"; \".join(unique_descs) if unique_descs else ac\n    \n    source_types = []\n    for s in d[\"sources\"]:\n        if s[\"budget_type\"] not in source_types:\n            source_types.append(s[\"budget_type\"])\n    \n    avg_price = d[\"total_amount\"] / d[\"quantity\"] if d[\"quantity\"] else 0\n    \n    doc.append(\"items\", {\n        \"item_key\": item_key,\n        \"consolidation_type\": \"Asset Category\",\n        \"asset_category\": ac,\n        \"description\": desc_text,\n        \"total_quantity\": d[\"quantity\"],\n        \"unit\": \"Units\",\n        \"total_estimated_value\": d[\"total_amount\"],\n        \"average_unit_price\": avg_price,\n        \"source_budget_types\": \", \".join(source_types),\n        \"source_count\": len(d[\"sources\"]),\n        \"suggested_procurement_method\": get_method(doc.procurement_category, d[\"total_amount\"]),\n        \"item_status\": \"Pending\"\n    })\n    \n    for s in d[\"sources\"]:\n        s[\"item_key\"] = item_key\n        doc.append(\"sources\", s)\n\n# Create consolidated items from accounts\nfor acc_key, d in account_cons.items():\n    item_key = \"ACC-\" + acc_key\n    desc_list = d[\"descriptions\"]\n    unique_descs = []\n    for desc in desc_list:\n        if desc and desc not in unique_descs:\n            unique_descs.append(desc)\n    desc_text = \"; \".join(unique_descs) if unique_descs else acc_key\n    \n    source_types = []\n    for s in d[\"sources\"]:\n        if s[\"budget_type\"] not in source_types:\n            source_types.append(s[\"budget_type\"])\n    \n    avg_price = d[\"total_amount\"] / d[\"quantity\"] if d[\"quantity\"] else 0\n    \n    doc.append(\"items\", {\n        \"item_key\": item_key,\n        \"consolidation_type\": \"Expense Account\",\n        \"account\": acc_key,\n        \"description\": desc_text,\n        \"total_quantity\": d[\"quantity\"],\n        \"unit\": \"Units\",\n        \"total_estimated_value\": d[\"total_amount\"],\n        \"average_unit_price\": avg_price,\n        \"source_budget_types\": \", \".join(source_types),\n        \"source_count\": len(d[\"sources\"]),\n        \"suggested_procurement_method\": get_method(doc.procurement_category, d[\"total_amount\"]),\n        \"item_status\": \"Pending\"\n    })\n    \n    for s in d[\"sources\"]:\n        s[\"item_key\"] = item_key\n        doc.append(\"sources\", s)\n\n# Update summary\ndoc.total_items = len(doc.items)\ntotal_val = 0\nfor item in doc.items:\n    total_val = total_val + frappe.utils.flt(item.total_estimated_value)\ndoc.total_estimated_value = total_val\ndoc.plan_status = \"Consolidated\"\ndoc.save()\n\nfrappe.msgprint(\"Consolidated \" + str(len(doc.items)) + \" items from \" + str(len(budgets)) + \" budgets\")\nfrappe.response[\"message\"] = {\"status\": \"success\", \"items\": len(doc.items), \"budgets\": len(budgets)}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "mpp_create_procurement_plans",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 06:39:19.614439",
  "module": null,
  "name": "Master Procurement Plan Create Plans",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ndoc_name = frappe.form_dict.get(\"doc_name\")\nmode = frappe.form_dict.get(\"mode\", \"individual\")\noverride = frappe.form_dict.get(\"override\", 0)\nselected_items = frappe.form_dict.get(\"selected_items\", [])\n\nif not doc_name:\n    frappe.throw(\"Document name is required\")\n\ndoc = frappe.get_doc(\"Master Procurement Plan\", doc_name)\n\n# Procurement Method mapping (MPP method -> Procurement Plan method)\nmethod_map = {\n    \"Simplified Bidding\": \"Simplified Bidding\",\n    \"Open National Bidding\": \"Open National Bidding\",\n    \"Open International Bidding\": \"Open International Bidding\",\n    \"Limited Bidding\": \"Limited Bidding\",\n    \"Direct Bidding\": \"Direct Bidding\",\n    \"Simplified Selection\": \"Simplified Selection\",\n    \"Open National Selection\": \"Open National Selection\",\n    \"Open International Selection\": \"Open International Selection\",\n    \"Limited Selection\": \"Limited Selection\",\n    \"Direct Selection\": \"Direct Selection\"\n}\n\n# Procurement Type mapping\n# Valid options: \"\", \"Goods\", \"Works\", \"Non Consulting Services\", \"Consulting Services\"\ntype_map = {\n    \"Goods/Works\": \"Goods\",\n    \"Consulting Services\": \"Consulting Services\"\n}\n\n# Build list of selected item keys from client\nselected_keys = []\nif selected_items:\n    if isinstance(selected_items, str):\n        selected_keys = selected_items.split(\",\")\n    else:\n        selected_keys = selected_items\n\n# Check for selected items\nselected = []\nitems_with_plans = []\n\nfor item in doc.items:\n    is_item_selected = item.item_key in selected_keys if selected_keys else item.is_selected\n    \n    if is_item_selected:\n        if item.procurement_plan and not override:\n            items_with_plans.append(item)\n        else:\n            selected.append(item)\n\n# If override is requested, include items with existing plans\nif override:\n    for item in doc.items:\n        is_item_selected = item.item_key in selected_keys if selected_keys else item.is_selected\n        if is_item_selected and item not in selected:\n            selected.append(item)\n\n# If no items selected at all\nif not selected and not items_with_plans:\n    frappe.throw(\"Please select at least one item using the checkbox\")\n\n# Flag to control execution flow\nshould_create_plans = True\n\n# If all selected items have plans and override not requested, return info\nif items_with_plans and not selected:\n    plan_list = []\n    for item in items_with_plans:\n        plan_list.append(item.item_key + \" -> \" + str(item.procurement_plan))\n    frappe.response[\"message\"] = {\n        \"status\": \"has_existing_plans\",\n        \"items_with_plans\": len(items_with_plans),\n        \"plan_details\": plan_list\n    }\n    should_create_plans = False\n\nif should_create_plans and not selected:\n    frappe.throw(\"No items available to create procurement plans\")\n\nif should_create_plans:\n    plans = []\n    plan_counter = 1\n\n    def create_plan(mpp_doc, items, suffix=\"\"):\n        total = 0\n        for i in items:\n            total = total + frappe.utils.flt(i.total_estimated_value)\n        \n        plan = frappe.new_doc(\"Procurement Plan\")\n        \n        # Generate reference number\n        plan_num = str(plan_counter).zfill(3)\n        if suffix:\n            ref_name = mpp_doc.name + \"-\" + plan_num + \"-\" + suffix\n        else:\n            ref_name = mpp_doc.name + \"-\" + plan_num\n        \n        # === PROCUREMENT PLAN FIELDS ===\n        # procurement_reference_number (Data)\n        plan.procurement_reference_number = ref_name\n        \n        # fiscal_year (Link) * - REQUIRED\n        plan.fiscal_year = mpp_doc.fiscal_year\n        \n        # procurement_type (Select) - \"\", \"Goods\", \"Works\", \"Non Consulting Services\", \"Consulting Services\"\n        plan.procurement_type = type_map.get(mpp_doc.procurement_category, \"Goods\")\n        \n        # procurement_method (Select)\n        first_item = items[0]\n        method_key = first_item.override_procurement_method or first_item.suggested_procurement_method\n        if method_key:\n            plan.procurement_method = method_map.get(method_key, method_key)\n        \n        # total_value (Currency)\n        plan.total_value = total\n        \n        # zppa_compliant (Check)\n        plan.zppa_compliant = 1 if mpp_doc.zppa_compliant else 0\n        \n        # zppa_no_objection_reference (Data)\n        if mpp_doc.zppa_reference:\n            plan.zppa_no_objection_reference = mpp_doc.zppa_reference\n        \n        # procurement_justification (Small Text) - combine descriptions\n        descriptions = []\n        for item in items:\n            if item.description:\n                descriptions.append(item.description)\n        if descriptions:\n            plan.procurement_justification = \"; \".join(descriptions)\n        \n        # === CHILD TABLE: items ===\n        for item in items:\n            desc = item.description or item.item_key or \"\"\n            plan.append(\"items\", {\n                \"description\": desc,\n                \"unit\": item.unit or \"Units\",\n                \"quantity\": item.total_quantity or 1\n            })\n        \n        # === CHILD TABLE: procurement_plan_type (Timeline) ===\n        if mpp_doc.tender_invitation_date:\n            plan.append(\"procurement_plan_type\", {\n                \"type\": \"Planned\",\n                \"estimated_cost\": total,\n                \"tender_invitation_date\": mpp_doc.tender_invitation_date,\n                \"tender_closing_date\": mpp_doc.tender_closing_date,\n                \"start_of_contract_execution\": mpp_doc.commencement_date,\n                \"completion_of_contract\": mpp_doc.completion_date\n            })\n        \n        plan.insert()\n        return plan\n\n    if mode == \"individual\":\n        for item in selected:\n            p = create_plan(doc, [item])\n            plans.append(p.name)\n            item.procurement_plan = p.name\n            item.item_status = \"Procurement Created\"\n            plan_counter = plan_counter + 1\n\n    elif mode == \"batch\":\n        batches = {}\n        unbatched = []\n        for item in selected:\n            if item.batch_group:\n                if item.batch_group not in batches:\n                    batches[item.batch_group] = []\n                batches[item.batch_group].append(item)\n            else:\n                unbatched.append(item)\n        \n        for batch_name, batch_items in batches.items():\n            p = create_plan(doc, batch_items, batch_name)\n            plans.append(p.name)\n            for item in batch_items:\n                item.procurement_plan = p.name\n                item.item_status = \"Procurement Created\"\n            plan_counter = plan_counter + 1\n        \n        for item in unbatched:\n            p = create_plan(doc, [item])\n            plans.append(p.name)\n            item.procurement_plan = p.name\n            item.item_status = \"Procurement Created\"\n            plan_counter = plan_counter + 1\n\n    elif mode == \"single\":\n        p = create_plan(doc, selected, \"Combined\")\n        plans.append(p.name)\n        for i in selected:\n            i.procurement_plan = p.name\n            i.item_status = \"Procurement Created\"\n\n    doc.plan_status = \"In Progress\"\n    doc.procurement_plans_created = len([i for i in doc.items if i.procurement_plan])\n    doc.save()\n\n    frappe.msgprint(\"Created \" + str(len(plans)) + \" Procurement Plan(s)\")\n    frappe.response[\"message\"] = {\"status\": \"success\", \"plans\": plans}\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "pp_create_po_split_by_supplier",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 07:03:00.976393",
  "module": null,
  "name": "Procurement Plan Create PO",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\ndoc_name = frappe.form_dict.get(\"doc_name\")\nselected_items = frappe.form_dict.get(\"selected_items\", \"\")\nwarehouse = frappe.form_dict.get(\"warehouse\", \"\")\nschedule_date = frappe.form_dict.get(\"schedule_date\", \"\")\n\nif not doc_name:\n    frappe.throw(\"Document name is required\")\n\ndoc = frappe.get_doc(\"Procurement Plan\", doc_name)\n\n# Parse selected items (these are idx values)\nselected_idxs = []\nif selected_items:\n    if isinstance(selected_items, str):\n        for x in selected_items.split(\",\"):\n            if x.strip():\n                selected_idxs.append(int(x.strip()))\n    else:\n        selected_idxs = selected_items\n\n# Get selected items\nitems_to_process = []\nfor item in doc.items:\n    if item.idx in selected_idxs:\n        if item.po_status == \"PO Created\":\n            frappe.throw(\"Item row \" + str(item.idx) + \" already has a PO: \" + str(item.purchase_order))\n        if not item.supplier:\n            frappe.throw(\"Please assign a Supplier to item row \" + str(item.idx) + \" before creating PO\")\n        items_to_process.append(item)\n\nif not items_to_process:\n    frappe.throw(\"Please select at least one item\")\n\n# Group items by supplier\nsupplier_items = {}\nfor item in items_to_process:\n    sup = item.supplier\n    if sup not in supplier_items:\n        supplier_items[sup] = []\n    supplier_items[sup].append(item)\n\n# Create PO for each supplier\ncreated_pos = []\n\nfor supplier, items in supplier_items.items():\n    po = frappe.new_doc(\"Purchase Order\")\n    po.supplier = supplier\n    po.schedule_date = schedule_date or frappe.utils.nowdate()\n    \n    if warehouse:\n        po.set_warehouse = warehouse\n    \n    for item in items:\n        po_item = {\n            \"qty\": item.quantity or 1,\n            \"rate\": item.rate or 0,\n            \"warehouse\": warehouse\n        }\n        \n        # If item_code is set, use it\n        if item.item_code:\n            po_item[\"item_code\"] = item.item_code\n            po_item[\"item_name\"] = item.item_name or item.description\n        else:\n            # Use description as item_name for non-stock items\n            po_item[\"item_name\"] = item.description or \"Procurement Item\"\n        \n        po_item[\"description\"] = item.description or item.item_name or \"\"\n        \n        if item.unit:\n            po_item[\"uom\"] = item.unit\n        \n        po.append(\"items\", po_item)\n    \n    po.insert()\n    created_pos.append({\"name\": po.name, \"supplier\": supplier, \"items\": len(items)})\n    \n    # Update procurement plan items\n    for item in items:\n        item.purchase_order = po.name\n        item.po_status = \"PO Created\"\n\ndoc.save()\n\n# Build message\nmsg_parts = []\nfor po_info in created_pos:\n    msg_parts.append(po_info[\"name\"] + \" (\" + po_info[\"supplier\"] + \", \" + str(po_info[\"items\"]) + \" items)\")\n\nfrappe.msgprint(\"Created \" + str(len(created_pos)) + \" Purchase Order(s):<br>\" + \"<br>\".join(msg_parts))\nfrappe.response[\"message\"] = {\"status\": \"success\", \"purchase_orders\": created_pos}\n",
  "script_type": "API"
 }
]